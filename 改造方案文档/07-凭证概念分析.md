# å‡­è¯æ¦‚å¿µåˆ†æ

> **åˆ›å»ºæ—¥æœŸ**: 2025-11-08
> **é—®é¢˜**: æ”¹é€ åçš„å‡­è¯æ¦‚å¿µå’Œ n8n åŸæœ¬çš„è®¾è®¡æœ‰å‡ºå…¥

---

## ğŸ“Š ä¸€ã€n8n åŸæœ¬çš„å‡­è¯ç³»ç»Ÿè®¾è®¡

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

åœ¨ n8n ä¸­ï¼Œ**å‡­è¯ï¼ˆCredentialsï¼‰** æ˜¯ä¸€ä¸ª**è·¨èŠ‚ç‚¹å¤ç”¨çš„è®¤è¯é…ç½®å¯¹è±¡**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Credentialsï¼ˆå‡­è¯å¯¹è±¡ï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ID: uuid                                  â”‚
â”‚ â€¢ Name: "æˆ‘çš„ GitHub Token"                 â”‚
â”‚ â€¢ Type: "githubApi"                         â”‚
â”‚ â€¢ Data: { "accessToken": "ghp_xxx" }        â”‚
â”‚ â€¢ ProjectId: workspace-1                    â”‚
â”‚ â€¢ isManaged: false                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹ä½¿ç”¨ â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚GitHubèŠ‚ç‚¹â”‚GitHubèŠ‚ç‚¹â”‚GitHubèŠ‚ç‚¹â”‚
    â”‚  (Node1) â”‚  (Node2) â”‚  (Node3) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å‡­è¯çš„ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **å¤ç”¨æ€§** | ä¸€ä¸ªå‡­è¯å¯ä»¥åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸­ä½¿ç”¨ | åŒä¸€ä¸ª GitHub Token ç”¨äº 10 ä¸ª GitHub èŠ‚ç‚¹ |
| **ç±»å‹åŒ–** | æ¯ç§æœåŠ¡æœ‰è‡ªå·±çš„å‡­è¯ç±»å‹ | githubApi, openAiApi, awsIam ç­‰ 400+ ç§ |
| **åŠ å¯†å­˜å‚¨** | å‡­è¯æ•°æ®åŠ å¯†å­˜å‚¨åœ¨æ•°æ®åº“ | AES-256-CBC åŠ å¯† |
| **å½’å±æ€§** | å‡­è¯å½’å±äºæŸä¸ªå·¥ä½œç©ºé—´ï¼ˆProjectï¼‰ | å·¥ä½œç©ºé—´ A çš„å‡­è¯ä¸èƒ½è¢«å·¥ä½œç©ºé—´ B ä½¿ç”¨ |
| **å¯é€‰ç®¡ç†** | å‡­è¯å¯ä»¥æ˜¯å¹³å°æ‰˜ç®¡çš„ï¼ˆisManaged=trueï¼‰ | n8n Cloud æä¾›çš„å…è´¹ OpenAI credits |

### 1.3 å‡­è¯ç±»å‹å®šä¹‰

æ¯ä¸ªç¬¬ä¸‰æ–¹æœåŠ¡éƒ½æœ‰è‡ªå·±çš„å‡­è¯ç±»å‹å®šä¹‰æ–‡ä»¶ï¼š

```
packages/nodes-base/credentials/
â”œâ”€â”€ OpenAiApi.credentials.ts          # OpenAI å‡­è¯
â”œâ”€â”€ GithubApi.credentials.ts          # GitHub å‡­è¯
â”œâ”€â”€ Aws.credentials.ts                # AWS IAM å‡­è¯
â”œâ”€â”€ SlackOAuth2Api.credentials.ts     # Slack OAuth å‡­è¯
â””â”€â”€ ... (400+ ä¸ªå‡­è¯ç±»å‹)
```

**ç¤ºä¾‹ï¼šOpenAI å‡­è¯å®šä¹‰**

```typescript
// packages/nodes-base/credentials/OpenAiApi.credentials.ts
export class OpenAiApi implements ICredentialType {
  name = 'openAiApi';
  displayName = 'OpenAI API';
  documentationUrl = 'openai';

  properties: INodeProperties[] = [
    {
      displayName: 'API Key',
      name: 'apiKey',
      type: 'string',
      typeOptions: { password: true },
      default: '',
    },
  ];

  async authenticate(
    credentials: ICredentialDataDecryptedObject,
    requestOptions: IHttpRequestOptions,
  ): Promise<IHttpRequestOptions> {
    requestOptions.headers = {
      'Authorization': `Bearer ${credentials.apiKey}`,
    };
    return requestOptions;
  }
}
```

### 1.4 å‡­è¯çš„ä½¿ç”¨æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant CredUI as å‡­è¯ç®¡ç†é¡µé¢
    participant CredsDB as credentials_entityè¡¨
    participant Node as OpenAI èŠ‚ç‚¹
    participant Executor as å·¥ä½œæµæ‰§è¡Œå™¨

    User->>CredUI: 1. åˆ›å»ºå‡­è¯ "æˆ‘çš„ OpenAI Key"
    CredUI->>CredsDB: 2. åŠ å¯†å­˜å‚¨ { apiKey: "sk-xxx" }

    User->>Node: 3. é…ç½®èŠ‚ç‚¹ä½¿ç”¨è¯¥å‡­è¯
    Node-->>User: 4. æ˜¾ç¤º "æˆ‘çš„ OpenAI Key"

    User->>Executor: 5. è¿è¡Œå·¥ä½œæµ
    Executor->>CredsDB: 6. æ ¹æ® credentialId è·å–å‡­è¯
    CredsDB-->>Executor: 7. è¿”å›åŠ å¯†çš„å‡­è¯æ•°æ®
    Executor->>Executor: 8. è§£å¯†å‡­è¯æ•°æ®
    Executor->>Node: 9. ä½¿ç”¨å‡­è¯è°ƒç”¨ OpenAI API
```

### 1.5 æ•°æ®åº“ç»“æ„ï¼ˆæ”¹é€ å‰ï¼‰

**æ”¹é€ å‰çš„è®¾è®¡ï¼ˆå·²åºŸå¼ƒï¼‰ï¼š**

```sql
-- SharedCredentials è¡¨ï¼ˆå·²åˆ é™¤ï¼‰
CREATE TABLE shared_credentials (
  id UUID PRIMARY KEY,
  credentials_id UUID,      -- å‡­è¯ ID
  project_id UUID,          -- é¡¹ç›® ID
  role VARCHAR(50)          -- è§’è‰²ï¼šowner, editor, viewer
);

-- Credentials è¡¨
CREATE TABLE credentials_entity (
  id UUID PRIMARY KEY,
  name VARCHAR(128),
  type VARCHAR(128),        -- å‡­è¯ç±»å‹ï¼šopenAiApi, githubApi ç­‰
  data TEXT,                -- åŠ å¯†çš„å‡­è¯æ•°æ®
  -- æ³¨æ„ï¼šåŸæœ¬æ²¡æœ‰ projectId å­—æ®µ
);
```

**æ”¹é€ åçš„è®¾è®¡ï¼ˆå½“å‰ï¼‰ï¼š**

```sql
-- Credentials è¡¨ï¼ˆç›´æ¥å½’å±å·¥ä½œç©ºé—´ï¼‰
CREATE TABLE credentials_entity (
  id UUID PRIMARY KEY,
  name VARCHAR(128),
  type VARCHAR(128),        -- å‡­è¯ç±»å‹ï¼šopenAiApi, githubApi ç­‰
  data TEXT,                -- åŠ å¯†çš„å‡­è¯æ•°æ®
  project_id UUID,          -- âœ… æ–°å¢ï¼šç›´æ¥å½’å±å·¥ä½œç©ºé—´
  is_managed BOOLEAN,       -- âœ… æ–°å¢ï¼šæ˜¯å¦å¹³å°æ‰˜ç®¡
  FOREIGN KEY (project_id) REFERENCES project(id)
);
```

---

## ğŸ”„ äºŒã€æ”¹é€ æ–¹æ¡ˆä¸­çš„å‡­è¯æ¦‚å¿µ

### 2.1 æ”¹é€ æ–¹æ¡ˆå¼•å…¥çš„æ–°æ¦‚å¿µ

æ”¹é€ æ–¹æ¡ˆåœ¨åŸæœ‰çš„ `credentials_entity` åŸºç¡€ä¸Šï¼Œ**æ–°å¢äº†ä¸€ä¸ª** `workspace_plugin_credentials` è¡¨ï¼š

```sql
CREATE TABLE workspace_plugin_credentials (
  id UUID PRIMARY KEY,
  workspace_id UUID NOT NULL,
  service_key VARCHAR(100) NOT NULL,      -- å¼•ç”¨ platform_service.service_key
  encrypted_config TEXT NOT NULL,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  UNIQUE (workspace_id, service_key)      -- æ¯ä¸ªå·¥ä½œç©ºé—´å¯¹æ¯ä¸ªæ’ä»¶åªèƒ½æœ‰ä¸€ä»½é…ç½®
);
```

### 2.2 æ”¹é€ æ–¹æ¡ˆä¸­çš„"ä¸¤å¥—å‡­è¯ç³»ç»Ÿ"

æ”¹é€ åå®é™…ä¸Šå½¢æˆäº†**ä¸¤å¥—å‡­è¯ç³»ç»Ÿ**ï¼š

| å‡­è¯ç³»ç»Ÿ | è¡¨å | ç”¨é€” | ç¤ºä¾‹ |
|---------|------|------|------|
| **åŸæœ‰å‡­è¯** | `credentials_entity` | é«˜çº§ç”¨æˆ·è·¨èŠ‚ç‚¹å¤ç”¨å‡­è¯ | åˆ›å»ºä¸€ä¸ª GitHub Token å‡­è¯ï¼Œåœ¨ 10 ä¸ª GitHub èŠ‚ç‚¹ä¸­å¤ç”¨ |
| **æ’ä»¶å‡­è¯** | `workspace_plugin_credentials` | å·¥ä½œç©ºé—´ä¸º"æ’ä»¶"é…ç½® API Key | å·¥ä½œç©ºé—´ A ä¸º "GitHub æ’ä»¶" é…ç½®ä¸€ä¸ª API Key |

### 2.3 æ”¹é€ æ–¹æ¡ˆä¸­çš„æ··æ·†ç‚¹

**é—®é¢˜ 1ï¼šæ’ä»¶ = èŠ‚ç‚¹ï¼Œä½†å‡­è¯è®¾è®¡æ²¡æœ‰å¯¹é½**

æ ¹æ®ä¹‹å‰çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ï¼š
- âœ… **æ’ä»¶ = èŠ‚ç‚¹**ï¼ˆè¿™æ˜¯æ­£ç¡®çš„ï¼‰
- âŒ ä½†æ˜¯å‡­è¯ç³»ç»Ÿå´æŠŠ "æ’ä»¶" å’Œ "èŠ‚ç‚¹" å½“ä½œä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µ

**é—®é¢˜ 2ï¼šWorkspacePluginCredentials çš„è®¾è®¡å‡è®¾**

`workspace_plugin_credentials` è¡¨çš„è®¾è®¡å‡è®¾ï¼š
- âŒ æ¯ä¸ªå·¥ä½œç©ºé—´å¯¹æ¯ä¸ª"æ’ä»¶"ï¼ˆèŠ‚ç‚¹ï¼‰åªéœ€è¦**ä¸€ä»½å‡­è¯é…ç½®**
- âŒ å‡­è¯é…ç½®é€šè¿‡ `service_key` å…³è”åˆ° `platform_service` è¡¨

ä½†å®é™…æƒ…å†µæ˜¯ï¼š
- âœ… ä¸€ä¸ªå·¥ä½œç©ºé—´å¯èƒ½éœ€è¦**å¤šä¸ªç›¸åŒç±»å‹çš„å‡­è¯**
  - ä¾‹å¦‚ï¼šå…¬å¸æœ‰ 5 ä¸ª GitHub è´¦å·ï¼Œéœ€è¦åˆ›å»º 5 ä¸ªä¸åŒçš„ GitHub å‡­è¯
  - ä¾‹å¦‚ï¼šç”¨æˆ·æœ‰ä¸ªäºº OpenAI è´¦å·å’Œå…¬å¸ OpenAI è´¦å·ï¼Œéœ€è¦åˆ›å»º 2 ä¸ª OpenAI å‡­è¯

**é—®é¢˜ 3ï¼šä¸ platform_service çš„å…³è”ä¸åˆç†**

```sql
-- workspace_plugin_credentials è¡¨
service_key VARCHAR(100) NOT NULL,   -- å¼•ç”¨ platform_service.service_key
```

è¿™ä¸ªè®¾è®¡å‡è®¾ï¼š
- âŒ `service_key` å¼•ç”¨çš„æ˜¯ `platform_service` è¡¨ä¸­çš„æŸæ¡è®°å½•
- âŒ `platform_service` è¡¨å­˜å‚¨çš„æ˜¯"æ’ä»¶/èŠ‚ç‚¹"çš„å…ƒä¿¡æ¯

ä½†å®é™…æƒ…å†µæ˜¯ï¼ˆæ ¹æ®ç°æœ‰ä»£ç ï¼‰ï¼š
- âŒ `platform_service` è¡¨å­˜å‚¨çš„æ˜¯**AI æ¨¡å‹**ï¼ˆgpt-4-turbo, claude-3-opus ç­‰ï¼‰
- âŒ è¿™å®Œå…¨æ˜¯é”™è¯¯çš„å…³è”ï¼

### 2.4 æ”¹é€ æ–¹æ¡ˆçš„æ„å›¾ï¼ˆæ¨æµ‹ï¼‰

æˆ‘æ¨æµ‹æ”¹é€ æ–¹æ¡ˆçš„åŸå§‹æ„å›¾æ˜¯ï¼š

```
åœºæ™¯ 1ï¼šå¹³å°æ‰˜ç®¡çš„ AI èŠ‚ç‚¹
ç”¨æˆ·ï¼šæ‹–æ‹½ OpenAI èŠ‚ç‚¹
ç³»ç»Ÿï¼šè‡ªåŠ¨æ³¨å…¥å¹³å°çš„ API Keyï¼ˆå­˜å‚¨åœ¨ platform_service.api_key_encryptedï¼‰
è®¡è´¹ï¼šä»å·¥ä½œç©ºé—´ä½™é¢æ‰£è´¹

åœºæ™¯ 2ï¼šç”¨æˆ·æ‰˜ç®¡çš„ç¬¬ä¸‰æ–¹èŠ‚ç‚¹
ç”¨æˆ·ï¼šæ‹–æ‹½ GitHub èŠ‚ç‚¹
ç³»ç»Ÿï¼šæç¤ºç”¨æˆ·é…ç½® API Key
ç”¨æˆ·ï¼šåœ¨ workspace_plugin_credentials ä¸­é…ç½® GitHub Token
è®¡è´¹ï¼šç”¨æˆ·è‡ªå·±è´Ÿè´£ GitHub çš„è´¹ç”¨
```

ä½†è¿™ä¸ªè®¾è®¡æœ‰ä»¥ä¸‹é—®é¢˜ï¼š

1. **åœºæ™¯ 1 çš„å®ç°æ–¹å¼é”™è¯¯**
   - âŒ ä¸åº”è¯¥æŠŠ GPT-4ã€GPT-3.5 å½“ä½œç‹¬ç«‹çš„"æœåŠ¡"å­˜å‚¨
   - âœ… åº”è¯¥æ˜¯ï¼šOpenAI ä½œä¸ºä¸€ä¸ªæœåŠ¡æä¾›å•†ï¼Œmodels ä½œä¸ºå‚æ•°

2. **åœºæ™¯ 2 çš„è®¾è®¡å†—ä½™**
   - âŒ `workspace_plugin_credentials` å®Œå…¨å¯ä»¥ç”¨ç°æœ‰çš„ `credentials_entity` ä»£æ›¿
   - âœ… åªéœ€è¦åœ¨ `credentials_entity` ä¸­æ·»åŠ  `is_managed` å­—æ®µåŒºåˆ†å¹³å°æ‰˜ç®¡/ç”¨æˆ·æ‰˜ç®¡å³å¯

---

## ğŸ’¡ ä¸‰ã€æ­£ç¡®çš„å‡­è¯æ¦‚å¿µåº”è¯¥æ˜¯ä»€ä¹ˆ

### 3.1 ç»Ÿä¸€çš„å‡­è¯ç³»ç»Ÿ

**åªéœ€è¦ä¸€å¼ è¡¨ï¼š`credentials_entity`**

```sql
CREATE TABLE credentials_entity (
  id UUID PRIMARY KEY,
  name VARCHAR(128),                    -- å‡­è¯åç§°ï¼šç”¨æˆ·è‡ªå®šä¹‰
  type VARCHAR(128),                    -- å‡­è¯ç±»å‹ï¼šopenAiApi, githubApi ç­‰
  data TEXT,                            -- åŠ å¯†çš„å‡­è¯æ•°æ®
  project_id UUID,                      -- å½’å±å·¥ä½œç©ºé—´
  is_managed BOOLEAN DEFAULT FALSE,     -- æ˜¯å¦å¹³å°æ‰˜ç®¡
  created_at TIMESTAMP,
  updated_at TIMESTAMP,

  FOREIGN KEY (project_id) REFERENCES project(id)
);
```

### 3.2 å‡­è¯çš„ä¸¤ç§æ¥æº

| æ¥æº | is_managed | è¯´æ˜ | ç¤ºä¾‹ |
|------|------------|------|------|
| **å¹³å°æ‰˜ç®¡** | `true` | å¹³å°æä¾› API Keyï¼Œç”¨æˆ·æ— éœ€é…ç½®ï¼ŒæŒ‰é‡è®¡è´¹ | å¹³å°æä¾›çš„ OpenAI Key |
| **ç”¨æˆ·è‡ªç®¡** | `false` | ç”¨æˆ·è‡ªå·±åˆ›å»ºå’Œé…ç½®å‡­è¯ï¼Œç”¨æˆ·è‡ªè´Ÿè´£è´¹ç”¨ | ç”¨æˆ·åˆ›å»ºçš„ GitHub Token |

### 3.3 å‡­è¯çš„ä½¿ç”¨æ–¹å¼

**æ–¹å¼ 1ï¼šåœ¨å‡­è¯ç®¡ç†é¡µé¢åˆ›å»ºï¼ˆé«˜çº§ç”¨æˆ·ï¼‰**

```
1. ç”¨æˆ·è¿›å…¥"å‡­è¯ç®¡ç†"é¡µé¢
2. ç‚¹å‡»"åˆ›å»ºå‡­è¯"
3. é€‰æ‹©å‡­è¯ç±»å‹ï¼ˆgithubApiï¼‰
4. å¡«å†™å‡­è¯åç§°ï¼ˆ"æˆ‘çš„ GitHub Token"ï¼‰
5. å¡«å†™ API Key
6. ä¿å­˜åï¼Œå¯ä»¥åœ¨å¤šä¸ª GitHub èŠ‚ç‚¹ä¸­å¤ç”¨è¿™ä¸ªå‡­è¯
```

**æ–¹å¼ 2ï¼šåœ¨èŠ‚ç‚¹å‚æ•°ä¸­ç›´æ¥åˆ›å»ºï¼ˆå¿«æ·æ–¹å¼ï¼‰**

```
1. ç”¨æˆ·æ‹–æ‹½ GitHub èŠ‚ç‚¹
2. åœ¨èŠ‚ç‚¹å‚æ•°é¢æ¿ä¸­ï¼Œ"Credential" å­—æ®µé€‰æ‹©"åˆ›å»ºæ–°å‡­è¯"
3. å¼¹å‡ºå¿«æ·åˆ›å»ºå¯¹è¯æ¡†
4. å¡«å†™å‡­è¯ä¿¡æ¯åä¿å­˜
5. è¯¥å‡­è¯è‡ªåŠ¨åº”ç”¨åˆ°å½“å‰èŠ‚ç‚¹ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åœ¨å…¶ä»–èŠ‚ç‚¹ä¸­å¤ç”¨
```

**æ–¹å¼ 3ï¼šä½¿ç”¨å¹³å°æ‰˜ç®¡çš„å‡­è¯ï¼ˆå¯¹äº AI èŠ‚ç‚¹ï¼‰**

```
1. ç”¨æˆ·æ‹–æ‹½ OpenAI èŠ‚ç‚¹
2. ç³»ç»Ÿæ£€æµ‹åˆ° OpenAI æ˜¯å¹³å°æ‰˜ç®¡çš„æœåŠ¡
3. è‡ªåŠ¨æ³¨å…¥å¹³å°çš„ OpenAI å‡­è¯ï¼ˆis_managed=trueï¼‰
4. ç”¨æˆ·æ— éœ€é…ç½®ï¼Œç›´æ¥ä½¿ç”¨
5. å·¥ä½œæµæ‰§è¡Œæ—¶ï¼Œä»å·¥ä½œç©ºé—´ä½™é¢æ‰£è´¹
```

### 3.4 å‡­è¯ä¸ AI æœåŠ¡æä¾›å•†çš„å…³ç³»

```mermaid
graph TB
    subgraph "å‡­è¯ç³»ç»Ÿ"
        C1[Credential: å¹³å° OpenAI Key<br/>type: openAiApi<br/>is_managed: true]
        C2[Credential: ç”¨æˆ· OpenAI Key<br/>type: openAiApi<br/>is_managed: false]
        C3[Credential: æˆ‘çš„ GitHub Token<br/>type: githubApi<br/>is_managed: false]
    end

    subgraph "AI æœåŠ¡æä¾›å•†ç®¡ç†"
        P1[Provider: OpenAI<br/>models: gpt-4, gpt-3.5-turbo]
        P2[Provider: Anthropic<br/>models: claude-3-opus, claude-3-sonnet]
    end

    subgraph "èŠ‚ç‚¹ä½¿ç”¨"
        N1[OpenAI Node<br/>ä½¿ç”¨: C1 æˆ– C2<br/>é€‰æ‹©æ¨¡å‹: gpt-4]
        N2[GitHub Node<br/>ä½¿ç”¨: C3]
    end

    C1 -.ç®¡ç†æ¨¡å‹åˆ—è¡¨.-> P1
    C2 -.ç®¡ç†æ¨¡å‹åˆ—è¡¨.-> P1
    N1 --> C1
    N1 --> C2
    N2 --> C3
```

---

## ğŸ› å››ã€æ”¹é€ ä»£ç ä¸­çš„å…·ä½“é—®é¢˜

### 4.1 WorkspacePluginCredentials è¡¨çš„é—®é¢˜

**é—®é¢˜**ï¼šè¿™ä¸ªè¡¨å®Œå…¨æ²¡æœ‰å¿…è¦å­˜åœ¨

```typescript
// packages/@n8n/db/src/entities/workspace-plugin-credentials.entity.ts
@Entity()
@Index(['workspaceId', 'serviceKey'], { unique: true }) // âŒ é”™è¯¯çº¦æŸï¼
export class WorkspacePluginCredentials extends WithTimestampsAndStringId {
  @Column({ type: 'uuid', name: 'workspace_id' })
  workspaceId: string;

  @Column({ type: 'varchar', length: 100, name: 'service_key' })
  serviceKey: string;   // âŒ å¼•ç”¨çš„æ˜¯ platform_serviceï¼ˆAI æ¨¡å‹ï¼‰ï¼Œä¸æ˜¯èŠ‚ç‚¹ï¼

  @Column({ type: 'text', name: 'encrypted_config' })
  encryptedConfig: string;
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. âŒ `UNIQUE (workspaceId, serviceKey)` - é™åˆ¶æ¯ä¸ªå·¥ä½œç©ºé—´å¯¹æ¯ä¸ªæœåŠ¡åªèƒ½æœ‰ä¸€ä¸ªå‡­è¯
   - ç°å®ï¼šä¸€ä¸ªå·¥ä½œç©ºé—´å¯èƒ½éœ€è¦å¤šä¸ª GitHub å‡­è¯ï¼ˆå¤šä¸ªè´¦å·ï¼‰

2. âŒ `service_key` å¼•ç”¨ `platform_service` - å…³è”åˆ°é”™è¯¯çš„è¡¨
   - `platform_service` å­˜å‚¨çš„æ˜¯ AI æ¨¡å‹ï¼ˆgpt-4, claude-3-opusï¼‰
   - å‡­è¯åº”è¯¥å…³è”åˆ°å‡­è¯ç±»å‹ï¼ˆgithubApi, openAiApiï¼‰ï¼Œè€Œä¸æ˜¯ AI æ¨¡å‹

3. âŒ åŠŸèƒ½é‡å¤ - `credentials_entity` å·²ç»æä¾›äº†æ‰€æœ‰éœ€è¦çš„åŠŸèƒ½

### 4.2 æ”¹é€ æ–¹æ¡ˆæ–‡æ¡£ä¸­çš„é”™è¯¯æè¿°

**æ–‡æ¡£ä¸­çš„é”™è¯¯è¡¨è¿°**ï¼š

```markdown
workspace_plugin_credentials: æ’ä»¶ API Key | service_id, encrypted_credentials
```

**é—®é¢˜**ï¼š
- "æ’ä»¶ API Key" æš—ç¤ºè¿™æ˜¯ä¸“é—¨ä¸º"æ’ä»¶"è®¾è®¡çš„å‡­è¯è¡¨
- ä½†å®é™…ä¸Šå‡­è¯åº”è¯¥æ˜¯è·¨èŠ‚ç‚¹å¤ç”¨çš„ï¼Œä¸åº”è¯¥å’Œ"æ’ä»¶"ç»‘å®š

### 4.3 è¿ç§»æ–‡ä»¶ä¸­çš„é—®é¢˜

è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹è¿ç§»æ–‡ä»¶ï¼š

```bash
packages/@n8n/db/src/migrations/common/
â”œâ”€â”€ 1762511302220-CreatePlatformServiceTables.ts    # åˆ›å»º platform_serviceï¼ˆAI æ¨¡å‹ï¼‰
â”œâ”€â”€ 1762511302660-ExtendPlatformServiceForPlugins.ts  # æ‰©å±•ä¸º"æ’ä»¶"
â””â”€â”€ 1762511302880-CreateWorkspacePluginCredentialsTable.ts  # âŒ åº”è¯¥ä¸å­˜åœ¨
```

---

## âœ… äº”ã€ä¿®æ­£æ–¹æ¡ˆ

### 5.1 åˆ é™¤ workspace_plugin_credentials è¡¨

**åŸå› **ï¼š
1. åŠŸèƒ½å®Œå…¨ç”± `credentials_entity` è¦†ç›–
2. è®¾è®¡çº¦æŸä¸åˆç†ï¼ˆæ¯ä¸ªå·¥ä½œç©ºé—´æ¯ä¸ªæœåŠ¡åªèƒ½ä¸€ä¸ªå‡­è¯ï¼‰
3. ä¸ `platform_service` çš„å…³è”æ˜¯é”™è¯¯çš„

### 5.2 åªä½¿ç”¨ credentials_entity

**ä¿ç•™ç°æœ‰çš„ credentials_entity è¡¨ç»“æ„**ï¼š

```sql
CREATE TABLE credentials_entity (
  id UUID PRIMARY KEY,
  name VARCHAR(128),                    -- ç”¨æˆ·è‡ªå®šä¹‰åç§°
  type VARCHAR(128),                    -- å‡­è¯ç±»å‹ï¼ˆ400+ ç§ï¼‰
  data TEXT,                            -- åŠ å¯†çš„å‡­è¯æ•°æ®
  project_id UUID,                      -- å½’å±å·¥ä½œç©ºé—´
  is_managed BOOLEAN DEFAULT FALSE,     -- å¹³å°æ‰˜ç®¡ vs ç”¨æˆ·è‡ªç®¡
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

### 5.3 å¹³å°æ‰˜ç®¡ AI å‡­è¯çš„å®ç°

**åˆ›å»ºå¹³å°æ‰˜ç®¡çš„ OpenAI å‡­è¯**ï¼š

```typescript
// åœ¨å·¥ä½œç©ºé—´åˆ›å»ºæ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºå¹³å°æ‰˜ç®¡çš„ AI å‡­è¯
async function createWorkspace(workspaceData) {
  // 1. åˆ›å»ºå·¥ä½œç©ºé—´
  const workspace = await projectRepository.save(workspaceData);

  // 2. ä¸ºè¯¥å·¥ä½œç©ºé—´åˆ›å»ºå¹³å°æ‰˜ç®¡çš„ AI å‡­è¯
  const platformOpenAiCred = await credentialsRepository.save({
    name: 'å¹³å° OpenAI å‡­è¯ï¼ˆæŒ‰é‡è®¡è´¹ï¼‰',
    type: 'openAiApi',
    data: encryptedPlatformApiKey,  // å¹³å°çš„ OpenAI API Key
    projectId: workspace.id,
    isManaged: true,  // âœ… å¹³å°æ‰˜ç®¡
  });

  const platformAnthropicCred = await credentialsRepository.save({
    name: 'å¹³å° Anthropic å‡­è¯ï¼ˆæŒ‰é‡è®¡è´¹ï¼‰',
    type: 'anthropicApi',
    data: encryptedPlatformApiKey,  // å¹³å°çš„ Anthropic API Key
    projectId: workspace.id,
    isManaged: true,  // âœ… å¹³å°æ‰˜ç®¡
  });

  return workspace;
}
```

### 5.4 ç”¨æˆ·ä½¿ç”¨å‡­è¯çš„æµç¨‹

**åœºæ™¯ 1ï¼šä½¿ç”¨å¹³å°æ‰˜ç®¡çš„ OpenAI**

```typescript
// ç”¨æˆ·æ‹–æ‹½ OpenAI èŠ‚ç‚¹
// ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹© isManaged=true çš„ OpenAI å‡­è¯
const credential = await credentialsRepository.findOne({
  where: {
    projectId: currentWorkspace.id,
    type: 'openAiApi',
    isManaged: true,
  },
});

// æ‰§è¡Œæ—¶ï¼Œä½¿ç”¨å¹³å° API Keyï¼Œä»å·¥ä½œç©ºé—´ä½™é¢æ‰£è´¹
```

**åœºæ™¯ 2ï¼šç”¨æˆ·è‡ªå·±é…ç½® OpenAI**

```typescript
// ç”¨æˆ·åˆ›å»ºè‡ªå·±çš„ OpenAI å‡­è¯
const userCred = await credentialsRepository.save({
  name: 'æˆ‘çš„ OpenAI Key',
  type: 'openAiApi',
  data: encryptedUserApiKey,
  projectId: currentWorkspace.id,
  isManaged: false,  // âœ… ç”¨æˆ·è‡ªç®¡
});

// ç”¨æˆ·åœ¨èŠ‚ç‚¹ä¸­é€‰æ‹©ä½¿ç”¨è¿™ä¸ªå‡­è¯
// æ‰§è¡Œæ—¶ï¼Œä½¿ç”¨ç”¨æˆ·è‡ªå·±çš„ API Keyï¼Œä¸æ‰£å·¥ä½œç©ºé—´ä½™é¢
```

---

## ğŸ“ å…­ã€æ€»ç»“

### 6.1 æ¦‚å¿µå¯¹æ¯”è¡¨

| æ¦‚å¿µ | n8n åŸæœ¬ | æ”¹é€ æ–¹æ¡ˆï¼ˆé”™è¯¯ï¼‰ | æ­£ç¡®åº”è¯¥æ˜¯ |
|------|---------|----------------|-----------|
| **å‡­è¯è¡¨** | credentials_entity | credentials_entity + workspace_plugin_credentials | åªéœ€è¦ credentials_entity |
| **å‡­è¯å½’å±** | SharedCredentials è¡¨ï¼ˆå·²åˆ é™¤ï¼‰ | ç›´æ¥ projectId | âœ… ç›´æ¥ projectId |
| **å‡­è¯å¤ç”¨** | âœ… å¯è·¨èŠ‚ç‚¹å¤ç”¨ | âŒ æ¯ä¸ªå·¥ä½œç©ºé—´æ¯ä¸ªæ’ä»¶ä¸€ä¸ªå‡­è¯ | âœ… å¯è·¨èŠ‚ç‚¹å¤ç”¨ |
| **å¹³å°æ‰˜ç®¡** | isManaged å­—æ®µï¼ˆä»… n8n Cloudï¼‰ | æ··ä¹±çš„ä¸¤å¥—ç³»ç»Ÿ | âœ… isManaged å­—æ®µ |
| **ä¸æœåŠ¡çš„å…³ç³»** | å‡­è¯ç±»å‹ï¼ˆ400+ç§ï¼‰ | é”™è¯¯å…³è”åˆ° platform_service | âœ… å‡­è¯ç±»å‹ï¼ˆ400+ç§ï¼‰ |

### 6.2 éœ€è¦ä¿®æ­£çš„æ–‡ä»¶

1. **åˆ é™¤çš„æ–‡ä»¶**ï¼š
   - `workspace-plugin-credentials.entity.ts`
   - `workspace-plugin-credentials.repository.ts`
   - `1762511302880-CreateWorkspacePluginCredentialsTable.ts`ï¼ˆè¿ç§»æ–‡ä»¶ï¼‰

2. **ä¿®æ­£çš„æ–‡ä»¶**ï¼š
   - æ‰€æœ‰å¼•ç”¨ `WorkspacePluginCredentials` çš„ Service/Controller
   - å‰ç«¯çš„å‡­è¯ç®¡ç†ç›¸å…³ç»„ä»¶

### 6.3 æ ¸å¿ƒç»“è®º

âœ… **æ­£ç¡®çš„å‡­è¯æ¦‚å¿µ**ï¼š
- å‡­è¯æ˜¯**è·¨èŠ‚ç‚¹å¤ç”¨çš„è®¤è¯é…ç½®å¯¹è±¡**
- ä¸€ä¸ªå·¥ä½œç©ºé—´å¯ä»¥æœ‰**å¤šä¸ªç›¸åŒç±»å‹çš„å‡­è¯**
- å‡­è¯é€šè¿‡ `type` å­—æ®µå…³è”åˆ°**å‡­è¯ç±»å‹**ï¼ˆä¸æ˜¯ AI æ¨¡å‹æˆ–èŠ‚ç‚¹ï¼‰
- å‡­è¯é€šè¿‡ `isManaged` å­—æ®µåŒºåˆ†**å¹³å°æ‰˜ç®¡ vs ç”¨æˆ·è‡ªç®¡**

âŒ **æ”¹é€ æ–¹æ¡ˆçš„é”™è¯¯**ï¼š
- åˆ›å»ºäº†å†—ä½™çš„ `workspace_plugin_credentials` è¡¨
- é”™è¯¯åœ°é™åˆ¶äº†æ¯ä¸ªå·¥ä½œç©ºé—´æ¯ä¸ªæœåŠ¡åªèƒ½æœ‰ä¸€ä¸ªå‡­è¯
- é”™è¯¯åœ°å°†å‡­è¯å…³è”åˆ° `platform_service`ï¼ˆAI æ¨¡å‹ï¼‰

---

## ğŸ¯ ä¸ƒã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… ç¡®è®¤åˆ é™¤ `workspace_plugin_credentials` ç›¸å…³ä»£ç 
2. âœ… åªä½¿ç”¨ `credentials_entity` è¡¨
3. âœ… å®ç°åŸºäº `isManaged` å­—æ®µçš„å¹³å°æ‰˜ç®¡å‡­è¯é€»è¾‘
4. âœ… æ›´æ–°å‰ç«¯å‡­è¯ç®¡ç† UI
5. âœ… æ›´æ–°æ¦‚å¿µä¿®æ­£æ–¹æ¡ˆæ–‡æ¡£ï¼ŒåŠ å…¥å‡­è¯ç³»ç»Ÿçš„ä¿®æ­£
