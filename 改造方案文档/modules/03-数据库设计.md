# æ•°æ®åº“è®¾è®¡

> **ç‰ˆæœ¬ï¼š** v1.0
> **çŠ¶æ€ï¼š** è®¾è®¡ä¸­

[â† è¿”å›æ€»è§ˆ](../00-æ€»è§ˆä¸å¯¼èˆª.md)

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### è¡¨æ¸…å•

| è¡¨å | ç”¨é€” | çŠ¶æ€ |
|------|------|------|
| `platform_ai_provider` | AI æœåŠ¡æä¾›å•†é…ç½® | âœ… å·²åˆ›å»º |
| `platform_node` | å¹³å°å’Œç¬¬ä¸‰æ–¹èŠ‚ç‚¹ | âœ… å·²åˆ›å»º |
| `custom_node` | å·¥ä½œç©ºé—´è‡ªå®šä¹‰èŠ‚ç‚¹ | âœ… å·²åˆ›å»º |
| `user_node_config` | ç”¨æˆ·èŠ‚ç‚¹é…ç½® | âœ… å·²åˆ›å»º |
| `credentials_entity` | **âŒ éœ€åˆ é™¤** | âš ï¸ å¾…åˆ é™¤ |

### 1. platform_ai_providerï¼ˆAI æä¾›å•†ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨å¹³å°æ‰˜ç®¡çš„ AI æœåŠ¡æä¾›å•†ï¼ˆOpenAIã€Anthropic ç­‰ï¼‰

```sql
CREATE TABLE platform_ai_provider (
  -- ä¸»é”®
  provider_key VARCHAR(100) PRIMARY KEY,  -- 'openai', 'anthropic', 'google'

  -- åŸºæœ¬ä¿¡æ¯
  provider_name VARCHAR(200) NOT NULL,    -- 'OpenAI', 'Anthropic', 'Google'
  description TEXT,
  icon_url VARCHAR(500),

  -- API é…ç½®ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
  api_config JSONB NOT NULL,              -- { apiKey: "sk-xxx", baseUrl: "..." }

  -- æ¨¡å‹é…ç½®ï¼ˆJSONB æ•°ç»„ï¼‰
  models_config JSONB NOT NULL,           -- [{ id, name, pricePerToken, ... }]

  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT true,
  is_enabled BOOLEAN DEFAULT true,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**models_config ç»“æ„ï¼š**

```json
[
  {
    "id": "gpt-4-turbo",
    "name": "GPT-4 Turbo",
    "description": "Most capable model, best for complex tasks",
    "pricePerToken": 0.00001,
    "contextWindow": 128000,
    "maxOutputTokens": 4096,
    "supportsVision": true,
    "supportsFunctionCalling": true
  },
  {
    "id": "gpt-3.5-turbo",
    "name": "GPT-3.5 Turbo",
    "description": "Fast and cost-effective",
    "pricePerToken": 0.000002,
    "contextWindow": 16385,
    "maxOutputTokens": 4096
  }
]
```

**api_config ç»“æ„ï¼ˆåŠ å¯†ï¼‰ï¼š**

```json
{
  "apiKey": "sk-proj-xxx",
  "baseUrl": "https://api.openai.com/v1",
  "organization": "org-xxx",
  "timeout": 60000
}
```

### 2. platform_nodeï¼ˆå¹³å°èŠ‚ç‚¹ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨å¹³å°å®˜æ–¹å’Œç¬¬ä¸‰æ–¹å®¡æ ¸é€šè¿‡çš„èŠ‚ç‚¹

```sql
CREATE TABLE platform_node (
  -- ä¸»é”®
  node_key VARCHAR(100) PRIMARY KEY,      -- 'weather-query', 'ocr-service'

  -- åŸºæœ¬ä¿¡æ¯
  node_name VARCHAR(200) NOT NULL,
  node_type VARCHAR(50) NOT NULL,         -- 'platform_official' | 'third_party_approved'
  category VARCHAR(100),                  -- 'utility', 'ai', 'data'
  description TEXT,
  icon_url VARCHAR(500),
  version VARCHAR(50) DEFAULT '1.0.0',

  -- èŠ‚ç‚¹å®šä¹‰ï¼ˆå®Œæ•´çš„ INodeTypeDescriptionï¼‰
  node_definition JSONB NOT NULL,

  -- èŠ‚ç‚¹ä»£ç ï¼ˆTypeScriptï¼‰
  node_code TEXT,

  -- è®¡è´¹é…ç½®ï¼ˆå¦‚æœæ˜¯å¹³å°æ‰˜ç®¡æœåŠ¡ï¼‰
  is_billable BOOLEAN DEFAULT false,
  price_per_request DECIMAL(10, 4),

  -- å®¡æ ¸ä¿¡æ¯ï¼ˆä»…ç¬¬ä¸‰æ–¹èŠ‚ç‚¹ï¼‰
  submission_status VARCHAR(50),          -- 'approved' | 'rejected'
  submitted_by UUID,
  submitted_at TIMESTAMP,
  reviewed_by UUID,
  reviewed_at TIMESTAMP,
  review_notes TEXT,

  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT true,
  enabled BOOLEAN DEFAULT true,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- å¤–é”®
  FOREIGN KEY (submitted_by) REFERENCES user(id),
  FOREIGN KEY (reviewed_by) REFERENCES user(id)
);

CREATE INDEX idx_platform_node_type ON platform_node(node_type);
CREATE INDEX idx_platform_node_category ON platform_node(category);
```

### 3. custom_nodeï¼ˆè‡ªå®šä¹‰èŠ‚ç‚¹ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨å·¥ä½œç©ºé—´ä¸Šä¼ çš„ç§æœ‰èŠ‚ç‚¹

```sql
CREATE TABLE custom_node (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- åŸºæœ¬ä¿¡æ¯
  node_key VARCHAR(100) NOT NULL,
  node_name VARCHAR(200) NOT NULL,
  workspace_id UUID NOT NULL,
  category VARCHAR(100),
  description TEXT,
  icon_url VARCHAR(500),
  version VARCHAR(50) DEFAULT '1.0.0',

  -- èŠ‚ç‚¹å®šä¹‰å’Œä»£ç 
  node_definition JSONB NOT NULL,
  node_code TEXT NOT NULL,

  -- é…ç½®æ¨¡å¼
  config_mode VARCHAR(20) DEFAULT 'personal',  -- 'personal' | 'shared'
  config_schema JSONB,

  -- å›¢é˜Ÿå…±äº«é…ç½®ï¼ˆä»… shared æ¨¡å¼ï¼‰
  shared_config_data TEXT,                     -- åŠ å¯†å­˜å‚¨
  shared_config_by UUID,

  -- å¯è§æ€§ï¼ˆå›ºå®šå€¼ï¼‰
  visibility VARCHAR(50) DEFAULT 'workspace',

  -- å®¡æ ¸æµç¨‹ï¼ˆå¯é€‰ï¼‰
  submission_status VARCHAR(50),               -- 'draft' | 'pending' | 'approved' | 'rejected'
  submitted_at TIMESTAMP,
  reviewed_by UUID,
  reviewed_at TIMESTAMP,
  review_notes TEXT,

  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT true,

  -- åˆ›å»ºä¿¡æ¯
  created_by UUID NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- å¤–é”®
  FOREIGN KEY (workspace_id) REFERENCES project(id) ON DELETE CASCADE,
  FOREIGN KEY (created_by) REFERENCES user(id),
  FOREIGN KEY (shared_config_by) REFERENCES user(id),
  FOREIGN KEY (reviewed_by) REFERENCES user(id),

  -- å”¯ä¸€çº¦æŸ
  UNIQUE(workspace_id, node_key)
);

CREATE INDEX idx_custom_node_workspace ON custom_node(workspace_id);
CREATE INDEX idx_custom_node_status ON custom_node(submission_status);
```

### 4. user_node_configï¼ˆç”¨æˆ·èŠ‚ç‚¹é…ç½®ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨ç”¨æˆ·çº§åˆ«çš„èŠ‚ç‚¹å‚æ•°é…ç½®ï¼Œæ›¿ä»£ credentials_entity

```sql
CREATE TABLE user_node_config (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- å…³è”ä¿¡æ¯
  user_id UUID NOT NULL,
  workspace_id UUID NOT NULL,
  node_type VARCHAR(100) NOT NULL,        -- èŠ‚ç‚¹ç±»å‹ï¼ˆå¦‚ 'github', 'slack'ï¼‰
  config_name VARCHAR(200),               -- ç”¨æˆ·è‡ªå®šä¹‰åç§°ï¼ˆå¦‚ "æˆ‘çš„ GitHub Token"ï¼‰

  -- é…ç½®æ•°æ®ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
  config_data TEXT NOT NULL,

  -- å…ƒæ•°æ®
  last_used_at TIMESTAMP,
  use_count INTEGER DEFAULT 0,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- å¤–é”®
  FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE,
  FOREIGN KEY (workspace_id) REFERENCES project(id) ON DELETE CASCADE
);

CREATE INDEX idx_user_node_config_user ON user_node_config(user_id);
CREATE INDEX idx_user_node_config_workspace ON user_node_config(workspace_id);
CREATE INDEX idx_user_node_config_type ON user_node_config(node_type);
```

### å…³é”®è®¾è®¡å†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ | ç†ç”± |
|--------|------|------|
| **AI æä¾›å•†** | ä½¿ç”¨ provider_key ä½œä¸ºä¸»é”® | ç®€åŒ– URL è·¯ç”±ï¼ˆ/platform-ai-providers/{key}ï¼‰ |
| **æ¨¡å‹å­˜å‚¨** | models_config (JSONB) | çµæ´»ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ æ¨¡å‹ |
| **èŠ‚ç‚¹ç±»å‹å­—æ®µ** | platform_node.node_type | åŒºåˆ†å¹³å°å®˜æ–¹å’Œç¬¬ä¸‰æ–¹ |
| **è‡ªå®šä¹‰èŠ‚ç‚¹å”¯ä¸€æ€§** | UNIQUE(workspace_id, node_key) | å·¥ä½œç©ºé—´å†…ä¸èƒ½é‡å¤ |
| **é…ç½®éš”ç¦»** | user_node_config.user_id | ç”¨æˆ·çº§åˆ«éš”ç¦»ï¼Œæ›´å®‰å…¨ |
| **åˆ é™¤ credentials** | âŒ å®Œå…¨åˆ é™¤ | ç®€åŒ–æ¶æ„ï¼Œç”¨ user_node_config æ›¿ä»£ |

---


[â† ä¸Šä¸€ç« ï¼šæ¶æ„æ€»è§ˆ](./02-æ¶æ„æ€»è§ˆ.md) | [è¿”å›æ€»è§ˆ](../00-æ€»è§ˆä¸å¯¼èˆª.md) | [ä¸‹ä¸€ç« ï¼šèŠ‚ç‚¹æ¶æ„ â†’](./04-èŠ‚ç‚¹æ¶æ„.md)
