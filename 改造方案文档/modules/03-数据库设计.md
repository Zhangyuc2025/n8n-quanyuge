# æ•°æ®åº“è®¾è®¡

> **ç‰ˆæœ¬ï¼š** v2.0
> **çŠ¶æ€ï¼š** è®¾è®¡ä¸­
> **æœ€åæ›´æ–°ï¼š** 2025-01-10

[â† è¿”å›æ€»è§ˆ](../00-æ€»è§ˆä¸å¯¼èˆª.md)

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### ğŸ“‹ å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|---------|
| v2.0 | 2025-01-10 | æ›´æ–° custom_node è¡¨ï¼Œæ”¯æŒå››å±‚èŠ‚ç‚¹æ¶æ„ï¼ˆnpm ç¤¾åŒºèŠ‚ç‚¹+ç”¨æˆ·ä¸Šä¼ èŠ‚ç‚¹ï¼‰ |
| v1.0 | 2024-12-XX | åˆå§‹ç‰ˆæœ¬ |

### è¡¨æ¸…å•

| è¡¨å | ç”¨é€” | çŠ¶æ€ |
|------|------|------|
| `platform_ai_provider` | AI æœåŠ¡æä¾›å•†é…ç½® | âœ… å·²åˆ›å»º |
| `platform_node` | å¹³å°å’Œç¬¬ä¸‰æ–¹èŠ‚ç‚¹ | âœ… å·²åˆ›å»º |
| `custom_node` | å·¥ä½œç©ºé—´è‡ªå®šä¹‰èŠ‚ç‚¹ï¼ˆnpm ç¤¾åŒº+ç”¨æˆ·ä¸Šä¼ ï¼‰ | âœ… å·²åˆ›å»º |
| `user_node_config` | ç”¨æˆ·èŠ‚ç‚¹é…ç½® | âœ… å·²åˆ›å»º |
| `credentials_entity` | **âŒ å·²åºŸå¼ƒ** | âš ï¸ å¾…åˆ é™¤ |
| `installed_packages` | **âŒ å·²åºŸå¼ƒ** | âš ï¸ å¾…åˆ é™¤ |
| `installed_nodes` | **âŒ å·²åºŸå¼ƒ** | âš ï¸ å¾…åˆ é™¤ |

### 1. platform_ai_providerï¼ˆAI æä¾›å•†ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨å¹³å°æ‰˜ç®¡çš„ AI æœåŠ¡æä¾›å•†ï¼ˆOpenAIã€Anthropic ç­‰ï¼‰

```sql
CREATE TABLE platform_ai_provider (
  -- ä¸»é”®
  provider_key VARCHAR(100) PRIMARY KEY,  -- 'openai', 'anthropic', 'google'

  -- åŸºæœ¬ä¿¡æ¯
  provider_name VARCHAR(200) NOT NULL,    -- 'OpenAI', 'Anthropic', 'Google'
  description TEXT,
  icon_url VARCHAR(500),

  -- API é…ç½®ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
  api_config JSONB NOT NULL,              -- { apiKey: "sk-xxx", baseUrl: "..." }

  -- æ¨¡å‹é…ç½®ï¼ˆJSONB æ•°ç»„ï¼‰
  models_config JSONB NOT NULL,           -- [{ id, name, pricePerToken, ... }]

  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT true,
  is_enabled BOOLEAN DEFAULT true,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**models_config ç»“æ„ï¼š**

```json
[
  {
    "id": "gpt-4-turbo",
    "name": "GPT-4 Turbo",
    "description": "Most capable model, best for complex tasks",
    "pricePerToken": 0.00001,
    "contextWindow": 128000,
    "maxOutputTokens": 4096,
    "supportsVision": true,
    "supportsFunctionCalling": true
  },
  {
    "id": "gpt-3.5-turbo",
    "name": "GPT-3.5 Turbo",
    "description": "Fast and cost-effective",
    "pricePerToken": 0.000002,
    "contextWindow": 16385,
    "maxOutputTokens": 4096
  }
]
```

**api_config ç»“æ„ï¼ˆåŠ å¯†ï¼‰ï¼š**

```json
{
  "apiKey": "sk-proj-xxx",
  "baseUrl": "https://api.openai.com/v1",
  "organization": "org-xxx",
  "timeout": 60000
}
```

### 2. platform_nodeï¼ˆå¹³å°èŠ‚ç‚¹ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨å¹³å°å®˜æ–¹å’Œç¬¬ä¸‰æ–¹å®¡æ ¸é€šè¿‡çš„èŠ‚ç‚¹

```sql
CREATE TABLE platform_node (
  -- ä¸»é”®
  node_key VARCHAR(100) PRIMARY KEY,      -- 'weather-query', 'ocr-service'

  -- åŸºæœ¬ä¿¡æ¯
  node_name VARCHAR(200) NOT NULL,
  node_type VARCHAR(50) NOT NULL,         -- 'platform_official' | 'third_party_approved'
  category VARCHAR(100),                  -- 'utility', 'ai', 'data'
  description TEXT,
  icon_url VARCHAR(500),
  version VARCHAR(50) DEFAULT '1.0.0',

  -- èŠ‚ç‚¹å®šä¹‰ï¼ˆå®Œæ•´çš„ INodeTypeDescriptionï¼‰
  node_definition JSONB NOT NULL,

  -- èŠ‚ç‚¹ä»£ç ï¼ˆTypeScriptï¼‰
  node_code TEXT,

  -- è®¡è´¹é…ç½®ï¼ˆå¦‚æœæ˜¯å¹³å°æ‰˜ç®¡æœåŠ¡ï¼‰
  is_billable BOOLEAN DEFAULT false,
  price_per_request DECIMAL(10, 4),

  -- å®¡æ ¸ä¿¡æ¯ï¼ˆä»…ç¬¬ä¸‰æ–¹èŠ‚ç‚¹ï¼‰
  submission_status VARCHAR(50),          -- 'approved' | 'rejected'
  submitted_by UUID,
  submitted_at TIMESTAMP,
  reviewed_by UUID,
  reviewed_at TIMESTAMP,
  review_notes TEXT,

  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT true,
  enabled BOOLEAN DEFAULT true,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- å¤–é”®
  FOREIGN KEY (submitted_by) REFERENCES user(id),
  FOREIGN KEY (reviewed_by) REFERENCES user(id)
);

CREATE INDEX idx_platform_node_type ON platform_node(node_type);
CREATE INDEX idx_platform_node_category ON platform_node(category);
```

### 3. custom_nodeï¼ˆè‡ªå®šä¹‰èŠ‚ç‚¹ - å››å±‚æ¶æ„ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨å·¥ä½œç©ºé—´ç§æœ‰èŠ‚ç‚¹ï¼ˆæ”¯æŒ npm ç¤¾åŒºèŠ‚ç‚¹å’Œç”¨æˆ·ä¸Šä¼ èŠ‚ç‚¹ï¼‰

**è®¾è®¡ç†å¿µï¼š**
- æ”¯æŒå››å±‚èŠ‚ç‚¹æ¶æ„ä¸­çš„ç¬¬ 3 å±‚ï¼ˆnpm ç¤¾åŒºèŠ‚ç‚¹ï¼‰å’Œç¬¬ 4 å±‚ï¼ˆç”¨æˆ·ä¸Šä¼ èŠ‚ç‚¹ï¼‰
- å®ç°å¤šç§Ÿæˆ·éš”ç¦»ï¼šæ¯ä¸ªå·¥ä½œç©ºé—´ç‹¬ç«‹å®‰è£…å’Œç®¡ç†èŠ‚ç‚¹
- è‡ªåŠ¨å‡­è¯è½¬æ¢ï¼šnpm ç¤¾åŒºèŠ‚ç‚¹çš„ Credentials ç³»ç»Ÿè‡ªåŠ¨è½¬æ¢ä¸ºèŠ‚ç‚¹å‚æ•°
- å®‰å…¨æ²™ç®±ï¼šèŠ‚ç‚¹ä»£ç åœ¨ VM2 æ²™ç®±ä¸­æ‰§è¡Œï¼Œä¸æ±¡æŸ“æœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿ

```sql
CREATE TABLE custom_node (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- å…³è”ä¿¡æ¯
  workspace_id UUID NOT NULL,                  -- æ‰€å±å·¥ä½œç©ºé—´ï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰

  -- åŸºæœ¬ä¿¡æ¯
  node_key VARCHAR(100) NOT NULL,              -- èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ 'n8n-nodes-base.github'ï¼‰
  node_name VARCHAR(200) NOT NULL,             -- èŠ‚ç‚¹æ˜¾ç¤ºåç§°
  category VARCHAR(100),                       -- èŠ‚ç‚¹åˆ†ç±»
  description TEXT,                            -- èŠ‚ç‚¹æè¿°
  icon_url VARCHAR(500),                       -- èŠ‚ç‚¹å›¾æ ‡ URL
  version VARCHAR(50) DEFAULT '1.0.0',         -- èŠ‚ç‚¹ç‰ˆæœ¬

  -- èŠ‚ç‚¹æ¥æºï¼ˆå…³é”®å­—æ®µï¼‰
  node_source VARCHAR(50) NOT NULL,            -- 'npm_community' | 'user_upload'

  -- npm ç¤¾åŒºèŠ‚ç‚¹å­—æ®µï¼ˆä»… node_source = 'npm_community' æ—¶ä½¿ç”¨ï¼‰
  npm_package_name VARCHAR(200),               -- npm åŒ…åï¼ˆå¦‚ 'n8n-nodes-telegram'ï¼‰
  npm_version VARCHAR(50),                     -- npm ç‰ˆæœ¬å·ï¼ˆå¦‚ '1.2.3'ï¼‰
  npm_author VARCHAR(200),                     -- npm åŒ…ä½œè€…
  npm_download_url TEXT,                       -- npm åŒ…ä¸‹è½½ URL
  npm_registry VARCHAR(200) DEFAULT 'https://registry.npmjs.org',  -- npm æº

  -- èŠ‚ç‚¹å®šä¹‰å’Œä»£ç 
  node_definition JSONB NOT NULL,              -- å®Œæ•´çš„ INodeTypeDescription
  node_code TEXT NOT NULL,                     -- èŠ‚ç‚¹æ‰§è¡Œä»£ç ï¼ˆTypeScript/JavaScriptï¼‰

  -- å‡­è¯è½¬æ¢å­—æ®µï¼ˆä»… npm ç¤¾åŒºèŠ‚ç‚¹ï¼‰
  converted_from_credentials BOOLEAN DEFAULT false,  -- æ˜¯å¦ç»è¿‡å‡­è¯è½¬æ¢
  original_credentials JSONB,                  -- åŸå§‹å‡­è¯å®šä¹‰ï¼ˆç”¨äºè°ƒè¯•å’Œå›æº¯ï¼‰
  credential_mapping JSONB,                    -- å‡­è¯å­—æ®µæ˜ å°„å…³ç³»

  -- ä¾èµ–ä¿¡æ¯
  dependencies JSONB,                          -- èŠ‚ç‚¹ä¾èµ–çš„ npm åŒ…åˆ—è¡¨
  allowed_imports JSONB,                       -- ç™½åå•å…è®¸çš„ import æ¨¡å—

  -- å®‰å…¨é…ç½®
  sandbox_enabled BOOLEAN DEFAULT true,        -- æ˜¯å¦å¯ç”¨ VM2 æ²™ç®±
  sandbox_timeout INTEGER DEFAULT 30000,       -- æ²™ç®±è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  sandbox_memory_limit INTEGER DEFAULT 512,    -- æ²™ç®±å†…å­˜é™åˆ¶ï¼ˆMBï¼‰
  code_signature TEXT,                         -- ä»£ç ç­¾åï¼ˆSHA256ï¼‰

  -- é…ç½®æ¨¡å¼
  config_mode VARCHAR(20) DEFAULT 'personal',  -- 'personal' | 'shared'
  config_schema JSONB,                         -- é…ç½®é¡¹ Schema

  -- å›¢é˜Ÿå…±äº«é…ç½®ï¼ˆä»… shared æ¨¡å¼ï¼‰
  shared_config_data TEXT,                     -- åŠ å¯†å­˜å‚¨çš„å…±äº«é…ç½®
  shared_config_by UUID,                       -- å…±äº«é…ç½®è®¾ç½®äºº

  -- å¯è§æ€§ï¼ˆå›ºå®šå€¼ï¼‰
  visibility VARCHAR(50) DEFAULT 'workspace',  -- å§‹ç»ˆä¸º 'workspace'

  -- å®¡æ ¸æµç¨‹ï¼ˆå¯é€‰ï¼Œç”¨äºæäº¤åˆ°å¹³å°ï¼‰
  submission_status VARCHAR(50),               -- 'draft' | 'pending' | 'approved' | 'rejected'
  submitted_at TIMESTAMP,
  reviewed_by UUID,
  reviewed_at TIMESTAMP,
  review_notes TEXT,

  -- ä½¿ç”¨ç»Ÿè®¡
  install_count INTEGER DEFAULT 0,             -- å®‰è£…æ¬¡æ•°ï¼ˆä»…å·¥ä½œç©ºé—´å†…ï¼‰
  last_used_at TIMESTAMP,                      -- æœ€åä½¿ç”¨æ—¶é—´
  execution_count INTEGER DEFAULT 0,           -- æ‰§è¡Œæ¬¡æ•°

  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT true,              -- æ˜¯å¦æ¿€æ´»
  is_verified BOOLEAN DEFAULT false,           -- æ˜¯å¦é€šè¿‡éªŒè¯ï¼ˆnpm ç¤¾åŒºèŠ‚ç‚¹è‡ªåŠ¨ä¸º trueï¼‰

  -- å…ƒæ•°æ®
  metadata JSONB,                              -- å…¶ä»–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€æ–‡æ¡£é“¾æ¥ç­‰ï¼‰

  -- åˆ›å»ºä¿¡æ¯
  created_by UUID NOT NULL,                    -- åˆ›å»ºäºº
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- å¤–é”®
  FOREIGN KEY (workspace_id) REFERENCES project(id) ON DELETE CASCADE,
  FOREIGN KEY (created_by) REFERENCES user(id),
  FOREIGN KEY (shared_config_by) REFERENCES user(id),
  FOREIGN KEY (reviewed_by) REFERENCES user(id),

  -- å”¯ä¸€çº¦æŸï¼šå·¥ä½œç©ºé—´å†…èŠ‚ç‚¹ key å”¯ä¸€
  UNIQUE(workspace_id, node_key),

  -- æ£€æŸ¥çº¦æŸ
  CONSTRAINT check_node_source CHECK (node_source IN ('npm_community', 'user_upload')),
  CONSTRAINT check_npm_fields CHECK (
    (node_source = 'npm_community' AND npm_package_name IS NOT NULL AND npm_version IS NOT NULL) OR
    (node_source = 'user_upload' AND npm_package_name IS NULL)
  )
);

-- ç´¢å¼•
CREATE INDEX idx_custom_node_workspace ON custom_node(workspace_id);
CREATE INDEX idx_custom_node_source ON custom_node(node_source);
CREATE INDEX idx_custom_node_status ON custom_node(submission_status);
CREATE INDEX idx_custom_node_npm_package ON custom_node(npm_package_name) WHERE node_source = 'npm_community';
CREATE INDEX idx_custom_node_active ON custom_node(is_active);
CREATE INDEX idx_custom_node_created_by ON custom_node(created_by);
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µç»„ | å­—æ®µ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|--------|------|------|---------|
| **èŠ‚ç‚¹æ¥æº** | `node_source` | åŒºåˆ† npm ç¤¾åŒºèŠ‚ç‚¹å’Œç”¨æˆ·ä¸Šä¼ èŠ‚ç‚¹ | æ‰€æœ‰ |
| **npm ä¿¡æ¯** | `npm_package_name` | npm åŒ…å | npm ç¤¾åŒºèŠ‚ç‚¹ |
| | `npm_version` | npm ç‰ˆæœ¬ | npm ç¤¾åŒºèŠ‚ç‚¹ |
| **å‡­è¯è½¬æ¢** | `converted_from_credentials` | æ˜¯å¦ç»è¿‡è‡ªåŠ¨å‡­è¯è½¬æ¢ | npm ç¤¾åŒºèŠ‚ç‚¹ |
| | `original_credentials` | åŸå§‹å‡­è¯å®šä¹‰ï¼ˆJSONï¼‰ | npm ç¤¾åŒºèŠ‚ç‚¹ |
| | `credential_mapping` | å‡­è¯åˆ°å‚æ•°çš„æ˜ å°„å…³ç³» | npm ç¤¾åŒºèŠ‚ç‚¹ |
| **å®‰å…¨** | `sandbox_enabled` | æ˜¯å¦å¯ç”¨ VM2 æ²™ç®± | æ‰€æœ‰ |
| | `sandbox_timeout` | æ²™ç®±è¶…æ—¶ï¼ˆé»˜è®¤ 30sï¼‰ | æ‰€æœ‰ |
| | `code_signature` | ä»£ç ç­¾åï¼ˆé˜²ç¯¡æ”¹ï¼‰ | æ‰€æœ‰ |
| **ä¾èµ–** | `dependencies` | npm ä¾èµ–åˆ—è¡¨ | npm ç¤¾åŒºèŠ‚ç‚¹ |
| | `allowed_imports` | ç™½åå•æ¨¡å— | æ‰€æœ‰ |

**credential_mapping ç»“æ„ç¤ºä¾‹ï¼š**

```json
{
  "githubApi": {
    "originalCredentialType": "githubApi",
    "convertedToParameter": "authentication",
    "fields": {
      "accessToken": "authentication.token",
      "server": "authentication.server",
      "domain": "authentication.domain"
    }
  }
}
```

**dependencies ç»“æ„ç¤ºä¾‹ï¼š**

```json
{
  "n8n-workflow": "^1.0.0",
  "n8n-core": "^1.0.0",
  "axios": "^1.6.0"
}
```

### 4. user_node_configï¼ˆç”¨æˆ·èŠ‚ç‚¹é…ç½®ï¼‰

**ç”¨é€”ï¼š** å­˜å‚¨ç”¨æˆ·çº§åˆ«çš„èŠ‚ç‚¹å‚æ•°é…ç½®ï¼Œæ›¿ä»£ credentials_entity

```sql
CREATE TABLE user_node_config (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- å…³è”ä¿¡æ¯
  user_id UUID NOT NULL,
  workspace_id UUID NOT NULL,
  node_type VARCHAR(100) NOT NULL,        -- èŠ‚ç‚¹ç±»å‹ï¼ˆå¦‚ 'github', 'slack'ï¼‰
  config_name VARCHAR(200),               -- ç”¨æˆ·è‡ªå®šä¹‰åç§°ï¼ˆå¦‚ "æˆ‘çš„ GitHub Token"ï¼‰

  -- é…ç½®æ•°æ®ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
  config_data TEXT NOT NULL,

  -- å…ƒæ•°æ®
  last_used_at TIMESTAMP,
  use_count INTEGER DEFAULT 0,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- å¤–é”®
  FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE,
  FOREIGN KEY (workspace_id) REFERENCES project(id) ON DELETE CASCADE
);

CREATE INDEX idx_user_node_config_user ON user_node_config(user_id);
CREATE INDEX idx_user_node_config_workspace ON user_node_config(workspace_id);
CREATE INDEX idx_user_node_config_type ON user_node_config(node_type);
```

### å…³é”®è®¾è®¡å†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ | ç†ç”± |
|--------|------|------|
| **AI æä¾›å•†** | ä½¿ç”¨ provider_key ä½œä¸ºä¸»é”® | ç®€åŒ– URL è·¯ç”±ï¼ˆ/platform-ai-providers/{key}ï¼‰ |
| **æ¨¡å‹å­˜å‚¨** | models_config (JSONB) | çµæ´»ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ æ¨¡å‹ |
| **èŠ‚ç‚¹ç±»å‹å­—æ®µ** | platform_node.node_type | åŒºåˆ†å¹³å°å®˜æ–¹å’Œç¬¬ä¸‰æ–¹ |
| **è‡ªå®šä¹‰èŠ‚ç‚¹æ¥æº** | custom_node.node_source | åŒºåˆ† npm ç¤¾åŒºèŠ‚ç‚¹å’Œç”¨æˆ·ä¸Šä¼ èŠ‚ç‚¹ |
| **è‡ªå®šä¹‰èŠ‚ç‚¹å”¯ä¸€æ€§** | UNIQUE(workspace_id, node_key) | å·¥ä½œç©ºé—´å†…ä¸èƒ½é‡å¤ |
| **npm ç¤¾åŒºèŠ‚ç‚¹å­˜å‚¨** | å­˜å‚¨åœ¨ custom_node è¡¨ï¼ˆéæ–‡ä»¶ç³»ç»Ÿï¼‰ | å¤šç§Ÿæˆ·éš”ç¦»ã€å®‰å…¨æ²™ç®±ã€ä¸æ±¡æŸ“æœåŠ¡å™¨ |
| **å‡­è¯è½¬æ¢** | è‡ªåŠ¨è½¬æ¢ä¸ºèŠ‚ç‚¹å‚æ•° | npm ç¤¾åŒºèŠ‚ç‚¹å…¼å®¹æ€§ï¼ŒåºŸå¼ƒ Credentials ç³»ç»Ÿ |
| **é…ç½®éš”ç¦»** | user_node_config.user_id | ç”¨æˆ·çº§åˆ«éš”ç¦»ï¼Œæ›´å®‰å…¨ |
| **åˆ é™¤ credentials** | âŒ å®Œå…¨åˆ é™¤ | ç®€åŒ–æ¶æ„ï¼Œç”¨ user_node_config æ›¿ä»£ |

---

### âš ï¸ å·²åºŸå¼ƒçš„è¡¨

ä»¥ä¸‹è¡¨åœ¨æ–°æ¶æ„ä¸­å·²è¢«åºŸå¼ƒï¼Œéœ€è¦è¿›è¡Œæ•°æ®è¿ç§»å’Œåˆ é™¤ï¼š

#### 1. installed_packages

**åŸç”¨é€”ï¼š** å­˜å‚¨ç”¨æˆ·å®‰è£…çš„ npm ç¤¾åŒºåŒ…ï¼ˆå¦‚ `n8n-nodes-telegram`ï¼‰

**åºŸå¼ƒåŸå› ï¼š**
- åŸæœ‰è®¾è®¡å°† npm åŒ…å®‰è£…åˆ°æœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿï¼ˆ`node_modules`ï¼‰
- åœ¨å¤šç§Ÿæˆ· SaaS æ¶æ„ä¸‹å­˜åœ¨å®‰å…¨é£é™©
- æ— æ³•å®ç°å·¥ä½œç©ºé—´çº§åˆ«éš”ç¦»

**æ›¿ä»£æ–¹æ¡ˆï¼š** ä½¿ç”¨ `custom_node` è¡¨ï¼Œè®¾ç½® `node_source = 'npm_community'`

**è¿ç§»ç­–ç•¥ï¼š**
```sql
-- å°† installed_packages è¿ç§»åˆ° custom_node
INSERT INTO custom_node (
  workspace_id,
  node_key,
  node_name,
  node_source,
  npm_package_name,
  npm_version,
  node_definition,
  node_code,
  created_by,
  created_at
)
SELECT
  p.id AS workspace_id,  -- å‡è®¾è¿ç§»åˆ°é»˜è®¤å·¥ä½œç©ºé—´
  ip.packageName AS node_key,
  ip.packageName AS node_name,
  'npm_community' AS node_source,
  ip.packageName AS npm_package_name,
  ip.installedVersion AS npm_version,
  '{}' AS node_definition,  -- éœ€è¦é‡æ–°ä» npm æå–
  '' AS node_code,  -- éœ€è¦é‡æ–°ä» npm æå–
  ip.installedBy AS created_by,
  ip.installedAt AS created_at
FROM installed_packages ip
CROSS JOIN project p
WHERE p.type = 'personal'  -- æˆ–æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©å·¥ä½œç©ºé—´
LIMIT 1;
```

#### 2. installed_nodes

**åŸç”¨é€”ï¼š** å­˜å‚¨å·²å®‰è£…åŒ…ä¸­çš„å…·ä½“èŠ‚ç‚¹ä¿¡æ¯

**åºŸå¼ƒåŸå› ï¼š**
- ä¸ `installed_packages` ç»‘å®šï¼ŒåŒ…è¢«åºŸå¼ƒåæ­¤è¡¨ä¹Ÿæ— æ„ä¹‰
- æ–°æ¶æ„ä¸­èŠ‚ç‚¹ç›´æ¥å­˜å‚¨åœ¨ `custom_node` è¡¨

**æ›¿ä»£æ–¹æ¡ˆï¼š** ä½¿ç”¨ `custom_node` è¡¨

**è¿ç§»ç­–ç•¥ï¼š**
```sql
-- installed_nodes æ•°æ®å·²åŒ…å«åœ¨ custom_node çš„ node_definition ä¸­
-- å¯ç›´æ¥åˆ é™¤ï¼Œæ— éœ€è¿ç§»
DROP TABLE IF EXISTS installed_nodes;
```

#### 3. credentials_entity

**åŸç”¨é€”ï¼š** å­˜å‚¨ç”¨æˆ·çš„å‡­è¯ä¿¡æ¯ï¼ˆAPI Keysã€Tokens ç­‰ï¼‰

**åºŸå¼ƒåŸå› ï¼š**
- æ–°æ¶æ„åºŸå¼ƒ Credentials ç³»ç»Ÿ
- å‡­è¯ä¿¡æ¯ç›´æ¥å­˜å‚¨åœ¨èŠ‚ç‚¹å‚æ•°ä¸­ï¼ˆ`user_node_config`ï¼‰

**æ›¿ä»£æ–¹æ¡ˆï¼š** ä½¿ç”¨ `user_node_config` è¡¨

**è¿ç§»ç­–ç•¥ï¼š**
```sql
-- å°† credentials_entity è¿ç§»åˆ° user_node_config
INSERT INTO user_node_config (
  user_id,
  workspace_id,
  node_type,
  config_name,
  config_data,
  created_at
)
SELECT
  c.userId AS user_id,
  u.globalRoleId AS workspace_id,  -- æ ¹æ®å®é™…é€»è¾‘æ˜ å°„å·¥ä½œç©ºé—´
  c.type AS node_type,
  c.name AS config_name,
  c.data AS config_data,  -- å·²åŠ å¯†çš„æ•°æ®ç›´æ¥è¿ç§»
  c.createdAt AS created_at
FROM credentials_entity c
JOIN user u ON c.userId = u.id;
```

**åˆ é™¤æ­¥éª¤ï¼š**

1. **å¤‡ä»½æ•°æ®**
   ```bash
   pg_dump -t installed_packages -t installed_nodes -t credentials_entity > deprecated_tables_backup.sql
   ```

2. **æ‰§è¡Œè¿ç§»è„šæœ¬**ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰

3. **éªŒè¯æ•°æ®å®Œæ•´æ€§**
   ```sql
   -- éªŒè¯è¿ç§»åçš„è®°å½•æ•°
   SELECT COUNT(*) FROM custom_node WHERE node_source = 'npm_community';
   SELECT COUNT(*) FROM user_node_config;
   ```

4. **åˆ é™¤åºŸå¼ƒè¡¨**
   ```sql
   DROP TABLE IF EXISTS installed_nodes;
   DROP TABLE IF EXISTS installed_packages;
   DROP TABLE IF EXISTS credentials_entity;
   ```

---

### ğŸ”— è¡¨å…³ç³»å›¾

```
project (workspace)
    |
    +-- custom_node (1:N)
    |       |
    |       +-- node_source = 'npm_community'  (ä» npm å®‰è£…)
    |       +-- node_source = 'user_upload'    (ç”¨æˆ·ä¸Šä¼ )
    |
    +-- user_node_config (1:N)
    |       |
    |       +-- config_data (åŠ å¯†å­˜å‚¨çš„èŠ‚ç‚¹é…ç½®)
    |
    +-- platform_node (å…¨å±€å…±äº«)
            |
            +-- node_type = 'platform_official'
            +-- node_type = 'third_party_approved'

user
    |
    +-- custom_node.created_by (1:N)
    +-- user_node_config.user_id (1:N)

platform_ai_provider (å…¨å±€å…±äº«)
    |
    +-- models_config (JSONB æ•°ç»„)
```

---


[â† ä¸Šä¸€ç« ï¼šæ¶æ„æ€»è§ˆ](./02-æ¶æ„æ€»è§ˆ.md) | [è¿”å›æ€»è§ˆ](../00-æ€»è§ˆä¸å¯¼èˆª.md) | [ä¸‹ä¸€ç« ï¼šèŠ‚ç‚¹æ¶æ„ â†’](./04-èŠ‚ç‚¹æ¶æ„.md)
