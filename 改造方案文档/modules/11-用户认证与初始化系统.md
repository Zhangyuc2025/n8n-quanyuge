# ç”¨æˆ·è®¤è¯ä¸åˆå§‹åŒ–ç³»ç»Ÿæ”¹é€ æ–¹æ¡ˆ

> **ç‰ˆæœ¬ï¼š** v1.0
> **çŠ¶æ€ï¼š** å¾…å®æ–½
> **ä¼˜å…ˆçº§ï¼š** P0ï¼ˆé˜»å¡ä¸Šçº¿ï¼‰
> **åŸºäºï¼š** å½“å‰é¡¹ç›® 73% å®Œæˆåº¦
> **åˆ›å»ºæ—¥æœŸï¼š** 2025-01-10

[â† è¿”å›æ€»è§ˆ](../00-æ€»è§ˆä¸å¯¼èˆª.md)

---

## ğŸ“‹ èƒŒæ™¯ä¸é—®é¢˜

### å½“å‰é¡¹ç›®çŠ¶æ€

**å·²å®Œæˆï¼ˆ73%ï¼‰ï¼š**
- âœ… æ•°æ®åº“å¤šç§Ÿæˆ·æ¶æ„ï¼ˆProjectã€WorkspaceBalanceã€UsageRecord ç­‰è¡¨ï¼‰
- âœ… å‡­è¯ç³»ç»Ÿå·²ç§»é™¤
- âœ… å·¥ä½œç©ºé—´éš”ç¦»æœºåˆ¶ï¼ˆ@ProjectScope è£…é¥°å™¨ï¼‰
- âœ… è®¡è´¹ç³»ç»ŸåŸºç¡€ï¼ˆWorkspaceBalance è¡¨ã€æ‰£è´¹é€»è¾‘ï¼‰
- âœ… Userã€Projectã€ProjectRelation å…³ç³»å·²å»ºç«‹

**å­˜åœ¨çš„æ ¸å¿ƒé—®é¢˜ï¼š**
- âŒ åˆå§‹åŒ–é€»è¾‘ä»æ˜¯å•ç§Ÿæˆ·æ¨¡å¼ï¼ˆ`/owner/setup` åªèƒ½è®¾ç½®ä¸€æ¬¡å…¨å±€ Ownerï¼‰
- âŒ æ²¡æœ‰å¹³å°ç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·çš„åŒºåˆ†
- âŒ ç”¨æˆ·æ³¨å†Œåæœªè‡ªåŠ¨åˆ›å»ºä¸ªäººå·¥ä½œç©ºé—´
- âŒ ç¼ºå°‘ä¼šå‘˜ç­‰çº§ä½“ç³»
- âŒ å›¢é˜Ÿå·¥ä½œç©ºé—´çš„æ‰£è´¹æ¨¡å¼æœªå®ç°

### æ”¹é€ ç›®æ ‡

å°†å•ç§Ÿæˆ·åˆå§‹åŒ–é€»è¾‘æ”¹é€ ä¸º**å¹³å°å‹ SaaS å¤šç§Ÿæˆ·åˆå§‹åŒ–ç³»ç»Ÿ**ï¼š

1. **ä¸¤å¥—è´¦å·ä½“ç³»**ï¼šå¹³å°ç®¡ç†å‘˜ vs å¹³å°ç”¨æˆ·ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰
2. **é¦–æ¬¡å¯åŠ¨æµç¨‹**ï¼šç®¡ç†å‘˜åå°åˆå§‹åŒ– â†’ ç”¨æˆ·ç«¯å¼€æ”¾æ³¨å†Œ
3. **è‡ªåŠ¨åŒ–æ³¨å†Œ**ï¼šç”¨æˆ·æ³¨å†Œ â†’ è‡ªåŠ¨åˆ›å»ºä¸ªäººå·¥ä½œç©ºé—´ + åˆå§‹ä½™é¢
4. **ä¼šå‘˜ä½“ç³»**ï¼šç»‘å®šåˆ°ç”¨æˆ·è´¦å·ï¼Œå½±å“å›¢é˜Ÿåˆ›å»ºæ•°é‡å’Œæˆå‘˜ä¸Šé™
5. **çµæ´»è®¡è´¹**ï¼šå›¢é˜Ÿå·¥ä½œç©ºé—´æ”¯æŒä¸¤ç§æ‰£è´¹æ¨¡å¼

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. ä¸¤å¥—è´¦å·ä½“ç³»

#### 1.1 å¹³å°ç®¡ç†å‘˜ï¼ˆPlatformAdminï¼‰

**ç”¨é€”ï¼š** ç®¡ç†æ•´ä¸ªå¹³å°çš„é…ç½®å’Œè¿è¥

**ç‰¹å¾ï¼š**
- å•ç‹¬çš„æ•°æ®è¡¨å’Œè®¤è¯ä½“ç³»
- å•ç‹¬çš„ç™»å½•å…¥å£ï¼ˆ`/admin/login`ï¼‰
- æ‹¥æœ‰è¶…çº§æƒé™ï¼ˆç®¡ç† AI Providerã€å¹³å°èŠ‚ç‚¹ã€ç”¨æˆ·è´¦å·ç­‰ï¼‰
- ä¸èƒ½ç›´æ¥è®¿é—®ç”¨æˆ·å·¥ä½œç©ºé—´å†…å®¹ï¼ˆæ•°æ®éš”ç¦»ï¼‰

**æ•°æ®åº“è®¾è®¡ï¼š**

```sql
CREATE TABLE platform_admin (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  name VARCHAR(100) NOT NULL,
  role VARCHAR(50) NOT NULL DEFAULT 'admin',  -- 'super_admin' | 'admin'
  is_active BOOLEAN NOT NULL DEFAULT true,
  last_login_at TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_platform_admin_email ON platform_admin(email);
```

#### 1.2 å¹³å°ç”¨æˆ·ï¼ˆUserï¼‰

**ç”¨é€”ï¼š** æ™®é€šç”¨æˆ·ï¼Œä½¿ç”¨å¹³å°åŠŸèƒ½

**ç‰¹å¾ï¼š**
- ä½¿ç”¨ç°æœ‰ User è¡¨
- ç”¨æˆ·ç™»å½•å…¥å£ï¼ˆ`/login`ï¼‰
- æ‹¥æœ‰è‡ªå·±çš„å·¥ä½œç©ºé—´å’Œæ•°æ®
- ä¼šå‘˜ç­‰çº§å½±å“ä½¿ç”¨é…é¢

**æ•°æ®åº“æ‰©å±•ï¼š**

```sql
-- æ‰©å±•ç°æœ‰ user è¡¨
ALTER TABLE "user"
  ADD COLUMN balance DECIMAL(10, 4) DEFAULT 0.0 COMMENT 'ä¸ªäººä½™é¢ï¼ˆäººæ°‘å¸ï¼‰',
  ADD COLUMN membership_tier VARCHAR(20) DEFAULT 'free'
    COMMENT 'ä¼šå‘˜ç­‰çº§: free, basic, pro, enterprise',
  ADD COLUMN membership_expire_at TIMESTAMP
    COMMENT 'ä¼šå‘˜è¿‡æœŸæ—¶é—´';

-- ç´¢å¼•
CREATE INDEX idx_user_membership ON "user"(membership_tier);
```

### 2. ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹

#### 2.1 é¦–æ¬¡å¯åŠ¨æ£€æµ‹

**ç³»ç»ŸçŠ¶æ€è¡¨ï¼š**

```sql
CREATE TABLE system_config (
  key VARCHAR(100) PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- åˆå§‹åŒ–æ ‡è®°
INSERT INTO system_config (key, value)
VALUES ('platform_initialized', 'false');
```

**æ£€æµ‹é€»è¾‘ï¼š**

```typescript
// packages/cli/src/services/system-init.service.ts
@Service()
export class SystemInitService {
  async isPlatformInitialized(): Promise<boolean> {
    const config = await this.systemConfigRepository.findOne({
      where: { key: 'platform_initialized' }
    });
    return config?.value === 'true';
  }

  async setPlatformInitialized(): Promise<void> {
    await this.systemConfigRepository.upsert({
      key: 'platform_initialized',
      value: 'true',
      updated_at: new Date()
    });
  }
}
```

#### 2.2 åˆå§‹åŒ–æµç¨‹å›¾

```mermaid
graph TD
    A[ç³»ç»Ÿé¦–æ¬¡å¯åŠ¨] --> B{æ£€æµ‹ platform_initialized}
    B -->|false| C[ç”¨æˆ·ç«¯æ˜¾ç¤º: å¹³å°æœªå¯åŠ¨]
    B -->|true| D[ç”¨æˆ·ç«¯æ­£å¸¸è®¿é—®]

    C --> E[ç®¡ç†å‘˜è®¿é—® /admin/setup]
    E --> F[æ˜¾ç¤ºåˆå§‹åŒ–å‘å¯¼]
    F --> G[å¡«å†™è¶…çº§ç®¡ç†å‘˜ä¿¡æ¯]
    G --> H[åˆ›å»º PlatformAdmin è®°å½•]
    H --> I[è®¾ç½® platform_initialized = true]
    I --> J[åˆå§‹åŒ–å¹³å°é…ç½®<br/>AI Provider, ç³»ç»Ÿé…ç½®ç­‰]
    J --> K[åˆå§‹åŒ–å®Œæˆ]
    K --> D
```

#### 2.3 ç”¨æˆ·ç«¯å¯åŠ¨é¡µé¢

**è·¯ç”±å®ˆå«ï¼š**

```typescript
// packages/frontend/editor-ui/src/router/index.ts
router.beforeEach(async (to, from, next) => {
  const systemStore = useSystemStore();

  // æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦åˆå§‹åŒ–
  if (!systemStore.initialized) {
    await systemStore.checkInitialization();
  }

  // å¦‚æœç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œä¸”ä¸æ˜¯ç®¡ç†å‘˜è·¯ç”±
  if (!systemStore.initialized && !to.path.startsWith('/admin')) {
    next('/platform-not-ready');
    return;
  }

  next();
});
```

**æœªåˆå§‹åŒ–é¡µé¢ï¼š**

```vue
<!-- packages/frontend/editor-ui/src/views/PlatformNotReady.vue -->
<template>
  <div class="platform-not-ready">
    <n8n-icon icon="lock" size="xlarge" />
    <h1>{{ $t('platformNotReady.title') }}</h1>
    <p>{{ $t('platformNotReady.description') }}</p>
    <n8n-text size="small" color="text-light">
      {{ $t('platformNotReady.contactAdmin') }}
    </n8n-text>
  </div>
</template>
```

### 3. ç”¨æˆ·æ³¨å†Œæµç¨‹

#### 3.1 æ³¨å†Œè‡ªåŠ¨åŒ–æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·æäº¤æ³¨å†Œè¡¨å•] --> B[åˆ›å»º User è®°å½•]
    B --> C[åˆ›å»º Personal Project]
    C --> D[åˆ›å»º ProjectRelation<br/>role: project:admin]
    D --> E[åˆ›å»º WorkspaceBalance<br/>åˆå§‹ä½™é¢å¯é…ç½®]
    E --> F[å‘é€æ¬¢è¿é‚®ä»¶]
    F --> G[è‡ªåŠ¨ç™»å½•]
    G --> H[è¿›å…¥ä¸ªäººå·¥ä½œç©ºé—´]
```

#### 3.2 æ³¨å†Œæ¥å£å®ç°

**Controllerï¼š**

```typescript
// packages/cli/src/controllers/auth.controller.ts
@RestController()
export class AuthController {
  constructor(
    private readonly authService: AuthService,
    private readonly userOnboardingService: UserOnboardingService,
  ) {}

  @Post('/register', { skipAuth: true })
  async register(
    req: AuthlessRequest,
    res: Response,
    @Body payload: UserRegisterDto,
  ): Promise<PublicUser> {
    const { email, password, firstName, lastName } = payload;

    // 1. åˆ›å»ºç”¨æˆ·è´¦å·
    const user = await this.authService.createUser({
      email,
      password,
      firstName,
      lastName,
      membershipTier: 'free',  // é»˜è®¤å…è´¹ä¼šå‘˜
      balance: 100.0,  // åˆå§‹ä½™é¢ 100 å…ƒï¼ˆå¯é…ç½®ï¼‰
    });

    // 2. è‡ªåŠ¨åˆ›å»ºä¸ªäººå·¥ä½œç©ºé—´
    await this.userOnboardingService.setupPersonalWorkspace(user);

    // 3. å‘æ”¾ç™»å½• Cookie
    this.authService.issueCookie(res, user, false, req.browserId);

    // 4. å‘é€æ¬¢è¿é‚®ä»¶
    await this.mailer.sendWelcomeEmail(user);

    return await this.userService.toPublic(user, { withScopes: true });
  }
}
```

**Serviceï¼š**

```typescript
// packages/cli/src/services/user-onboarding.service.ts
@Service()
export class UserOnboardingService {
  constructor(
    private readonly projectRepository: ProjectRepository,
    private readonly projectRelationRepository: ProjectRelationRepository,
    private readonly workspaceBalanceRepository: WorkspaceBalanceRepository,
    private readonly logger: Logger,
  ) {}

  async setupPersonalWorkspace(user: User): Promise<Project> {
    return await this.projectRepository.manager.transaction(async (em) => {
      // 1. åˆ›å»ºä¸ªäººå·¥ä½œç©ºé—´
      const personalProject = em.create(Project, {
        id: uuidv4(),
        name: `${user.firstName}'s Workspace`,
        type: 'personal',
        icon: { type: 'emoji', value: 'ğŸ ' },
        description: 'Personal workspace',
      });
      await em.save(personalProject);

      // 2. å…³è”ç”¨æˆ·ï¼ˆOwner è§’è‰²ï¼‰
      const relation = em.create(ProjectRelation, {
        userId: user.id,
        projectId: personalProject.id,
        role: 'project:admin',  // ä¸ªäººç©ºé—´çš„ Owner
      });
      await em.save(relation);

      // 3. åˆå§‹åŒ–å·¥ä½œç©ºé—´ä½™é¢ï¼ˆæš‚æ—¶ä¸ç”¨ï¼Œä½™é¢åœ¨ç”¨æˆ·è´¦å·ä¸Šï¼‰
      // æœªæ¥å¦‚æœéœ€è¦å·¥ä½œç©ºé—´ç‹¬ç«‹ä½™é¢ï¼Œå¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–

      this.logger.info(`Personal workspace created for user ${user.id}`);

      return personalProject;
    });
  }
}
```

### 4. ä½™é¢å’Œè®¡è´¹ä½“ç³»

#### 4.1 åŒå±‚ä½™é¢æ¶æ„

**è®¾è®¡åŸåˆ™ï¼š**
- ç”¨æˆ·ä½™é¢ï¼šå­˜åœ¨ `user.balance`ï¼Œå……å€¼åˆ°è¿™é‡Œ
- å·¥ä½œç©ºé—´å…±äº«ä½™é¢æ± ï¼šå­˜åœ¨ `workspace_balance.balance`ï¼Œåªç”¨äºå›¢é˜Ÿå…±äº«æ¨¡å¼

**æ•°æ®ç»“æ„ï¼š**

```typescript
// User è¡¨ï¼ˆå·²æ‰©å±•ï¼‰
interface User {
  balance: number;  // ä¸ªäººä½™é¢ï¼ˆCNYï¼‰
  membershipTier: 'free' | 'basic' | 'pro' | 'enterprise';
  membershipExpireAt?: Date;
}

// WorkspaceBalance è¡¨ï¼ˆç°æœ‰ï¼‰
interface WorkspaceBalance {
  workspaceId: string;
  balanceCny: number;  // å›¢é˜Ÿå…±äº«ä½™é¢æ± ï¼ˆCNYï¼‰
  lowBalanceThresholdCny: number;
  currency: string;
}

// Project è¡¨ï¼ˆéœ€æ‰©å±•ï¼‰
interface Project {
  type: 'personal' | 'team';
  billingMode: 'executor' | 'shared-pool';  // æ–°å¢å­—æ®µ
}
```

#### 4.2 æ‰£è´¹æ¨¡å¼

**Personal Projectï¼š**
- å›ºå®š `billingMode = 'executor'`
- æ‰£è´¹æ¥æºï¼š`user.balance`

**Team Projectï¼š**

| æ‰£è´¹æ¨¡å¼ | è¯´æ˜ | æ‰£è´¹æ¥æº |
|---------|------|---------|
| `executor` | è°æ‰§è¡Œæ‰£è°çš„ä½™é¢ | æ‰§è¡Œè€…çš„ `user.balance` |
| `shared-pool` | å›¢é˜Ÿå…±äº«ä½™é¢æ±  | `workspace_balance.balance` |

**åˆ›å»ºå›¢é˜Ÿæ—¶é€‰æ‹©ï¼š**

```typescript
@Post('/projects')
async createTeamWorkspace(
  req: AuthenticatedRequest,
  @Body payload: CreateTeamProjectDto,
) {
  const { name, billingMode } = payload;  // billingMode: 'executor' | 'shared-pool'

  const project = await this.projectService.createTeamWorkspace({
    name,
    type: 'team',
    billingMode,
    ownerId: req.user.id,
  });

  // å¦‚æœæ˜¯ shared-pool æ¨¡å¼ï¼Œåˆå§‹åŒ– WorkspaceBalance
  if (billingMode === 'shared-pool') {
    await this.workspaceBalanceRepository.save({
      workspaceId: project.id,
      balanceCny: 0.0,
      lowBalanceThresholdCny: 10.0,
      currency: 'CNY',
    });
  }

  return project;
}
```

**æ‰£è´¹é€»è¾‘ï¼š**

```typescript
// packages/cli/src/services/billing.service.ts
@Service()
export class BillingService {
  async deductBalance(params: {
    workspaceId: string;
    executorUserId: string;
    amount: number;
    serviceKey: string;
    metadata?: Record<string, any>;
  }): Promise<void> {
    const { workspaceId, executorUserId, amount, serviceKey, metadata } = params;

    // 1. è·å–å·¥ä½œç©ºé—´ä¿¡æ¯
    const project = await this.projectRepository.findOneOrFail({
      where: { id: workspaceId },
    });

    let balanceSource: 'user' | 'workspace';
    let newBalance: number;

    // 2. æ ¹æ®æ‰£è´¹æ¨¡å¼å†³å®šæ‰£è´¹æ¥æº
    if (project.type === 'personal' || project.billingMode === 'executor') {
      // æ‰£æ‰§è¡Œè€…çš„ä½™é¢
      const user = await this.userRepository.findOneOrFail({
        where: { id: executorUserId },
      });

      if (user.balance < amount) {
        throw new OperationalError('ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼');
      }

      newBalance = user.balance - amount;
      await this.userRepository.update(
        { id: executorUserId },
        { balance: newBalance }
      );
      balanceSource = 'user';
    } else {
      // æ‰£å·¥ä½œç©ºé—´å…±äº«ä½™é¢æ± 
      const wsBalance = await this.workspaceBalanceRepository.findOneOrFail({
        where: { workspaceId },
      });

      if (wsBalance.balanceCny < amount) {
        throw new OperationalError('å›¢é˜Ÿä½™é¢ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å……å€¼');
      }

      newBalance = wsBalance.balanceCny - amount;
      await this.workspaceBalanceRepository.update(
        { workspaceId },
        { balanceCny: newBalance }
      );
      balanceSource = 'workspace';
    }

    // 3. è®°å½•ä½¿ç”¨è®°å½•
    await this.usageRecordRepository.save({
      workspaceId,
      userId: executorUserId,
      serviceKey,
      amount,
      balanceAfter: newBalance,
      balanceSource,
      metadata,
      createdAt: new Date(),
    });
  }
}
```

#### 4.3 å›¢é˜Ÿå…±äº«ä½™é¢æ± å……å€¼

**å……å€¼æ¥å£ï¼š**

```typescript
@Post('/workspaces/:id/balance/transfer')
async transferToWorkspace(
  req: AuthenticatedRequest,
  @Param('id') workspaceId: string,
  @Body payload: { amount: number },
): Promise<{ success: boolean }> {
  const { amount } = payload;
  const userId = req.user.id;

  // 1. éªŒè¯æƒé™ï¼ˆåªæœ‰ Owner å’Œ Admin å¯ä»¥å……å€¼ï¼‰
  await this.projectService.validateAccess(userId, workspaceId, ['project:admin']);

  // 2. éªŒè¯å·¥ä½œç©ºé—´æ˜¯ shared-pool æ¨¡å¼
  const project = await this.projectRepository.findOneOrFail({
    where: { id: workspaceId },
  });

  if (project.billingMode !== 'shared-pool') {
    throw new BadRequestError('è¯¥å·¥ä½œç©ºé—´ä¸æ”¯æŒå…±äº«ä½™é¢æ± ');
  }

  // 3. ä»ç”¨æˆ·ä½™é¢è½¬å…¥å·¥ä½œç©ºé—´ä½™é¢æ± 
  await this.projectRepository.manager.transaction(async (em) => {
    // æ‰£é™¤ç”¨æˆ·ä½™é¢
    const user = await em.findOneOrFail(User, { where: { id: userId } });
    if (user.balance < amount) {
      throw new OperationalError('ä¸ªäººä½™é¢ä¸è¶³');
    }
    user.balance -= amount;
    await em.save(user);

    // å¢åŠ å·¥ä½œç©ºé—´ä½™é¢
    const wsBalance = await em.findOneOrFail(WorkspaceBalance, {
      where: { workspaceId },
    });
    wsBalance.balanceCny += amount;
    await em.save(wsBalance);

    // è®°å½•è½¬è´¦
    await em.save(em.create(BalanceTransferRecord, {
      fromUserId: userId,
      toWorkspaceId: workspaceId,
      amount,
      createdAt: new Date(),
    }));
  });

  return { success: true };
}
```

### 5. ä¼šå‘˜ç­‰çº§ä½“ç³»

#### 5.1 ä¼šå‘˜ç­‰çº§å®šä¹‰

**ç»‘å®šåˆ°ç”¨æˆ·è´¦å·ï¼š**

| ç­‰çº§ | å¯åˆ›å»ºå›¢é˜Ÿæ•° | å›¢é˜Ÿæˆå‘˜ä¸Šé™ | ä¸ªäººç©ºé—´ç‰¹æƒ | æœˆè´¹ |
|------|------------|-------------|-------------|------|
| Free | 1 ä¸ª | 5 äºº | åŸºç¡€åŠŸèƒ½ | å…è´¹ |
| Basic | 3 ä¸ª | 20 äºº | + ä¼˜å…ˆé˜Ÿåˆ— | Â¥99/æœˆ |
| Pro | 10 ä¸ª | 50 äºº | + æ— é™æ‰§è¡Œ | Â¥299/æœˆ |
| Enterprise | æ— é™ | æ— é™ | + ä¸“å±æ”¯æŒ | å®šåˆ¶ |

#### 5.2 æƒç›Šåˆ¤æ–­é€»è¾‘

```typescript
// packages/cli/src/services/membership.service.ts
@Service()
export class MembershipService {
  getMembershipLimits(tier: MembershipTier): MembershipLimits {
    const limits = {
      free: {
        maxTeams: 1,
        maxTeamMembers: 5,
        monthlyExecutions: 1000,
      },
      basic: {
        maxTeams: 3,
        maxTeamMembers: 20,
        monthlyExecutions: 10000,
      },
      pro: {
        maxTeams: 10,
        maxTeamMembers: 50,
        monthlyExecutions: -1,  // æ— é™
      },
      enterprise: {
        maxTeams: -1,  // æ— é™
        maxTeamMembers: -1,  // æ— é™
        monthlyExecutions: -1,  // æ— é™
      },
    };

    return limits[tier];
  }

  async canCreateTeam(userId: string): Promise<boolean> {
    const user = await this.userRepository.findOneOrFail({
      where: { id: userId },
    });

    const limits = this.getMembershipLimits(user.membershipTier);

    // æ— é™åˆ¶
    if (limits.maxTeams === -1) return true;

    // ç»Ÿè®¡å½“å‰å›¢é˜Ÿæ•°é‡
    const teamCount = await this.projectRepository.count({
      where: {
        type: 'team',
        projectRelations: {
          userId,
          role: 'project:admin',  // åªç»Ÿè®¡è‡ªå·±åˆ›å»ºçš„
        },
      },
    });

    return teamCount < limits.maxTeams;
  }

  async canAddTeamMember(projectId: string): Promise<boolean> {
    const project = await this.projectRepository.findOneOrFail({
      where: { id: projectId },
      relations: ['projectRelations', 'projectRelations.user'],
    });

    // æ‰¾åˆ°å›¢é˜Ÿ Owner
    const owner = project.projectRelations.find(
      (rel) => rel.role === 'project:admin'
    )?.user;

    if (!owner) return false;

    const limits = this.getMembershipLimits(owner.membershipTier);

    // æ— é™åˆ¶
    if (limits.maxTeamMembers === -1) return true;

    // ç»Ÿè®¡å½“å‰æˆå‘˜æ•°
    const memberCount = project.projectRelations.length;

    return memberCount < limits.maxTeamMembers;
  }
}
```

#### 5.3 ä¼šå‘˜è¿‡æœŸå¤„ç†

**ç­–ç•¥ï¼š** åªé™åˆ¶æ–°å¢ï¼Œä¸è¸¢å‡ºç°æœ‰æˆå‘˜

```typescript
@Cron('0 0 * * *')  // æ¯å¤©å‡Œæ™¨æ£€æŸ¥
async checkExpiredMemberships() {
  const expiredUsers = await this.userRepository.find({
    where: {
      membershipTier: Not('free'),
      membershipExpireAt: LessThan(new Date()),
    },
  });

  for (const user of expiredUsers) {
    // é™çº§ä¸º Free
    await this.userRepository.update(
      { id: user.id },
      { membershipTier: 'free', membershipExpireAt: null }
    );

    // å‘é€é€šçŸ¥é‚®ä»¶
    await this.mailer.sendMembershipExpiredEmail(user);

    this.logger.info(`User ${user.id} membership expired, downgraded to free`);
  }
}
```

### 6. è§’è‰²ä½“ç³»

#### 6.1 ä¸¤å±‚è§’è‰²ä½“ç³»

**å¹³å°çº§è§’è‰²ï¼š**

| è§’è‰² | æƒé™èŒƒå›´ |
|------|---------|
| `super_admin` | ç®¡ç†å¹³å°é…ç½®ã€AI Providerã€ç”¨æˆ·è´¦å·ã€æŸ¥çœ‹ç»Ÿè®¡ |
| `admin` | ç®¡ç†å¹³å°èŠ‚ç‚¹ã€æŸ¥çœ‹ç»Ÿè®¡ï¼ˆæƒé™ç•¥ä½äº super_adminï¼‰|

**å·¥ä½œç©ºé—´çº§è§’è‰²ï¼ˆç°æœ‰ï¼‰ï¼š**

| è§’è‰² | æƒé™èŒƒå›´ |
|------|---------|
| `project:admin` | å·¥ä½œç©ºé—´ Ownerï¼Œå®Œå…¨æ§åˆ¶ï¼ˆä¸å¯è½¬è®©ï¼‰|
| `project:editor` | å¯åˆ›å»º/ç¼–è¾‘å·¥ä½œæµã€ç®¡ç†æˆå‘˜ |
| `project:viewer` | åªè¯»æƒé™ |

#### 6.2 è§’è‰²éªŒè¯è£…é¥°å™¨

```typescript
// packages/cli/src/decorators/platform-admin.decorator.ts
export function RequirePlatformAdmin(minRole: 'admin' | 'super_admin' = 'admin') {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;

    descriptor.value = async function (...args: any[]) {
      const req = args[0] as AuthenticatedRequest;

      if (!req.platformAdmin) {
        throw new AuthError('éœ€è¦å¹³å°ç®¡ç†å‘˜æƒé™');
      }

      if (minRole === 'super_admin' && req.platformAdmin.role !== 'super_admin') {
        throw new ForbiddenError('éœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™');
      }

      return originalMethod.apply(this, args);
    };

    return descriptor;
  };
}
```

---

## ğŸ”§ å®æ–½æ¸…å•

### é˜¶æ®µ 1ï¼šæ•°æ®åº“æ”¹é€ ï¼ˆ1 å¤©ï¼‰

**æ–°å¢è¡¨ï¼š**

- [ ] åˆ›å»º `platform_admin` è¡¨ï¼ˆå¹³å°ç®¡ç†å‘˜ï¼‰
- [ ] åˆ›å»º `system_config` è¡¨ï¼ˆç³»ç»Ÿé…ç½®ï¼‰
- [ ] åˆ›å»º `balance_transfer_record` è¡¨ï¼ˆä½™é¢è½¬è´¦è®°å½•ï¼‰

**æ‰©å±•è¡¨ï¼š**

- [ ] `user` è¡¨æ·»åŠ ï¼š`balance`, `membership_tier`, `membership_expire_at`
- [ ] `project` è¡¨æ·»åŠ ï¼š`billing_mode`
- [ ] `usage_record` è¡¨æ·»åŠ ï¼š`balance_source` å­—æ®µ

**è¿ç§»è„šæœ¬ï¼š**

```sql
-- 1. åˆ›å»º platform_admin è¡¨
CREATE TABLE platform_admin (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  name VARCHAR(100) NOT NULL,
  role VARCHAR(50) NOT NULL DEFAULT 'admin',
  is_active BOOLEAN NOT NULL DEFAULT true,
  last_login_at TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 2. åˆ›å»º system_config è¡¨
CREATE TABLE system_config (
  key VARCHAR(100) PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO system_config (key, value) VALUES ('platform_initialized', 'false');

-- 3. åˆ›å»ºä½™é¢è½¬è´¦è®°å½•è¡¨
CREATE TABLE balance_transfer_record (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  from_user_id UUID NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  to_workspace_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  amount DECIMAL(10, 4) NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 4. æ‰©å±• user è¡¨
ALTER TABLE "user"
  ADD COLUMN balance DECIMAL(10, 4) DEFAULT 100.0,
  ADD COLUMN membership_tier VARCHAR(20) DEFAULT 'free',
  ADD COLUMN membership_expire_at TIMESTAMP;

-- 5. æ‰©å±• project è¡¨
ALTER TABLE project
  ADD COLUMN billing_mode VARCHAR(20) DEFAULT 'executor';

-- ä¸ªäººå·¥ä½œç©ºé—´å›ºå®šä¸º executor æ¨¡å¼
UPDATE project SET billing_mode = 'executor' WHERE type = 'personal';

-- 6. æ‰©å±• usage_record è¡¨
ALTER TABLE usage_record
  ADD COLUMN balance_source VARCHAR(20) DEFAULT 'user';

-- 7. ç´¢å¼•
CREATE INDEX idx_user_balance ON "user"(balance);
CREATE INDEX idx_user_membership ON "user"(membership_tier);
CREATE INDEX idx_project_billing_mode ON project(billing_mode);
CREATE INDEX idx_balance_transfer_user ON balance_transfer_record(from_user_id);
CREATE INDEX idx_balance_transfer_workspace ON balance_transfer_record(to_workspace_id);
```

### é˜¶æ®µ 2ï¼šåç«¯å®ç°ï¼ˆ3 å¤©ï¼‰

**Service å±‚ï¼š**

- [ ] åˆ›å»º `SystemInitService`ï¼ˆç³»ç»Ÿåˆå§‹åŒ–æ£€æµ‹ï¼‰
- [ ] åˆ›å»º `PlatformAdminService`ï¼ˆç®¡ç†å‘˜è®¤è¯å’Œç®¡ç†ï¼‰
- [ ] åˆ›å»º `UserOnboardingService`ï¼ˆç”¨æˆ·æ³¨å†Œè‡ªåŠ¨åŒ–ï¼‰
- [ ] åˆ›å»º `MembershipService`ï¼ˆä¼šå‘˜æƒç›Šåˆ¤æ–­ï¼‰
- [ ] å¢å¼º `BillingService`ï¼ˆåŒå±‚ä½™é¢æ‰£è´¹é€»è¾‘ï¼‰

**Controller å±‚ï¼š**

- [ ] åˆ›å»º `PlatformAdminController`
  - `POST /admin/setup`ï¼ˆé¦–æ¬¡åˆå§‹åŒ–ï¼‰
  - `POST /admin/login`ï¼ˆç®¡ç†å‘˜ç™»å½•ï¼‰
  - `GET /admin/dashboard`ï¼ˆç»Ÿè®¡é¢æ¿ï¼‰
- [ ] å¢å¼º `AuthController`
  - `POST /register`ï¼ˆç”¨æˆ·æ³¨å†Œ + è‡ªåŠ¨åˆ›å»ºå·¥ä½œç©ºé—´ï¼‰
  - `GET /system/status`ï¼ˆæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦åˆå§‹åŒ–ï¼‰
- [ ] å¢å¼º `ProjectsController`
  - `POST /projects`ï¼ˆæ”¯æŒ billingMode å‚æ•°ï¼‰
  - `POST /projects/:id/balance/transfer`ï¼ˆå……å€¼åˆ°å·¥ä½œç©ºé—´ï¼‰

**Middlewareï¼š**

- [ ] åˆ›å»º `PlatformAdminAuthMiddleware`ï¼ˆç®¡ç†å‘˜èº«ä»½éªŒè¯ï¼‰
- [ ] åˆ›å»º `SystemInitMiddleware`ï¼ˆæ£€æµ‹ç³»ç»Ÿæ˜¯å¦åˆå§‹åŒ–ï¼‰

**Entityï¼š**

- [ ] åˆ›å»º `PlatformAdmin` å®ä½“
- [ ] åˆ›å»º `SystemConfig` å®ä½“
- [ ] åˆ›å»º `BalanceTransferRecord` å®ä½“

### é˜¶æ®µ 3ï¼šå‰ç«¯å®ç°ï¼ˆ2 å¤©ï¼‰

**ç”¨æˆ·ç«¯ï¼š**

- [ ] åˆ›å»º `PlatformNotReady.vue`ï¼ˆç³»ç»Ÿæœªåˆå§‹åŒ–æç¤ºé¡µï¼‰
- [ ] åˆ›å»º `Register.vue`ï¼ˆç”¨æˆ·æ³¨å†Œé¡µé¢ï¼‰
- [ ] å¢å¼º `router/index.ts`ï¼ˆæ·»åŠ ç³»ç»Ÿåˆå§‹åŒ–æ£€æµ‹ï¼‰
- [ ] åˆ›å»º `SystemStore`ï¼ˆç³»ç»ŸçŠ¶æ€ç®¡ç†ï¼‰

**ç®¡ç†å‘˜ç«¯ï¼š**

- [ ] åˆ›å»º `AdminSetup.vue`ï¼ˆç®¡ç†å‘˜åˆå§‹åŒ–å‘å¯¼ï¼‰
- [ ] åˆ›å»º `AdminLogin.vue`ï¼ˆç®¡ç†å‘˜ç™»å½•é¡µï¼‰
- [ ] åˆ›å»º `AdminDashboard.vue`ï¼ˆç®¡ç†å‘˜åå°é¦–é¡µï¼‰
- [ ] åˆ›å»ºç‹¬ç«‹çš„ç®¡ç†å‘˜è·¯ç”±ï¼ˆ`/admin/*`ï¼‰

**å·¥ä½œç©ºé—´ç®¡ç†ï¼š**

- [ ] å¢å¼º `CreateWorkspaceDialog.vue`ï¼ˆæ·»åŠ æ‰£è´¹æ¨¡å¼é€‰æ‹©ï¼‰
- [ ] åˆ›å»º `WorkspaceBalanceTransfer.vue`ï¼ˆå……å€¼åˆ°å·¥ä½œç©ºé—´ï¼‰
- [ ] åˆ›å»º `MembershipUpgrade.vue`ï¼ˆä¼šå‘˜å‡çº§é¡µé¢ï¼‰

### é˜¶æ®µ 4ï¼šæµ‹è¯•éªŒæ”¶ï¼ˆ1 å¤©ï¼‰

**åŠŸèƒ½æµ‹è¯•ï¼š**

- [ ] é¦–æ¬¡å¯åŠ¨æµç¨‹
  - ç”¨æˆ·ç«¯æ˜¾ç¤º"å¹³å°æœªå¯åŠ¨"
  - ç®¡ç†å‘˜å¯ä»¥å®Œæˆåˆå§‹åŒ–
  - åˆå§‹åŒ–åç”¨æˆ·ç«¯æ­£å¸¸è®¿é—®
- [ ] ç”¨æˆ·æ³¨å†Œæµç¨‹
  - æ³¨å†Œè‡ªåŠ¨åˆ›å»ºä¸ªäººå·¥ä½œç©ºé—´
  - è‡ªåŠ¨åˆ†é…åˆå§‹ä½™é¢
  - è‡ªåŠ¨ç™»å½•è¿›å…¥å·¥ä½œç©ºé—´
- [ ] å›¢é˜Ÿå·¥ä½œç©ºé—´
  - åˆ›å»ºæ—¶å¯é€‰æ‹©æ‰£è´¹æ¨¡å¼
  - executor æ¨¡å¼æ‰£æ‰§è¡Œè€…ä½™é¢
  - shared-pool æ¨¡å¼æ‰£å·¥ä½œç©ºé—´ä½™é¢
  - Owner/Admin å¯ä»¥å……å€¼åˆ°å·¥ä½œç©ºé—´
- [ ] ä¼šå‘˜æƒç›Š
  - åˆ›å»ºå›¢é˜Ÿæ—¶æ£€æŸ¥ä¼šå‘˜é™åˆ¶
  - æ·»åŠ æˆå‘˜æ—¶æ£€æŸ¥ä¼šå‘˜é™åˆ¶
  - ä¼šå‘˜è¿‡æœŸè‡ªåŠ¨é™çº§

**å®‰å…¨æµ‹è¯•ï¼š**

- [ ] ç®¡ç†å‘˜åå°éœ€è¦å•ç‹¬è®¤è¯
- [ ] æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®ç®¡ç†å‘˜æ¥å£
- [ ] ç®¡ç†å‘˜æ— æ³•è®¿é—®ç”¨æˆ·å·¥ä½œç©ºé—´æ•°æ®
- [ ] ä½™é¢æ‰£åˆ°è´Ÿæ•°é˜»æ­¢æ‰§è¡Œ

**æ€§èƒ½æµ‹è¯•ï¼š**

- [ ] ç³»ç»Ÿåˆå§‹åŒ–æ£€æµ‹ < 10ms
- [ ] ç”¨æˆ·æ³¨å†Œæµç¨‹ < 500ms
- [ ] ä½™é¢æ‰£è´¹ < 20ms

---

## ğŸ“Š æ•°æ®åº“ ER å›¾

```mermaid
erDiagram
    PLATFORM_ADMIN {
        uuid id PK
        string email UK
        string password
        string name
        string role
        boolean is_active
        timestamp last_login_at
    }

    USER {
        uuid id PK
        string email UK
        decimal balance "æ–°å¢: ä¸ªäººä½™é¢"
        string membership_tier "æ–°å¢: ä¼šå‘˜ç­‰çº§"
        timestamp membership_expire_at "æ–°å¢: ä¼šå‘˜è¿‡æœŸæ—¶é—´"
    }

    PROJECT {
        uuid id PK
        string type "personal | team"
        string billing_mode "æ–°å¢: executor | shared-pool"
    }

    WORKSPACE_BALANCE {
        uuid workspace_id PK
        decimal balance_cny "å›¢é˜Ÿå…±äº«ä½™é¢æ± "
    }

    BALANCE_TRANSFER_RECORD {
        uuid id PK
        uuid from_user_id FK
        uuid to_workspace_id FK
        decimal amount
        timestamp created_at
    }

    SYSTEM_CONFIG {
        string key PK
        string value
    }

    USER ||--o{ PROJECT : "owns/member of"
    PROJECT ||--o| WORKSPACE_BALANCE : "has (if shared-pool)"
    USER ||--o{ BALANCE_TRANSFER_RECORD : "transfers from"
    PROJECT ||--o{ BALANCE_TRANSFER_RECORD : "receives to"
```

---

## ğŸ¯ ä¸šåŠ¡æµç¨‹å›¾

### ç”¨æˆ·æ³¨å†Œè‡ªåŠ¨åŒ–æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant A as AuthController
    participant O as UserOnboardingService
    participant DB as æ•°æ®åº“

    U->>F: å¡«å†™æ³¨å†Œè¡¨å•
    F->>A: POST /register
    A->>DB: åˆ›å»º User è®°å½•
    A->>O: setupPersonalWorkspace(user)
    O->>DB: åˆ›å»º Personal Project
    O->>DB: åˆ›å»º ProjectRelation
    O->>DB: (å¯é€‰) åˆå§‹åŒ– WorkspaceBalance
    O-->>A: Personal Project
    A->>F: è¿”å›ç”¨æˆ·ä¿¡æ¯ + Token
    F->>U: è‡ªåŠ¨ç™»å½•ï¼Œè¿›å…¥ä¸ªäººå·¥ä½œç©ºé—´
```

### å›¢é˜Ÿå·¥ä½œç©ºé—´æ‰£è´¹æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant W as WorkflowRunner
    participant B as BillingService
    participant DB as æ•°æ®åº“

    U->>W: æ‰§è¡Œå·¥ä½œæµ
    W->>B: deductBalance(workspace, user, amount)

    alt Personal æˆ– executor æ¨¡å¼
        B->>DB: æŸ¥è¯¢ user.balance
        DB-->>B: balance
        B->>DB: user.balance -= amount
    else shared-pool æ¨¡å¼
        B->>DB: æŸ¥è¯¢ workspace_balance.balance_cny
        DB-->>B: balance_cny
        B->>DB: workspace_balance.balance_cny -= amount
    end

    B->>DB: è®°å½• usage_record
    B-->>W: æ‰£è´¹æˆåŠŸ
    W->>U: å·¥ä½œæµæ‰§è¡Œç»“æœ
```

---

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. ç®¡ç†å‘˜åå°éš”ç¦»

**è·¯ç”±éš”ç¦»ï¼š**
- ç”¨æˆ·ç«¯ï¼š`https://app.example.com`
- ç®¡ç†å‘˜ï¼š`https://admin.example.com` æˆ– `/admin/*`

**è®¤è¯éš”ç¦»ï¼š**
- ä¸åŒçš„ JWT Secret
- ä¸åŒçš„ Session Cookie åç§°
- ç‹¬ç«‹çš„è®¤è¯ä¸­é—´ä»¶

### 2. ä½™é¢å¹¶å‘å®‰å…¨

**ä½¿ç”¨æ‚²è§‚é”ï¼š**

```typescript
async deductBalance(params) {
  await this.dataSource.transaction(async (em) => {
    // ä½¿ç”¨ FOR UPDATE æ‚²è§‚é”
    const user = await em.findOne(User, {
      where: { id: params.userId },
      lock: { mode: 'pessimistic_write' },
    });

    if (user.balance < params.amount) {
      throw new OperationalError('ä½™é¢ä¸è¶³');
    }

    user.balance -= params.amount;
    await em.save(user);
  });
}
```

### 3. ä¼šå‘˜æƒç›Šé˜²ç¯¡æ”¹

**æœåŠ¡ç«¯éªŒè¯ï¼š**
- æ‰€æœ‰ä¼šå‘˜æƒç›Šåˆ¤æ–­å¿…é¡»åœ¨åç«¯
- å‰ç«¯åªæ˜¾ç¤ºï¼Œä¸å†³ç­–
- åˆ›å»ºå›¢é˜Ÿã€æ·»åŠ æˆå‘˜æ—¶å®æ—¶æ£€æŸ¥

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘åå…¼å®¹

**ç°æœ‰æ•°æ®å¤„ç†ï¼š**

ç›´æ¥åˆ é™¤ç°æœ‰çš„n8næ•°æ®åº“

### 2. åˆå§‹ä½™é¢é…ç½®

**å»ºè®®åšæˆå¯é…ç½®ï¼š**

```typescript
// packages/cli/src/config/schema.ts
{
  user: {
    initialBalance: {
      doc: 'ç”¨æˆ·æ³¨å†Œæ—¶çš„åˆå§‹ä½™é¢ï¼ˆäººæ°‘å¸ï¼‰',
      format: Number,
      default: 0,
      env: 'N8N_USER_INITIAL_BALANCE',
    },
  },
}
```

---

## ğŸ“ˆ åç»­ä¼˜åŒ–ï¼ˆPhase 2ï¼‰

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2 ä¸ªæœˆï¼‰

- [ ] æ”¯ä»˜é›†æˆï¼ˆæ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ï¼‰
- [ ] å……å€¼ä¼˜æƒ æ´»åŠ¨ï¼ˆé¦–å……åŒå€ç­‰ï¼‰
- [ ] é‚€è¯·å¥½å‹å¥–åŠ±æœºåˆ¶
- [ ] ä¼šå‘˜è‡ªåŠ¨ç»­è´¹



---

## ğŸ“ ç›¸å…³èµ„æº

### ä»£ç ä½ç½®

**åç«¯ï¼š**
- Entity: `packages/@n8n/db/src/entities/`
- Service: `packages/cli/src/services/`
- Controller: `packages/cli/src/controllers/`

**å‰ç«¯ï¼š**
- Views: `packages/frontend/editor-ui/src/views/`
- Stores: `packages/frontend/editor-ui/src/stores/`
- Router: `packages/frontend/editor-ui/src/router/`

### å‚è€ƒæ–‡æ¡£

- [01-å¤šç§Ÿæˆ·æ¶æ„](./01-å¤šç§Ÿæˆ·æ¶æ„.md) - ç°æœ‰å¤šç§Ÿæˆ·åŸºç¡€
- [03-æ•°æ®åº“è®¾è®¡](./03-æ•°æ®åº“è®¾è®¡.md) - æ•°æ®åº“è¡¨ç»“æ„
- [05-AIæœåŠ¡æ¶æ„](./05-AIæœåŠ¡æ¶æ„.md) - è®¡è´¹ç³»ç»Ÿè®¾è®¡
- [Chat-HubæŒ‰é‡è®¡è´¹æ”¹é€ æ–¹æ¡ˆ](../Chat-HubæŒ‰é‡è®¡è´¹æ”¹é€ æ–¹æ¡ˆ.md) - è®¡è´¹å®ç°å‚è€ƒ

---

**æ–‡æ¡£ç»´æŠ¤ï¼š** å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°ï¼š** 2025-01-10
**ä¸‹ä¸€æ¬¡å®¡æŸ¥ï¼š** å®æ–½å‰
