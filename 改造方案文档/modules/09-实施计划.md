# 实施计划

> **版本:** v7.0 (阶段 5.3 核心完成)
> **日期:** 2025-11-09
> **状态:** 阶段 5.3 已完成 90%，待前端 UI 改造
> **整体完成度:** 92%

[← 返回总览](../00-总览与导航.md)

---

## 📋 文档说明

本文档基于 **实际代码深度分析** 编写,反映真实的实施进度和代码状态。

**分析方法:**
- 4个专业子代理并行分析代码库
- 统计实际代码行数和文件数量
- 验证功能完成度和集成状态
- 识别与原计划的差异

**配套文档:**
- [00-总览与导航](../00-总览与导航.md) - 项目总览
- [01-多租户架构](./01-多租户架构.md) - 核心架构
- [10-验收标准](./10-验收标准.md) - 质量标准

---

## 🎯 项目概述

### 改造目标

将 n8n 从单租户架构升级为 **多租户 SaaS 平台**:

1. **工作空间隔离** - 数据、资源、权限完全隔离
2. **AI 平台托管** - 统一管理 API Key,按量计费
3. **节点市场** - 三层节点架构(内置/平台/自定义)
4. **计费系统** - 工作空间级别独立计费

### 整体进度

| 维度 | 完成度 | 代码量 | 说明 |
|------|--------|--------|------|
| **数据库层** | ✅ 100% | 43 Entity + 44 Repository | 多租户基础设施完成 |
| **后端Service** | ✅ 90% | 37 Service (~7,749行) | 核心业务逻辑完成 |
| **前端实现** | ✅ 98% | 17 文件 (~11,867行) | UI层几乎完成 |
| **节点系统** | 🔄 50% | LmChatPlatform已动态化 | 通用动态化进行中 |
| **整体** | 🟢 **87%** | 净增 +21,332行 | 核心架构已稳定 |

---

## 📊 阶段总览

### 已完成阶段 (0-5.2)

| 阶段 | 任务 | 完成日期 | 核心交付物 | 完成度 |
|------|------|----------|-----------|--------|
| **阶段 0** | 准备阶段 | 2025-01-07 | 环境搭建、技术选型 | ✅ 100% |
| **阶段 1** | 数据库迁移 | 2025-01-07 | 78个迁移脚本 | ✅ 100% |
| **阶段 2** | Entity + Repository | 2025-01-07 | 43 Entity + 44 Repository | ✅ 100% |
| **阶段 3** | Service 层 | 2025-01-07 | 37个Service | ✅ 90% |
| **阶段 4** | Controller + Middleware | 2025-11-08 | 37个API端点 | ✅ 100% |
| **阶段 5.0** | 前端改造 | 2025-11-08 | 6 Store + 5 API + 4 组件 | ✅ 98% |
| **阶段 5.1** | 概念修正 | 2025-11-08 | 删除17个旧文件 | ✅ 100% |
| **阶段 5.2** | 节点备份 | 2025-11-09 | 备份303个节点 | ✅ 100% |
| **阶段 5.3** | 节点动态化（核心） | 2025-11-09 | 后端+前端 Store | ✅ 90% |

### 进行中阶段 (5.3 剩余部分)

| 阶段 | 任务 | 预计完成 | 优先级 | 工期 |
|------|------|----------|--------|------|
| **阶段 5.3 (UI)** | 节点选择器 UI 改造 | 2025-01-16 | 🔥 P0 | 1-2天 |

### 待开始阶段 (5.4-7)

| 阶段 | 任务 | 预计开始 | 优先级 | 工期 |
|------|------|----------|--------|------|
| **阶段 5.4** | 核心节点中文化 | 2025-01-17 | P1 | 5-7天 |
| **阶段 6** | 支付集成 | 待定 | P2 (延后) | 3天 |
| **阶段 7** | 测试和优化 | 2025-01-24 | P1 | 2-3周 |

---

## ✅ 已完成阶段详细记录

### 阶段 0-2: 数据库层改造

**完成日期:** 2025-01-07
**完成度:** ✅ 100%

#### 数据库迁移脚本

| 数据库类型 | 迁移文件数量 | 说明 |
|-----------|------------|------|
| Common (通用) | 78 个 | 跨数据库通用逻辑 |
| PostgreSQL | 49 个 | PostgreSQL 特定 |
| MySQL | 53 个 | MySQL 特定 |
| SQLite | 51 个 | SQLite 特定 |

#### 关键迁移脚本

| 迁移脚本 | 职责 |
|---------|------|
| `1762511301780-MultitenantTransformation` | 删除 SharedWorkflow/SharedCredentials |
| `1762511302000-CreateBillingTables` | 创建计费系统 |
| `1762511303000-RedesignPlatformArchitecture` | 节点三层架构 |

#### Entity 定义 (43个)

| 类别 | Entity 数量 | 主要Entity |
|------|-----------|-----------|
| 多租户核心 | 4 | Project, ProjectRelation, WorkflowEntity, CredentialsEntity |
| 计费系统 | 3 | WorkspaceBalance, UsageRecord, RechargeRecord |
| 平台服务 | 4 | PlatformAIProvider, PlatformNode, CustomNode, UserNodeConfig |
| 权限系统 | 4 | User, Role, Scope, ProjectRelation |
| 资源管理 | 5 | WorkflowEntity, CredentialsEntity, Folder, Tag, Variables |
| 其他 | 23 | Execution, EventDestinations, AuditLog 等 |

#### Repository 实现 (44个)

- ✅ 所有 Entity 均有对应 Repository
- ✅ 使用依赖注入 (`@Service()`)
- ✅ 类型安全的查询方法
- ✅ 关联查询支持

---

### 阶段 3: Service 层实现

**完成日期:** 2025-01-07
**完成度:** ✅ 90%
**代码量:** 37个Service, ~7,749行

#### 多租户核心 Service (8个)

| Service | 文件 | 完成度 | 核心功能 |
|---------|------|--------|---------|
| ProjectService | `project.service.ee.ts` | ✅ 100% | 工作空间 CRUD、成员管理 |
| WorkspaceContextService | `workspace-context.service.ts` | ✅ 100% | 上下文查询 |
| BillingService | `billing.service.ts` | ✅ 100% | 余额、扣费、充值 |
| WorkflowService | `workflow.service.ts` | ✅ 95% | 工作流 CRUD |
| CredentialsService | `credentials.service.ts` | ✅ 95% | 凭证管理 |
| UserService | `user.service.ts` | ✅ 100% | 用户管理 |
| RoleService | `role.service.ts` | ✅ 100% | 角色权限 |
| AuthService | `auth.service.ts` | ✅ 100% | JWT 认证 |

#### 节点管理 Service (3个)

| Service | 完成度 | 核心功能 |
|---------|--------|---------|
| CustomNodeService | ✅ 100% | 自定义节点、审核流程 |
| PlatformNodeService | ✅ 100% | 平台节点、第三方节点 |
| UserNodeConfigService | ✅ 100% | 节点配置、加密存储 |

#### AI 服务 Service (2个)

| Service | 完成度 | 核心功能 |
|---------|--------|---------|
| PlatformAIProviderService | ✅ 100% | AI提供商、自动计费 |
| AiService | 🟡 75% | AI助手（部分依赖外部SDK） |

---

### 阶段 4: Controller + Middleware

**完成日期:** 2025-11-08
**完成度:** ✅ 100%

#### Controller 实现 (6个, 37个端点)

| Controller | 端点数量 | 核心功能 |
|-----------|---------|---------|
| WorkspaceController | 8 | 工作空间 CRUD、成员管理 |
| BillingController | 6 | 余额、充值、使用记录 |
| CustomNodeController | 7 | 自定义节点 CRUD、审核 |
| PlatformNodeController | 6 | 平台节点管理、搜索 |
| UserNodeConfigController | 5 | 节点配置 CRUD |
| AIProviderController | 5 | AI提供商、模型列表 |

#### Middleware 实现 (2个)

| Middleware | 功能 |
|-----------|------|
| WorkspaceContextMiddleware | 工作空间上下文注入 |
| RateLimitMiddleware | API 限流 |

---

### 阶段 5.0: 前端改造

**完成日期:** 2025-11-08
**完成度:** ✅ 98%
**代码量:** ~11,867行

#### Pinia Store (6个, 1,812行)

| Store | 代码行数 | 完成度 | 核心功能 |
|-------|---------|--------|---------|
| billing.store.ts | 314 | ✅ 100% | 余额、使用记录、充值 |
| customNodes.store.ts | 348 | ✅ 100% | 自定义节点管理 |
| aiProviders.store.ts | 208 | ✅ 100% | AI提供商、模型选择 |
| platformNodes.store.ts | 318 | ✅ 100% | 平台节点浏览 |
| userNodeConfig.store.ts | 284 | ✅ 100% | 节点配置 |
| projects.store.ts | 340 | ✅ 100% | 工作空间管理 |

#### API 层 (5个, 851行)

| API 模块 | 代码行数 | 接口数量 |
|---------|---------|---------|
| billing.api.ts | 241 | 6个 |
| custom-nodes.ts | 196 | 7个 |
| ai-providers.ts | 121 | 4个 |
| platform-nodes.ts | 144 | 6个 |
| user-node-config.ts | 149 | 6个 |

#### Vue 组件 (4个, 1,170行)

| 组件 | 代码行数 | 完成度 |
|------|---------|--------|
| WorkspaceSwitcher.vue | 203 | ✅ 100% |
| BalanceCard.vue | 154 | ✅ 100% |
| BillingModal.vue | 351 | ⚠️ 80% |
| BillingPage.vue | 462 | ✅ 100% |

#### 国际化

- ✅ 英文: 4,030 行
- ✅ 中文: 4,004 行
- ✅ 所有 UI 文本已国际化

---

### 阶段 5.2: 节点备份与移动

**完成日期:** 2025-11-09
**完成度:** ✅ 100%

#### 节点备份统计

| 节点类型 | 数量 | 说明 |
|---------|------|------|
| 需要凭证的节点 | 240 | GitHub, Slack 等 |
| AI/LangChain节点 | 63 | ChatOpenAI, ChatAnthropic 等 |
| 保留的核心节点 | 142 | Set, If, HttpRequest 等 |
| **总计** | **445** | 303 备份 + 142 保留 |

#### package.json 更新

- ✅ 移除 329 个节点引用
- ✅ 移除 389 个凭证引用
- ✅ 保留 142 个核心节点引用

---

### 阶段 5.3: 节点动态化架构（核心部分）

**完成日期:** 2025-11-09
**完成度:** ✅ 90% (UI 部分待完成)
**代码量:** ~1,050 行

#### 5.3.1 后端节点加载改造 ✅

**修改文件:**
- `packages/cli/src/load-nodes-and-credentials.ts` (~220 行)
- `packages/core/src/nodes-loader/directory-loader.ts` (修复 getVersionedNodeTypeAll)
- `packages/core/bin/generate-metadata` (添加过滤逻辑)

**核心功能:**
- ✅ 节点元数据验证 (validateNodeMetadata)
- ✅ 数据库节点加载 (loadNodesFromDatabase)
- ✅ 节点转换逻辑 (convertDbNodeToDescription)
- ✅ 优雅降级机制
- ✅ 修复 Switch 节点 group 字段 null 问题

#### 5.3.2 NodeCompilerService 创建 ✅

**新增文件:**
- `packages/cli/src/services/node-compiler.service.ts` (256 行)

**核心功能:**
- ✅ 节点代码编译 (VM2 沙箱)
- ✅ 节点元数据验证
- ✅ 节点实例化
- ✅ 安全隔离机制

#### 5.3.3 Service 层扩展 ✅

**扩展的 Service:**
- ✅ CustomNodeService (+3 方法)
- ✅ PlatformNodeService (+3 方法)

#### 5.3.4 API 端点实现 ✅

**修改文件:**
- `packages/cli/src/controllers/available-nodes.controller.ts`

**新增端点:**
- ✅ `GET /rest/available-nodes/builtin` - 内置节点列表
- ✅ 改进 `GET /rest/available-nodes` - 合并所有节点类型

#### 5.3.5 前端 Store 改造 ✅

**修改文件:**
- `packages/frontend/editor-ui/src/app/stores/nodeTypes.store.ts` (~130 行)

**新增文件:**
- `packages/frontend/editor-ui/src/app/api/available-nodes.api.ts` (115 行)

**核心功能:**
- ✅ 三步节点加载（内置 + 动态 AI + 可用节点）
- ✅ 节点分类存储
- ✅ 加载状态管理
- ✅ 错误处理

#### 5.3.6 Bug 修复 ✅

**问题:** Switch 节点 group 字段为 null 导致前端崩溃

**修复文件:**
- `packages/core/src/nodes-loader/directory-loader.ts`
- `packages/core/bin/generate-metadata`

**验证结果:**
- ✅ nodes.json 中 0 个节点有 null 字段
- ✅ Switch 节点从 4 个条目减少到 3 个（移除无效条目）
- ✅ 所有节点字段完整

---

## 🚧 进行中阶段

### 🔥 阶段 5.3 (UI): 节点选择器改造

**目标:** 从根本上解决节点管理问题
**预计工期:** 4-5 天
**优先级:** P0 (最高)

#### 5.3.1 后端节点加载改造 (2天)

**文件:** `packages/cli/src/services/load-nodes-and-credentials.service.ts`

| 子任务 | 工时 | 交付物 |
|--------|------|--------|
| 实现 `validateNodeMetadata()` | 0.5天 | 元数据验证逻辑 |
| 实现 `validateAndMerge()` | 0.5天 | 优雅降级合并 |
| 重构 `loadBuiltinNodes()` | 0.5天 | 错误容错处理 |
| 重构 `loadSharedNodes()` | 0.5天 | 编译验证 |

**验收标准:**
- [ ] 元数据包含必需字段
- [ ] group 必须是非空数组
- [ ] 单节点失败不影响整体
- [ ] 错误日志清晰

#### 5.3.2 CustomNodeService 扩展 (1天)

| 子任务 | 工时 | 交付物 |
|--------|------|--------|
| `getSharedNodes()` | 0.25天 | 查询平台+第三方节点 |
| `getWorkspaceNodes()` | 0.25天 | 查询工作空间节点 |
| `createWorkspaceNode()` | 0.25天 | 创建私有节点 |
| 审核流程方法 | 0.25天 | submitForReview, reviewNode |

#### 5.3.3 API 端点实现 (0.5天)

| 端点 | 方法 | 功能 |
|------|------|------|
| `/node-types/` | GET | 获取所有节点 |
| `/custom-nodes/workspace` | POST | 上传节点 |
| `/custom-nodes/:id/submit` | POST | 提交审核 |

#### 5.3.4 前端 Store 改造 (1天)

**文件:** `packages/editor-ui/src/stores/nodeTypes.store.ts`

| 子任务 | 工时 |
|--------|------|
| `fetchNodeTypes()` 从 API 加载 | 0.25天 |
| 安全属性访问方法 | 0.25天 |
| 计算属性分类节点 | 0.25天 |
| 错误处理和加载状态 | 0.25天 |

#### 5.3.5 节点选择器 UI 改造 (1天)

**新 Tab 设计:**

| Tab | 内容 |
|-----|------|
| **基础节点** | 142个内置节点 |
| **扩展节点** | 平台+第三方节点（直接可用） |
| **我的节点** | 工作空间私有节点 |

#### 5.3.6 集成测试 (0.5天)

**测试场景:**
- [ ] 管理员上传平台节点,所有用户可用
- [ ] 工作空间节点隔离
- [ ] 审核流程正常
- [ ] 删除节点不崩溃
- [ ] 元数据不完整节点被跳过

---

## ⏳ 待开始阶段

### 阶段 5.4: 核心节点中文化

**预计工期:** 5-7 天
**优先级:** P1
**延后至:** 阶段 5.3 完成后

#### P0 优先级节点 (28个)

**核心逻辑 (8个):**
Set, If, Switch, Merge, Code, Loop, Filter, Item Lists

**数据处理 (10个):**
Edit Fields, Split Out, Aggregate, Sort, Limit, Remove Duplicates, Compare Datasets, Move Binary Data, Crypto, Date & Time

**HTTP/API (5个):**
HTTP Request, Webhook, Respond to Webhook, Execute Workflow, Wait

**触发器 (5个):**
Schedule Trigger, Manual Trigger, Error Trigger, Execute Command, Read/Write Files

---

### 阶段 6: 支付集成 (延后)

**状态:** 延后处理
**说明:** 当前使用管理员充值作为替代

---

### 阶段 7: 测试和优化

**预计开始:** 2025-01-24
**预计工期:** 2-3 周

#### 7.1 功能测试 (1周)

**测试清单:**
- [ ] 数据隔离测试
- [ ] 权限测试
- [ ] 计费测试

#### 7.2 性能优化 (1周)

**性能目标:**

| 指标 | 目标 |
|------|------|
| 工作流列表查询 | < 100ms (p95) |
| 工作空间切换 | < 50ms (p95) |
| 权限检查 | < 10ms (p95) |
| 余额查询 | < 20ms (p95) |
| 并发用户数 | > 1000 |

#### 7.3 安全审计 (可选)

- [ ] SQL 注入防护
- [ ] XSS 防护
- [ ] CSRF 防护
- [ ] API 限流
- [ ] 数据加密

---

## 📈 项目指标

### 代码量统计

| 类别 | 新增 | 删除 | 净增 |
|------|------|------|------|
| 数据库迁移 | 1,768 | - | +1,768 |
| Entity/Repository | 5,315 | ~147处引用 | +5,315 |
| Service 层 | 7,749 | - | +7,749 |
| Controller/Middleware | 4,245 | 10,965 | -6,720 |
| 前端 | ~11,867 | - | +11,867 |
| 概念修正 | 4,500 | 3,000 | +1,500 |
| **总计** | **~35,444** | **~14,112** | **+21,332** |

### 里程碑跟踪

| 里程碑 | 计划 | 实际 | 状态 |
|--------|------|------|------|
| M0-M5.2 | Week 0-9 | 2025-01-07 ~ 2025-11-09 | ✅ 完成 |
| M5.3 节点动态化 | 2025-01-16 | - | 🔄 进行中 |
| M5.4 中文化 | 2025-01-23 | - | ⬜ 待开始 |
| M7 测试优化 | 2025-02-06 | - | ⬜ 待开始 |
| M8 上线 | 2025-02-13 | - | ⬜ 待开始 |

---

## ⚠️ 风险管理

### 技术风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|---------|
| 节点动态化延期 | 中 | 高 | 分阶段实施,充分测试 |
| Redis缓存雪崩 | 低 | 中 | 过期时间加随机值 |
| 并发扣费冲突 | 低 | 高 | ✅ 已实现悲观锁 |
| 数据隔离漏洞 | 低 | 高 | 充分测试,代码审查 |

### 进度风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|---------|
| 测试时间不足 | 中 | 高 | 同步测试,提前准备 |
| 中文化工作量低估 | 中 | 中 | 预留缓冲,分批完成 |
| 需求变更 | 低 | 中 | 核心架构已完成 |

---

## 👥 资源需求

### 团队配置

| 角色 | 人数 | 投入度 | 负责 |
|------|------|--------|------|
| 全栈工程师 | 1 | 100% | 节点动态化+中文化 |
| 后端工程师 | 1 | 100% | 性能优化+缓存 |
| 前端工程师 | 1 | 50% | UI优化 |
| QA工程师 | 1 | 100% | 测试 |
| DevOps工程师 | 1 | 50% | 部署+监控 |

**预计:** 3.5人 × 5周 = **17.5人周**

---

## 📋 下一步行动

### 本周任务 (阶段 5.3)

**Day 1-2: 后端节点加载改造**
- 实现元数据验证
- 实现优雅降级
- 重构加载逻辑

**Day 3: Service 扩展 + API**
- CustomNodeService 方法
- API 端点实现

**Day 4-5: 前端改造 + 测试**
- Store 改造
- 节点选择器 UI
- 集成测试

---

## 🔗 相关文档

- [← 上一章: 用户体验](./08-用户体验.md)
- [返回总览](../00-总览与导航.md)
- [下一章: 验收标准 →](./10-验收标准.md)

---

**文档版本:** v6.0 (基于实际代码分析)
**最后更新:** 2025-01-09
**维护者:** 开发团队
