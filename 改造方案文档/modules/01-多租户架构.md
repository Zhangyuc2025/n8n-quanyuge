# å¤šç§Ÿæˆ·åŸºç¡€æ¶æ„ï¼ˆå·²å®Œæˆ âœ…ï¼‰

> **ç‰ˆæœ¬ï¼š** v1.0
> **çŠ¶æ€ï¼š** å·²å®Œæˆ 73%
> **å®Œæˆé˜¶æ®µï¼š** 0-3.1

[â† è¿”å›æ€»è§ˆ](../00-æ€»è§ˆä¸å¯¼èˆª.md)

---

## æ”¹é€ æˆæœ

n8n å·²æˆåŠŸä»**å•ç§Ÿæˆ·å¼€æºå·¥å…·**æ”¹é€ ä¸º**å¤šç§Ÿæˆ· SaaS å¹³å°**ï¼Œå®Œæˆåº¦ **73%**ã€‚

## æ¶æ„æ¼”è¿›

**æ”¹é€ å‰ï¼ˆ4å±‚JOINï¼Œæ€§èƒ½å·®ï¼‰ï¼š**
```
User â†’ ProjectRelation â†’ Project â†’ SharedWorkflow âŒ â†’ Workflow
```

**æ”¹é€ åï¼ˆ3å±‚JOINï¼Œæ€§èƒ½æå‡30-40%ï¼‰ï¼š**
```
User â†’ ProjectRelation â†’ Project â†’ Workflow âœ…
                               â””â”€â†’ Credentials âœ…
                               â””â”€â†’ UsageRecord âœ…
```

## æ ¸å¿ƒæ”¹åŠ¨

| æ”¹åŠ¨é¡¹ | æ”¹é€ å‰ | æ”¹é€ å | å½±å“ |
|--------|--------|--------|------|
| **èµ„æºå½’å±** | SharedWorkflow ä¸­é—´è¡¨ | ç›´æ¥å½’å± Project | æ€§èƒ½ â†‘30-40% |
| **å·¥ä½œç©ºé—´** | å•ä¸€å›ºå®š | Project è¡¨ï¼ˆtypeå­—æ®µï¼‰ | æ”¯æŒå¤šå·¥ä½œç©ºé—´ |
| **è®¡è´¹ç³»ç»Ÿ** | æ—  | æŒ‰é‡è®¡è´¹ï¼ˆäººæ°‘å¸ï¼‰ | å•†ä¸šåŒ–åŸºç¡€ |
| **æ•°æ®åº“è¡¨** | 45 ä¸ª | 56 ä¸ªï¼ˆ+11 æ–°è¡¨ï¼Œ-2 æ—§è¡¨ï¼‰ | - |
| **éš”ç¦»æœºåˆ¶** | æ—  | @ProjectScope è£…é¥°å™¨ | è‡ªåŠ¨éš”ç¦» |

## å·²å®Œæˆçš„åŠŸèƒ½ï¼ˆé˜¶æ®µ 0-3.1ï¼‰

### âœ… æ•°æ®åº“å±‚ï¼ˆé˜¶æ®µ 1-2ï¼Œ100%ï¼‰

**æ‰©å±•ç°æœ‰è¡¨ï¼š**
- `project` â†’ æ–°å¢ï¼š`balance_cny`, `low_balance_threshold`, `slug`, `status`
- `workflow_entity` â†’ æ–°å¢ï¼š`project_id` (FKï¼Œç›´æ¥å½’å±)
- `credentials_entity` â†’ æ–°å¢ï¼š`project_id` (FK), `is_managed`
- `execution_entity` â†’ æ–°å¢ï¼š`workspace_id` (FK)
- `user` â†’ æ–°å¢ï¼š`tier`, `email_verified`, `is_admin`

**æ–°å¢è¡¨ï¼ˆ11ä¸ªï¼‰ï¼š**
1. `platform_ai_provider` - AI æœåŠ¡æä¾›å•†ï¼ˆOpenAI, Anthropic ç­‰ï¼‰
2. `platform_node` - å¹³å°èŠ‚ç‚¹ï¼ˆå®˜æ–¹ + ç¬¬ä¸‰æ–¹å®¡æ ¸ï¼‰
3. `custom_node` - è‡ªå®šä¹‰èŠ‚ç‚¹ï¼ˆå·¥ä½œç©ºé—´ç§æœ‰ï¼‰
4. `user_node_config` - ç”¨æˆ·èŠ‚ç‚¹é…ç½®ï¼ˆæ›¿ä»£ credentialsï¼‰
5. `usage_records` - ä½¿ç”¨é‡å’Œæ‰£è´¹è®°å½•
6. `monthly_usage_summary` - æœˆåº¦è´¦å•æ±‡æ€»
7. `workspace_quotas` - å·¥ä½œç©ºé—´é…é¢
8. `workspace_features` - åŠŸèƒ½å¼€å…³
9. `invite_codes` - é‚€è¯·ç ç³»ç»Ÿ
10. `audit_logs` - å®¡è®¡æ—¥å¿—
11. `recharge_records` - å……å€¼è®°å½•

**åˆ é™¤è¡¨ï¼ˆ2ä¸ªï¼‰ï¼š**
- âŒ `shared_workflow` - å·²åˆ é™¤ï¼Œç®€åŒ–æ¶æ„
- âŒ `shared_credentials` - å·²åˆ é™¤ï¼Œç®€åŒ–æ¶æ„

### âœ… å·¥ä½œç©ºé—´éš”ç¦»æœºåˆ¶ï¼ˆé˜¶æ®µ 2-3ï¼Œ100%ï¼‰

**æ ¸å¿ƒæ¦‚å¿µï¼šProject = Workspace**

```typescript
// n8n ä¸­ï¼ŒProject å®ä½“å°±æ˜¯ Workspaceï¼ˆå·¥ä½œç©ºé—´ï¼‰
@Entity()
export class Project {
  @Column({ type: 'enum', enum: ['personal', 'team'] })
  type: 'personal' | 'team';  // ä¸ªäººç©ºé—´ | å›¢é˜Ÿç©ºé—´

  @Column({ type: 'decimal', precision: 10, scale: 4 })
  balance_cny: number;  // å·¥ä½œç©ºé—´ä½™é¢ï¼ˆäººæ°‘å¸ï¼‰

  @OneToMany(() => Workflow, (workflow) => workflow.project)
  workflows: Workflow[];  // ç›´æ¥å…³è”å·¥ä½œæµ
}
```

**@ProjectScope è£…é¥°å™¨è‡ªåŠ¨éš”ç¦»ï¼š**

```typescript
@RestController('/workflows')
export class WorkflowsController {
  @Get('/')
  @ProjectScope()  // âœ… è‡ªåŠ¨å®ç°å·¥ä½œç©ºé—´éš”ç¦»
  async getWorkflows(req: AuthenticatedRequest) {
    // åªè¿”å›ç”¨æˆ·æœ‰æƒé™çš„å·¥ä½œç©ºé—´çš„ workflows
    return await this.workflowService.getAll(req.user);
  }
}
```

**éš”ç¦»æµç¨‹ï¼š**
```mermaid
sequenceDiagram
    Client->>Router: GET /workflows
    Router->>ProjectScope: æ‹¦æˆªè¯·æ±‚
    ProjectScope->>DB: éªŒè¯ç”¨æˆ·å·¥ä½œç©ºé—´æƒé™
    alt æ— æƒé™
        ProjectScope-->>Client: 403 Forbidden
    else æœ‰æƒé™
        ProjectScope->>Service: æ³¨å…¥ workspaceId
        Service->>DB: æŸ¥è¯¢è¯¥å·¥ä½œç©ºé—´çš„æ•°æ®
        DB-->>Client: è¿”å›è¿‡æ»¤åçš„æ•°æ®
    end
```

### âœ… è®¡è´¹ç³»ç»Ÿï¼ˆé˜¶æ®µ 3ï¼Œ100%ï¼‰

**å¹¶å‘å®‰å…¨æ‰£è´¹ï¼ˆæ‚²è§‚é”ï¼‰ï¼š**

```typescript
async recordUsageAndCharge(params: UsageParams) {
  return await this.projectRepository.manager.transaction(async (trx) => {
    // ğŸ”’ æ‚²è§‚å†™é”ï¼Œé˜²æ­¢å¹¶å‘é€æ”¯
    const workspace = await trx.findOne(Project, {
      where: { id: workspaceId },
      lock: { mode: 'pessimistic_write' },
    });

    // æ£€æŸ¥ä½™é¢
    if (workspace.balanceCny < cost) {
      throw new InsufficientBalanceError();
    }

    // æ‰£è´¹
    workspace.balanceCny -= cost;
    await trx.save(workspace);

    // è®°å½•ä½¿ç”¨é‡
    await trx.save(usageRecord);
  });
}
```

**è®¡è´¹æµç¨‹ï¼š**
```
ç”¨æˆ·è¿è¡Œå·¥ä½œæµ â†’ AI èŠ‚ç‚¹è°ƒç”¨ â†’ æ£€æŸ¥ä½™é¢ â†’ è°ƒç”¨ä¸Šæ¸¸ API â†’
è®°å½• token ä½¿ç”¨é‡ â†’ è®¡ç®—è´¹ç”¨ â†’ æ‰£é™¤ä½™é¢ â†’ è¿”å›ç»“æœ
```

### âœ… å·²å®ç°çš„ Service å±‚ï¼ˆé˜¶æ®µ 3ï¼Œ100%ï¼‰

| Service | åŠŸèƒ½ | çŠ¶æ€ |
|---------|------|------|
| `BillingService` | ä½™é¢æ£€æŸ¥ã€æ‰£è´¹ã€è´¦å• | âœ… å®Œæˆ |
| `PlatformAIService` | AI æœåŠ¡è°ƒç”¨ã€æ¨¡å‹ç®¡ç† | âœ… å®Œæˆ |
| `CustomNodeService` | èŠ‚ç‚¹ç®¡ç†ã€å®¡æ ¸ | âœ… å®Œæˆ |
| `WorkspaceContextService` | å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡ç®¡ç† | âœ… å®Œæˆ |
| `PluginValidatorService` | æ’ä»¶ä»£ç éªŒè¯ã€å®‰å…¨æ£€æŸ¥ | âœ… å®Œæˆ |
| `EncryptionService` | API Key åŠ å¯†å­˜å‚¨ | âœ… å®Œæˆ |

### âœ… å·²å®ç°çš„ Controllerï¼ˆé˜¶æ®µ 4ï¼Œ30%ï¼‰

**å·²å®Œæˆï¼š**
- `AdminPluginsController` - å¹³å°æ’ä»¶ç®¡ç†ï¼ˆç®¡ç†å‘˜ï¼‰
- `PluginsController` - ç”¨æˆ·æ’ä»¶ç®¡ç†

**è¿›è¡Œä¸­ï¼š**
- ğŸŸ¡ `BillingController` - è®¡è´¹ API
- ğŸŸ¡ `WorkspaceController` - å·¥ä½œç©ºé—´ç®¡ç†
- ğŸŸ¡ `PlatformAIController` - å¹³å° AI æœåŠ¡

## æ•°æ®åº“ E-R å…³ç³»å›¾ï¼ˆå·²å®ç°ï¼‰

```mermaid
erDiagram
    USER ||--o{ PROJECT_RELATION : "æˆå‘˜"
    PROJECT_RELATION }o--|| PROJECT : "æ‰€å±"

    PROJECT ||--o{ WORKFLOW : "æ‹¥æœ‰"
    PROJECT ||--o{ CREDENTIALS : "æ‹¥æœ‰"
    PROJECT ||--o{ CUSTOM_NODE : "æ‹¥æœ‰"
    PROJECT ||--o{ USAGE_RECORD : "è®¡è´¹è®°å½•"
    PROJECT ||--o{ WORKSPACE_QUOTA : "é…é¢é™åˆ¶"

    PLATFORM_AI_PROVIDER ||--o{ USAGE_RECORD : "æœåŠ¡è°ƒç”¨"
    CUSTOM_NODE ||--o{ PLATFORM_NODE : "å®¡æ ¸é€šè¿‡åè½¬ç§»"

    USER {
        uuid id PK
        string email
        string tier "free|pro|enterprise"
        boolean email_verified
        boolean is_admin
    }

    PROJECT {
        uuid id PK
        string name
        string type "personal|team"
        decimal balance_cny "å·¥ä½œç©ºé—´ä½™é¢"
        string status "active|archived"
    }

    WORKFLOW {
        uuid id PK
        uuid project_id FK "ç›´æ¥å½’å±å·¥ä½œç©ºé—´"
        boolean active
    }

    CREDENTIALS {
        uuid id PK
        uuid project_id FK "ç›´æ¥å½’å±å·¥ä½œç©ºé—´"
        boolean is_managed "å¹³å°æ‰˜ç®¡æ ‡è¯†"
    }

    USAGE_RECORD {
        uuid id PK
        uuid workspace_id FK
        uuid user_id FK
        string service_key
        int tokens_used
        decimal cost_cny "æ‰£è´¹é‡‘é¢"
    }

    PLATFORM_AI_PROVIDER {
        string provider_key PK
        jsonb api_config "åŠ å¯†å­˜å‚¨"
        jsonb models_config "æ¨¡å‹åˆ—è¡¨"
        decimal price_per_token
    }
```

## æ€§èƒ½ä¼˜åŒ–æˆæœ

| æŒ‡æ ‡ | æ”¹é€ å‰ | æ”¹é€ å | æå‡ |
|------|--------|--------|------|
| **æŸ¥è¯¢å±‚çº§** | 4 å±‚ JOIN | 3 å±‚ JOIN | â†‘ 30-40% |
| **å·¥ä½œæµæŸ¥è¯¢** | 150ms | < 100ms | â†‘ 33% |
| **å¹¶å‘æ‰£è´¹ TPS** | N/A | > 500 | - |

## å¾…å®Œæˆå·¥ä½œï¼ˆé˜¶æ®µ 4-8ï¼Œ27%ï¼‰

**é˜¶æ®µ 4ï¼šController + Middlewareï¼ˆå‰©ä½™ 70%ï¼‰**
- BillingController å®Œå–„
- WorkspaceController å®Œå–„
- PlatformAIController å®Œå–„

**é˜¶æ®µ 5ï¼šå‰ç«¯æ”¹é€ ï¼ˆ0%ï¼‰**
- å·¥ä½œç©ºé—´åˆ‡æ¢å™¨
- è´¦å•ä¸­å¿ƒ
- èŠ‚ç‚¹ç®¡ç†ç•Œé¢ï¼ˆæœ¬æ–‡æ¡£æ–°å¢å†…å®¹ï¼‰

**é˜¶æ®µ 6ï¼šæ”¯ä»˜é›†æˆï¼ˆ0%ï¼‰**
- æ”¯ä»˜å®æ¥å…¥
- å¾®ä¿¡æ”¯ä»˜æ¥å…¥

**é˜¶æ®µ 7-8ï¼šæµ‹è¯•å’Œä¸Šçº¿ï¼ˆ0%ï¼‰**
- é›†æˆæµ‹è¯•
- å‹åŠ›æµ‹è¯•
- æ–‡æ¡£å®Œå–„

## ä»£ç ä½ç½®ç´¢å¼•

**å·²å®Œæˆä»£ç ï¼š**
- æ•°æ®åº“è¿ç§»ï¼š`packages/@n8n/db/src/migrations/common/176250471*.ts`ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰
- Entity å±‚ï¼š`packages/@n8n/db/src/entities/`ï¼ˆ11ä¸ªæ–°å®ä½“ï¼‰
- Repository å±‚ï¼š`packages/@n8n/db/src/repositories/`ï¼ˆ11ä¸ªæ–°ä»“åº“ï¼‰
- Service å±‚ï¼š`packages/cli/src/services/`ï¼ˆ6ä¸ªæœåŠ¡ï¼Œ920è¡Œï¼‰
- Controller å±‚ï¼š`packages/cli/src/controllers/`ï¼ˆ2ä¸ªå·²å®Œæˆï¼‰

---

[â† è¿”å›æ€»è§ˆ](../00-æ€»è§ˆä¸å¯¼èˆª.md) | [ä¸‹ä¸€ç« ï¼šæ¶æ„æ€»è§ˆ â†’](./02-æ¶æ„æ€»è§ˆ.md)
