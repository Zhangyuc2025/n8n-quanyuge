# 架构总览

> **版本：** v1.0
> **状态：** 设计中

[← 返回总览](../00-总览与导航.md)

---

## 🏗️ 架构总览

### 系统架构图

```mermaid
graph TB
    subgraph "用户端"
        U[用户]
        WF[工作流编辑器]
        NS[节点选择器]
        NM[节点管理]
    end

    subgraph "节点来源"
        BN[内置节点<br/>142个<br/>文件系统]
        PN[平台节点<br/>platform_node表<br/>全平台可用]
        CN[自定义节点<br/>custom_node表<br/>工作空间私有]
    end

    subgraph "AI 服务"
        LCP[LmChatPlatform节点]
        PAP[platform_ai_provider表]
        OpenAI[OpenAI API]
        Anthropic[Anthropic API]
    end

    subgraph "后端服务"
        API[REST API]
        LoadSvc[LoadNodesAndCredentials]
        CNSvc[CustomNodeService]
        AISvc[PlatformAIService]
        Billing[计费服务]
    end

    U --> WF
    WF --> NS
    NS --> BN
    NS --> PN
    NS --> CN

    WF --> LCP
    LCP --> API
    API --> AISvc
    AISvc --> PAP
    AISvc --> OpenAI
    AISvc --> Anthropic
    AISvc --> Billing

    API --> LoadSvc
    LoadSvc --> BN
    LoadSvc --> PN
    LoadSvc --> CN

    API --> CNSvc
    CNSvc --> CN

    style BN fill:#51cf66
    style PN fill:#74c0fc
    style CN fill:#ffd43b
    style LCP fill:#ff6b6b
    style PAP fill:#ff6b6b
```

### 数据流程

```
节点加载流程：
┌─────────┐
│ 前端启动 │
└────┬────┘
     ↓
┌──────────────────────────┐
│ 调用 GET /node-types/    │
└────┬─────────────────────┘
     ↓
┌────────────────────────────────┐
│ LoadNodesAndCredentials        │
│ ├─ loadBuiltinNodes()          │  ← 文件系统（142个）
│ ├─ loadPlatformNodes()         │  ← platform_node 表
│ └─ loadWorkspaceNodes(wsId)    │  ← custom_node 表
└────┬───────────────────────────┘
     ↓
┌─────────────────────────┐
│ validateNodeMetadata()  │  ← 验证元数据完整性
└────┬────────────────────┘
     ↓
┌─────────────────────────┐
│ 返回节点列表             │
│ [内置 + 平台 + 自定义]   │
└────┬────────────────────┘
     ↓
┌─────────────────────────┐
│ 前端渲染节点选择器       │
│ ├─ Tab 1: 基础节点      │
│ ├─ Tab 2: 扩展节点      │
│ └─ Tab 3: 我的节点      │
└─────────────────────────┘
```

```
AI 调用流程：
┌──────────────────┐
│ 用户运行工作流     │
└────┬─────────────┘
     ↓
┌─────────────────────────────────┐
│ LmChatPlatform.supplyData()     │
│ providerKey = "openai"          │
│ modelId = "gpt-4-turbo"         │
└────┬────────────────────────────┘
     ↓
┌──────────────────────────────────────────────┐
│ POST /platform-ai-providers/openai/chat/     │
│      completions                             │
│ Body: { model, messages, temperature... }   │
└────┬─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ PlatformAIController                │
│ └─ platformAIService.chat()         │
└────┬────────────────────────────────┘
     ↓
┌──────────────────────────────────────────┐
│ 1. 从 platform_ai_provider 获取 API Key │
│ 2. 调用上游 OpenAI API                  │
│ 3. 记录使用量                           │
│ 4. 计费并扣除余额                       │
│ 5. 返回 AI 响应                         │
└────┬─────────────────────────────────────┘
     ↓
┌────────────────┐
│ 返回给用户      │
└────────────────┘
```

---


[← 上一章：多租户架构](./01-多租户架构.md) | [返回总览](../00-总览与导航.md) | [下一章：数据库设计 →](./03-数据库设计.md)
