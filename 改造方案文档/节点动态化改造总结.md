# n8n 节点动态化改造总结

> **文档版本：** v2.0（架构调整版）
> **创建日期：** 2025-01-10
> **更新日期：** 2025-01-10
> **状态：** 架构调整完成

---

## 📋 文档目的

本文档总结了 n8n 多租户 SaaS 改造过程中的节点动态化设计，记录了从发现问题到最终解决方案的完整过程。

**v2.0 重要调整：** 删除用户端 npm 安装功能，只允许管理员添加社区节点。

---

## 🔍 问题发现

### 1. 多租户安全问题

**背景：** 在分析 n8n 社区节点安装机制时发现，原有系统允许用户直接从 npm 安装包到服务器文件系统（`node_modules`）。

**风险分析：**

| 风险类型 | 严重性 | 具体问题 |
|---------|-------|---------|
| **安全风险** | 🔴 高 | 用户可安装恶意代码到服务器，影响所有租户 |
| **隔离问题** | 🔴 高 | 租户 A 安装的节点可能被租户 B 访问 |
| **权限混乱** | 🟡 中 | 普通用户不应有修改服务器文件系统的权限 |
| **运维复杂** | 🟡 中 | 每个租户安装的包都污染全局 `node_modules` |

### 2. 凭证系统兼容性问题

**背景：** 改造方案废弃了 n8n 原有的 Credentials 系统，但社区节点都是基于该系统开发的。

**问题表现：**

```typescript
// 社区节点代码示例（GitHub 节点）
export class GitHub implements INodeType {
  description: INodeTypeDescription = {
    credentials: [
      {
        name: 'githubApi',  // 引用凭证类型
        required: true,
      }
    ],
  }

  async execute(this: IExecuteFunctions) {
    const credentials = await this.getCredentials('githubApi');
    const token = credentials.accessToken;
    // ...
  }
}
```

**冲突点：**
- 原系统：`credentials` 字段 + `getCredentials()` API
- 新系统：节点参数 + `getNodeParameter()` API
- 需要手动改造每个节点

### 3. 自动转换的问题

**原计划：** 使用 AST 自动转换社区节点凭证为参数

**实际问题：**
- ❌ 节点结构千奇百怪，自动转换成功率低
- ❌ 复杂的认证逻辑（OAuth2, JWT）难以自动处理
- ❌ 汉化工作量巨大（2000+ 节点 × 50+ 翻译）
- ❌ 每个工作空间重复安装浪费资源

---

## 💡 最终解决方案（v2.0 调整）

### 三层节点架构

**核心调整：删除用户端 npm 安装，只允许管理员添加**

```
┌─────────────────────────────────────────────────────────────┐
│  多租户 SaaS 平台 - 三层节点架构（v2.0）                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Layer 1: 内置基础节点（53个）                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 📁 文件系统加载                                      │    │
│  │ Set, If, Code, Switch, Merge, Filter...             │    │
│  │ 源码位置: packages/nodes-base/nodes/*/*.node.ts     │    │
│  │ 无凭证依赖，纯逻辑节点                               │    │
│  │ 所有用户可用                                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                           ↓                                  │
│  Layer 2: 平台节点（管理员添加）                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 💾 数据库加载: platform_node 表                      │    │
│  │                                                      │    │
│  │ 2.1 平台托管节点（Platform Managed）                │    │
│  │     ├─ OpenAI Chat（平台API Key + 按量计费）        │    │
│  │     ├─ Claude Chat（平台API Key + 按量计费）        │    │
│  │     └─ 用户无需配置，开箱即用                        │    │
│  │                                                      │    │
│  │ 2.2 第三方节点（Third Party）                       │    │
│  │     ├─ GitHub（用户配置自己的Token）                │    │
│  │     ├─ Slack（用户配置自己的Token）                 │    │
│  │     └─ 管理员从npm精选、手动改造、汉化              │    │
│  │                                                      │    │
│  │ 加载方式: PlatformNodesService.loadAll()            │    │
│  │ 可用范围: 所有用户可见                               │    │
│  │ 维护者: 管理员统一管理                               │    │
│  └─────────────────────────────────────────────────────┘    │
│                           ↓                                  │
│  Layer 3: 用户自定义节点（User Custom）                     │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 💾 数据库加载: custom_node 表                        │    │
│  │ 用户编写TypeScript代码上传                           │    │
│  │ VM2 沙箱隔离执行                                     │    │
│  │ 仅自己工作空间可用                                   │    │
│  │ 可选提交审核 → 通过后变成 Layer 2                   │    │
│  │ 加载方式: CustomNodesService.loadWorkspaceNodes()   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 关键决策

### ❌ 删除功能：用户端 npm 安装

**理由：**
1. **安全性**：每个用户安装 npm 包引入安全风险
2. **自动转换不可靠**：节点结构复杂，自动转换凭证成功率低
3. **汉化工作量巨大**：2000+ 节点无法统一汉化
4. **资源浪费**：多个工作空间重复安装相同节点
5. **对标 Coze**：Coze 不允许用户安装插件，只能使用平台提供的

**删除的功能模块：**
```typescript
// 后端
- NpmDownloadService（npm 下载）
- CredentialConverterService（自动凭证转换）
- WorkflowConverterService（工作流导入转换）
- POST /rest/custom-nodes/install-from-npm（安装接口）

// 前端
- NpmNodeSearch.vue（npm 搜索界面）
- NpmNodeInstall.vue（安装界面）
```

---

### ✅ 保留功能：管理员添加 + 用户上传

**管理员添加流程：**
```
1. 管理员从 npm 挑选优质节点
   ↓
2. 下载到本地，手动改造：
   - 凭证转换（credentials → properties）
   - 汉化（displayName, description 等）
   - 测试验证
   ↓
3. 上传到管理员后台
   ↓
4. 选择节点类型：
   - 平台托管（配置平台 API Key + 计费规则）
   - 第三方（用户自己配置认证）
   ↓
5. 启用 → 所有用户可见
```

**用户需求流程：**
```
用户需要某个节点
  ↓
【方案1】自己编写
  ├─ 编写 TypeScript 代码
  ├─ 上传到"我的节点"
  ├─ 立即可用（仅自己工作空间）
  └─ （可选）提交审核 → 全平台可用

【方案2】联系管理员
  ├─ 提交节点请求
  ├─ 管理员评估优先级
  ├─ 管理员改造上传
  └─ 全员可用
```

---

## 📊 数据库设计

### platform_node 表（平台节点）

```sql
CREATE TABLE platform_node (
  -- 主键
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 基本信息
  node_key VARCHAR(100) NOT NULL UNIQUE,
  node_name VARCHAR(200) NOT NULL,
  version VARCHAR(50) DEFAULT '1.0.0',

  -- 节点来源（关键字段）
  node_source VARCHAR(50) NOT NULL CHECK (
    node_source IN ('platform_managed', 'third_party')
  ),

  -- npm 信息（如果来源于 npm）
  npm_package_name VARCHAR(200),
  npm_version VARCHAR(50),
  npm_author VARCHAR(200),

  -- 节点定义和代码
  node_definition JSONB NOT NULL,
  node_code TEXT NOT NULL,

  -- 平台托管节点字段
  platform_api_key_encrypted TEXT,  -- 平台 API Key（加密）
  pricing_config JSONB,  -- 计费配置

  -- 状态
  is_enabled BOOLEAN DEFAULT true,

  -- 元数据
  description TEXT,
  icon_url VARCHAR(500),
  documentation_url VARCHAR(500),

  -- 创建信息
  created_by UUID NOT NULL REFERENCES user(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_platform_node_source ON platform_node(node_source);
CREATE INDEX idx_platform_node_enabled ON platform_node(is_enabled);
```

### custom_node 表（用户自定义节点）

```sql
CREATE TABLE custom_node (
  -- 主键
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 关联信息
  workspace_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,

  -- 基本信息
  node_key VARCHAR(100) NOT NULL,
  node_name VARCHAR(200) NOT NULL,
  version VARCHAR(50) DEFAULT '1.0.0',

  -- 节点来源（固定为 user_upload）
  node_source VARCHAR(50) NOT NULL DEFAULT 'user_upload',

  -- 节点定义和代码
  node_definition JSONB NOT NULL,
  node_code TEXT NOT NULL,

  -- 安全配置
  sandbox_enabled BOOLEAN DEFAULT true,
  sandbox_timeout INTEGER DEFAULT 30000,
  code_signature TEXT,

  -- 审核状态
  review_status VARCHAR(50) DEFAULT 'draft' CHECK (
    review_status IN ('draft', 'pending', 'approved', 'rejected')
  ),
  review_note TEXT,
  reviewed_by UUID REFERENCES user(id),
  reviewed_at TIMESTAMP,

  -- 创建信息
  created_by UUID NOT NULL REFERENCES user(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- 唯一约束：工作空间内节点 key 唯一
  UNIQUE(workspace_id, node_key)
);

CREATE INDEX idx_custom_node_workspace ON custom_node(workspace_id);
CREATE INDEX idx_custom_node_review_status ON custom_node(review_status);
```

### 废弃表迁移

```sql
-- 1. 备份数据
pg_dump -t installed_packages -t installed_nodes > backup.sql

-- 2. 删除废弃表（无需迁移，全新架构）
DROP TABLE IF EXISTS installed_nodes;
DROP TABLE IF EXISTS installed_packages;
```

---

## 🔐 安全措施

### 1. VM2 沙箱隔离

```typescript
import { VM } from 'vm2';

@Service()
export class NodeCompilerService {
  compileNodeCode(code: string): any {
    const vm = new VM({
      timeout: 5000,
      sandbox: {
        require: this.createSecureRequire(),
        console,
        Buffer,
      },
      eval: false,
      wasm: false,
    });

    return vm.run(code);
  }

  private createSecureRequire(allowedModules: string[]): any {
    return (moduleName: string) => {
      // 白名单验证
      if (!allowedModules.includes(moduleName)) {
        throw new Error(`Module '${moduleName}' is not allowed`);
      }
      return require(moduleName);
    };
  }
}
```

### 2. 代码验证

```typescript
@Service()
export class CodeValidationService {
  private dangerousFunctions = [
    'eval', 'Function', 'execSync', 'exec', 'spawn',
  ];

  async validateNodeCode(code: string): Promise<ValidationResult> {
    const errors: string[] = [];

    // 检测危险函数
    for (const dangerousFunc of this.dangerousFunctions) {
      if (code.includes(dangerousFunc)) {
        errors.push(`Dangerous function detected: ${dangerousFunc}`);
      }
    }

    // 生成代码签名
    const signature = createHash('sha256').update(code).digest('hex');

    return {
      isValid: errors.length === 0,
      errors,
      signature,
    };
  }
}
```

---

## 🎯 实施清单

### 后端任务

- [x] **数据库迁移**
  - [x] 创建 platform_node 表
  - [x] 创建 custom_node 表
  - [x] 删除 installed_packages, installed_nodes

- [ ] **Service 层**
  - [ ] 实现 PlatformNodesService（管理员管理平台节点）
  - [ ] 实现 CustomNodesService（用户自定义节点）
  - [ ] 实现 NodeCompilerService（VM2 沙箱编译）
  - [ ] 实现 CodeValidationService（代码安全验证）

- [ ] **Controller 层**
  - [ ] 实现 AdminPlatformNodesController（管理员添加节点）
  - [ ] 实现 CustomNodesController（用户上传节点）
  - [ ] 实现 NodeReviewController（审核用户提交）

### 前端任务

- [ ] **管理员后台**
  - [ ] PlatformNodeUpload.vue（上传节点界面）
  - [ ] NodeTypeSelector.vue（选择平台托管/第三方）
  - [ ] ApiKeyConfig.vue（配置平台API Key）
  - [ ] NodeReviewQueue.vue（审核队列）

- [ ] **用户端**
  - [ ] CustomNodeUpload.vue（上传自定义节点）
  - [ ] NodeSelector.vue（节点选择器 - 三层展示）

---

## 📈 预期收益

### 1. 安全性提升

| 指标 | 改造前 | 改造后 | 提升 |
|------|--------|--------|------|
| **用户安装风险** | 🔴 每个用户可安装 | ✅ 只有管理员 | 🔒 完全隔离 |
| **恶意代码防护** | ❌ 无防护 | ✅ VM2 沙箱 | 🔒 沙箱隔离 |
| **代码审查** | ❌ 无 | ✅ 自动验证 | 🔒 拦截危险函数 |

### 2. 用户体验

| 指标 | 改造前 | 改造后 | 效果 |
|------|--------|--------|------|
| **节点可用性** | 🔴 需自己安装 | ✅ 管理员提供 | ✨ 开箱即用 |
| **汉化质量** | ❌ 无汉化 | ✅ 统一汉化 | ✨ 中文友好 |
| **节点质量** | 🟡 参差不齐 | ✅ 管理员把关 | ✨ 质量保证 |

### 3. 运维简化

| 指标 | 改造前 | 改造后 | 效果 |
|------|--------|--------|------|
| **资源占用** | 🔴 重复安装 | ✅ 全局共享 | ⬇️ 减少90% |
| **维护成本** | 🔴 每用户独立 | ✅ 统一维护 | ⬇️ 减少80% |

---

## 🔚 总结

### 核心成果

1. **三层节点架构**：内置基础 + 平台节点（管理员） + 用户自定义
2. **多租户安全**：管理员统一添加，VM2 沙箱隔离
3. **用户体验优化**：开箱即用，统一汉化，质量保证
4. **运维简化**：全局共享，统一维护

### 技术亮点

- **删除复杂功能**：不再需要自动凭证转换、npm 下载服务
- **VM2 沙箱**：安全隔离，防止恶意代码
- **审核机制**：用户可贡献节点，管理员审核后全平台共享
- **灵活性**：用户可自己上传节点立即使用

### 对标 Coze

- ✅ 平台统一提供节点（类似 Coze 插件）
- ✅ 用户无需配置（平台托管节点）
- ✅ 质量有保证（管理员审核）
- ✅ 开箱即用（统一汉化）

---

**文档版本：** v2.0（架构调整版）
**创建日期：** 2025-01-10
**更新日期：** 2025-01-10
**作者：** 改造方案团队
**状态：** ✅ 架构调整完成，待实施
