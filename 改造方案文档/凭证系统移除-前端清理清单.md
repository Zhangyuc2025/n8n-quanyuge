# å‡­è¯ç³»ç»Ÿç§»é™¤ - å‰ç«¯æ¸…ç†æ¸…å•

> **ç­–ç•¥ï¼š** æ•°æ®åº“ç›´æ¥åˆ é™¤ï¼Œå‰ç«¯å…¨é¢æ¸…ç†å‡­è¯å¼•ç”¨
> **é¢„è®¡å·¥æ—¶ï¼š** 1 å¤©
> **å¤æ‚åº¦ï¼š** ä¸­ç­‰

---

## ğŸ¯ æ¸…ç†ç­–ç•¥

### æ ¸å¿ƒåŸåˆ™
1. **ä¸ä¿ç•™ä»»ä½•å‡­è¯ç›¸å…³ä»£ç **
2. **åˆ é™¤æ‰€æœ‰ credentials å­—æ®µå¤„ç†é€»è¾‘**
3. **ç®€åŒ–èŠ‚ç‚¹å‚æ•°ï¼Œåªä¿ç•™å¿…è¦é…ç½®**

---

## ğŸ“‹ åˆ†ä¼˜å…ˆçº§æ¸…ç†æ¸…å•

### P0ï¼šæ ¸å¿ƒæµç¨‹æ–‡ä»¶ï¼ˆå¿…é¡»ä¿®å¤ï¼Œå¦åˆ™æ„å»ºå¤±è´¥ï¼‰

| æ–‡ä»¶ | å‡­è¯å¼•ç”¨ | å¤„ç†æ–¹å¼ | é¢„ä¼°å·¥æ—¶ |
|------|---------|---------|---------|
| **workflows.store.ts** | `usedCredentials` å­—æ®µ | åˆ é™¤æ•´ä¸ª `usedCredentials` ç›¸å…³é€»è¾‘ | 1h |
| **useCanvasOperations.ts** | `credentialsStore`ã€`matchCredentials` ç­‰ | åˆ é™¤å‡­è¯åŒ¹é…ã€è¿‡æ»¤ã€éªŒè¯é€»è¾‘ | 2h |
| **useNodeHelpers.ts** | `credentialsUpdated`ã€`updateNodeCredentialIssues` | åˆ é™¤å‡­è¯éªŒè¯æ–¹æ³• | 1h |
| **nodeTypes.store.ts** | `credentialOnlyNodes` ç­‰ | åˆ é™¤å‡­è¯èŠ‚ç‚¹åˆ†ç±»é€»è¾‘ | 1h |
| **NodeView.vue** | å‡­è¯ç›¸å…³ UI é€»è¾‘ | åˆ é™¤å‡­è¯æç¤ºã€é”™è¯¯å¤„ç† | 0.5h |

**å°è®¡ï¼š** 5.5 å°æ—¶

---

### P1ï¼šUI ç»„ä»¶ï¼ˆå½±å“ç”¨æˆ·ç•Œé¢ï¼‰

| æ–‡ä»¶ | å‡­è¯å¼•ç”¨ | å¤„ç†æ–¹å¼ | é¢„ä¼°å·¥æ—¶ |
|------|---------|---------|---------|
| **useCredentialNavigationCommands.ts** | æ•´ä¸ªæ–‡ä»¶ | **ç›´æ¥åˆ é™¤æ•´ä¸ªæ–‡ä»¶** âœ… | 0.1h |
| **ProjectMoveResourceModal.vue** | å‡­è¯ç§»åŠ¨åŠŸèƒ½ | åˆ é™¤å‡­è¯ç›¸å…³ä»£ç ï¼Œåªä¿ç•™å·¥ä½œæµç§»åŠ¨ | 0.5h |
| **ProjectMoveResourceModalCredentialsList.vue** | æ•´ä¸ªæ–‡ä»¶ | **ç›´æ¥åˆ é™¤æ•´ä¸ªæ–‡ä»¶** âœ… | 0.1h |
| **useActionsGeneration.ts** | `httpOnlyCredentials` | åˆ é™¤ HTTP å‡­è¯ç›¸å…³é€»è¾‘ | 0.5h |
| **setupTemplate.store.ts** | æ¨¡æ¿å‡­è¯æ˜ å°„ | åˆ é™¤å‡­è¯æ›¿æ¢é€»è¾‘ | 1h |
| **logStreaming.utils.ts** | `INodeCredentials` | åˆ é™¤å‡­è¯é…ç½® | 0.5h |

**å°è®¡ï¼š** 2.7 å°æ—¶

---

### P2ï¼šæµ‹è¯•æ–‡ä»¶ï¼ˆéœ€è¦é‡å†™æˆ–åˆ é™¤ï¼‰

| æ–‡ä»¶ | å¤„ç†æ–¹å¼ | é¢„ä¼°å·¥æ—¶ |
|------|---------|---------|
| `useCredentialNavigationCommands.test.ts` | **ç›´æ¥åˆ é™¤** âœ… | 0.1h |
| `workflows.store.test.ts` | åˆ é™¤å‡­è¯ç›¸å…³æµ‹è¯•ç”¨ä¾‹ | 0.5h |
| `cloudStoreUtils.ts` | åˆ é™¤å‡­è¯æµ‹è¯•æ•°æ® | 0.3h |
| å…¶ä»–æµ‹è¯•æ–‡ä»¶ï¼ˆ9 ä¸ªï¼‰ | æ‰¹é‡åˆ é™¤å‡­è¯ç›¸å…³æ–­è¨€ | 1h |

**å°è®¡ï¼š** 1.9 å°æ—¶

---

### P3ï¼šç±»å‹å®šä¹‰æ¸…ç†

| æ–‡ä»¶ | å¤„ç†æ–¹å¼ | é¢„ä¼°å·¥æ—¶ |
|------|---------|---------|
| `@/types/*` | åˆ é™¤ `INodeCredentials`ã€`ICredential*` ç±»å‹å¯¼å‡º | 0.5h |
| `features/credentials/credentials.types.ts` | **å·²åˆ é™¤** âœ… | - |

**å°è®¡ï¼š** 0.5 å°æ—¶

---

## ğŸ“ å¯ä»¥ç›´æ¥åˆ é™¤çš„å®Œæ•´æ–‡ä»¶åˆ—è¡¨

ä»¥ä¸‹ 11 ä¸ªæ–‡ä»¶å¯ä»¥**æ•´ä¸ªåˆ é™¤**ï¼Œæ— éœ€ä¿®æ”¹ï¼š

```bash
# å‡­è¯å¯¼èˆªå‘½ä»¤
rm packages/frontend/editor-ui/src/features/shared/commandBar/composables/useCredentialNavigationCommands.ts
rm packages/frontend/editor-ui/src/features/shared/commandBar/composables/useCredentialNavigationCommands.test.ts

# é¡¹ç›®å‡­è¯ç§»åŠ¨ç»„ä»¶
rm packages/frontend/editor-ui/src/features/collaboration/projects/components/ProjectMoveResourceModalCredentialsList.vue

# å‡­è¯ç›¸å…³æµ‹è¯•
rm packages/frontend/editor-ui/src/app/stores/__tests__/utils/cloudStoreUtils.ts

# å…¶ä»–å‡­è¯ç»„ä»¶ï¼ˆå¦‚æœè¿˜æœ‰çš„è¯ï¼‰
find packages/frontend/editor-ui -name "*credential*" -type f | grep -E "\.(vue|ts)$"
```

---

## ğŸ”§ æ ¸å¿ƒæ–‡ä»¶ä¿®æ”¹è¯¦è§£

### 1. workflows.store.ts

**å½“å‰é—®é¢˜ï¼š**
```typescript
// å­˜å‚¨ä½¿ç”¨çš„å‡­è¯
usedCredentials: Record<string, IUsedCredential>

// å·¥ä½œæµä¿å­˜æ—¶è¿‡æ»¤å‡­è¯
filterAllowedCredentials(credentials, usedCredentials)
```

**ä¿®æ”¹æ–¹æ¡ˆï¼š**
```typescript
// 1. åˆ é™¤ usedCredentials çŠ¶æ€
- usedCredentials: Record<string, IUsedCredential>

// 2. åˆ é™¤å‡­è¯ç›¸å…³æ–¹æ³•
- filterAllowedCredentials()
- setUsedCredentials()
- updateUsedCredentials()

// 3. å·¥ä½œæµä¿å­˜æ—¶ç§»é™¤ credentials å­—æ®µ
function sanitizeWorkflowData(workflow: IWorkflowDb) {
  const nodes = workflow.nodes.map(node => {
    const { credentials, ...rest } = node; // ç›´æ¥åˆ é™¤
    return rest;
  });
  return { ...workflow, nodes };
}
```

**é¢„è®¡ä¿®æ”¹ä½ç½®ï¼š** ~15 å¤„

---

### 2. useCanvasOperations.ts

**å½“å‰é—®é¢˜ï¼š**
```typescript
import { useCredentialsStore } from '@/features/credentials/credentials.store';
const credentialsStore = useCredentialsStore();

// å„ç§å‡­è¯ç›¸å…³æ–¹æ³•è°ƒç”¨
nodeHelpers.matchCredentials(node)
nodeHelpers.updateNodeCredentialIssues(node)
removeUnknownCredentials(workflow)
filterAllowedCredentials(credentials, usedCredentials)
```

**ä¿®æ”¹æ–¹æ¡ˆï¼š**
```typescript
// 1. åˆ é™¤å¯¼å…¥
- import { useCredentialsStore } from '@/features/credentials/credentials.store';
- import type { IUsedCredential } from '@/features/credentials/credentials.types';

// 2. åˆ é™¤ store åˆå§‹åŒ–
- const credentialsStore = useCredentialsStore();

// 3. åˆ é™¤æ‰€æœ‰å‡­è¯ç›¸å…³æ–¹æ³•è°ƒç”¨
- nodeHelpers.matchCredentials(node)           âœ… åˆ é™¤
- nodeHelpers.updateNodeCredentialIssues(node) âœ… åˆ é™¤
- removeUnknownCredentials(workflow)           âœ… åˆ é™¤æ•´ä¸ªå‡½æ•°
- filterAllowedCredentials(...)                âœ… åˆ é™¤æ•´ä¸ªå‡½æ•°

// 4. å·¥ä½œæµæ•°æ®æ¸…ç†ï¼ˆä¿ç•™è¿™ä¸ªï¼‰
function cleanWorkflowData(data: WorkflowDataUpdate) {
  // æ¸…ç†èŠ‚ç‚¹ä¸­çš„ credentials å­—æ®µ
  data.nodes = data.nodes.map(node => {
    const { credentials, ...rest } = node;
    return rest;
  });
  return data;
}
```

**é¢„è®¡ä¿®æ”¹ä½ç½®ï¼š** ~10 å¤„

---

### 3. nodeTypes.store.ts

**å½“å‰é—®é¢˜ï¼š**
```typescript
// å‡­è¯èŠ‚ç‚¹åˆ†ç±»
credentialOnlyNodes: INodeTypeDescription[]
```

**ä¿®æ”¹æ–¹æ¡ˆï¼š**
```typescript
// åˆ é™¤æ•´ä¸ª credentialOnlyNodes è®¡ç®—å±æ€§å’Œç›¸å…³é€»è¾‘
- credentialOnlyNodes: ...
```

**é¢„è®¡ä¿®æ”¹ä½ç½®ï¼š** ~5 å¤„

---

### 4. useNodeHelpers.ts

**å½“å‰é—®é¢˜ï¼š**
```typescript
credentialsUpdated: Ref<boolean>
updateNodeCredentialIssues(node)
matchCredentials(node)
```

**ä¿®æ”¹æ–¹æ¡ˆï¼š**
```typescript
// å…¨éƒ¨åˆ é™¤
- credentialsUpdated
- updateNodeCredentialIssues()
- matchCredentials()
```

**é¢„è®¡ä¿®æ”¹ä½ç½®ï¼š** ~8 å¤„

---

## âš¡ æ‰¹é‡ä¿®æ”¹è„šæœ¬

### æŸ¥æ‰¾æ‰€æœ‰å‡­è¯å¼•ç”¨

```bash
# æŸ¥æ‰¾æ‰€æœ‰å‡­è¯ç›¸å…³å¯¼å…¥
grep -r "from.*credentials" packages/frontend/editor-ui/src --include="*.ts" --include="*.vue"

# æŸ¥æ‰¾æ‰€æœ‰ credentialsStore ä½¿ç”¨
grep -r "credentialsStore" packages/frontend/editor-ui/src --include="*.ts" --include="*.vue"

# æŸ¥æ‰¾æ‰€æœ‰å‡­è¯ç±»å‹ä½¿ç”¨
grep -r "INodeCredentials\|ICredential" packages/frontend/editor-ui/src --include="*.ts"
```

### è‡ªåŠ¨åˆ é™¤å¯¼å…¥è¯­å¥

```bash
# åˆ é™¤å‡­è¯ store å¯¼å…¥
find packages/frontend/editor-ui/src -type f \( -name "*.ts" -o -name "*.vue" \) -exec \
  sed -i "/import.*useCredentialsStore.*from/d" {} \;

# åˆ é™¤å‡­è¯ç±»å‹å¯¼å…¥
find packages/frontend/editor-ui/src -type f \( -name "*.ts" -o -name "*.vue" \) -exec \
  sed -i "/import.*ICredential.*from.*credentials.types/d" {} \;
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### æ„å»ºæµ‹è¯•
```bash
# å‰ç«¯æ„å»º
cd packages/frontend/editor-ui
pnpm typecheck
pnpm lint
pnpm build

# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‡­è¯å¼•ç”¨
grep -r "credentialsStore\|ICredential" src --include="*.ts" --include="*.vue" | wc -l
# é¢„æœŸè¾“å‡ºï¼š0
```

### ä»£ç æ£€æŸ¥
```bash
# ä¸åº”è¯¥æœ‰è¿™äº›å¯¼å…¥
! grep -r "from '@/features/credentials" packages/frontend/editor-ui/src
! grep -r "useCredentialsStore" packages/frontend/editor-ui/src
! grep -r "IUsedCredential" packages/frontend/editor-ui/src
```

---

## ğŸ“Š å·¥æ—¶æ€»è®¡

| ä¼˜å…ˆçº§ | å·¥æ—¶ |
|--------|------|
| P0 æ ¸å¿ƒæµç¨‹ | 5.5h |
| P1 UI ç»„ä»¶ | 2.7h |
| P2 æµ‹è¯• | 1.9h |
| P3 ç±»å‹ | 0.5h |
| **æ€»è®¡** | **10.6h â‰ˆ 1.5 å¤©** |

åŠ ä¸Šæ„å»ºæµ‹è¯•å’Œä¿®å¤ï¼Œé¢„è®¡ **1-2 å¤©**å®Œæˆã€‚

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. å…ˆæ‰§è¡Œæ•°æ®åº“æ¸…ç†è„šæœ¬
2. åˆ é™¤å¯ä»¥ç›´æ¥åˆ é™¤çš„ 11 ä¸ªæ–‡ä»¶
3. æŒ‰ P0 â†’ P1 â†’ P2 â†’ P3 é¡ºåºä¿®å¤
4. æ¯ä¿®å¤ 5 ä¸ªæ–‡ä»¶è¿è¡Œä¸€æ¬¡ `pnpm typecheck`
5. å…¨éƒ¨å®Œæˆåè¿è¡Œå®Œæ•´æ„å»º

---

**åˆ›å»ºæ—¥æœŸï¼š** 2025-01-10
**ç»´æŠ¤è€…ï¼š** å¼€å‘å›¢é˜Ÿ
