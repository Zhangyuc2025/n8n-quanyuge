# æ—§æ¶æ„é—ç•™ä»£ç æ¸…ç†æ¸…å•

> **åˆ›å»ºæ—¥æœŸ**: 2025-11-08
> **çŠ¶æ€**: å¾…æ¸…ç†
> **ä¼˜å…ˆçº§**: P1ï¼ˆå»ºè®®åœ¨æµ‹è¯•é€šè¿‡åç«‹å³æ¸…ç†ï¼‰

---

## ğŸ“‹ æ¸…ç†æ¦‚è¿°

æ¦‚å¿µä¿®æ­£å®Œæˆåï¼Œå‘ç°ä»¥ä¸‹æ—§æ¶æ„çš„é—ç•™ä»£ç éœ€è¦æ¸…ç†ã€‚è¿™äº›æ–‡ä»¶åŸºäºé”™è¯¯çš„æ¦‚å¿µè®¾è®¡ï¼Œå·²è¢«æ–°æ¶æ„å®Œå…¨æ›¿ä»£ã€‚

**æ€»è®¡éœ€è¦æ¸…ç†**: çº¦ 40+ ä¸ªæ–‡ä»¶

---

## ğŸ—‘ï¸ éœ€è¦åˆ é™¤çš„æ–‡ä»¶æ¸…å•

### 1. æ•°æ®åº“å±‚ (3ä¸ªæ—§è¿ç§»æ–‡ä»¶)

**ä½ç½®**: `packages/@n8n/db/src/migrations/common/`

```bash
# âŒ éœ€è¦åˆ é™¤çš„è¿ç§»æ–‡ä»¶
1762511302220-CreatePlatformServiceTables.ts          # 12KB - åˆ›å»ºplatform_serviceè¡¨ï¼ˆé”™è¯¯è®¾è®¡ï¼‰
1762511302660-ExtendPlatformServiceForPlugins.ts      # 8.1KB - æ‰©å±•platform_serviceï¼ˆé”™è¯¯è®¾è®¡ï¼‰
1762511302880-CreateWorkspacePluginCredentialsTable.ts # 3.4KB - åˆ›å»ºworkspace_plugin_credentialsï¼ˆé”™è¯¯è®¾è®¡ï¼‰
```

**åˆ é™¤åŸå› **:
- åŸºäºé”™è¯¯çš„æ¦‚å¿µï¼ˆå¤§æ¨¡å‹å½“èŠ‚ç‚¹ã€æ’ä»¶èŠ‚ç‚¹åˆ†ç¦»ï¼‰
- å·²è¢«æ–°è¿ç§» `1762511303000-RedesignPlatformArchitecture.ts` æ›¿ä»£
- æ–°è¿ç§»ä¼šåˆ é™¤è¿™äº›æ—§è¿ç§»åˆ›å»ºçš„è¡¨

**æ³¨æ„äº‹é¡¹**:
âš ï¸ åˆ é™¤å‰ç¡®ä¿æ–°è¿ç§»å·²æˆåŠŸæ‰§è¡Œï¼æ–°è¿ç§»ä¼šåœ¨ `down()` æ–¹æ³•ä¸­å¤„ç†æ•°æ®å›æ»šã€‚

---

### 2. Entity å±‚ (2ä¸ªæ–‡ä»¶)

**ä½ç½®**: `packages/@n8n/db/src/entities/`

```bash
# âŒ éœ€è¦åˆ é™¤çš„Entityæ–‡ä»¶
platform-service.entity.ts                # åŸºäºé”™è¯¯çš„platform_serviceè¡¨
workspace-plugin-credentials.entity.ts    # åŸºäºé”™è¯¯çš„å‡­è¯è®¾è®¡
```

**åˆ é™¤åŸå› **:
- `platform-service.entity.ts`: æ··åˆäº†AIæ¨¡å‹å’Œæ’ä»¶æ¦‚å¿µï¼Œå·²è¢«æ‹†åˆ†ä¸º `platform-ai-provider.entity.ts` å’Œ `platform-node.entity.ts`
- `workspace-plugin-credentials.entity.ts`: å†—ä½™çš„å‡­è¯ç³»ç»Ÿï¼Œå·²è¢« `user-node-config.entity.ts` æ›¿ä»£

**åˆ é™¤åéœ€è¦ä¿®æ”¹**:
- `packages/@n8n/db/src/entities/index.ts` - ç§»é™¤è¿™ä¸¤ä¸ªEntityçš„å¯¼å‡º

---

### 3. Repository å±‚ (2ä¸ªæ–‡ä»¶)

**ä½ç½®**: `packages/@n8n/db/src/repositories/`

```bash
# âŒ éœ€è¦åˆ é™¤çš„Repositoryæ–‡ä»¶
platform-service.repository.ts                # å¯¹åº”platform-service.entity.ts
workspace-plugin-credentials.repository.ts    # å¯¹åº”workspace-plugin-credentials.entity.ts
```

**åˆ é™¤åŸå› **: ä¸å¯¹åº”çš„Entityä¸€èµ·åºŸå¼ƒ

**åˆ é™¤åéœ€è¦ä¿®æ”¹**:
- `packages/@n8n/db/src/repositories/index.ts` - ç§»é™¤è¿™ä¸¤ä¸ªRepositoryçš„å¯¼å‡º

---

### 4. Service å±‚ (2ä¸ªæ–‡ä»¶)

**ä½ç½®**: `packages/cli/src/services/`

```bash
# âŒ éœ€è¦åˆ é™¤çš„Serviceæ–‡ä»¶
platform-service.service.ts      # 14KB - æ··åˆäº†AIæœåŠ¡å’Œæ’ä»¶ç®¡ç†é€»è¾‘
plugin-validator.service.ts      # æ’ä»¶éªŒè¯æœåŠ¡ï¼ˆå¯é€‰åˆ é™¤ï¼‰
```

**åˆ é™¤åŸå› **:
- `platform-service.service.ts`: åŠŸèƒ½å·²è¢«æ‹†åˆ†åˆ° `platform-ai-provider.service.ts`ã€`platform-node.service.ts` å’Œ `custom-node.service.ts`
- `plugin-validator.service.ts`: å¦‚æœåªç”¨äºæ—§çš„æ’ä»¶ç³»ç»Ÿï¼Œå¯ä»¥åˆ é™¤ï¼›å¦‚æœæœ‰é€šç”¨éªŒè¯é€»è¾‘ï¼Œå¯ä»¥ä¿ç•™å¹¶é‡æ„

**âš ï¸ è­¦å‘Š**:
åˆ é™¤å‰éœ€è¦ç¡®è®¤æ²¡æœ‰å…¶ä»–ä»£ç å¼•ç”¨è¿™äº›Serviceï¼ç›®å‰ `PlatformServiceService` ä¼¼ä¹æ²¡æœ‰è¢«å¼•ç”¨ã€‚

---

### 5. Controller å±‚ (3ä¸ªæ–‡ä»¶)

**ä½ç½®**: `packages/cli/src/controllers/` å’Œ `packages/cli/src/controllers/admin/`

```bash
# âŒ éœ€è¦åˆ é™¤çš„Controlleræ–‡ä»¶
controllers/plugins.controller.ts                      # 10KB, 368è¡Œ - æ’ä»¶ç®¡ç†API
controllers/admin/admin-plugins.controller.ts          # 9.2KB, 342è¡Œ - ç®¡ç†å‘˜æ’ä»¶å®¡æ ¸API
controllers/admin/admin-platform-services.controller.ts # 14KB, 526è¡Œ - ç®¡ç†å‘˜å¹³å°æœåŠ¡ç®¡ç†API
```

**åˆ é™¤åŸå› **:
- åŸºäºé”™è¯¯çš„"æ’ä»¶"æ¦‚å¿µ
- åŠŸèƒ½å·²è¢«æ–°Controllerå®Œå…¨æ›¿ä»£ï¼š
  - `plugins.controller.ts` â†’ `custom-nodes.controller.ts` + `platform-nodes.controller.ts`
  - `admin-plugins.controller.ts` â†’ `platform-nodes.controller.ts` (ç®¡ç†å‘˜ç«¯ç‚¹)
  - `admin-platform-services.controller.ts` â†’ `platform-ai-providers.controller.ts`

**âš ï¸ é‡è¦**:
`plugins.controller.ts` è¿˜åœ¨ä½¿ç”¨ `WorkspacePluginCredentialsRepository`ï¼Œéœ€è¦å…ˆç¡®è®¤æ²¡æœ‰å‰ç«¯è°ƒç”¨è¿™äº›APIç«¯ç‚¹ï¼

---

### 6. å‰ç«¯ API å±‚ (1ä¸ªæ–‡ä»¶)

**ä½ç½®**: `packages/frontend/editor-ui/src/features/plugins/`

```bash
# âŒ éœ€è¦åˆ é™¤çš„APIæ–‡ä»¶
plugins.api.ts     # å°è£…æ—§çš„æ’ä»¶APIè°ƒç”¨
```

**åˆ é™¤åŸå› **: å·²è¢« `custom-nodes.ts` å’Œ `platform-nodes.ts` æ›¿ä»£

---

### 7. å‰ç«¯ Store å±‚ (1ä¸ªæ–‡ä»¶)

**ä½ç½®**: `packages/frontend/editor-ui/src/features/plugins/`

```bash
# âŒ éœ€è¦åˆ é™¤çš„Storeæ–‡ä»¶
plugins.store.ts   # æ—§çš„æ’ä»¶çŠ¶æ€ç®¡ç†
```

**åˆ é™¤åŸå› **: å·²è¢« `customNodes.store.ts` å’Œ `platformNodes.store.ts` æ›¿ä»£

---

### 8. å‰ç«¯è·¯ç”±å±‚ (1ä¸ªæ–‡ä»¶)

**ä½ç½®**: `packages/frontend/editor-ui/src/features/plugins/`

```bash
# âŒ éœ€è¦åˆ é™¤çš„è·¯ç”±æ–‡ä»¶
plugins.routes.ts  # æ—§çš„æ’ä»¶é¡µé¢è·¯ç”±
```

**åˆ é™¤åŸå› **: å¦‚æœæœ‰æ’ä»¶å¸‚åœºé¡µé¢ï¼Œéœ€è¦æ›¿æ¢ä¸ºæ–°çš„èŠ‚ç‚¹ç®¡ç†é¡µé¢è·¯ç”±

---

### 9. å‰ç«¯å¸¸é‡ (1ä¸ªæ–‡ä»¶)

**ä½ç½®**: `packages/frontend/editor-ui/src/features/plugins/`

```bash
# âŒ éœ€è¦åˆ é™¤çš„å¸¸é‡æ–‡ä»¶
plugins.constants.ts  # æ—§çš„æ’ä»¶ç›¸å…³å¸¸é‡
```

**åˆ é™¤åŸå› **: å·²è¢«æ–°çš„å¸¸é‡å®šä¹‰æ›¿ä»£

---

### 10. æ„å»ºäº§ç‰© (dist ç›®å½•)

æ‰€æœ‰ `dist/` ç›®å½•ä¸‹å¯¹åº”çš„ç¼–è¯‘æ–‡ä»¶éƒ½éœ€è¦æ¸…ç†ï¼ˆé‡æ–°æ„å»ºä¼šè‡ªåŠ¨æ¸…ç†ï¼‰

---

## ğŸ” åˆ é™¤å‰çš„æ£€æŸ¥æ¸…å•

### æ­¥éª¤ 1: æœç´¢å¼•ç”¨

åœ¨åˆ é™¤æ¯ä¸ªæ–‡ä»¶å‰ï¼Œå…ˆæœç´¢æ˜¯å¦æœ‰å…¶ä»–ä»£ç å¼•ç”¨ï¼š

```bash
# æ£€æŸ¥Entityå¼•ç”¨
grep -r "PlatformService" packages/ --include="*.ts" | grep -v "dist/" | grep -v ".map"
grep -r "WorkspacePluginCredentials" packages/ --include="*.ts" | grep -v "dist/" | grep -v ".map"

# æ£€æŸ¥Serviceå¼•ç”¨
grep -r "PlatformServiceService" packages/ --include="*.ts" | grep -v "dist/"

# æ£€æŸ¥Controllerå¼•ç”¨ï¼ˆæ£€æŸ¥è·¯ç”±æ³¨å†Œï¼‰
grep -r "PluginsController" packages/ --include="*.ts" | grep -v "dist/"
grep -r "AdminPluginsController" packages/ --include="*.ts" | grep -v "dist/"

# æ£€æŸ¥å‰ç«¯å¼•ç”¨
grep -r "plugins.api" packages/frontend --include="*.ts" --include="*.vue"
grep -r "plugins.store" packages/frontend --include="*.ts" --include="*.vue"
grep -r "plugins.routes" packages/frontend --include="*.ts" --include="*.vue"
```

### æ­¥éª¤ 2: æ£€æŸ¥APIç«¯ç‚¹è°ƒç”¨

ç¡®è®¤å‰ç«¯æ˜¯å¦è¿˜åœ¨è°ƒç”¨æ—§çš„APIç«¯ç‚¹ï¼š

```bash
# æ£€æŸ¥å‰ç«¯æ˜¯å¦è°ƒç”¨ /plugins ç«¯ç‚¹
grep -r "'/plugins" packages/frontend --include="*.ts" --include="*.vue"
grep -r '"/plugins' packages/frontend --include="*.ts" --include="*.vue"

# æ£€æŸ¥å‰ç«¯æ˜¯å¦è°ƒç”¨ /platform-services ç«¯ç‚¹
grep -r "'/platform-services" packages/frontend --include="*.ts" --include="*.vue"
```

### æ­¥éª¤ 3: æ•°æ®åº“è¿ç§»éªŒè¯

```bash
# ç¡®è®¤æ–°è¿ç§»å·²æ³¨å†Œ
grep "1762511303000" packages/@n8n/db/src/migrations/*/index.ts

# è¿è¡Œè¿ç§»æµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
pnpm --filter @n8n/db test:migrations
```

---

## ğŸ“ åˆ é™¤é¡ºåºå»ºè®®

**å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºåˆ é™¤ï¼Œä»å¤–åˆ°å†…ï¼š**

### ç¬¬1æ‰¹ï¼šå‰ç«¯æ–‡ä»¶ï¼ˆä½é£é™©ï¼‰
1. `plugins.constants.ts`
2. `plugins.routes.ts`
3. `plugins.store.ts`
4. `plugins.api.ts`

### ç¬¬2æ‰¹ï¼šControllerå±‚ï¼ˆä¸­é£é™©ï¼‰
âš ï¸ åˆ é™¤å‰ç¡®è®¤å‰ç«¯ä¸å†è°ƒç”¨è¿™äº›API
1. `plugins.controller.ts`
2. `admin-plugins.controller.ts`
3. `admin-platform-services.controller.ts`

### ç¬¬3æ‰¹ï¼šServiceå±‚ï¼ˆä¸­é£é™©ï¼‰
âš ï¸ åˆ é™¤å‰ç¡®è®¤Controllerå·²åˆ é™¤
1. `platform-service.service.ts`
2. `plugin-validator.service.ts` (å¯é€‰)

### ç¬¬4æ‰¹ï¼šRepositoryå±‚ï¼ˆé«˜é£é™©ï¼‰
âš ï¸ åˆ é™¤å‰ç¡®è®¤Serviceå·²åˆ é™¤
1. `platform-service.repository.ts`
2. `workspace-plugin-credentials.repository.ts`

### ç¬¬5æ‰¹ï¼šEntityå±‚ï¼ˆé«˜é£é™©ï¼‰
âš ï¸ åˆ é™¤å‰ç¡®è®¤Repositoryå·²åˆ é™¤
1. `platform-service.entity.ts`
2. `workspace-plugin-credentials.entity.ts`

### ç¬¬6æ‰¹ï¼šè¿ç§»æ–‡ä»¶ï¼ˆæœ€é«˜é£é™©ï¼‰
âš ï¸âš ï¸âš ï¸ **æœ€ååˆ é™¤ï¼Œä¸”ä»…åœ¨ä»¥ä¸‹æ¡ä»¶æ»¡è¶³æ—¶åˆ é™¤**ï¼š
- æ–°è¿ç§»å·²åœ¨æ‰€æœ‰ç¯å¢ƒæˆåŠŸæ‰§è¡Œ
- æ•°æ®å·²æˆåŠŸè¿ç§»åˆ°æ–°è¡¨
- ç³»ç»Ÿè¿è¡Œç¨³å®šè‡³å°‘1å‘¨

1. `1762511302220-CreatePlatformServiceTables.ts`
2. `1762511302660-ExtendPlatformServiceForPlugins.ts`
3. `1762511302880-CreateWorkspacePluginCredentialsTable.ts`

---

## âš ï¸ åˆ é™¤æ³¨æ„äº‹é¡¹

### 1. ä¸è¦ä¸€æ¬¡æ€§åˆ é™¤æ‰€æœ‰æ–‡ä»¶
- å»ºè®®åˆ†æ‰¹åˆ é™¤
- æ¯åˆ é™¤ä¸€æ‰¹åè¿è¡Œæµ‹è¯•
- ç¡®ä¿ç³»ç»Ÿä»ç„¶æ­£å¸¸å·¥ä½œ

### 2. ä¿ç•™ç‰ˆæœ¬æ§åˆ¶å†å²
- ä½¿ç”¨ git åˆ é™¤ï¼ˆ`git rm`ï¼‰è€Œä¸æ˜¯ç›´æ¥åˆ é™¤
- æ¯æ‰¹åˆ é™¤åå•ç‹¬æäº¤
- ç¼–å†™æ¸…æ™°çš„æäº¤ä¿¡æ¯

ç¤ºä¾‹æäº¤ä¿¡æ¯ï¼š
```
chore: remove deprecated platform-service files

Removed old platform-service entity, repository, and service files.
These were replaced by the new architecture:
- platform-ai-provider.service.ts
- platform-node.service.ts
- custom-node.service.ts

Related: #<issue-number>
```

### 3. æ›´æ–°å¯¼å…¥/å¯¼å‡º

åˆ é™¤æ–‡ä»¶åï¼Œéœ€è¦æ›´æ–°ä»¥ä¸‹ç´¢å¼•æ–‡ä»¶ï¼š

```typescript
// packages/@n8n/db/src/entities/index.ts
// ç§»é™¤ï¼š
export { PlatformService } from './platform-service.entity';
export { WorkspacePluginCredentials } from './workspace-plugin-credentials.entity';

// packages/@n8n/db/src/repositories/index.ts
// ç§»é™¤ï¼š
export { PlatformServiceRepository } from './platform-service.repository';
export { WorkspacePluginCredentialsRepository } from './workspace-plugin-credentials.repository';
```

### 4. æ¸…ç†æ„å»ºç¼“å­˜

åˆ é™¤æ–‡ä»¶åï¼Œæ¸…ç†æ„å»ºç¼“å­˜ï¼š

```bash
# æ¸…ç†æ‰€æœ‰æ„å»ºäº§ç‰©
pnpm clean

# é‡æ–°æ„å»º
pnpm build
```

---

## ğŸ§ª åˆ é™¤åçš„éªŒè¯

### 1. TypeScript ç¼–è¯‘æ£€æŸ¥
```bash
pnpm typecheck
```

### 2. å•å…ƒæµ‹è¯•
```bash
pnpm test
```

### 3. é›†æˆæµ‹è¯•
```bash
# å¦‚æœæœ‰é›†æˆæµ‹è¯•
pnpm test:integration
```

### 4. æ‰‹åŠ¨åŠŸèƒ½æµ‹è¯•
- [ ] AIèŠ‚ç‚¹è°ƒç”¨æ­£å¸¸
- [ ] å¹³å°èŠ‚ç‚¹æµè§ˆæ­£å¸¸
- [ ] è‡ªå®šä¹‰èŠ‚ç‚¹ä¸Šä¼ æ­£å¸¸
- [ ] èŠ‚ç‚¹é…ç½®ç®¡ç†æ­£å¸¸

---

## ğŸ“Š é¢„è®¡å½±å“

### ä»£ç è¡Œæ•°å‡å°‘
- åˆ é™¤æ–‡ä»¶ï¼šçº¦ 40+ ä¸ª
- åˆ é™¤ä»£ç è¡Œï¼šçº¦ 3000+ è¡Œ
- ä»£ç åº“æ¸…æ´åº¦ï¼šæ˜¾è‘—æå‡

### ç»´æŠ¤æˆæœ¬é™ä½
- ä¸å†éœ€è¦ç»´æŠ¤ä¸¤å¥—ç³»ç»Ÿ
- å‡å°‘æ¦‚å¿µæ··æ·†
- é™ä½Bugé£é™©

---

## âœ… å®Œæˆæ ‡å‡†

æ¸…ç†å®Œæˆåï¼Œåº”æ»¡è¶³ä»¥ä¸‹æ ‡å‡†ï¼š

- [ ] æ‰€æœ‰æ—§æ–‡ä»¶å·²åˆ é™¤
- [ ] æ‰€æœ‰å¯¼å…¥/å¯¼å‡ºå·²æ›´æ–°
- [ ] TypeScriptç¼–è¯‘é€šè¿‡ï¼ˆ0é”™è¯¯ï¼‰
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç³»ç»ŸåŠŸèƒ½æ­£å¸¸
- [ ] æ— é—ç•™çš„å¼•ç”¨é”™è¯¯
- [ ] Gitå†å²æ¸…æ™°
- [ ] æ–‡æ¡£å·²æ›´æ–°

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [06-æ¦‚å¿µä¿®æ­£æ–¹æ¡ˆ.md](./06-æ¦‚å¿µä¿®æ­£æ–¹æ¡ˆ.md) - äº†è§£ä¸ºä»€ä¹ˆè¿™äº›æ–‡ä»¶éœ€è¦åˆ é™¤
- [07-å‡­è¯æ¦‚å¿µåˆ†æ.md](./07-å‡­è¯æ¦‚å¿µåˆ†æ.md) - äº†è§£å‡­è¯ç³»ç»Ÿçš„ä¿®æ­£

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-08
**çŠ¶æ€**: å¾…æ‰§è¡Œ
**é¢„è®¡å®Œæˆ**: å»ºè®®åœ¨æ–°æ¶æ„éªŒè¯é€šè¿‡å1å‘¨å†…å®Œæˆ
