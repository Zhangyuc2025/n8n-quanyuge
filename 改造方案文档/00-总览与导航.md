# n8n 多租户 SaaS 平台改造方案（总览）

> **版本：** v1.0
> **日期：** 2025-01-09
> **状态：** 阶段 5.2 完成，进入阶段 5.3（节点动态化）
> **基于分支：** 20251102
> **改造目标：** 工作空间架构 + AI 平台托管 + 节点市场

---

## 📚 文档导航

本项目采用**分层架构**，按模块组织文档：

### 核心架构文档

| 文档 | 描述 | 推荐读者 | 状态 |
|------|------|----------|------|
| [01-多租户架构](./modules/01-多租户架构.md) | 已完成的多租户基础架构（73%） | 后端开发 | ✅ 已完成 |
| [02-架构总览](./modules/02-架构总览.md) | 整体技术架构和服务分层 | 所有人 | 📝 设计中 |
| [03-数据库设计](./modules/03-数据库设计.md) | 完整数据库表结构和E-R图 | 后端开发、DBA | 📝 设计中 |
| [04-节点架构](./modules/04-节点架构.md) | 三层节点系统架构 | 后端开发、节点开发 | 📝 设计中 |
| [05-AI服务架构](./modules/05-AI服务架构.md) | AI 平台托管和计费系统 | 后端开发、AI 工程师 | 📝 设计中 |

### 实现指南文档

| 文档 | 描述 | 推荐读者 | 状态 |
|------|------|----------|------|
| [06-后端实现](./modules/06-后端实现.md) | 后端模块、Service、Controller | 后端开发 | 📝 设计中 |
| [07-前端实现](./modules/07-前端实现.md) | Vue 组件、Store、路由 | 前端开发 | 📝 设计中 |
| [08-用户体验](./modules/08-用户体验.md) | 用户界面和交互设计 | 前端开发、产品经理 | 📝 设计中 |

### 项目管理文档

| 文档 | 描述 | 推荐读者 | 状态 |
|------|------|----------|------|
| [09-实施计划](./modules/09-实施计划.md) | 分阶段实施计划和里程碑 | 项目经理、技术主管 | 🔄 进行中 |
| [10-验收标准](./modules/10-验收标准.md) | 功能和性能验收标准 | QA、测试工程师 | 📝 设计中 |

---

## 🎯 核心概念速览

### 1. 节点三层架构

```
┌─────────────────────────────────────┐
│  内置节点 (Built-in Nodes)          │
│  • 142个官方节点                     │
│  • 打包在代码中                      │
│  • 示例：Set, If, HttpRequest       │
├─────────────────────────────────────┤
│  平台节点 (Platform Nodes)          │
│  • 平台官方 + 第三方审核             │
│  • 存储在 platform_node 表          │
│  • 全平台用户可见                    │
├─────────────────────────────────────┤
│  自定义节点 (Custom Nodes)          │
│  • 用户上传                          │
│  • 存储在 custom_node 表            │
│  • 仅上传者工作空间可见              │
└─────────────────────────────────────┘
```

### 2. AI 节点架构

**核心原则：** 1 个通用节点 (LmChatPlatform) + 隐藏参数区分提供商

```
Agent 节点
└─ Chat Model (参数)
   ├─ OpenAI (LmChatPlatform + providerKey="openai")
   ├─ Anthropic (LmChatPlatform + providerKey="anthropic")
   └─ ...其他提供商同理
```

### 3. 凭证系统变更

```
改造前：需要创建凭证 → 选择凭证
改造后：❌ 删除 credentials_entity 表
       ✅ 直接在节点参数中配置
       ✅ user_node_config 表自动复用
```

### 4. 平台托管 AI

**商业模式：** 平台统一管理 API Key，用户按量付费（人民币）

```
用户操作：选择模型 → 运行工作流
后台处理：扣除余额 → 调用上游 API → 返回结果
```

### 5. 多租户架构（已完成 73%）

**核心改动：**
- 性能：4层JOIN → 3层JOIN（提升 30-40%）
- 资源：SharedWorkflow 中间表 → 直接归属 Project
- 计费：新增按量计费系统（悲观锁保证并发安全）

---

## 🏗️ 整体架构图

```mermaid
graph TB
    subgraph "前端层"
        A[Vue 3 + Pinia]
        B[节点选择器]
        C[工作流编辑器]
        D[节点管理页]
    end

    subgraph "API层"
        E[Express Controllers]
        F[@ProjectScope 装饰器]
    end

    subgraph "业务层"
        G[Service Layer]
        H[NodeService]
        I[AIProviderService]
        J[BillingService]
    end

    subgraph "数据层"
        K[TypeORM Repository]
        L[PostgreSQL/MySQL]
    end

    subgraph "节点系统"
        M[内置节点<br/>文件系统]
        N[平台节点<br/>platform_node]
        O[自定义节点<br/>custom_node]
    end

    subgraph "AI服务"
        P[LmChatPlatform节点]
        Q[平台AI代理]
        R[OpenAI/Anthropic等]
    end

    A --> E
    B --> E
    C --> E
    D --> E

    E --> F
    F --> G

    G --> H
    G --> I
    G --> J

    H --> K
    I --> K
    J --> K

    K --> L

    H --> M
    H --> N
    H --> O

    P --> Q
    Q --> R
    Q --> J
```

---

## 📊 项目进度概览

### 已完成（阶段 0-5.2）

- ✅ **阶段 1-2：** 数据库层多租户改造（100%）
- ✅ **阶段 3.0：** 工作空间隔离机制（100%）
- ✅ **阶段 3.1：** 计费系统（100%）
- ✅ **阶段 4：** Service 层实现（100%）
- ✅ **阶段 5.0-5.1：** 前端多租户架构（100%）
- ✅ **阶段 5.2：** 动态 AI Chat Model 节点（100%）

### 进行中（阶段 5.3）

- 🔄 **节点动态化：** 节点选择器从文件系统改为数据库查询

### 待开始（阶段 6-9）

- ⏳ **阶段 6：** 节点市场前端
- ⏳ **阶段 7：** 节点安全审核
- ⏳ **阶段 8：** 品牌替换
- ⏳ **阶段 9：** 完整测试和优化

---

## 🔍 快速定位

### 按角色查找文档

**后端开发工程师：**
1. 先读：[01-多租户架构](./modules/01-多租户架构.md)
2. 再读：[03-数据库设计](./modules/03-数据库设计.md)
3. 实现：[06-后端实现](./modules/06-后端实现.md)

**前端开发工程师：**
1. 先读：[02-架构总览](./modules/02-架构总览.md)
2. 再读：[08-用户体验](./modules/08-用户体验.md)
3. 实现：[07-前端实现](./modules/07-前端实现.md)

**节点开发者：**
1. 先读：[04-节点架构](./modules/04-节点架构.md)
2. 再读：[08-用户体验](./modules/08-用户体验.md)

**AI 工程师：**
1. 先读：[05-AI服务架构](./modules/05-AI服务架构.md)
2. 再读：[03-数据库设计](./modules/03-数据库设计.md)

**项目经理 / 产品经理：**
1. 先读：本文档（总览）
2. 再读：[09-实施计划](./modules/09-实施计划.md)
3. 验收：[10-验收标准](./modules/10-验收标准.md)

### 按问题查找文档

| 问题 | 参考文档 |
|------|----------|
| 如何添加新的节点类型？ | [04-节点架构](./modules/04-节点架构.md) |
| 如何接入新的 AI 提供商？ | [05-AI服务架构](./modules/05-AI服务架构.md) |
| 工作空间隔离如何实现？ | [01-多租户架构](./modules/01-多租户架构.md) |
| 数据库表结构是什么？ | [03-数据库设计](./modules/03-数据库设计.md) |
| 节点选择器怎么改造？ | [08-用户体验](./modules/08-用户体验.md) |
| 计费系统如何工作？ | [05-AI服务架构](./modules/05-AI服务架构.md) |
| 如何保证并发安全？ | [01-多租户架构](./modules/01-多租户架构.md) |
| 性能优化有哪些？ | [01-多租户架构](./modules/01-多租户架构.md) |

---

## 📝 文档维护规范

### 更新流程

1. **修改模块文档：** 直接编辑 `modules/` 下的对应文件
2. **更新总览文档：** 如果架构有重大变更，同步更新本文档
3. **更新实施计划：** 阶段完成后，更新 [09-实施计划](./modules/09-实施计划.md)

### 文档版本

- 所有模块文档应保持版本号一致
- 重大架构变更时，版本号升级（如 v1.0 → v2.0）
- 小改动只更新日期，不升级版本号

---

## 🆘 获取帮助

- **技术问题：** 优先查阅对应模块文档
- **架构疑问：** 联系技术主管
- **实施计划：** 查看 [09-实施计划](./modules/09-实施计划.md)
- **代码位置：** 参考各模块文档的"代码位置"章节
