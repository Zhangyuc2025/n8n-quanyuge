# 凭证系统移除 - 总体执行方案（激进版）

> **版本：** v2.0（数据库直接删除）
> **日期：** 2025-01-10
> **预计工期：** 2-3 天
> **完成度：** 70% → 100%

---

## 📊 方案对比

| 维度 | 原方案（保守） | 新方案（激进）✅ | 优势 |
|------|--------------|----------------|------|
| **数据迁移** | 编写兼容性迁移脚本 | 直接 SQL 删除 | 节省 1 天 |
| **代码清理** | 保留部分读取逻辑 | 全部删除 | 更彻底 |
| **测试成本** | 需要测试兼容性 | 只需测试功能 | 节省 0.5 天 |
| **维护成本** | 遗留代码存在 | 完全移除 | 长期受益 |
| **总工期** | 4-5 天 | **2-3 天** | **节省 50%** |

---

## 🎯 核心理念

### 为什么可以直接删除？

根据你的项目架构调整：

| 原有功能 | 依赖凭证系统 | 新架构替代方案 | 状态 |
|---------|-------------|--------------|------|
| **AI 节点**（OpenAI、Claude） | ✅ | PlatformAIProvider（平台托管 API Key） | ✅ 已实现 |
| **第三方节点**（GitHub、Slack） | ✅ | UserNodeConfig（用户配置 Token） | ✅ 已设计 |
| **内置节点**（Set、If、Code） | ❌ | 无需凭证 | ✅ 已保留 142 个 |
| **社区节点**（用户 npm 安装） | ✅ | ❌ 已删除功能 | ✅ 已删除 240 个 |

**结论：** 凭证系统已经没有任何使用场景，可以完全删除！

---

## 📋 三步执行计划

### 第一步：数据库彻底清理 ⚡ 30 分钟

**执行脚本：** `/改造方案文档/凭证系统移除-数据库清理脚本.sql`

```bash
# 1. 备份数据库（重要！）
pg_dump -h localhost -U postgres n8n > backup-before-credential-removal.sql

# 2. 执行清理脚本
psql -h localhost -U postgres n8n < 改造方案文档/凭证系统移除-数据库清理脚本.sql

# 3. 验证结果
psql -h localhost -U postgres n8n -c "
  SELECT table_name FROM information_schema.tables
  WHERE table_name IN ('credentials_entity', 'shared_credentials');
"
# 预期输出：0 rows（表已删除）
```

**清理内容：**
- ✅ 删除工作流中的 `node.credentials` 字段
- ✅ 删除 `credentials_entity` 表
- ✅ 删除 `shared_credentials` 表
- ✅ 删除相关索引

---

### 第二步：前端代码批量清理 🎨 1-1.5 天

**执行清单：** `/改造方案文档/凭证系统移除-前端清理清单.md`

#### 2.1 快速删除（11 个文件）

```bash
cd /home/zhang/n8n-quanyuge

# 删除凭证导航命令
rm packages/frontend/editor-ui/src/features/shared/commandBar/composables/useCredentialNavigationCommands.ts
rm packages/frontend/editor-ui/src/features/shared/commandBar/composables/useCredentialNavigationCommands.test.ts

# 删除项目凭证移动组件
rm packages/frontend/editor-ui/src/features/collaboration/projects/components/ProjectMoveResourceModalCredentialsList.vue

# 删除凭证测试工具
rm packages/frontend/editor-ui/src/app/stores/__tests__/utils/cloudStoreUtils.ts
```

#### 2.2 核心文件修改（5 个 P0 文件）

| 文件 | 修改点 | 工时 |
|------|--------|------|
| `workflows.store.ts` | 删除 `usedCredentials` 状态和相关方法 | 1h |
| `useCanvasOperations.ts` | 删除 credentialsStore 导入和调用 | 2h |
| `useNodeHelpers.ts` | 删除凭证验证方法 | 1h |
| `nodeTypes.store.ts` | 删除 `credentialOnlyNodes` | 1h |
| `NodeView.vue` | 删除凭证相关 UI 逻辑 | 0.5h |

**总计：** 5.5 小时 + 2.7 小时（P1）+ 1.9 小时（P2）= **10 小时 ≈ 1.5 天**

#### 2.3 批量清理导入

```bash
# 删除所有凭证 store 导入
find packages/frontend/editor-ui/src -type f \( -name "*.ts" -o -name "*.vue" \) -exec \
  sed -i "/import.*useCredentialsStore.*from/d" {} \;

# 删除所有凭证类型导入
find packages/frontend/editor-ui/src -type f \( -name "*.ts" -o -name "*.vue" \) -exec \
  sed -i "/import.*from.*credentials\.types/d" {} \;
```

---

### 第三步：后端执行逻辑清理 🔧 0.5 天

**执行清单：** `/改造方案文档/凭证系统移除-后端清理清单.md`

#### 3.1 核心修改（3 个文件）

| 文件 | 修改内容 | 工时 |
|------|---------|------|
| `packages/core/src/execution-engine/node-execution-context/index.ts` | 删除 `getCredentials()` 方法 | 0.5h |
| `packages/core/src/node-execution-functions.ts` | 删除 `getCredentials()` 实现 | 0.5h |
| `packages/workflow/src/Interfaces.ts` | 删除 `INodeCredentials` 类型 | 0.3h |

**总计：** 1.3 小时 + 0.5 小时（测试）= **1.8 小时 ≈ 0.5 天**

#### 3.2 查找遗漏引用

```bash
# 查找所有 getCredentials 调用
grep -r "getCredentials\|this\.helpers\.getCredentials" packages/nodes-base/nodes --include="*.ts"

# 如果有结果，说明某个内置节点还在用凭证（需要移除或改造）
```

---

## ✅ 验收标准

### 1. 数据库验证

```sql
-- 凭证表已删除
SELECT table_name FROM information_schema.tables
WHERE table_name IN ('credentials_entity', 'shared_credentials');
-- 预期：0 rows

-- 工作流数据无 credentials 字段
SELECT id, name FROM workflow_entity
WHERE nodes::text LIKE '%credentials%';
-- 预期：0 rows
```

### 2. 前端构建验证

```bash
cd packages/frontend/editor-ui
pnpm typecheck  # 预期：无类型错误
pnpm lint       # 预期：无 lint 错误
pnpm build      # 预期：构建成功

# 检查无凭证引用
grep -r "credentialsStore\|ICredential" src --include="*.ts" --include="*.vue" | wc -l
# 预期：0
```

### 3. 后端构建验证

```bash
cd packages/core
pnpm typecheck && pnpm build

cd packages/cli
pnpm typecheck && pnpm build

# 检查无凭证引用
! grep -r "CredentialsService\|getCredentials" packages/core/src packages/cli/src
```

### 4. 功能测试

```bash
# 启动 n8n
pnpm dev

# 测试用例：
# ✅ 创建工作流（Set → Code → HttpRequest）
# ✅ 保存工作流
# ✅ 执行工作流
# ✅ 工作空间切换
# ✅ 无凭证相关报错
```

---

## 📊 工期与里程碑

| 阶段 | 任务 | 工期 | 累计 |
|------|------|------|------|
| **Day 1 上午** | 数据库清理 + 文件删除 | 0.5 天 | 0.5 天 |
| **Day 1 下午 - Day 2** | 前端核心文件修改（P0） | 1 天 | 1.5 天 |
| **Day 2 下午** | 前端 UI 组件修改（P1） | 0.5 天 | 2 天 |
| **Day 3 上午** | 后端清理 + 测试 | 0.5 天 | 2.5 天 |
| **Day 3 下午** | 完整构建测试 + 修复 | 0.5 天 | **3 天** |

**最快：** 2 天（如果构建测试一次通过）
**预期：** 2.5 天
**最慢：** 3 天（需要多次修复）

---

## 🚨 风险与应对

### 风险 1：数据库删除后无法回滚

**风险等级：** 高
**发生概率：** 低
**影响范围：** 全部数据

**应对措施：**
- ✅ 执行前完整备份数据库
- ✅ 在开发环境先测试
- ✅ 生产环境凌晨执行（用户少）

### 风险 2：前端遗漏凭证引用导致运行时错误

**风险等级：** 中
**发生概率：** 中
**影响范围：** 部分功能

**应对措施：**
- ✅ 先运行 typecheck 抓类型错误
- ✅ 手工测试核心流程（工作流创建/执行）
- ✅ 查看浏览器 Console 错误

### 风险 3：内置节点中仍有凭证调用

**风险等级：** 低
**发生概率：** 低（已删除 240 个需要凭证的节点）
**影响范围：** 特定节点

**应对措施：**
- ✅ 执行前搜索所有 `getCredentials` 调用
- ✅ 如果发现，将该节点移到 backup 目录

---

## 🎯 下一步行动

### 立即执行（如果确认方案）

```bash
# 1. 创建工作分支
git checkout -b feature/remove-credentials-system

# 2. 备份数据库
pg_dump -h localhost -U postgres n8n > backup-$(date +%Y%m%d).sql

# 3. 执行数据库清理
psql -h localhost -U postgres n8n < 改造方案文档/凭证系统移除-数据库清理脚本.sql

# 4. 删除前端文件
bash 改造方案文档/凭证系统移除-前端清理清单.md  # 复制其中的删除命令

# 5. 开始修改核心文件（按清单逐个处理）

# 6. 每修复 5 个文件，运行一次 typecheck
cd packages/frontend/editor-ui && pnpm typecheck

# 7. 全部完成后，运行完整构建
pnpm build > build.log 2>&1
tail -n 50 build.log
```

---

## 📚 配套文档

| 文档 | 用途 |
|------|------|
| `凭证系统移除-数据库清理脚本.sql` | 数据库删除 SQL |
| `凭证系统移除-前端清理清单.md` | 前端 51 个文件的修改指南 |
| `凭证系统移除-后端清理清单.md` | 后端 5 个文件的修改指南 |
| `凭证系统移除工作总结.md` | 当前进度（70%）和历史记录 |

---

## 💡 核心优势

### 为什么这个方案最合理？

1. **架构已经不需要凭证系统**
   - AI 节点改用 PlatformAIProvider ✅
   - 第三方节点将用 UserNodeConfig ✅
   - 内置节点不需要凭证 ✅
   - 社区节点功能已删除 ✅

2. **彻底删除优于保留兼容**
   - 没有历史包袱
   - 代码更简洁
   - 维护成本低
   - 不会给未来埋坑

3. **数据库直接删除最高效**
   - 不需要复杂的迁移脚本
   - 不需要兼容性代码
   - 节省 50% 工时
   - 一次性解决问题

---

## 🎉 预期结果

执行完成后：

- ✅ 数据库：无 credentials/shared_credentials 表
- ✅ 后端：无凭证相关代码（Entity/Service/Controller 已删除）
- ✅ 前端：无凭证相关代码（store/components/types 已删除）
- ✅ 节点：无凭证注入逻辑
- ✅ 构建：全部通过，无类型错误
- ✅ 功能：工作流正常创建/执行

**净删除代码量：** ~15,000 行
**简化程度：** 大幅简化
**长期收益：** 维护成本降低 30%+

---

**创建日期：** 2025-01-10
**维护者：** 开发团队
**状态：** ✅ 方案已定稿，等待执行
