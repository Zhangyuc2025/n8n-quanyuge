# n8n å¤šç§Ÿæˆ·æ¶æ„å®Œæ•´æ–¹æ¡ˆ

> **ç‰ˆæœ¬ï¼š** v6.0 - æ•´åˆç‰ˆ
> **æ—¥æœŸï¼š** 2025-01-08
> **åŸºäºåˆ†æ”¯ï¼š** 20251102
> **æ”¹é€ ç›®æ ‡ï¼š** å¯¹æ ‡ Coze - å·¥ä½œç©ºé—´æ¶æ„ + AI æŒ‰é‡è®¡è´¹ + æ’ä»¶ç³»ç»Ÿ
> **å‰ææ¡ä»¶ï¼š** é¡¹ç›®æœªéƒ¨ç½²ç”Ÿäº§ï¼Œå¯æ¿€è¿›æ”¹é€ 

---

## ğŸ“‹ ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦ï¼ˆTL;DRï¼‰](#æ‰§è¡Œæ‘˜è¦tldr)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ•°æ®åº“è®¾è®¡ä¸å®æ–½](#æ•°æ®åº“è®¾è®¡ä¸å®æ–½)
4. [åç«¯æ¶æ„](#åç«¯æ¶æ„)
5. [å‰ç«¯æ¶æ„](#å‰ç«¯æ¶æ„)
6. [å®‰å…¨ä¸æ€§èƒ½](#å®‰å…¨ä¸æ€§èƒ½)
7. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
8. [é£é™©æ§åˆ¶](#é£é™©æ§åˆ¶)
9. [æˆåŠŸæ ‡å‡†](#æˆåŠŸæ ‡å‡†)
10. [é™„å½•](#é™„å½•)

---

## ğŸ¯ æ‰§è¡Œæ‘˜è¦ï¼ˆTL;DRï¼‰

### æ ¸å¿ƒç›®æ ‡

å°† n8n ä»**å•ç§Ÿæˆ·å¼€æºå·¥å…·**æ”¹é€ ä¸º**å¤šç§Ÿæˆ· SaaS å¹³å°**ï¼Œå¯¹æ ‡ Coze å•†ä¸šç‰ˆã€‚

### å…³é”®æ•°å­—

| æŒ‡æ ‡ | æ”¹é€ å‰ | æ”¹é€ å | æå‡ |
|------|--------|--------|------|
| æŸ¥è¯¢å±‚çº§ | 4 å±‚ JOIN | 3 å±‚ JOIN | æ€§èƒ½æå‡ 30-40% |
| å·¥ä½œç©ºé—´æ•° | 1ï¼ˆå›ºå®šï¼‰ | æ— é™åˆ¶ | âˆ |
| è®¡è´¹æ–¹å¼ | æ—  | æŒ‰é‡è®¡è´¹ï¼ˆäººæ°‘å¸ï¼‰ | - |
| è¡¨æ•°é‡ | 45 ä¸ª | 56 ä¸ªï¼ˆ+11 æ–°è¡¨ï¼‰ | - |
| åˆ é™¤æ—§è¡¨ | - | 2 ä¸ªï¼ˆSharedWorkflow/Credentialsï¼‰ | - |

### ROI åˆ†æ

**æ”¶ç›Šï¼š**
- âœ… æ”¯æŒå¤šç§Ÿæˆ· SaaS å•†ä¸šæ¨¡å¼
- âœ… æŒ‰é‡è®¡è´¹ç³»ç»Ÿï¼ˆé¢„è®¡æœˆè¥æ”¶ï¼šç”¨æˆ·æ•° Ã— Â¥50-200ï¼‰
- âœ… ä¸‰å±‚æ’ä»¶å¸‚åœºï¼ˆå¹³å°æ’ä»¶ + ç¬¬ä¸‰æ–¹æ’ä»¶ + è‡ªå®šä¹‰æ’ä»¶ï¼‰
- âœ… æ€§èƒ½æå‡ 30-40%
- âœ… é™ä½å¼€å‘å¤æ‚åº¦ï¼ˆåˆ é™¤ SharedWorkflow ä¸­é—´å±‚ï¼‰

**æˆæœ¬ï¼š**
- å¼€å‘æ—¶é—´ï¼š12 å‘¨ï¼ˆ3 ä¸ªæœˆï¼‰
- å¼€å‘äººåŠ›ï¼š1-2 äºº
- æµ‹è¯•æ—¶é—´ï¼š2 å‘¨

**é£é™©ï¼š**
- âš ï¸ æ¿€è¿›æ”¹é€ ï¼Œæ— æ³•å›é€€åˆ°åŸæ¶æ„
- âš ï¸ éœ€è¦å®Œæ•´é‡æ„ Repository/Service å±‚ï¼ˆ50+ æ–‡ä»¶ï¼‰

---

## ğŸ“ æ¶æ„è®¾è®¡

### æ ¸å¿ƒå†³ç­–è¡¨

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ | ç†ç”± | å½±å“ |
|--------|------|------|------|
| **SharedWorkflow/Credentials** | ç›´æ¥åˆ é™¤ | ç®€åŒ–æ¶æ„ | æ€§èƒ½ â†‘30-40% |
| **èµ„æºå½’å±** | Workflow/Credentials â†’ Project | å‡å°‘ JOIN å±‚çº§ | æŸ¥è¯¢é€Ÿåº¦ â†‘ |
| **å·¥ä½œç©ºé—´** | Project è¡¨æ‰©å±•ï¼ˆtype å­—æ®µï¼‰ | æ— éœ€æ–°è¡¨ | å…¼å®¹æ€§å¥½ |
| **è®¡è´¹è´§å¸** | ç›´æ¥äººæ°‘å¸ï¼ˆCNYï¼‰ | ä¸æç§¯åˆ† | ç”¨æˆ·ä½“éªŒå¥½ |
| **çŸ¥è¯†åº“** | å¹³å° RAG æ’ä»¶ï¼ˆæŒ‰æ¬¡è®¡è´¹ï¼‰ | é™ä½å¹³å°æˆæœ¬ | ç”¨æˆ·æ•°æ®éš”ç¦» |
| **æ’ä»¶ç³»ç»Ÿ** | ä¸‰å±‚æ¶æ„ï¼ˆå¹³å°/ç¬¬ä¸‰æ–¹/è‡ªå®šä¹‰ï¼‰ | çµæ´»æ‰©å±• | è¥æ”¶å¢é•¿ç‚¹ |
| **å‰åç«¯åˆ†ç¦»** | å·²å®ç°ï¼ˆVite + Expressï¼‰ | ç‹¬ç«‹éƒ¨ç½² | æå‡å¯ç»´æŠ¤æ€§ |

### æ¶æ„æ¼”è¿›å¯¹æ¯”

**æ”¹é€ å‰ï¼ˆ4å±‚JOINï¼‰ï¼š**
```mermaid
graph LR
    User[ç”¨æˆ·] --> PR[ProjectRelation]
    PR --> Project[é¡¹ç›®]
    Project --> SW[SharedWorkflow âŒ]
    SW --> Workflow[å·¥ä½œæµ]

    style SW fill:#ff6b6b
```

**æ”¹é€ åï¼ˆ3å±‚JOINï¼‰ï¼š**
```mermaid
graph LR
    User[ç”¨æˆ·] --> PR[ProjectRelation]
    PR --> Project[å·¥ä½œç©ºé—´]
    Project --> Workflow[å·¥ä½œæµ âœ…]
    Project --> Credentials[å‡­è¯ âœ…]
    Project --> Usage[è®¡è´¹è®°å½• âœ…]

    style Project fill:#51cf66
    style Workflow fill:#51cf66
    style Credentials fill:#51cf66
```

### æ•°æ®åº“ E-R å…³ç³»å›¾

```mermaid
erDiagram
    USER ||--o{ PROJECT_RELATION : "æˆå‘˜"
    PROJECT_RELATION }o--|| PROJECT : "æ‰€å±"

    PROJECT ||--o{ WORKFLOW : "æ‹¥æœ‰"
    PROJECT ||--o{ CREDENTIALS : "æ‹¥æœ‰"
    PROJECT ||--o{ EXECUTION : "æ‰§è¡Œè®°å½•"
    PROJECT ||--o{ USAGE_RECORD : "è®¡è´¹è®°å½•"
    PROJECT ||--o{ WORKSPACE_QUOTA : "é…é¢é™åˆ¶"
    PROJECT ||--o{ WORKSPACE_PLUGIN_CREDENTIALS : "æ’ä»¶å‡­è¯"

    PLATFORM_SERVICE ||--o{ USAGE_RECORD : "æœåŠ¡è°ƒç”¨"
    PLATFORM_RAG_SERVICE ||--o{ USAGE_RECORD : "RAGæŸ¥è¯¢"
    PLATFORM_SERVICE ||--o{ WORKSPACE_PLUGIN_CREDENTIALS : "å…³è”æœåŠ¡"

    USER {
        uuid id PK
        string email
        string tier "free|pro|enterprise"
        boolean email_verified
        boolean is_admin "ç®¡ç†å‘˜æ ‡è¯†"
    }

    PROJECT {
        uuid id PK
        string name
        string type "personal|team"
        decimal balance_cny "å·¥ä½œç©ºé—´ä½™é¢"
        decimal low_balance_threshold
        string status "active|archived"
    }

    WORKFLOW {
        uuid id PK
        string name
        uuid project_id FK "ç›´æ¥å½’å±"
        boolean active
    }

    CREDENTIALS {
        uuid id PK
        string name
        uuid project_id FK "ç›´æ¥å½’å±"
        boolean is_managed "å¹³å°æ‰˜ç®¡"
    }

    USAGE_RECORD {
        uuid id PK
        uuid workspace_id FK
        uuid user_id FK
        string service_key
        int tokens_used
        decimal cost_cny "æ‰£è´¹é‡‘é¢"
    }

    PLATFORM_SERVICE {
        uuid id PK
        string service_key UK
        string service_type "ai_model|rag|plugin"
        jsonb api_config "åŠ å¯†å­˜å‚¨"
        decimal price_per_1k_tokens
    }
```

### æ ¸å¿ƒè¡¨è®¾è®¡æ‘˜è¦

**æ‰©å±•ç°æœ‰è¡¨ï¼š**

| è¡¨å | æ–°å¢å­—æ®µ | ç”¨é€” |
|------|---------|------|
| `project` | `balance_cny`, `low_balance_threshold`, `slug`, `status` | å·¥ä½œç©ºé—´è®¡è´¹ |
| `workflow_entity` | `project_id` (FK) | ç›´æ¥å½’å±å·¥ä½œç©ºé—´ |
| `credentials_entity` | `project_id` (FK), `is_managed` | ç›´æ¥å½’å± + å¹³å°æ‰˜ç®¡æ ‡è¯† |
| `execution_entity` | `workspace_id` (FK) | å·¥ä½œç©ºé—´éš”ç¦» |
| `user` | `tier`, `email_verified`, `is_admin` | ç”¨æˆ·å±‚çº§å’Œç®¡ç†å‘˜ |

**æ–°å¢è¡¨ï¼ˆ11 ä¸ªï¼‰ï¼š**

| è¡¨å | ç”¨é€” | å…³é”®å­—æ®µ |
|------|------|---------|
| `platform_services` | å¹³å° AI æœåŠ¡é…ç½® | `service_key`, `price_per_1k_tokens` |
| `platform_rag_services` | å¹³å° RAG çŸ¥è¯†åº“ | `category`, `price_per_query` |
| `usage_records` | ä½¿ç”¨é‡å’Œæ‰£è´¹è®°å½• | `workspace_id`, `cost_cny` |
| `monthly_usage_summary` | æœˆåº¦è´¦å•æ±‡æ€» | `month`, `total_cost_cny` |
| `workspace_quotas` | å·¥ä½œç©ºé—´é…é¢ | `max_workflows`, `max_executions_per_day` |
| `workspace_features` | åŠŸèƒ½å¼€å…³ | `feature_key`, `enabled` |
| `workspace_plugin_credentials` | æ’ä»¶ API Key | `service_id`, `encrypted_credentials` |
| `invite_codes` | é‚€è¯·ç ç³»ç»Ÿ | `code`, `bonus_amount_cny` |
| `audit_logs` | å®¡è®¡æ—¥å¿— | `workspace_id`, `action` |
| `recharge_records` | å……å€¼è®°å½• | `amount_cny`, `payment_method` |
| `registration_stats` | æ³¨å†Œç»Ÿè®¡ | `date`, `total_registrations` |

**åˆ é™¤è¡¨ï¼ˆ2 ä¸ªï¼‰ï¼š**
- âŒ `shared_workflow`
- âŒ `shared_credentials`

### è®¡è´¹ç³»ç»Ÿæ ¸å¿ƒæµç¨‹

```mermaid
sequenceDiagram
    participant W as Workflow
    participant BS as BillingService
    participant DB as Database

    W->>BS: checkBalance(workspaceId, 1.0)
    BS->>DB: SELECT balance_cny (WITH LOCK)
    DB-->>BS: balance: Â¥100.50

    alt ä½™é¢å……è¶³
        BS-->>W: âœ… é€šè¿‡
        W->>W: æ‰§è¡Œ AI æœåŠ¡è°ƒç”¨
        W->>BS: recordUsageAndCharge(tokens, cost)

        BS->>DB: BEGIN TRANSACTION
        BS->>DB: UPDATE balance (-cost)
        BS->>DB: INSERT usage_record
        BS->>DB: COMMIT

        Note over BS,DB: æ‚²è§‚é”ä¿è¯å¹¶å‘å®‰å…¨
    else ä½™é¢ä¸è¶³
        BS-->>W: âŒ InsufficientBalanceError
    end
```

### ä¸‰å±‚æ’ä»¶ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    subgraph "å¹³å°æ’ä»¶ï¼ˆå®˜æ–¹ï¼‰"
        P1[OpenAI GPT-4]
        P2[Claude 3]
        P3[æ³•å¾‹ RAG]
    end

    subgraph "ç¬¬ä¸‰æ–¹æ’ä»¶ï¼ˆå®¡æ ¸é€šè¿‡ï¼‰"
        T1[å¼€å‘è€… A çš„æ’ä»¶]
        T2[å¼€å‘è€… B çš„æ’ä»¶]
    end

    subgraph "è‡ªå®šä¹‰æ’ä»¶ï¼ˆå·¥ä½œç©ºé—´ç§æœ‰ï¼‰"
        C1[å…¬å¸å†…éƒ¨ API]
        C2[å®šåˆ¶ä¸šåŠ¡é€»è¾‘]
    end

    Admin[å¹³å°ç®¡ç†å‘˜] -->|é…ç½®| P1
    Admin -->|å®¡æ ¸| T1
    User[å·¥ä½œç©ºé—´ç”¨æˆ·] -->|ä¸Šä¼ | C1

    P1 --> WPC[WorkspacePluginCredentials<br/>API Key ç®¡ç†]
    T1 --> WPC
    C1 --> WPC
```

### èŠ‚ç‚¹åŠ¨æ€åŒ–æ¶æ„ï¼ˆCoze é£æ ¼ï¼‰

**æ ¸å¿ƒç†å¿µ**ï¼šè®©ç”¨æˆ·å¼€ç®±å³ç”¨ AI èƒ½åŠ›,æ— éœ€é…ç½® OpenAI API Key

```mermaid
graph TB
    subgraph "èŠ‚ç‚¹åˆ†ç±»ï¼ˆ644 ä¸ªèŠ‚ç‚¹ï¼‰"
        Cat1["å¹³å°æ‰˜ç®¡èŠ‚ç‚¹<br/>AI å¤§æ¨¡å‹ï¼š10-15 ä¸ª<br/>å¹³å°ç»Ÿä¸€é…ç½®"]
        Cat2["ç¬¬ä¸‰æ–¹æœåŠ¡èŠ‚ç‚¹<br/>Notion/Slack ç­‰ï¼š300+<br/>ç”¨æˆ· OAuth æˆæƒ"]
        Cat3["åŠŸèƒ½èŠ‚ç‚¹<br/>Code/HTTP ç­‰ï¼š50+<br/>æ— éœ€é…ç½®"]
        Cat4["å¹³å°å®˜æ–¹æ’ä»¶<br/>å¤©æ°”/OCR ç­‰<br/>å¹³å°è‡ªç ”æœåŠ¡"]
    end

    subgraph "ç”¨æˆ·ä½“éªŒæµç¨‹"
        User[ç”¨æˆ·] -->|1. æ‹–æ‹½èŠ‚ç‚¹| Check{èŠ‚ç‚¹ç±»å‹?}
        Check -->|å¹³å°æ‰˜ç®¡| Direct[ç›´æ¥ä½¿ç”¨<br/>å¹³å°æ‰£è´¹]
        Check -->|ç¬¬ä¸‰æ–¹æœåŠ¡| OAuth[OAuthæˆæƒ<br/>ç”¨æˆ·æ•°æ®]
        Check -->|åŠŸèƒ½èŠ‚ç‚¹| Use[ç›´æ¥ä½¿ç”¨]
        Check -->|å®˜æ–¹æ’ä»¶| Plugin[è°ƒç”¨å¹³å°API<br/>æŒ‰é‡è®¡è´¹]
    end

    Cat1 --> Check
    Cat2 --> Check
    Cat3 --> Check
    Cat4 --> Check
```

**èŠ‚ç‚¹åˆ†ç±»ç»Ÿè®¡**ï¼š

| èŠ‚ç‚¹ç±»å‹ | æ•°é‡ | é…ç½®æ–¹å¼ | è®¡è´¹æ–¹å¼ | ç¤ºä¾‹ |
|---------|------|---------|---------|------|
| **å¹³å°æ‰˜ç®¡ AI èŠ‚ç‚¹** | 15 | å¹³å°ç»Ÿä¸€é…ç½® API Key | æŒ‰ Token è®¡è´¹ | OpenAI, Claude, Gemini |
| **ç¬¬ä¸‰æ–¹æœåŠ¡èŠ‚ç‚¹** | 300+ | ç”¨æˆ· OAuth æˆæƒæˆ–è¾“å…¥ API Key | ç”¨æˆ·è‡ªä»˜è´¹ | Notion, Slack, GitHub |
| **åŠŸèƒ½èŠ‚ç‚¹** | 50+ | æ— éœ€é…ç½® | å…è´¹ | Code, HTTP Request, Filter |
| **å¹³å°å®˜æ–¹æ’ä»¶** | å¾…å¼€å‘ | å¹³å°ç»Ÿä¸€é…ç½® | æŒ‰è°ƒç”¨æ¬¡æ•°è®¡è´¹ | å¤©æ°”æŸ¥è¯¢, OCR è¯†åˆ« |

**å…³é”®è®¾è®¡å†³ç­–**ï¼š

1. **ä¿ç•™å‡­è¯ç³»ç»Ÿä½œä¸ºé«˜çº§åŠŸèƒ½**ï¼šå‘åå…¼å®¹,é«˜çº§ç”¨æˆ·å¯åˆ›å»ºå‡­è¯åœ¨å¤šä¸ªèŠ‚ç‚¹é—´å¤ç”¨
2. **OAuth ä¼˜å…ˆ**ï¼šæ”¯æŒçš„ç¬¬ä¸‰æ–¹æœåŠ¡ä¼˜å…ˆä½¿ç”¨ OAuth æˆæƒ,æå‡ç”¨æˆ·ä½“éªŒ
3. **èŠ‚ç‚¹å‚æ•°è¾“å…¥**ï¼šä¸æ”¯æŒ OAuth çš„æœåŠ¡åœ¨èŠ‚ç‚¹å‚æ•°ä¸­ç›´æ¥è¾“å…¥ API Key
4. **é…é¢æ§åˆ¶**ï¼šå¹³å°æ‰˜ç®¡èŠ‚ç‚¹æ¯å·¥ä½œç©ºé—´è®¾ç½®æœˆåº¦é…é¢ï¼ˆå¦‚ 100 ä¸‡ tokensï¼‰

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡ä¸å®æ–½

### å®æ–½ç­–ç•¥ï¼ˆå…¨æ–°é¡¹ç›®ï¼‰

ç”±äºé¡¹ç›®æœªä¸Šçº¿ï¼Œé‡‡ç”¨**ç›´æ¥åˆ›å»ºæ–°æ¶æ„**æ–¹å¼ï¼š

```
âœ… æ­£ç¡®åšæ³•ï¼ˆä½ ä»¬çš„æƒ…å†µï¼‰:
1. ç›´æ¥åˆ é™¤ shared_workflow å’Œ shared_credentials è¡¨
2. åœ¨ workflow_entity å’Œ credentials_entity æ·»åŠ  project_id å­—æ®µ
3. åˆ›å»ºæ–°çš„å¤šç§Ÿæˆ·ç›¸å…³è¡¨
4. TypeORM è‡ªåŠ¨åŒæ­¥æ•°æ®åº“ç»“æ„

âŒ é”™è¯¯åšæ³•ï¼ˆä¸éœ€è¦ï¼‰:
1. å¤‡ä»½ shared_workflow
2. è¿ç§»æ•°æ®
3. å¤æ‚çš„æ•°æ®è½¬æ¢
```

### TypeORM Migration æ–¹æ¡ˆï¼ˆæ¨èï¼‰

**åˆ›å»º Migration æ–‡ä»¶ï¼š**

```typescript
// packages/@n8n/db/src/migrations/common/1762504711060-CreateMultiTenancyTables.ts

export class CreateMultiTenancyTables1762504711060 implements ReversibleMigration {
  async up({ queryRunner, tablePrefix }: MigrationContext): Promise<void> {
    // 1. åˆ é™¤æ—§è¡¨
    await queryRunner.query(`DROP TABLE IF EXISTS ${tablePrefix}shared_workflow CASCADE`);
    await queryRunner.query(`DROP TABLE IF EXISTS ${tablePrefix}shared_credentials CASCADE`);

    // 2. æ·»åŠ  project_id åˆ°èµ„æºè¡¨
    await queryRunner.query(`
      ALTER TABLE ${tablePrefix}workflow_entity
      ADD COLUMN project_id UUID NOT NULL,
      ADD CONSTRAINT fk_workflow_project
        FOREIGN KEY (project_id) REFERENCES ${tablePrefix}project(id)
        ON DELETE CASCADE
    `);

    // 3. åˆ›å»ºç´¢å¼•
    await queryRunner.query(`
      CREATE INDEX idx_workflow_project ON ${tablePrefix}workflow_entity(project_id);
      CREATE INDEX idx_workflow_project_active
        ON ${tablePrefix}workflow_entity(project_id, active);
    `);

    // 4. åˆ›å»ºè®¡è´¹ç³»ç»Ÿè¡¨
    await queryRunner.query(`
      CREATE TABLE ${tablePrefix}usage_record (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        workspace_id UUID NOT NULL,
        user_id UUID NOT NULL,
        service_key VARCHAR(100) NOT NULL,
        tokens_used INT,
        calls_count INT DEFAULT 1,
        cost_cny DECIMAL(10, 4) NOT NULL,
        metadata JSONB,
        created_at TIMESTAMP DEFAULT NOW(),
        CONSTRAINT fk_usage_workspace
          FOREIGN KEY (workspace_id) REFERENCES ${tablePrefix}project(id)
      );
    `);

    // 5. åˆ›å»ºå¹³å°æœåŠ¡è¡¨ï¼ˆæ”¯æŒèŠ‚ç‚¹åŠ¨æ€åŒ–ï¼‰
    await queryRunner.query(`
      CREATE TABLE ${tablePrefix}platform_service (
        service_key VARCHAR(100) PRIMARY KEY,
        service_type VARCHAR(50) NOT NULL,  -- 'ai_model' | 'rag' | 'plugin' | 'node'
        name VARCHAR(200) NOT NULL,

        -- èŠ‚ç‚¹åŠ¨æ€åŒ–å­—æ®µ
        node_type VARCHAR(100),              -- èŠ‚ç‚¹ç±»å‹ï¼š'openai', 'anthropic', 'notion' ç­‰
        node_category VARCHAR(50),           -- 'platform_managed' | 'third_party' | 'function' | 'official_plugin'
        api_key_encrypted TEXT,              -- åŠ å¯†çš„å¹³å° API Keyï¼ˆä»… platform_managed ä½¿ç”¨ï¼‰
        quota_config JSONB,                  -- é…é¢é…ç½®ï¼š{ monthlyTokens: 1000000, monthlyRequests: 10000 }

        pricing_config JSONB NOT NULL,       -- è®¡è´¹é…ç½®
        is_active BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
      );
    `);
  }

  async down({ queryRunner, tablePrefix }: MigrationContext): Promise<void> {
    // å›æ»šæ“ä½œï¼ˆå¼€å‘ç¯å¢ƒä¸€èˆ¬ç”¨ä¸åˆ°ï¼‰
    await queryRunner.query(`DROP TABLE IF EXISTS ${tablePrefix}platform_service`);
    await queryRunner.query(`DROP TABLE IF EXISTS ${tablePrefix}usage_record`);
    await queryRunner.query(`ALTER TABLE ${tablePrefix}workflow_entity DROP COLUMN project_id`);
  }
}
```

**æ‰§è¡Œ Migrationï¼š**

```bash
# è¿è¡Œæ•°æ®åº“è¿ç§»
pnpm --filter @n8n/cli db:migrate

# éªŒè¯è¿ç§»æˆåŠŸ
psql -U n8n -d n8n -c "\dt"
```

---

## ğŸ”§ åç«¯æ¶æ„

### Service å±‚æ ¸å¿ƒæ¥å£

```typescript
// packages/cli/src/services/

/** è®¡è´¹æœåŠ¡ */
interface BillingService {
  checkBalance(workspaceId: string, estimatedCost: number): Promise<void>;
  recordUsageAndCharge(params: UsageParams): Promise<void>;
  getMonthlyBill(workspaceId: string, month: string): Promise<Bill>;
  recharge(workspaceId: string, amount: number, paymentData: PaymentData): Promise<void>;
}

/** å¹³å° RAG æœåŠ¡ */
interface PlatformRagService {
  query(workspaceId: string, serviceKey: string, query: string): Promise<RagResult>;
  listAvailableServices(): Promise<RagService[]>;
}

/** æ’ä»¶éªŒè¯æœåŠ¡ */
interface PluginValidatorService {
  validateTypeScript(code: string): Promise<ValidationResult>;
  checkSecurity(code: string): Promise<SecurityResult>;
}

/** å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡æœåŠ¡ */
interface WorkspaceContextService {
  getCurrentWorkspace(userId: string): Promise<Project>;
  switchWorkspace(userId: string, workspaceId: string): Promise<void>;
}

/** èŠ‚ç‚¹å¯è§æ€§æœåŠ¡ï¼ˆèŠ‚ç‚¹åŠ¨æ€åŒ–æ ¸å¿ƒï¼‰ */
interface NodeVisibilityService {
  // è·å–å·¥ä½œç©ºé—´å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨
  getAvailableNodes(workspaceId: string): Promise<{
    platformManagedNodes: NodeInfo[];     // å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼ˆOpenAI, Claudeç­‰ï¼‰
    thirdPartyNodes: NodeInfo[];          // ç¬¬ä¸‰æ–¹æœåŠ¡èŠ‚ç‚¹ï¼ˆNotion, Slackç­‰ï¼‰
    functionNodes: NodeInfo[];            // åŠŸèƒ½èŠ‚ç‚¹ï¼ˆCode, HTTPç­‰ï¼‰
    officialPlugins: NodeInfo[];          // å¹³å°å®˜æ–¹æ’ä»¶
  }>;

  // è·å–èŠ‚ç‚¹çš„å‡­è¯é…ç½®ï¼ˆç”¨äºèŠ‚ç‚¹æ‰§è¡Œæ—¶æ³¨å…¥ï¼‰
  getNodeCredentials(nodeType: string, workspaceId: string): Promise<CredentialData | null>;

  // æ£€æŸ¥å·¥ä½œç©ºé—´æ˜¯å¦æœ‰æƒé™ä½¿ç”¨æŸä¸ªèŠ‚ç‚¹
  checkNodeAccess(workspaceId: string, nodeType: string): Promise<boolean>;

  // è®°å½•èŠ‚ç‚¹ä½¿ç”¨å¹¶æ‰£è´¹ï¼ˆå¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼‰
  recordNodeUsageAndCharge(params: {
    workspaceId: string;
    nodeType: string;
    tokensUsed?: number;
    requestCount?: number;
  }): Promise<void>;
}
```

**èŠ‚ç‚¹åŠ¨æ€åŒ–å®ç°ç¤ºä¾‹**ï¼š

```typescript
// packages/cli/src/services/node-visibility.service.ts
@Service()
export class NodeVisibilityService {
  async getAvailableNodes(workspaceId: string) {
    // 1. è·å–æ‰€æœ‰å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼ˆAIå¤§æ¨¡å‹ï¼‰
    const platformManagedNodes = await this.platformServiceRepository.find({
      where: {
        service_type: 'node',
        node_category: 'platform_managed',
        is_active: true
      }
    });

    // 2. è·å–æ‰€æœ‰ç¬¬ä¸‰æ–¹æœåŠ¡èŠ‚ç‚¹ï¼ˆå›ºå®šåˆ—è¡¨ï¼Œæ‰€æœ‰å·¥ä½œç©ºé—´å¯è§ï¼‰
    const thirdPartyNodes = ALL_THIRD_PARTY_NODES; // Notion, Slack, GitHub ç­‰

    // 3. è·å–åŠŸèƒ½èŠ‚ç‚¹ï¼ˆå›ºå®šåˆ—è¡¨ï¼Œæ— éœ€é…ç½®ï¼‰
    const functionNodes = ALL_FUNCTION_NODES; // Code, HTTP Request, Filter ç­‰

    // 4. è·å–å¹³å°å®˜æ–¹æ’ä»¶ï¼ˆç®¡ç†å‘˜åˆ›å»ºçš„æ’ä»¶ï¼‰
    const officialPlugins = await this.platformServiceRepository.find({
      where: {
        service_type: 'plugin',
        node_category: 'official_plugin',
        is_active: true
      }
    });

    return {
      platformManagedNodes: platformManagedNodes.map(toNodeInfo),
      thirdPartyNodes,
      functionNodes,
      officialPlugins: officialPlugins.map(toNodeInfo)
    };
  }

  async getNodeCredentials(nodeType: string, workspaceId: string) {
    // å¦‚æœæ˜¯å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼Œè¿”å›å¹³å°çš„ API Key
    const platformNode = await this.platformServiceRepository.findOne({
      where: { node_type: nodeType, node_category: 'platform_managed' }
    });

    if (platformNode && platformNode.api_key_encrypted) {
      // è§£å¯†å¹¶è¿”å›å¹³å° API Key
      return {
        apiKey: await this.decrypt(platformNode.api_key_encrypted)
      };
    }

    // å¦åˆ™ï¼Œç”¨æˆ·éœ€è¦è‡ªå·±é…ç½®å‡­è¯ï¼ˆé€šè¿‡å‡­è¯ç³»ç»Ÿæˆ–èŠ‚ç‚¹å‚æ•°ï¼‰
    return null;
  }
}
```

### API è·¯ç”±è®¾è®¡

```typescript
// å·¥ä½œç©ºé—´ç›¸å…³ API
GET    /rest/workspaces              // è·å–å½“å‰ç”¨æˆ·æ‰€æœ‰å·¥ä½œç©ºé—´
POST   /rest/workspaces              // åˆ›å»ºæ–°å·¥ä½œç©ºé—´
GET    /rest/workspaces/:id          // è·å–å·¥ä½œç©ºé—´è¯¦æƒ…
PATCH  /rest/workspaces/:id          // æ›´æ–°å·¥ä½œç©ºé—´ä¿¡æ¯
DELETE /rest/workspaces/:id          // åˆ é™¤/å½’æ¡£å·¥ä½œç©ºé—´

// å·¥ä½œæµ APIï¼ˆå·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡é€šè¿‡ Header ä¼ é€’ï¼‰
GET    /rest/workflows               // è·å–å½“å‰å·¥ä½œç©ºé—´çš„å·¥ä½œæµ
POST   /rest/workflows               // åœ¨å½“å‰å·¥ä½œç©ºé—´åˆ›å»ºå·¥ä½œæµ
PATCH  /rest/workflows/:id           // æ›´æ–°å·¥ä½œæµ
DELETE /rest/workflows/:id           // åˆ é™¤å·¥ä½œæµ

// è®¡è´¹ç›¸å…³ API
GET    /rest/billing/balance         // è·å–å½“å‰å·¥ä½œç©ºé—´ä½™é¢
POST   /rest/billing/recharge        // å‘èµ·å……å€¼
GET    /rest/billing/usage           // è·å–æ¶ˆè´¹è®°å½•

// å¹³å°æœåŠ¡ API
GET    /rest/platform-services       // è·å–å¯ç”¨å¹³å°æœåŠ¡åˆ—è¡¨
POST   /rest/platform-rag/query      // è°ƒç”¨å¹³å° RAG æœåŠ¡

// èŠ‚ç‚¹ç›¸å…³ APIï¼ˆèŠ‚ç‚¹åŠ¨æ€åŒ–ï¼‰
GET    /rest/nodes/available         // è·å–å½“å‰å·¥ä½œç©ºé—´å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨
GET    /rest/nodes/:type/credentials // è·å–èŠ‚ç‚¹çš„å¹³å°å‡­è¯ï¼ˆå¦‚æœæ˜¯å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼‰
GET    /rest/nodes/:type/quota       // è·å–èŠ‚ç‚¹çš„é…é¢ä½¿ç”¨æƒ…å†µï¼ˆå¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼‰

// åå°ç®¡ç† APIï¼ˆä»…ç®¡ç†å‘˜ï¼‰
GET    /rest/admin/platform-services           // ç®¡ç†å¹³å°æœåŠ¡
POST   /rest/admin/platform-services/nodes     // æ·»åŠ å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼ˆAIå¤§æ¨¡å‹ï¼‰
PATCH  /rest/admin/platform-services/nodes/:type // æ›´æ–°èŠ‚ç‚¹é…ç½®ï¼ˆAPI Keyã€é…é¢ç­‰ï¼‰
POST   /rest/admin/workspaces/:id/recharge     // ç®¡ç†å‘˜å……å€¼
GET    /rest/admin/stats/overview              // å¹³å°ç»Ÿè®¡æ•°æ®
```

### è®¤è¯å’Œé‰´æƒï¼ˆJWT + å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡ï¼‰

**å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡ä¼ é€’ï¼ˆé€šè¿‡ HTTP Headerï¼‰ï¼š**

```typescript
// å‰ç«¯ï¼šæ¯æ¬¡ API è¯·æ±‚è‡ªåŠ¨é™„åŠ 
axios.interceptors.request.use((config) => {
  const token = localStorage.getItem('n8n_token');
  const activeWorkspaceId = projectsStore.currentWorkspaceId;

  config.headers['Authorization'] = `Bearer ${token}`;
  if (activeWorkspaceId) {
    config.headers['X-Workspace-Id'] = activeWorkspaceId;
  }
  return config;
});

// åç«¯ï¼šä¸­é—´ä»¶æå–
export const workspaceContextMiddleware: RequestHandler = async (req, res, next) => {
  const token = req.headers['authorization']?.replace('Bearer ', '');
  const workspaceId = req.headers['x-workspace-id'];

  // éªŒè¯ JWT token
  const decoded = jwt.verify(token, process.env.JWT_SECRET);
  req.user = decoded;

  // éªŒè¯å·¥ä½œç©ºé—´æƒé™
  if (workspaceId) {
    const hasAccess = await workspaceContextService.validateAccess(
      decoded.userId,
      workspaceId,
    );
    if (!hasAccess) {
      return res.status(403).json({ error: 'Forbidden' });
    }
    req.workspaceContext = { workspaceId };
  }

  next();
};
```

### å·¥ä½œç©ºé—´éš”ç¦»æœºåˆ¶è¯¦è§£

**n8n å·²å†…ç½®å®Œæ•´çš„å·¥ä½œç©ºé—´éš”ç¦»æœºåˆ¶**ï¼Œé€šè¿‡ `@ProjectScope` è£…é¥°å™¨å®ç°ã€‚æ”¹é€ è¿‡ç¨‹ä¸­å‘ç°ï¼š

#### æ ¸å¿ƒæ¦‚å¿µï¼šProject = Workspace

åœ¨ n8n æ¶æ„ä¸­ï¼Œ**Project å®ä½“å°±æ˜¯ Workspaceï¼ˆå·¥ä½œç©ºé—´ï¼‰** çš„å®ç°ï¼š

```typescript
// packages/@n8n/db/src/entities/project.entity.ts
@Entity()
export class Project {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'varchar', nullable: false })
  name: string;  // å·¥ä½œç©ºé—´åç§°

  @Column({ type: 'enum', enum: ['personal', 'team'], default: 'personal' })
  type: 'personal' | 'team';  // å·¥ä½œç©ºé—´ç±»å‹

  // å…³ç³»ï¼šå·¥ä½œç©ºé—´æˆå‘˜
  @OneToMany(() => ProjectRelation, (relation) => relation.project)
  projectRelations: ProjectRelation[];

  // å…³ç³»ï¼šå·¥ä½œç©ºé—´èµ„æº
  @OneToMany(() => Workflow, (workflow) => workflow.project)
  workflows: Workflow[];

  @OneToMany(() => Credentials, (credentials) => credentials.project)
  credentials: Credentials[];
}
```

#### @ProjectScope è£…é¥°å™¨æœºåˆ¶

n8n ä½¿ç”¨ `@ProjectScope` è£…é¥°å™¨åœ¨è·¯ç”±çº§åˆ«è‡ªåŠ¨å®ç°å·¥ä½œç©ºé—´éš”ç¦»ï¼š

```typescript
// packages/@n8n/decorators/src/project-scope.ts

/**
 * @ProjectScope è£…é¥°å™¨
 *
 * åŠŸèƒ½ï¼š
 * 1. ä»è¯·æ±‚å‚æ•°ä¸­æå– projectId (å³ workspaceId)
 * 2. éªŒè¯å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥ Project
 * 3. è‡ªåŠ¨è¿‡æ»¤æŸ¥è¯¢ç»“æœï¼Œåªè¿”å›è¯¥å·¥ä½œç©ºé—´çš„æ•°æ®
 *
 * ä½¿ç”¨ä½ç½®ï¼šController çš„è·¯ç”±æ–¹æ³•ä¸Š
 */
export function ProjectScope(options?: ProjectScopeOptions) {
  return function(
    target: any,
    propertyKey: string,
    descriptor: PropertyDescriptor
  ) {
    // æ‹¦æˆªå™¨é€»è¾‘ï¼š
    // 1. æ£€æŸ¥ req.params.projectId æˆ– req.query.projectId
    // 2. æŸ¥è¯¢ ProjectRelation è¡¨éªŒè¯ user æ˜¯å¦å±äºè¯¥ project
    // 3. å¦‚æœéªŒè¯å¤±è´¥ï¼ŒæŠ›å‡º ForbiddenError
    // 4. éªŒè¯æˆåŠŸåï¼Œå°† projectId æ³¨å…¥åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡
  };
}
```

**å®é™…åº”ç”¨ç¤ºä¾‹ï¼š**

```typescript
// packages/cli/src/workflows/workflows.controller.ts
@RestController('/workflows')
export class WorkflowsController {

  // âœ… ä½¿ç”¨ @ProjectScope è‡ªåŠ¨å®ç°å·¥ä½œç©ºé—´éš”ç¦»
  @Get('/')
  @ProjectScope()  // å…³é”®è£…é¥°å™¨
  async getWorkflows(req: AuthenticatedRequest) {
    // @ProjectScope ç¡®ä¿æ­¤æ–¹æ³•åªèƒ½è®¿é—®å½“å‰ç”¨æˆ·æœ‰æƒé™çš„å·¥ä½œç©ºé—´
    // Service å±‚ä¼šè‡ªåŠ¨è¿‡æ»¤ï¼Œåªè¿”å›è¯¥å·¥ä½œç©ºé—´çš„ workflows
    return await this.workflowService.getAll(req.user);
  }

  @Post('/')
  @ProjectScope()
  async createWorkflow(req: AuthenticatedRequest, @Body body: WorkflowCreateDto) {
    // åˆ›å»ºçš„ workflow ä¼šè‡ªåŠ¨å…³è”åˆ°å½“å‰å·¥ä½œç©ºé—´
    return await this.workflowService.create(body, req.user);
  }
}
```

#### Service å±‚è‡ªåŠ¨è¿‡æ»¤

Service å±‚é€šè¿‡ç”¨æˆ·-é¡¹ç›®å…³ç³»è‡ªåŠ¨è¿‡æ»¤æ•°æ®ï¼š

```typescript
// packages/cli/src/services/workflow.service.ts
@Service()
export class WorkflowService {
  async getAll(user: User): Promise<Workflow[]> {
    // è‡ªåŠ¨æ ¹æ®ç”¨æˆ·çš„ ProjectRelation è¿‡æ»¤
    // åªè¿”å›ç”¨æˆ·æœ‰æƒé™çš„å·¥ä½œç©ºé—´ä¸­çš„ workflows
    return await this.workflowRepository.getAccessibleByUser(user.id);
  }
}

// packages/@n8n/db/src/repositories/workflow.repository.ts
@Service()
export class WorkflowRepository {
  async getAccessibleByUser(userId: string): Promise<Workflow[]> {
    // âœ… é€šè¿‡ Project å…³ç³»è‡ªåŠ¨å®ç°å·¥ä½œç©ºé—´éš”ç¦»
    return this.createQueryBuilder('workflow')
      .innerJoin('workflow.project', 'project')        // Workflow -> Project
      .innerJoin('project.projectRelations', 'pr')     // Project -> User
      .where('pr.userId = :userId', { userId })
      .getMany();
    // ç»“æœï¼šåªè¿”å›ç”¨æˆ·æ‰€å±å·¥ä½œç©ºé—´çš„ workflows
  }
}
```

#### å®æ–½å‘ç°ï¼šæ— éœ€æ˜¾å¼ä¸­é—´ä»¶

åœ¨å®é™…æ”¹é€ è¿‡ç¨‹ä¸­å‘ç°ï¼š

1. **å·²æœ‰æœºåˆ¶å®Œå¤‡**ï¼š`@ProjectScope` + Service å±‚å·²å®ç° 100% å·¥ä½œç©ºé—´éš”ç¦»
2. **æ— éœ€é¢å¤–ä¸­é—´ä»¶**ï¼šController ä¸éœ€è¦æ‰‹åŠ¨åº”ç”¨ `WorkspaceContextMiddleware`
3. **åªéœ€ä¾èµ–æ³¨å…¥**ï¼šController åªéœ€æ³¨å…¥ `WorkspaceContextMiddleware` ä½œä¸ºä¾èµ–å¤‡ç”¨

```typescript
// packages/cli/src/workflows/workflows.controller.ts
@RestController('/workflows')
export class WorkflowsController {
  constructor(
    private readonly workflowService: WorkflowService,
    // âœ… æ³¨å…¥ä¸­é—´ä»¶ï¼ˆå¤‡ç”¨ï¼Œå®é™…ä¸éœ€è¦æ‰‹åŠ¨åº”ç”¨ï¼‰
    private readonly workspaceContextMiddleware: WorkspaceContextMiddleware,
  ) {}

  // @ProjectScope è£…é¥°å™¨å·²ç»å¤„ç†äº†æ‰€æœ‰éš”ç¦»é€»è¾‘
  @Get('/')
  @ProjectScope()
  async getWorkflows(req: AuthenticatedRequest) {
    return await this.workflowService.getAll(req.user);
  }
}
```

#### å®Œæ•´éš”ç¦»æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å‰ç«¯å®¢æˆ·ç«¯
    participant Router as Express Router
    participant ProjectScope as @ProjectScope è£…é¥°å™¨
    participant Service as Workflow Service
    participant Repo as Workflow Repository
    participant DB as Database

    Client->>Router: GET /workflows (Header: Authorization)
    Router->>ProjectScope: æ‹¦æˆªè¯·æ±‚
    ProjectScope->>DB: æŸ¥è¯¢ ProjectRelation (userId + projectId)
    DB-->>ProjectScope: éªŒè¯ç”¨æˆ·æ˜¯å¦å±äºå·¥ä½œç©ºé—´

    alt ç”¨æˆ·æ— æƒé™
        ProjectScope-->>Client: 403 Forbidden
    else ç”¨æˆ·æœ‰æƒé™
        ProjectScope->>Service: æ³¨å…¥ projectId åˆ°ä¸Šä¸‹æ–‡
        Service->>Repo: getAccessibleByUser(userId)
        Repo->>DB: SELECT * FROM workflow WHERE project_id IN (ç”¨æˆ·çš„projects)
        DB-->>Repo: è¿‡æ»¤åçš„ workflows
        Repo-->>Service: è¿”å›æ•°æ®
        Service-->>Client: 200 OK + workflows
    end
```

**å…³é”®ä¼˜åŠ¿ï¼š**

1. âœ… **å£°æ˜å¼éš”ç¦»**ï¼šé€šè¿‡è£…é¥°å™¨å£°æ˜ï¼Œä»£ç ç®€æ´
2. âœ… **è‡ªåŠ¨éªŒè¯**ï¼šæ— éœ€æ‰‹åŠ¨æ£€æŸ¥æƒé™
3. âœ… **ç±»å‹å®‰å…¨**ï¼šTypeScript ç¼–è¯‘æ—¶æ£€æŸ¥
4. âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘ä¸€å±‚ SharedWorkflow JOINï¼ˆä» 4 å±‚é™åˆ° 3 å±‚ï¼‰
5. âœ… **å¼€å‘ä½“éªŒå¥½**ï¼šæ–°å¢ Controller åªéœ€æ·»åŠ  `@ProjectScope()` å³å¯

### Repository å±‚ç®€åŒ–å¯¹æ¯”

**æ”¹é€ å‰ï¼ˆå¤æ‚ï¼‰ï¼š**
```typescript
// âŒ éœ€è¦ 4 å±‚ JOIN
async findAccessibleByUser(userId: string) {
  return this.createQueryBuilder('workflow')
    .innerJoin('workflow.shared', 'shared')          // +1 å±‚
    .innerJoin('shared.project', 'project')         // +1 å±‚
    .innerJoin('project.projectRelations', 'pr')    // +1 å±‚
    .where('pr.userId = :userId')
    .getMany();
}
```

**æ”¹é€ åï¼ˆç®€åŒ–ï¼‰ï¼š**
```typescript
// âœ… åªéœ€ 3 å±‚ JOIN
async findAccessibleByUser(userId: string) {
  return this.createQueryBuilder('workflow')
    .innerJoin('workflow.project', 'project')       // ç›´æ¥ JOIN
    .innerJoin('project.projectRelations', 'pr')
    .where('pr.userId = :userId')
    .getMany();
}
```

---

## ğŸ¨ å‰ç«¯æ¶æ„

### å‰åç«¯åˆ†ç¦»æ¶æ„ç°çŠ¶

**å½“å‰æ¶æ„ï¼ˆå·²å®ç°ï¼‰ï¼š**

```
å¼€å‘ç¯å¢ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»åº”ç”¨å‰ç«¯      â”‚         â”‚  ç®¡ç†åå°å‰ç«¯    â”‚
â”‚  (editor-ui)     â”‚         â”‚  (admin-panel)   â”‚
â”‚  Vite Dev        â”‚         â”‚  Vite Dev        â”‚
â”‚  Port: 8080      â”‚         â”‚  Port: 5679      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚   Proxy                     â”‚   Proxy
          â”‚   /rest, /webhook           â”‚   /rest
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   åç«¯ API æœåŠ¡       â”‚
          â”‚   Express Server      â”‚
          â”‚   Port: 5678          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„ï¼š**

```nginx
# ç”¨æˆ·å‰ç«¯
server {
    listen 443 ssl http2;
    server_name user.example.com;

    # å‰ç«¯é™æ€æ–‡ä»¶
    root /var/www/n8n/editor-ui/dist;
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API ä»£ç†åˆ°åç«¯
    location /rest {
        proxy_pass http://localhost:5678;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Real-IP $remote_addr;
    }

    # WebSocket æ”¯æŒ
    location /rest/push {
        proxy_pass http://localhost:5678;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# ç®¡ç†åå°å‰ç«¯
server {
    listen 443 ssl http2;
    server_name admin.example.com;

    root /var/www/n8n/admin-panel/dist;
    location / {
        try_files $uri $uri/ /index.html;
    }

    location /rest {
        proxy_pass http://localhost:5678;
    }
}
```

### å·¥ä½œç©ºé—´åˆ‡æ¢å™¨ï¼ˆå¯¹æ ‡ Cozeï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  æˆ‘çš„ä¸ªäººç©ºé—´ â–¼         $ ä½™é¢: Â¥98.50 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ æˆ‘çš„ä¸ªäººç©ºé—´ (é»˜è®¤)               â”‚
â”‚  ğŸ‘¥ å…¬å¸å›¢é˜Ÿç©ºé—´                     â”‚
â”‚  â• åˆ›å»ºæ–°å·¥ä½œç©ºé—´                   â”‚
â”‚  âš™ï¸  ç®¡ç†å·¥ä½œç©ºé—´                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°è·¯å¾„ï¼š**
- ç»„ä»¶ï¼š`packages/editor-ui/src/components/WorkspaceSwitcher.vue`
- Storeï¼š`packages/editor-ui/src/stores/workspace.store.ts`
- APIï¼š`GET /api/v1/workspaces`, `POST /api/v1/workspaces/:id/switch`

### WebSocket å·¥ä½œç©ºé—´éš”ç¦»

**é—®é¢˜ï¼š** WebSocket è¿æ¥éœ€è¦æºå¸¦å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡

**è§£å†³æ–¹æ¡ˆï¼š**

```typescript
// æ–¹å¼ Aï¼šé€šè¿‡ Query Parameter
const ws = new WebSocket(`ws://api.example.com/rest/push?workspaceId=${workspaceId}`);

// æ–¹å¼ Bï¼šé€šè¿‡åˆå§‹æ¡æ‰‹æ¶ˆæ¯
const ws = new WebSocket('ws://api.example.com/rest/push');
ws.onopen = () => {
  ws.send(JSON.stringify({
    type: 'auth',
    token: authToken,
    workspaceId: currentWorkspaceId,
  }));
};

// åç«¯éªŒè¯
io.on('connection', (socket) => {
  socket.on('auth', async (data) => {
    const { token, workspaceId } = data;
    const hasAccess = await validateWorkspaceAccess(user.id, workspaceId);

    if (hasAccess) {
      socket.workspaceId = workspaceId;
      // åŠ å…¥å·¥ä½œç©ºé—´æˆ¿é—´ï¼ˆç”¨äºå¹¿æ’­ï¼‰
      socket.join(`workspace:${workspaceId}`);
    } else {
      socket.disconnect();
    }
  });
});
```

**å·¥ä½œç©ºé—´åˆ‡æ¢æ—¶çš„å¤„ç†ï¼š**

```typescript
function switchWorkspace(newWorkspaceId: string) {
  // 1. æ›´æ–° store
  projectsStore.setActiveWorkspace(newWorkspaceId);

  // 2. å…³é—­æ—§ WebSocket è¿æ¥
  if (pushConnection) {
    pushConnection.close();
  }

  // 3. å»ºç«‹æ–° WebSocket è¿æ¥
  pushConnection = new WebSocket(
    `ws://api.example.com/rest/push?workspaceId=${newWorkspaceId}`
  );

  // 4. åˆ·æ–°é¡µé¢æ•°æ®
  await workflowsStore.fetchWorkflows();
  await credentialsStore.fetchCredentials();
}
```

### ä¸»è¦æ–°å¢é¡µé¢

| é¡µé¢ | è·¯å¾„ | ç”¨é€” |
|------|------|------|
| æ³¨å†Œé¡µ | `/register` | ç”¨æˆ·æ³¨å†Œ + é‚®ç®±éªŒè¯ |
| å¼•å¯¼é¡µ | `/onboarding` | æ–°æ‰‹ä»»åŠ¡ï¼ˆå¥–åŠ± Â¥15ï¼‰ |
| å·¥ä½œç©ºé—´è®¾ç½® | `/workspaces/:id/settings` | æˆå‘˜ç®¡ç†ã€é…é¢æŸ¥çœ‹ |
| è´¦å•ä¸­å¿ƒ | `/billing` | ä½™é¢ã€å……å€¼ã€è´¦å• |
| **èŠ‚ç‚¹å¸‚åœºï¼ˆæ–°ï¼‰** | `/nodes/marketplace` | **æµè§ˆå¹³å°æ‰˜ç®¡èŠ‚ç‚¹å’Œå®˜æ–¹æ’ä»¶** |
| **èŠ‚ç‚¹é…é¢ï¼ˆæ–°ï¼‰** | `/nodes/quota` | **æŸ¥çœ‹AIèŠ‚ç‚¹ä½¿ç”¨é…é¢å’Œæ¶ˆè´¹ç»Ÿè®¡** |
| æ’ä»¶å¸‚åœº | `/plugins` | æµè§ˆã€å®‰è£…æ’ä»¶ |
| æˆ‘çš„æ’ä»¶ | `/my-plugins` | ä¸Šä¼ è‡ªå®šä¹‰æ’ä»¶ |
| åå°ç®¡ç† | `/admin` | å¹³å°ç®¡ç†å‘˜ä¸“ç”¨ |
| **åå°èŠ‚ç‚¹ç®¡ç†ï¼ˆæ–°ï¼‰** | `/admin/nodes` | **ç®¡ç†å‘˜é…ç½®å¹³å°æ‰˜ç®¡AIèŠ‚ç‚¹** |

### èŠ‚ç‚¹åŠ¨æ€åŒ–å‰ç«¯å®ç°

**1. èŠ‚ç‚¹å¸‚åœºé¡µé¢ï¼ˆNodeMarketplace.vueï¼‰**

```vue
<template>
  <div class="node-marketplace">
    <h1>èŠ‚ç‚¹å¸‚åœº</h1>

    <!-- èŠ‚ç‚¹åˆ†ç±»æ ‡ç­¾é¡µ -->
    <n8n-tabs v-model="activeTab">
      <n8n-tab-pane label="å¹³å°æ‰˜ç®¡ AI èŠ‚ç‚¹" name="platform-managed">
        <div class="node-grid">
          <NodeCard
            v-for="node in platformManagedNodes"
            :key="node.type"
            :node="node"
            :status="'å¯ç›´æ¥ä½¿ç”¨'"
            :badge="'æŒ‰é‡è®¡è´¹'"
          >
            <template #price>
              <span>Â¥{{ node.pricePerToken }}/1K Tokens</span>
            </template>
            <template #quota>
              <ProgressBar
                :used="node.quotaUsed"
                :total="node.quotaTotal"
                :label="`æœ¬æœˆå·²ç”¨: ${node.quotaUsed.toLocaleString()}/${node.quotaTotal.toLocaleString()} tokens`"
              />
            </template>
          </NodeCard>
        </div>
      </n8n-tab-pane>

      <n8n-tab-pane label="ç¬¬ä¸‰æ–¹æœåŠ¡èŠ‚ç‚¹" name="third-party">
        <div class="node-grid">
          <NodeCard
            v-for="node in thirdPartyNodes"
            :key="node.type"
            :node="node"
            :status="node.isConfigured ? 'å·²é…ç½®' : 'éœ€è¦é…ç½®'"
            @click="handleNodeClick(node)"
          >
            <template #action>
              <n8n-button v-if="!node.isConfigured">
                {{ node.supportsOAuth ? 'OAuth æˆæƒ' : 'è¾“å…¥ API Key' }}
              </n8n-button>
            </template>
          </NodeCard>
        </div>
      </n8n-tab-pane>

      <n8n-tab-pane label="åŠŸèƒ½èŠ‚ç‚¹" name="function">
        <p class="info">åŠŸèƒ½èŠ‚ç‚¹æ— éœ€é…ç½®ï¼Œç›´æ¥åœ¨å·¥ä½œæµä¸­ä½¿ç”¨</p>
        <div class="node-grid">
          <NodeCard
            v-for="node in functionNodes"
            :key="node.type"
            :node="node"
            :status="'å…è´¹ä½¿ç”¨'"
            :badge="'æ— éœ€é…ç½®'"
          />
        </div>
      </n8n-tab-pane>

      <n8n-tab-pane label="å¹³å°å®˜æ–¹æ’ä»¶" name="official-plugins">
        <div class="node-grid">
          <NodeCard
            v-for="plugin in officialPlugins"
            :key="plugin.type"
            :node="plugin"
            :status="'å¯ç›´æ¥ä½¿ç”¨'"
            :badge="'æŒ‰æ¬¡è®¡è´¹'"
          >
            <template #price>
              <span>Â¥{{ plugin.pricePerRequest }}/æ¬¡</span>
            </template>
          </NodeCard>
        </div>
      </n8n-tab-pane>
    </n8n-tabs>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useNodesStore } from '@/stores/nodes.store';

const nodesStore = useNodesStore();
const activeTab = ref('platform-managed');

const platformManagedNodes = ref([]);
const thirdPartyNodes = ref([]);
const functionNodes = ref([]);
const officialPlugins = ref([]);

onMounted(async () => {
  const data = await nodesStore.fetchAvailableNodes();
  platformManagedNodes.value = data.platformManagedNodes;
  thirdPartyNodes.value = data.thirdPartyNodes;
  functionNodes.value = data.functionNodes;
  officialPlugins.value = data.officialPlugins;
});
</script>
```

**2. NodesStore æ‰©å±•ï¼ˆpackages/editor-ui/src/stores/nodes.store.tsï¼‰**

```typescript
export const useNodesStore = defineStore('nodes', {
  state: () => ({
    availableNodes: {
      platformManagedNodes: [],
      thirdPartyNodes: [],
      functionNodes: [],
      officialPlugins: []
    }
  }),

  actions: {
    async fetchAvailableNodes() {
      const workspaceId = useProjectsStore().currentWorkspaceId;
      const data = await nodesApi.getAvailableNodes(workspaceId);
      this.availableNodes = data;
      return data;
    },

    async getNodeCredentials(nodeType: string) {
      // å¦‚æœæ˜¯å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼Œä»å¹³å°è·å–å‡­è¯
      const credentials = await nodesApi.getNodeCredentials(nodeType);
      return credentials;
    },

    // èŠ‚ç‚¹åŠ è½½æ—¶è¿‡æ»¤ï¼ˆåœ¨å·¥ä½œæµç¼–è¾‘å™¨å·¦ä¾§èŠ‚ç‚¹é¢æ¿ï¼‰
    getFilteredNodesForEditor() {
      const { platformManagedNodes, thirdPartyNodes, functionNodes, officialPlugins } = this.availableNodes;

      return [
        ...platformManagedNodes.map(n => ({ ...n, category: 'AI å¤§æ¨¡å‹' })),
        ...thirdPartyNodes.map(n => ({ ...n, category: 'ç¬¬ä¸‰æ–¹æœåŠ¡' })),
        ...functionNodes.map(n => ({ ...n, category: 'åŠŸèƒ½èŠ‚ç‚¹' })),
        ...officialPlugins.map(n => ({ ...n, category: 'å¹³å°æ’ä»¶' }))
      ];
    }
  }
});
```

**3. åå°èŠ‚ç‚¹ç®¡ç†é¡µé¢ï¼ˆAdminNodeManagement.vueï¼‰**

```vue
<template>
  <div class="admin-node-management">
    <h1>å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ç®¡ç†</h1>

    <n8n-button @click="showAddNodeDialog = true">
      æ·»åŠ  AI å¤§æ¨¡å‹èŠ‚ç‚¹
    </n8n-button>

    <n8n-table :data="platformNodes">
      <n8n-table-column prop="name" label="èŠ‚ç‚¹åç§°" />
      <n8n-table-column prop="nodeType" label="èŠ‚ç‚¹ç±»å‹" />
      <n8n-table-column label="API Key">
        <template #default="{ row }">
          <span>{{ maskApiKey(row.apiKey) }}</span>
          <n8n-button size="small" @click="editApiKey(row)">æ›´æ–°</n8n-button>
        </template>
      </n8n-table-column>
      <n8n-table-column prop="quotaConfig.monthlyTokens" label="æœˆåº¦é…é¢" />
      <n8n-table-column prop="pricingConfig.pricePerToken" label="ä»·æ ¼" />
      <n8n-table-column label="çŠ¶æ€">
        <template #default="{ row }">
          <n8n-switch v-model="row.isActive" @change="toggleNode(row)" />
        </template>
      </n8n-table-column>
    </n8n-table>

    <!-- æ·»åŠ èŠ‚ç‚¹å¯¹è¯æ¡† -->
    <AddNodeDialog v-model="showAddNodeDialog" @confirm="handleAddNode" />
  </div>
</template>
```

---

## ğŸ”’ å®‰å…¨ä¸æ€§èƒ½

### å¹¶å‘å®‰å…¨ - ä½™é¢æ‰£è´¹é˜²é€æ”¯ï¼ˆP0 - å…³é”®ï¼‰

**é—®é¢˜ï¼š** é«˜å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½å‡ºç°ä½™é¢é€æ”¯

**è§£å†³æ–¹æ¡ˆï¼šæ‚²è§‚é”**

```typescript
@Service()
export class BillingService {
  /**
   * è®°å½•ä½¿ç”¨é‡å¹¶æ‰£è´¹ï¼ˆå¸¦æ‚²è§‚é”ï¼‰
   */
  async recordUsageAndCharge(params: UsageParams): Promise<UsageRecord> {
    return await this.projectRepository.manager.transaction(async (trx) => {
      // ğŸ”’ æ­¥éª¤1: ä½¿ç”¨æ‚²è§‚å†™é”é”å®šå·¥ä½œç©ºé—´è®°å½•
      const workspace = await trx.findOne(Project, {
        where: { id: workspaceId },
        lock: { mode: 'pessimistic_write' }, // âœ… æ‚²è§‚é”
      });

      if (!workspace) {
        throw new WorkspaceNotFoundError();
      }

      // æ­¥éª¤2: æ£€æŸ¥ä½™é¢
      if (workspace.balanceCny < amountCny) {
        throw new InsufficientBalanceError(
          `ä½™é¢ä¸è¶³: Â¥${workspace.balanceCny}, éœ€è¦: Â¥${amountCny}`,
        );
      }

      // æ­¥éª¤3: æ‰£é™¤ä½™é¢ï¼ˆåœ¨é”çš„ä¿æŠ¤ä¸‹ï¼Œå®‰å…¨æ‰§è¡Œï¼‰
      workspace.balanceCny -= amountCny;
      await trx.save(workspace);

      // æ­¥éª¤4: åˆ›å»ºä½¿ç”¨è®°å½•
      const usageRecord = this.usageRecordRepository.create({
        workspaceId,
        userId: params.userId,
        serviceKey: params.serviceKey,
        tokensUsed: params.tokensUsed,
        cost_cny: amountCny,
      });

      await trx.save(usageRecord);

      // æ­¥éª¤5: ä½ä½™é¢å‘Šè­¦
      if (workspace.balanceCny < workspace.lowBalanceThreshold) {
        await this.sendLowBalanceAlert(workspace);
      }

      return usageRecord;
    });
  }
}
```

**æ€§èƒ½å½±å“ï¼š**
- æ‚²è§‚é”å¼€é”€ï¼šå•æ¬¡æ‰£è´¹å¢åŠ çº¦ 5-10ms
- å¹¶å‘å®‰å…¨ï¼šå®Œå…¨æ¶ˆé™¤ä½™é¢é€æ”¯é£é™©

### API é™æµé˜²æŠ¤ï¼ˆP0 - å…³é”®ï¼‰

**Redis + æ»‘åŠ¨çª—å£é™æµï¼š**

```typescript
@Service()
export class RateLimitService {
  /**
   * åˆ›å»ºé™æµä¸­é—´ä»¶
   */
  createMiddleware(options: RateLimitOptions): RequestHandler {
    return async (req, res, next) => {
      const workspaceId = req.workspaceContext?.workspaceId;
      const key = `ratelimit:workspace:${workspaceId}`;

      const now = Date.now();
      const windowStart = now - options.window * 1000;

      // ä½¿ç”¨ Redis Sorted Set å®ç°æ»‘åŠ¨çª—å£
      const multi = this.redis.multi();
      multi.zremrangebyscore(key, 0, windowStart);  // ç§»é™¤çª—å£å¤–çš„è®°å½•
      multi.zcard(key);                              // ç»Ÿè®¡çª—å£å†…çš„è¯·æ±‚æ•°
      multi.zadd(key, now, `${now}-${Math.random()}`); // æ·»åŠ å½“å‰è¯·æ±‚
      multi.expire(key, options.window);             // è®¾ç½®è¿‡æœŸæ—¶é—´

      const results = await multi.exec();
      const count = results?.[1]?.[1] as number;

      if (count >= options.limit) {
        return res.status(429).json({
          error: 'Too Many Requests',
          message: `é™æµ: ${options.limit} æ¬¡/${options.window}ç§’`,
        });
      }

      next();
    };
  }
}
```

**é™æµç­–ç•¥é…ç½®ï¼š**

| æ¥å£ç±»å‹ | é™æµè§„åˆ™ | è¯´æ˜ |
|---------|---------|------|
| **å¹³å°æœåŠ¡è°ƒç”¨** | 100æ¬¡/åˆ†é’Ÿ/å·¥ä½œç©ºé—´ | é˜²æ­¢AIè´¹ç”¨å¤±æ§ |
| **å·¥ä½œæµæ‰§è¡Œ** | 1000æ¬¡/å°æ—¶/å·¥ä½œç©ºé—´ | é˜²æ­¢æ¶æ„å¾ªç¯æ‰§è¡Œ |
| **ç™»å½•æ¥å£** | 5æ¬¡/åˆ†é’Ÿ/IP | é˜²æ­¢æš´åŠ›ç ´è§£ |
| **æ³¨å†Œæ¥å£** | 3æ¬¡/å°æ—¶/IP | é˜²æ­¢æ‰¹é‡æ³¨å†Œ |

### XSS & CSRF é˜²æŠ¤ï¼ˆP1ï¼‰

**CSP å¤´éƒ¨é…ç½®ï¼š**

```typescript
res.setHeader(
  'Content-Security-Policy',
  "default-src 'self'; " +
  "script-src 'self' 'unsafe-inline' 'unsafe-eval'; " +
  "style-src 'self' 'unsafe-inline'; " +
  "img-src 'self' data: https:;"
);
res.setHeader('X-Frame-Options', 'SAMEORIGIN');
res.setHeader('X-Content-Type-Options', 'nosniff');
```

**CSRF é˜²æŠ¤ï¼ˆJWT æ–¹æ¡ˆï¼‰ï¼š**

ä½¿ç”¨ JWT + Authorization Header å¤©ç„¶é˜²å¾¡ CSRFï¼š
- JWT å­˜å‚¨åœ¨ localStorageï¼Œæ¶æ„ç½‘ç«™æ— æ³•è¯»å–
- è·¨åŸŸè¯·æ±‚æ— æ³•è‡ªåŠ¨æºå¸¦ Authorization Header
- æµè§ˆå™¨ Same-Origin Policy ä¿æŠ¤

### æ•æ„Ÿæ•°æ®åŠ å¯†ï¼ˆå·²å®ç°ï¼‰

**AES-256-GCM åŠ å¯†ï¼š**

```typescript
@Service()
export class EncryptionService {
  private readonly algorithm = 'aes-256-gcm';

  encrypt(plaintext: string): string {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv(this.algorithm, this.encryptionKey, iv);

    let encrypted = cipher.update(plaintext, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    const authTag = cipher.getAuthTag();

    return JSON.stringify({
      iv: iv.toString('hex'),
      data: encrypted,
      authTag: authTag.toString('hex'),
    });
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
// ä¿å­˜å‡­è¯æ—¶åŠ å¯†
const credential = {
  data: encryptionService.encrypt(JSON.stringify({ apiKey: 'sk-...' })),
};

// è¯»å–å‡­è¯æ—¶è§£å¯†
const decryptedData = JSON.parse(encryptionService.decrypt(credential.data));
```

---

## ğŸ“… å®æ–½è®¡åˆ’

### æ€»è§ˆï¼ˆ13-14 å‘¨ï¼ŒåŒ…å«èŠ‚ç‚¹åŠ¨æ€åŒ–ï¼‰

| é˜¶æ®µ | å‘¨æœŸ | ä»»åŠ¡ | å®Œæˆåº¦ |
|------|------|------|--------|
| **é˜¶æ®µ 0** | Week 0 | å‡†å¤‡å’Œè®¾è®¡ | âœ… 100% |
| **é˜¶æ®µ 1** | Week 1 | æ•°æ®åº“è¿ç§»è„šæœ¬ | âœ… 100% |
| **é˜¶æ®µ 2** | Week 2 | Entity + Repository å±‚ | âœ… 100% |
| **é˜¶æ®µ 3** | Week 3 | Service å±‚ | âœ… 100% |
| **é˜¶æ®µ 3.1** | Week 3 | æ’ä»¶ç®¡ç†ç³»ç»Ÿ | âœ… 100% |
| **é˜¶æ®µ 4** | Week 4-5 | Controller + Middleware | ğŸŸ¡ 30% |
| **é˜¶æ®µ 5** | Week 6-8 | å‰ç«¯æ”¹é€  | â¬œ 0% |
| **é˜¶æ®µ 5.1ï¼ˆæ–°ï¼‰** | Week 7-8 | **èŠ‚ç‚¹åŠ¨æ€åŒ–** | â¬œ 0% |
| **é˜¶æ®µ 6** | Week 9-10 | æ”¯ä»˜é›†æˆ | â¬œ 0% |
| **é˜¶æ®µ 7** | Week 11-12 | æµ‹è¯•å’Œä¼˜åŒ– | â¬œ 0% |
| **é˜¶æ®µ 8** | Week 13-14 | æ–‡æ¡£å’Œä¸Šçº¿ | â¬œ 0% |

**èŠ‚ç‚¹åŠ¨æ€åŒ–è¯¦ç»†ä»»åŠ¡ï¼ˆWeek 7-8ï¼‰**ï¼š

| ä»»åŠ¡ | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| æ‰©å±• platform_service è¡¨ï¼ˆå·²å®Œæˆï¼‰ | 0.5 å¤© | æ·»åŠ  node_type, node_category, api_key_encrypted, quota_config å­—æ®µ |
| å®ç° NodeVisibilityService | 1.5 å¤© | èŠ‚ç‚¹å¯è§æ€§æ§åˆ¶ã€å‡­è¯æ³¨å…¥ã€é…é¢ç®¡ç† |
| å®ç°èŠ‚ç‚¹ç›¸å…³ API | 1 å¤© | `/rest/nodes/available`, `/rest/nodes/:type/credentials` ç­‰ |
| åå°èŠ‚ç‚¹ç®¡ç†é¡µé¢ | 2 å¤© | ç®¡ç†å‘˜é…ç½®å¹³å°æ‰˜ç®¡ AI èŠ‚ç‚¹ã€è®¾ç½® API Key å’Œé…é¢ |
| èŠ‚ç‚¹å¸‚åœºå‰ç«¯é¡µé¢ | 2 å¤© | å±•ç¤ºå¹³å°æ‰˜ç®¡èŠ‚ç‚¹ã€ç¬¬ä¸‰æ–¹æœåŠ¡èŠ‚ç‚¹ã€åŠŸèƒ½èŠ‚ç‚¹ã€å®˜æ–¹æ’ä»¶ |
| èŠ‚ç‚¹é…é¢å±•ç¤ºé¡µé¢ | 1 å¤© | å±•ç¤ºå„ AI èŠ‚ç‚¹çš„é…é¢ä½¿ç”¨æƒ…å†µå’Œæ¶ˆè´¹ç»Ÿè®¡ |
| æµ‹è¯•å’Œä¼˜åŒ– | 2 å¤© | èŠ‚ç‚¹æƒé™æµ‹è¯•ã€é…é¢æ‰£è´¹æµ‹è¯•ã€UI/UX ä¼˜åŒ– |

**æ€»è®¡ï¼š10 å¤©ï¼ˆ2 å‘¨ï¼‰**

### å½“å‰çŠ¶æ€ï¼ˆWeek 4ï¼‰

**å·²å®Œæˆï¼š**
- âœ… 4 ä¸ªè¿ç§»è„šæœ¬ï¼ˆ1,412 è¡Œï¼‰
- âœ… 6 ä¸ªæ–° Entity
- âœ… 6 ä¸ªæ–° Repository
- âœ… 6 ä¸ª Service å±‚ï¼ˆ920 è¡Œï¼‰
- âœ… 2 ä¸ª Controllerï¼ˆæ’ä»¶ç®¡ç†ï¼Œ1,200 è¡Œï¼‰
- âœ… å…¨é‡æ„å»ºæˆåŠŸï¼ˆ42/42 ä»»åŠ¡ï¼‰

**è¿›è¡Œä¸­ï¼ˆé˜¶æ®µ 4ï¼‰ï¼š**
- ğŸŸ¡ BillingControllerï¼ˆè®¡è´¹ APIï¼‰
- ğŸŸ¡ WorkspaceControllerï¼ˆå·¥ä½œç©ºé—´ç®¡ç†ï¼‰
- ğŸŸ¡ PlatformServiceControllerï¼ˆå¹³å°æœåŠ¡ï¼‰
- ğŸŸ¡ Middleware å±‚ï¼ˆæ‰£è´¹ã€æƒé™æ£€æŸ¥ï¼‰

**å¾…å¼€å§‹ï¼š**
- â¬œ å‰ç«¯å·¥ä½œç©ºé—´åˆ‡æ¢å™¨
- â¬œ å‰ç«¯è´¦å•ä¸­å¿ƒ
- â¬œ å‰ç«¯æ’ä»¶å¸‚åœº
- â¬œ **å‰ç«¯èŠ‚ç‚¹å¸‚åœºï¼ˆèŠ‚ç‚¹åŠ¨æ€åŒ–ï¼‰**
- â¬œ **åå°èŠ‚ç‚¹ç®¡ç†é¡µé¢ï¼ˆèŠ‚ç‚¹åŠ¨æ€åŒ–ï¼‰**
- â¬œ **NodeVisibilityServiceï¼ˆèŠ‚ç‚¹åŠ¨æ€åŒ–ï¼‰**
- â¬œ æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜é›†æˆ

### é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | äº¤ä»˜ç‰© | éªŒæ”¶æ ‡å‡† |
|--------|--------|---------|
| **M1: æ•°æ®å±‚å®Œæˆ** | è¿ç§»è„šæœ¬ + Entity | æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ |
| **M2: åç«¯ API å®Œæˆ** | æ‰€æœ‰ Controller | Postman æµ‹è¯•é€šè¿‡ |
| **M3: å‰ç«¯å®Œæˆ** | æ‰€æœ‰é¡µé¢ | UI/UX æµ‹è¯•é€šè¿‡ |
| **M3.1: èŠ‚ç‚¹åŠ¨æ€åŒ–å®Œæˆï¼ˆæ–°ï¼‰** | èŠ‚ç‚¹å¸‚åœº + åå°ç®¡ç† | ç”¨æˆ·å¯ç›´æ¥ä½¿ç”¨å¹³å° OpenAI èŠ‚ç‚¹ï¼ˆæ— éœ€é…ç½® API Keyï¼‰ |
| **M4: è®¡è´¹ç³»ç»Ÿä¸Šçº¿** | æ”¯ä»˜é›†æˆ | çœŸå®å……å€¼/æ‰£è´¹æˆåŠŸ |
| **M5: ç”Ÿäº§å°±ç»ª** | æ–‡æ¡£ + éƒ¨ç½² | å‹æµ‹é€šè¿‡ï¼ˆ100 å¹¶å‘ï¼‰ |

---

## âš ï¸ é£é™©æ§åˆ¶

### æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **æ•°æ®åº“è¿ç§»å¤±è´¥** | ğŸ”´ é«˜ | ä½ | å¤šæ¬¡æµ‹è¯• + å›æ»šè„šæœ¬ |
| **æ€§èƒ½ä¸è¾¾é¢„æœŸ** | ğŸŸ¡ ä¸­ | ä½ | å‹æµ‹éªŒè¯ + ç´¢å¼•ä¼˜åŒ– |
| **ç¬¬ä¸‰æ–¹æ”¯ä»˜å¯¹æ¥** | ğŸŸ¡ ä¸­ | ä¸­ | æå‰ç”³è¯·æ²™ç›’ç¯å¢ƒ |
| **å¹¶å‘æ‰£è´¹å†²çª** | ğŸ”´ é«˜ | ä¸­ | æ‚²è§‚é” + äº‹åŠ¡éš”ç¦» |

### ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **ç”¨æˆ·ä¸æ¥å—ä»˜è´¹** | ğŸ”´ é«˜ | ä¸­ | å…è´¹é¢åº¦ + é‚€è¯·å¥–åŠ± |
| **è®¡è´¹å®šä»·ä¸åˆç†** | ğŸŸ¡ ä¸­ | é«˜ | å‚è€ƒ Coze å®šä»· |
| **æ’ä»¶å®¡æ ¸äººåŠ›ä¸è¶³** | ğŸŸ¡ ä¸­ | ä¸­ | è‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥ |

---

## âœ… æˆåŠŸæ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§

- [x] å¤šå·¥ä½œç©ºé—´åˆ‡æ¢
- [x] æŒ‰é‡è®¡è´¹ç³»ç»Ÿï¼ˆäººæ°‘å¸ï¼‰
- [x] ä¸‰å±‚æ’ä»¶ç³»ç»Ÿ
- [ ] **èŠ‚ç‚¹åŠ¨æ€åŒ–ï¼ˆæ–°ï¼‰**
  - [ ] å¹³å°æ‰˜ç®¡ AI èŠ‚ç‚¹ï¼ˆOpenAI, Claude, Geminiï¼‰
  - [ ] èŠ‚ç‚¹å¸‚åœºå±•ç¤ºï¼ˆ4 ä¸ªåˆ†ç±»æ ‡ç­¾é¡µï¼‰
  - [ ] åå°èŠ‚ç‚¹ç®¡ç†ï¼ˆé…ç½® API Key å’Œé…é¢ï¼‰
  - [ ] èŠ‚ç‚¹é…é¢å±•ç¤ºå’Œç»Ÿè®¡
  - [ ] è‡ªåŠ¨æ³¨å…¥å¹³å°å‡­è¯ï¼ˆç”¨æˆ·æ— éœ€é…ç½®ï¼‰
- [ ] ç”¨æˆ·æ³¨å†Œå’ŒéªŒè¯
- [ ] æ”¯ä»˜é›†æˆï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰
- [ ] è´¦å•å’ŒæŠ¥è¡¨
- [ ] åå°ç®¡ç†ç³»ç»Ÿ

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹è¯•æ–¹æ³• |
|------|------|---------|
| å·¥ä½œæµæŸ¥è¯¢é€Ÿåº¦ | < 100ms | Postman å‹æµ‹ |
| å¹¶å‘æ‰£è´¹ TPS | > 500 | JMeter æµ‹è¯• |
| æ•°æ®åº“æŸ¥è¯¢å±‚çº§ | â‰¤ 3 å±‚ JOIN | ä»£ç å®¡æŸ¥ |
| é¡µé¢åŠ è½½æ—¶é—´ | < 2s | Lighthouse |

### å®‰å…¨æ€§

- [x] API Key åŠ å¯†å­˜å‚¨ï¼ˆAES-256-GCMï¼‰
- [x] æ’ä»¶ä»£ç å®‰å…¨éªŒè¯
- [x] SQL æ³¨å…¥é˜²æŠ¤ï¼ˆTypeORMï¼‰
- [x] XSS é˜²æŠ¤ï¼ˆCSP + Vue è‡ªåŠ¨è½¬ä¹‰ï¼‰
- [x] CSRF é˜²æŠ¤ï¼ˆJWT + localStorageï¼‰
- [x] æ‚²è§‚é”é˜²æ­¢ä½™é¢å¹¶å‘æ‰£è´¹

---

## ğŸ“š é™„å½•

### ç›¸å…³æ–‡æ¡£

ä»¥ä¸‹æ–‡æ¡£å·²æ•´åˆåˆ°æœ¬æ–‡æ¡£ï¼Œå½’æ¡£å¤‡æŸ¥ï¼š

- [02-æ¶æ„å›¾å’Œæµç¨‹å›¾.md](./archived/02-æ¶æ„å›¾å’Œæµç¨‹å›¾.md) - è¯¦ç»†æ¶æ„å›¾ï¼ˆå·²æ•´åˆï¼‰
- [03-å‰åç«¯åˆ†ç¦»æ¶æ„è¯´æ˜.md](./archived/03-å‰åç«¯åˆ†ç¦»æ¶æ„è¯´æ˜.md) - å‰åç«¯åˆ†ç¦»ï¼ˆå·²æ•´åˆï¼‰
- [04-å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ.md](./archived/04-å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ.md) - å®‰å…¨æ€§èƒ½ï¼ˆå·²æ•´åˆï¼‰
- [05-æ•°æ®åº“åˆå§‹åŒ–æ–¹æ¡ˆ.md](./archived/05-æ•°æ®åº“åˆå§‹åŒ–æ–¹æ¡ˆ.md) - æ•°æ®åº“åˆå§‹åŒ–ï¼ˆå·²æ•´åˆï¼‰
- [02-èŠ‚ç‚¹åˆ†ç±»å’Œé…ç½®ç­–ç•¥.md](./archived/02-èŠ‚ç‚¹åˆ†ç±»å’Œé…ç½®ç­–ç•¥.md) - èŠ‚ç‚¹åŠ¨æ€åŒ–è®¾è®¡ï¼ˆå·²æ•´åˆï¼‰
- [03-èŠ‚ç‚¹åŠ¨æ€åŒ–æ”¹é€ å½±å“åˆ†æ.md](./archived/03-èŠ‚ç‚¹åŠ¨æ€åŒ–æ”¹é€ å½±å“åˆ†æ.md) - èŠ‚ç‚¹åŠ¨æ€åŒ–å½±å“åˆ†æï¼ˆå·²æ•´åˆï¼‰

ä»ç„¶ç‹¬ç«‹çš„æ–‡æ¡£ï¼š

- [02-å®æ–½è®¡åˆ’ä¸é‡Œç¨‹ç¢‘.md](./02-å®æ–½è®¡åˆ’ä¸é‡Œç¨‹ç¢‘.md) - è¯¦ç»†å®æ–½è¿›åº¦è·Ÿè¸ªï¼ˆæ´»æ–‡æ¡£ï¼‰
- [03-å“ç‰Œæ›¿æ¢æŒ‡å—.md](./03-å“ç‰Œæ›¿æ¢æŒ‡å—.md) - å“ç‰Œæ›¿æ¢æ“ä½œæ‰‹å†Œ
- [START-HERE.md](./START-HERE.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—

### ä»£ç ä½ç½®ç´¢å¼•

**æ•°æ®åº“è¿ç§»ï¼š**
- `packages/@n8n/db/src/migrations/common/1762504711060-CreateMultiTenancyTables.ts`
- `packages/@n8n/db/src/migrations/common/1762504712060-CreateBillingTables.ts`
- `packages/@n8n/db/src/migrations/common/1762511302660-ExtendPlatformServiceForPlugins.ts`
- `packages/@n8n/db/src/migrations/common/1762511302880-CreateWorkspacePluginCredentialsTable.ts`

**Entity å±‚ï¼š**
- `packages/@n8n/db/src/entities/workspace*.entity.ts` - å·¥ä½œç©ºé—´ç›¸å…³
- `packages/@n8n/db/src/entities/billing.entity.ts` - è®¡è´¹å®ä½“
- `packages/@n8n/db/src/entities/platform-service.entity.ts` - å¹³å°æœåŠ¡

**Service å±‚ï¼š**
- `packages/cli/src/services/billing.service.ts` - è®¡è´¹æœåŠ¡
- `packages/cli/src/services/platform-*.service.ts` - å¹³å°æœåŠ¡
- `packages/cli/src/services/workspace-context.service.ts` - å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡
- `packages/cli/src/services/plugin-validator.service.ts` - æ’ä»¶éªŒè¯

**Controller å±‚ï¼š**
- `packages/cli/src/controllers/admin/admin-plugins.controller.ts` - å¹³å°æ’ä»¶ç®¡ç†
- `packages/cli/src/controllers/plugins.controller.ts` - ç”¨æˆ·æ’ä»¶ç®¡ç†

### æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| å·¥ä½œç©ºé—´ | Workspace | Project è¡¨ï¼Œ`type='personal'` æˆ– `'team'` |
| ä¸ªäººç©ºé—´ | Personal Workspace | ç”¨æˆ·æ³¨å†Œè‡ªåŠ¨åˆ›å»ºçš„é»˜è®¤ç©ºé—´ |
| å›¢é˜Ÿç©ºé—´ | Team Workspace | å¤šäººåä½œçš„å…±äº«ç©ºé—´ |
| æŒ‰é‡è®¡è´¹ | Pay-as-you-go | æ ¹æ®å®é™…ä½¿ç”¨é‡æ‰£è´¹ï¼ˆtokens/è°ƒç”¨æ¬¡æ•°ï¼‰ |
| å¹³å°æœåŠ¡ | Platform Service | å¹³å°ç»Ÿä¸€é…ç½®çš„ AI æœåŠ¡ï¼ˆOpenAI/Claude ç­‰ï¼‰ |
| RAG æœåŠ¡ | RAG Service | æ£€ç´¢å¢å¼ºç”Ÿæˆï¼Œå‚ç›´é¢†åŸŸçŸ¥è¯†åº“ |
| æ’ä»¶å‡­è¯ | Plugin Credentials | ç”¨æˆ·é…ç½®çš„ API Keyï¼ˆåŠ å¯†å­˜å‚¨ï¼‰ |
| æ‚²è§‚é” | Pessimistic Lock | æ•°æ®åº“è¡Œçº§é”ï¼Œé˜²æ­¢å¹¶å‘å†²çª |

### å‚è€ƒèµ„æ–™

- [Coze å®˜ç½‘å®šä»·](https://www.coze.cn/pricing) - å‚è€ƒå®šä»·æ¨¡å‹
- [n8n å®˜æ–¹æ–‡æ¡£](https://docs.n8n.io/) - åŸæœ‰æ¶æ„æ–‡æ¡£
- [TypeORM æ–‡æ¡£](https://typeorm.io/) - æ•°æ®åº“ ORM
- [PostgreSQL æ‚²è§‚é”](https://www.postgresql.org/docs/current/explicit-locking.html) - å¹¶å‘æ§åˆ¶

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v6.0 - æ•´åˆç‰ˆ
**æœ€åæ›´æ–°ï¼š** 2025-01-08
**ä½œè€…ï¼š** æ¶æ„å›¢é˜Ÿ
**æ•´åˆå†…å®¹ï¼š** 02 æ¶æ„å›¾ + 03 å‰åç«¯åˆ†ç¦» + 04 å®‰å…¨æ€§èƒ½ + 05 æ•°æ®åº“åˆå§‹åŒ–

---

## ğŸ“ ç‰ˆæœ¬å†å²

### v6.0 - æ•´åˆç‰ˆ (2025-01-08)
- âœ… æ•´åˆ 02/03/04/05 æ–‡æ¡£å†…å®¹
- âœ… å•ä¸€ä¿¡æ¯æºï¼ˆSingle Source of Truthï¼‰
- âœ… ä» 4,031 è¡Œç²¾ç®€åˆ° 1,800 è¡Œ
- âœ… å®Œæ•´çš„æ¶æ„è®¾è®¡ + å®æ–½æŒ‡å—
- âœ… æ—§æ–‡æ¡£å½’æ¡£è‡³ `archived/`

### v5.0-compact (2025-01-08)
- âœ… ç²¾ç®€æ–‡æ¡£ä» 4,031 è¡Œåˆ° 519 è¡Œï¼ˆå‡å°‘ 87%ï¼‰
- âœ… åˆ é™¤æ‰€æœ‰å®Œæ•´ä»£ç å®ç°
- âœ… ç”¨ Mermaid å›¾æ›¿ä»£é•¿ç¯‡æ–‡å­—

### v4.0 (2025-01-07)
- å®Œæ•´ç”¨æˆ·æ³¨å†Œç³»ç»Ÿ
- é‚€è¯·ç ç³»ç»Ÿ
- OAuth ç¬¬ä¸‰æ–¹ç™»å½•

### v3.0 (2025-01-05)
- ä¸‰å±‚æ’ä»¶ç³»ç»Ÿè®¾è®¡
- å¹³å° RAG æœåŠ¡
- è®¡è´¹ç³»ç»Ÿå®Œæ•´è®¾è®¡

### v2.0 (2025-01-03)
- å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡
- æ•°æ®åº“ schema è®¾è®¡

### v1.0 (2025-01-01)
- åˆç‰ˆæ–¹æ¡ˆ
