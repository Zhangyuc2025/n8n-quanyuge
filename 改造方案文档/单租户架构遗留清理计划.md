# 单租户架构遗留清理计划

## 概述

从单租户架构迁移到多租户 SaaS 架构后，需要清理以下旧版遗留代码和逻辑。

---

## 1. 前端清理项目

### 1.1 路由和视图

#### SetupView.vue（旧单租户初始化）
**位置**: `/packages/frontend/editor-ui/src/features/core/auth/views/SetupView.vue`

**状态**: ⏳ 待处理

**操作**:
- ❌ **不要删除** - 此文件仍然用于个人用户的首次设置（创建账号）
- ✅ 保留但调整用途：用于新注册用户的个人信息填写
- 📝 添加注释说明新用途

**理由**:
- 用户注册后需要填写个人信息
- 与平台初始化（AdminSetupView）不同
- 用户设置是用户级别，平台设置是管理员级别

---

### 1.2 Settings Store

#### settingsStore.showSetupPage 逻辑
**位置**: `/packages/frontend/editor-ui/src/app/stores/settings.store.ts`

**状态**: ⏳ 待检查

**操作**:
1. 检查 `showSetupPage` 的用途
2. 如果只用于单租户初始化，需要重构
3. 如果用于用户级别设置，需要重命名以避免混淆

---

### 1.3 路由守卫

#### router.beforeEach 中的 showSetupPage 检查
**位置**: `/packages/frontend/editor-ui/src/router.ts`

**当前代码** (约 Line 918-925):
```typescript
if (settingsStore.showSetupPage) {
	if (to.name === VIEWS.SETUP) {
		return next();
	}
	return next({ name: VIEWS.SETUP });
}
```

**状态**: ✅ 已保留（但需要验证用途）

**注意事项**:
- 此逻辑现在位于平台初始化检测之后
- 用于用户级别的设置，非平台级别
- 需要确认与新的多租户架构兼容

---

## 2. 后端清理项目

### 2.1 Owner Setup 相关

#### instance-owner-setup 事件
**位置**: `/packages/cli/src/events/maps/relay.event-map.ts`

**当前状态**:
```typescript
'instance-owner-setup': {
	userId: string;
};
```

**操作**:
- ⏳ 保留但重命名为 `'user-initial-setup'`
- 📝 更新所有使用此事件的地方
- 🔄 语义从"实例所有者"改为"用户初始设置"

---

### 2.2 Owner Controller

**位置**: `/packages/cli/src/controllers/owner.controller.ts`

**状态**: ⏳ 需要review

**操作**:
1. 检查所有 owner 相关的 API 端点
2. 区分"首次设置"和"管理员操作"
3. 必要时重构或重命名

---

## 3. 配置和环境变量

### 3.1 Settings 相关

**检查点**:
- `N8N_OWNER_*` 环境变量（如果有）
- 单租户相关的配置项
- 首次启动检测逻辑

**状态**: ⏳ 待检查

---

## 4. 数据库清理

### 4.1 User 表的 role 字段

**位置**: `/packages/@n8n/db/src/entities/user.ts`

**当前状态**:
```typescript
role: 'global:owner' | 'global:member' | 'global:admin'
```

**操作**:
- ✅ 保留（仍然需要用于权限控制）
- 📝 添加文档说明新架构下的角色含义：
  - `global:owner`: 保留为遗留字段或重新定义为"平台管理员"
  - `global:admin`: 工作空间管理员
  - `global:member`: 普通成员

---

## 5. 清理优先级

### 🔥 高优先级
1. ✅ **已完成** - 创建新的平台管理员系统（AdminSetupView, AdminLoginView）
2. ✅ **已完成** - 添加系统初始化检测（SystemStore, router guard）
3. ⏳ **进行中** - 验证前端构建
4. ⏳ **待处理** - 清理和重命名易混淆的命名

### ⚠️ 中优先级
1. ⏳ 重构 owner.controller.ts
2. ⏳ 更新事件名称（instance-owner-setup → user-initial-setup）
3. ⏳ 添加文档说明角色系统的新语义

### 📝 低优先级
1. ⏳ 清理未使用的配置项
2. ⏳ 优化错误消息和用户提示
3. ⏳ 添加单元测试覆盖新逻辑

---

## 6. 验证清单

### 功能验证
- [ ] 首次启动 → 管理员初始化流程
- [ ] 管理员登录 → 访问admin panel
- [ ] 用户注册 → 自动创建个人工作空间 + 初始余额
- [ ] 用户登录 → 正常访问editor-ui
- [ ] 平台未初始化时，用户无法访问

### 安全验证
- [ ] 管理员API需要认证
- [ ] 用户不能访问管理员API
- [ ] 平台初始化只能执行一次

### 兼容性验证
- [ ] 旧的用户数据兼容性
- [ ] 升级路径测试
- [ ] 回滚方案验证

---

## 7. 执行时间表

**第1天（今天）**:
- ✅ 完成前端实现
- ⏳ 验证构建
- ⏳ 识别需要清理的代码

**第2天**:
- 执行高优先级清理
- 功能测试

**第3天**:
- 中低优先级清理
- 安全和兼容性测试

---

## 8. 注意事项

⚠️ **关键提醒**:
1. SetupView.vue **不要删除** - 用于用户个人信息设置
2. user.role 字段 **不要删除** - 权限系统需要
3. 清理前务必备份数据库
4. 每个清理步骤后运行构建验证
5. 保留向后兼容性，支持数据迁移

---

## 9. 回滚计划

如果清理导致问题：
1. Git revert 到清理前的commit
2. 检查数据库迁移状态
3. 恢复环境变量配置
4. 重新构建和部署

---

**最后更新**: 2025-11-11
**负责人**: AI Assistant
**状态**: 进行中 - 阶段3验证中
