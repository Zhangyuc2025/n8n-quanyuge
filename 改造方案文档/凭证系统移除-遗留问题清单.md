# 凭证系统移除 - 遗留问题清单

> **生成日期:** 2025-01-10
> **扫描范围:** 全部代码库
> **状态:** 待处理

---

## 📊 问题概览

| 类别 | 数量 | 优先级 | 预计工时 |
|------|------|--------|----------|
| **功能改造** | 1 | P1 | 1-2 天 |
| **测试文件更新** | 10+ | P2 | 2-3 天 |
| **文档更新** | 4 | P2 | 1-2 天 |
| **代码清理** | 若干 | P3 | 1 天 |

**总计预计工时:** 5-8 天

---

## 🔴 P1 - 功能改造（必须处理）

### 1. Chat Hub 按量计费改造

**问题描述:**
Chat Hub 模块当前无法使用，需要改造为使用平台 AI Provider 进行认证和按量计费。

**影响范围:**
- ChatHubAgent 实体
- ChatHubWorkflowService
- ChatHubService
- 前端 Chat Hub 组件

**相关文件:**
- `packages/cli/src/modules/chat-hub/chat-hub-agent.entity.ts`
- `packages/cli/src/modules/chat-hub/chat-hub-workflow.service.ts` (line 339)
- `packages/cli/src/modules/chat-hub/chat-hub.service.ts`

**详细方案:** 见 `改造方案文档/Chat-Hub按量计费改造方案.md`

**优先级:** **P1**（阻塞 Chat Hub 功能）
**预计工时:** 1-2 天
**责任人:** 后端工程师 + 前端工程师

---

## 🟡 P2 - 测试文件更新（影响测试覆盖率）

### 2. 单元测试更新

**问题描述:**
10+ 个测试文件中包含凭证相关的测试用例，需要更新或移除。

**受影响的测试文件:**

| 文件 | 凭证引用类型 | 处理方式 |
|------|-------------|---------|
| `test-runner.service.ee.test.ts` | CredentialsRepository Mock | 移除凭证相关测试 |
| `user-management-mailer.test.ts` | 凭证共享通知 | 移除相关断言 |
| `execute-batch.test.ts` | 工作流凭证 | 简化为无凭证测试 |
| `execute.test.ts` | 工作流凭证 | 简化为无凭证测试 |
| `community-node.test.ts` | 节点凭证类型 | 移除凭证类型检查 |
| `load-nodes-and-credentials.test.ts` | 凭证加载 | 移除凭证加载测试 |
| `workflow-execute-additional-data.test.ts` | CredentialsHelper Mock | 移除凭证助手测试 |
| `external-hooks.test.ts` | 凭证钩子 | 移除凭证事件测试 |
| `node-types.test.ts` | 凭证类型 | 移除凭证类型测试 |
| `source-control-export.service.test.ts` | 凭证导出 | 移除凭证导出测试 |

**处理策略:**

#### 2.1 工作流执行测试
```typescript
// 修改前
const workflow = {
  nodes: [{ credentials: { api: { id: '123' } } }]
};

// 修改后
const workflow = {
  nodes: [{ /* 无凭证字段 */ }]
};
```

#### 2.2 节点加载测试
```typescript
// 移除凭证类型相关测试
// it('should load credential types', ...) // 删除
```

#### 2.3 Mock 清理
```typescript
// 移除
jest.mock('@/credentials-helper');
jest.mock('@/credentials.service');
```

**优先级:** **P2**（不影响生产代码，但影响测试覆盖率）
**预计工时:** 2-3 天
**责任人:** 测试工程师 / 后端工程师

---

### 3. 集成测试更新

**问题描述:**
集成测试中涉及凭证的测试场景需要调整。

**受影响的测试场景:**
- 工作流导入导出测试
- Source Control 同步测试
- 权限测试
- OAuth 登录测试

**处理方式:**
- 移除凭证导入导出相关测试
- 调整权限测试（移除凭证权限检查）
- 禁用 OAuth 登录测试

**优先级:** **P2**
**预计工时:** 1 天

---

## 🟢 P2 - 文档更新（保持同步）

### 4. API 文档更新

**需要更新的文档:**
- Swagger/OpenAPI 规范
- REST API 文档
- GraphQL Schema（如有）

**移除的 API 端点:**
```
DELETE /api/v1/credentials
GET    /api/v1/credentials
POST   /api/v1/credentials
PUT    /api/v1/credentials/:id
DELETE /api/v1/credentials/:id
GET    /api/v1/credentials/:id
POST   /api/v1/credentials/test
GET    /api/v1/credentials/types
```

**优先级:** **P2**
**预计工时:** 0.5 天
**责任人:** 技术文档工程师

---

### 5. 用户手册更新

**需要更新的章节:**
- 节点配置说明（移除凭证配置部分）
- 工作流导入导出（说明不再包含凭证）
- AI 节点使用指南（说明使用平台 API Key）
- OAuth 登录说明（标记为已禁用）

**优先级:** **P2**
**预计工时:** 1 天
**责任人:** 技术文档工程师

---

### 6. 开发者文档更新

**需要更新的内容:**
- 架构图（移除凭证系统）
- 数据模型文档（更新 ER 图）
- API 集成指南
- 节点开发指南

**优先级:** **P2**
**预计工时:** 0.5 天
**责任人:** 技术文档工程师

---

### 7. 迁移指南

**需要创建的文档:**
- 从旧版本升级指南
- 凭证系统移除的影响说明
- 数据迁移步骤
- FAQ

**优先级:** **P2**
**预计工时:** 0.5 天
**责任人:** 技术文档工程师

---

## 🔵 P3 - 代码清理（可选优化）

### 8. 注释代码清理

**问题描述:**
代码中有一些注释掉的凭证相关代码，虽然有说明性注释，但可以进一步清理。

**需要清理的位置:**

#### 8.1 OAuth 控制器导入
```typescript
// packages/cli/src/server.ts
// OAuth credential controllers removed - credential system disabled
// import '@/controllers/oauth/oauth1-credential.controller';
// import '@/controllers/oauth/oauth2-credential.controller';
```

**建议:** 可以保留注释说明，删除 import 语句

#### 8.2 Source Control 注释
```typescript
// packages/cli/src/environments.ee/source-control/source-control.service.ee.ts
// Credential export is no longer supported - the export will return empty result
```

**建议:** 保留（作为历史说明）

#### 8.3 Chat Hub 空凭证对象
```typescript
// packages/cli/src/modules/chat-hub/chat-hub-workflow.service.ts:339
credentials: {}, // TODO: Add API key credentials for pay-per-use
```

**建议:** 在实施 Chat Hub 改造时一并处理

**优先级:** **P3**（代码质量优化）
**预计工时:** 0.5 天
**责任人:** 任意开发工程师

---

### 9. 类型定义清理

**问题描述:**
一些凭证相关的类型定义仍然存在，虽然不影响功能，但可以清理。

**待检查的位置:**
- `n8n-workflow` 包中的凭证接口
- `@n8n/api-types` 包中的凭证 DTO

**建议:** 在后续迭代中逐步清理

**优先级:** **P3**
**预计工时:** 0.5 天

---

### 10. 数据库迁移脚本归档

**问题描述:**
已备份的凭证相关迁移脚本可以进一步归档。

**备份位置:**
- `packages/@n8n/db-backup/src/migrations/`

**建议:**
1. 添加 README 说明这些是已移除功能的历史迁移
2. 考虑在未来版本中完全删除

**优先级:** **P3**
**预计工时:** 0.5 天

---

## 📋 执行计划

### Phase 1: 紧急修复 (本周完成)

**目标:** 恢复 Chat Hub 功能

| 任务 | 负责人 | 工时 | 状态 |
|------|--------|------|------|
| Chat Hub 按量计费改造 | 后端 + 前端 | 1.5 天 | ⬜ 待开始 |

---

### Phase 2: 测试更新 (2 周内完成)

**目标:** 恢复测试覆盖率

| 任务 | 负责人 | 工时 | 状态 |
|------|--------|------|------|
| 单元测试更新 | 后端 | 2 天 | ⬜ 待开始 |
| 集成测试更新 | QA | 1 天 | ⬜ 待开始 |

---

### Phase 3: 文档同步 (3 周内完成)

**目标:** 保持文档与代码同步

| 任务 | 负责人 | 工时 | 状态 |
|------|--------|------|------|
| API 文档更新 | 技术文档 | 0.5 天 | ⬜ 待开始 |
| 用户手册更新 | 技术文档 | 1 天 | ⬜ 待开始 |
| 开发者文档更新 | 技术文档 | 0.5 天 | ⬜ 待开始 |
| 迁移指南编写 | 技术文档 | 0.5 天 | ⬜ 待开始 |

---

### Phase 4: 代码清理 (可选，低优先级)

**目标:** 代码质量优化

| 任务 | 负责人 | 工时 | 状态 |
|------|--------|------|------|
| 注释代码清理 | 任意 | 0.5 天 | ⬜ 待开始 |
| 类型定义清理 | 任意 | 0.5 天 | ⬜ 待开始 |
| 迁移脚本归档 | 任意 | 0.5 天 | ⬜ 待开始 |

---

## ⚠️ 风险提示

### 1. Chat Hub 功能阻塞

**风险:** Chat Hub 无法使用影响用户体验
**缓解:** 优先完成 Chat Hub 改造（P1 任务）

### 2. 测试覆盖率下降

**风险:** 单元测试失败导致 CI/CD 阻塞
**缓解:**
- 临时禁用失败的测试文件
- 在 2 周内完成测试更新

### 3. 文档过时

**风险:** 用户参考过时文档导致困惑
**缓解:**
- 在关键位置添加"凭证系统已移除"提示
- 优先更新用户手册

---

## 📊 进度跟踪

**更新频率:** 每周

| 日期 | Phase | 完成任务 | 剩余任务 | 备注 |
|------|-------|---------|---------|------|
| 2025-01-10 | - | 凭证系统移除完成 | 10 项遗留任务 | 初始扫描 |
| 2025-01-17 | Phase 1 | - | - | 待更新 |
| 2025-01-24 | Phase 2 | - | - | 待更新 |
| 2025-01-31 | Phase 3 | - | - | 待更新 |

---

## ✅ 验收标准

### Phase 1 验收
- [ ] Chat Hub 功能正常
- [ ] AI 模型调用成功
- [ ] 自动计费功能正常

### Phase 2 验收
- [ ] 所有单元测试通过
- [ ] 集成测试通过
- [ ] 测试覆盖率 > 80%

### Phase 3 验收
- [ ] API 文档更新完成
- [ ] 用户手册更新完成
- [ ] 迁移指南发布

### Phase 4 验收
- [ ] 无未使用的凭证相关代码
- [ ] 代码质量检查通过

---

## 📞 联系方式

**项目负责人:** 开发团队
**技术支持:** 后端工程师
**文档维护:** 技术文档工程师

**问题反馈:** GitHub Issues

---

**文档版本:** v1.0
**最后更新:** 2025-01-10
**下次更新:** 2025-01-17
