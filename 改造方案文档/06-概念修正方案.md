# n8n å¤šç§Ÿæˆ·æ¶æ„ - æ¦‚å¿µä¿®æ­£æ–¹æ¡ˆ

> **ç´§æ€¥ä¿®æ­£æ–‡æ¡£**
> **åˆ›å»ºæ—¥æœŸï¼š** 2025-11-08
> **é—®é¢˜å‘ç°ï¼š** æ”¹é€ è¿‡ç¨‹ä¸­å‘ç°æ’ä»¶ã€èŠ‚ç‚¹ã€å¤§æ¨¡å‹æ¦‚å¿µç†è§£é”™è¯¯
> **å½±å“èŒƒå›´ï¼š** æ•°æ®åº“è®¾è®¡ã€åç«¯ Service/Controllerã€å‰ç«¯ç»„ä»¶
> **ä¿®æ­£ä¼˜å…ˆçº§ï¼š** P0ï¼ˆæ ¸å¿ƒæ¶æ„é—®é¢˜ï¼Œå¿…é¡»ç«‹å³ä¿®æ­£ï¼‰

---

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜æ€»ç»“](#é—®é¢˜æ€»ç»“)
2. [æ¦‚å¿µé”™è¯¯åˆ†æ](#æ¦‚å¿µé”™è¯¯åˆ†æ)
3. [æ­£ç¡®çš„æ¶æ„ç†è§£](#æ­£ç¡®çš„æ¶æ„ç†è§£)
4. [éœ€è¦ä¿®æ­£çš„åœ°æ–¹](#éœ€è¦ä¿®æ­£çš„åœ°æ–¹)
5. [ä¿®æ­£å®æ–½è®¡åˆ’](#ä¿®æ­£å®æ–½è®¡åˆ’)
6. [ä¿®æ­£åçš„æ•°æ®åº“è®¾è®¡](#ä¿®æ­£åçš„æ•°æ®åº“è®¾è®¡)
7. [ä¿®æ­£åçš„ä»£ç ç¤ºä¾‹](#ä¿®æ­£åçš„ä»£ç ç¤ºä¾‹)

---

## ğŸš¨ é—®é¢˜æ€»ç»“

### æ ¸å¿ƒé—®é¢˜

**åŸæ–¹æ¡ˆçš„é”™è¯¯ç†è§£ï¼š**
- âŒ æŠŠå¤§æ¨¡å‹ï¼ˆGPT-4, Claude 3ï¼‰å½“æˆäº† 15 ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹
- âŒ æ’ä»¶å’ŒèŠ‚ç‚¹åˆ†ç¦»ï¼Œåˆ›å»ºäº†ç‹¬ç«‹çš„"æ’ä»¶å¸‚åœº"å’Œ"èŠ‚ç‚¹å¸‚åœº"
- âŒ åœ¨ `platform_service` è¡¨ä¸­å­˜å‚¨æ¯ä¸ªå¤§æ¨¡å‹ä¸ºå•ç‹¬è®°å½•

**æ­£ç¡®çš„ç†è§£ï¼š**
- âœ… **åªæœ‰ 1 ä¸ª AI èŠ‚ç‚¹**ï¼ˆæˆ–å«"å¤§æ¨¡å‹"èŠ‚ç‚¹ï¼‰
- âœ… **å¤§æ¨¡å‹æ˜¯ AI èŠ‚ç‚¹çš„å‚æ•°é€‰é¡¹**ï¼Œä¸æ˜¯èŠ‚ç‚¹æœ¬èº«
- âœ… **æ’ä»¶ = èŠ‚ç‚¹**ï¼Œæ²¡æœ‰"æ’ä»¶"å’Œ"èŠ‚ç‚¹"çš„åŒºåˆ†
- âœ… å¹³å°æ‰˜ç®¡çš„æ˜¯ AI æœåŠ¡æä¾›å•†ï¼ˆOpenAI, Anthropicï¼‰ï¼Œä¸æ˜¯å•ä¸ªæ¨¡å‹

### å½±å“èŒƒå›´ç»Ÿè®¡

| ç±»åˆ« | é”™è¯¯å®ç° | éœ€ä¿®æ­£æ–‡ä»¶ | é¢„è®¡å·¥æ—¶ |
|------|---------|-----------|---------|
| æ•°æ®åº“ | âœ… å·²åˆ›å»º | 2 ä¸ªè¿ç§»æ–‡ä»¶ | 0.5 å¤© |
| Entity/Repository | âœ… å·²åˆ›å»º | 2 ä¸ªæ–‡ä»¶ | 0.5 å¤© |
| Service å±‚ | âœ… å·²åˆ›å»º | 3 ä¸ªæ–‡ä»¶ | 1 å¤© |
| Controller å±‚ | âœ… å·²åˆ›å»º | 2 ä¸ªæ–‡ä»¶ | 1 å¤© |
| å‰ç«¯ API | âœ… å·²åˆ›å»º | 2 ä¸ªæ–‡ä»¶ | 0.5 å¤© |
| å‰ç«¯ Store | âœ… å·²åˆ›å»º | 2 ä¸ªæ–‡ä»¶ | 0.5 å¤© |
| å‰ç«¯ç»„ä»¶ | âœ… å·²åˆ›å»º | 3 ä¸ªæ–‡ä»¶ | 1 å¤© |
| **æ€»è®¡** | - | **16 ä¸ªæ–‡ä»¶** | **5 å¤©** |

---

## ğŸ” æ¦‚å¿µé”™è¯¯åˆ†æ

### é”™è¯¯ 1ï¼šå¤§æ¨¡å‹å½“æˆèŠ‚ç‚¹

**åŸæ–¹æ¡ˆçš„æ•°æ®åº“ï¼š**
```sql
-- âŒ é”™è¯¯ï¼šæŠŠæ¯ä¸ªå¤§æ¨¡å‹å½“æˆä¸€æ¡è®°å½•
INSERT INTO platform_service VALUES ('gpt-4-turbo', 'ai_model', 'GPT-4 Turbo', ...);
INSERT INTO platform_service VALUES ('gpt-3.5-turbo', 'ai_model', 'GPT-3.5 Turbo', ...);
INSERT INTO platform_service VALUES ('claude-3-opus', 'ai_model', 'Claude 3 Opus', ...);
INSERT INTO platform_service VALUES ('claude-3-sonnet', 'ai_model', 'Claude 3 Sonnet', ...);
-- ... 15 æ¡è®°å½•
```

**é—®é¢˜åˆ†æï¼š**
- n8n å®é™…åªæœ‰ **1 ä¸ª OpenAI èŠ‚ç‚¹**
- ç”¨æˆ·åœ¨èŠ‚ç‚¹å‚æ•°ä¸­é€‰æ‹©æ¨¡å‹ï¼ˆgpt-4, gpt-3.5 ç­‰ï¼‰
- æ¨¡å‹åˆ—è¡¨é€šè¿‡ OpenAI API åŠ¨æ€åŠ è½½

**è¯æ®ï¼ˆæ¥è‡ª n8n æºç ï¼‰ï¼š**
```typescript
// packages/nodes-base/nodes/OpenAi/ChatDescription.ts
const completeOperations: INodeProperties[] = [
  {
    displayName: 'Model',           // è¿™åªæ˜¯ä¸€ä¸ªå‚æ•°ï¼
    name: 'model',
    type: 'options',                 // ä¸‹æ‹‰é€‰é¡¹
    typeOptions: {
      loadOptions: {
        routing: {
          request: {
            method: 'GET',
            url: '/v1/models',      // åŠ¨æ€åŠ è½½æ¨¡å‹åˆ—è¡¨
          },
        },
      },
    },
  },
];
```

### é”™è¯¯ 2ï¼šæ’ä»¶å’ŒèŠ‚ç‚¹åˆ†ç¦»

**åŸæ–¹æ¡ˆï¼š**
- `platform_service` è¡¨æ—¢å­˜å‚¨ AI æ¨¡å‹ï¼Œåˆå­˜å‚¨æ’ä»¶ä»£ç ï¼ˆ`plugin_code` å­—æ®µï¼‰
- å‰ç«¯åˆ›å»ºäº†ä¸¤ä¸ªå¸‚åœºï¼š`NodeMarket.vue` å’Œ `PluginMarket.vue`

**æ­£ç¡®ç†è§£ï¼ˆæ¥è‡ª n8n æºç ï¼‰ï¼š**
```
packages/nodes-base/nodes/
â”œâ”€â”€ OpenAi/                  # â† è¿™å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹
â”œâ”€â”€ Code/                    # â† è¿™ä¹Ÿæ˜¯ä¸€ä¸ªèŠ‚ç‚¹
â”œâ”€â”€ HttpRequest/             # â† è¿™è¿˜æ˜¯ä¸€ä¸ªèŠ‚ç‚¹
â””â”€â”€ ... (300+ èŠ‚ç‚¹)
```

**åœ¨ n8n ä¸­ï¼š**
- èŠ‚ç‚¹ = å·¥ä½œæµä¸­å¯æ‹–æ‹½çš„åŠŸèƒ½å•å…ƒ
- æ’ä»¶ = èŠ‚ç‚¹çš„å¦ä¸€ç§è¯´æ³•ï¼ˆæ¥è‡ªç¤¾åŒºè´¡çŒ®ï¼‰
- æ²¡æœ‰"æ’ä»¶å¸‚åœº"å’Œ"èŠ‚ç‚¹å¸‚åœº"çš„åŒºåˆ«ï¼Œåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„ç•Œé¢

### é”™è¯¯ 3ï¼šæ··æ·†å¹³å°æœåŠ¡å’Œæ’ä»¶

**åŸæ–¹æ¡ˆçš„è¡¨ç»“æ„æ··ä¹±ï¼š**
```sql
CREATE TABLE platform_service (
  service_key VARCHAR(100) PRIMARY KEY,
  service_type VARCHAR(50),      -- 'ai_model' | 'rag' | 'plugin' âŒ

  -- AI ç›¸å…³å­—æ®µ
  pricing_config JSONB,

  -- æ’ä»¶ç›¸å…³å­—æ®µï¼ˆæ··åœ¨ä¸€èµ·ï¼ï¼‰
  plugin_code TEXT,               -- âŒ ä¸åº”è¯¥åœ¨è¿™ä¸ªè¡¨
  visibility VARCHAR(50),         -- âŒ ä¸åº”è¯¥åœ¨è¿™ä¸ªè¡¨
  owner_workspace_id UUID,        -- âŒ ä¸åº”è¯¥åœ¨è¿™ä¸ªè¡¨
  submission_status VARCHAR(50),  -- âŒ ä¸åº”è¯¥åœ¨è¿™ä¸ªè¡¨
);
```

**é—®é¢˜ï¼š**
- å¹³å° AI æœåŠ¡ï¼ˆOpenAI, Claudeï¼‰å’Œç”¨æˆ·ä¸Šä¼ æ’ä»¶æ˜¯å®Œå…¨ä¸åŒçš„æ¦‚å¿µ
- åº”è¯¥åˆ†ä¸ºä¸¤å¼ è¡¨ï¼š`platform_ai_service` å’Œ `custom_node`

### é”™è¯¯ 4ï¼šå‡­è¯ç³»ç»Ÿçš„å†—ä½™å’Œæ··ä¹±

**åŸæ–¹æ¡ˆåˆ›å»ºäº†ä¸¤å¥—å‡­è¯ç³»ç»Ÿï¼š**

1. **credentials_entity è¡¨**ï¼ˆn8n åŸæœ‰çš„ï¼Œä¿ç•™äº†ï¼‰
   - ç”¨é€”ï¼šé«˜çº§ç”¨æˆ·è·¨èŠ‚ç‚¹å¤ç”¨å‡­è¯
   - ç‰¹ç‚¹ï¼šæ”¯æŒ 400+ ç§å‡­è¯ç±»å‹ï¼ˆopenAiApi, githubApi ç­‰ï¼‰

2. **workspace_plugin_credentials è¡¨**ï¼ˆæ–°å¢çš„ï¼Œé”™è¯¯ï¼ï¼‰
   - ç”¨é€”ï¼šå·¥ä½œç©ºé—´ä¸º"æ’ä»¶"é…ç½® API Key
   - é—®é¢˜ï¼šåŠŸèƒ½ä¸ credentials_entity é‡å¤ï¼Œè®¾è®¡æœ‰è¯¯

**workspace_plugin_credentials çš„è®¾è®¡é—®é¢˜ï¼š**

```sql
-- âŒ é”™è¯¯è®¾è®¡
CREATE TABLE workspace_plugin_credentials (
  workspace_id UUID,
  service_key VARCHAR(100),        -- å¼•ç”¨ platform_service.service_key
  encrypted_config TEXT,
  UNIQUE (workspace_id, service_key)  -- âŒ æ¯ä¸ªå·¥ä½œç©ºé—´æ¯ä¸ªæœåŠ¡åªèƒ½ä¸€ä¸ªå‡­è¯
);
```

**é—®é¢˜åˆ†æï¼š**

1. âŒ **åŠŸèƒ½é‡å¤** - credentials_entity å·²ç»æä¾›äº†æ‰€æœ‰éœ€è¦çš„åŠŸèƒ½
2. âŒ **çº¦æŸä¸åˆç†** - `UNIQUE (workspace_id, service_key)` é™åˆ¶æ¯ä¸ªå·¥ä½œç©ºé—´æ¯ä¸ªæœåŠ¡åªèƒ½æœ‰ä¸€ä¸ªå‡­è¯
   - ç°å®ï¼šä¸€ä¸ªå·¥ä½œç©ºé—´å¯èƒ½éœ€è¦å¤šä¸ª GitHub å‡­è¯ï¼ˆå¤šä¸ªè´¦å·ï¼‰
3. âŒ **å…³è”é”™è¯¯** - `service_key` å¼•ç”¨çš„æ˜¯ `platform_service`ï¼ˆAI æ¨¡å‹è¡¨ï¼‰ï¼Œè€Œä¸æ˜¯å‡­è¯ç±»å‹
4. âŒ **è¿èƒŒç”¨æˆ·éœ€æ±‚** - ç”¨æˆ·å¸Œæœ›èŠ‚ç‚¹çº§åˆ«é…ç½®ï¼Œä¸æ˜¯å·¥ä½œç©ºé—´çº§åˆ«

**ç”¨æˆ·çœŸæ­£çš„éœ€æ±‚ï¼š**

```
âŒ ä¸éœ€è¦ï¼šå‡­è¯ç®¡ç†é¡µé¢
âœ… éœ€è¦ï¼šåœ¨å·¥ä½œæµä¸­ç›´æ¥é…ç½®èŠ‚ç‚¹çš„ API Key
âœ… éœ€è¦ï¼šå›¢é˜Ÿæˆå‘˜ä½¿ç”¨è‡ªå·±çš„æˆæƒä¿¡æ¯ï¼ˆç”¨æˆ·çº§åˆ«éš”ç¦»ï¼‰
âœ… éœ€è¦ï¼šåŒç±»å‹èŠ‚ç‚¹è‡ªåŠ¨å¤ç”¨é…ç½®
```

---

## âœ… æ­£ç¡®çš„æ¶æ„ç†è§£

### æ ¸å¿ƒæ¦‚å¿µå…³ç³»å›¾

```mermaid
graph TB
    subgraph "å·¥ä½œæµç¼–è¾‘å™¨å·¦ä¾§èŠ‚ç‚¹é¢æ¿"
        AI[AI èŠ‚ç‚¹<br/>åªæœ‰1ä¸ª]
        Plugin1[æ’ä»¶1<br/>å¹³å°å®˜æ–¹]
        Plugin2[æ’ä»¶2<br/>ç¬¬ä¸‰æ–¹]
        Plugin3[æ’ä»¶3<br/>è‡ªå®šä¹‰]
        Notion[Notion èŠ‚ç‚¹]
        Code[Code èŠ‚ç‚¹]
    end

    subgraph "AI èŠ‚ç‚¹å†…éƒ¨å‚æ•°"
        Provider[é€‰æ‹©æä¾›å•†]
        OpenAI[OpenAI]
        Anthropic[Anthropic]

        Provider --> OpenAI
        Provider --> Anthropic

        OpenAI --> GPT4[GPT-4 Turbo<br/>Â¥0.01/1K]
        OpenAI --> GPT35[GPT-3.5<br/>Â¥0.002/1K]

        Anthropic --> Claude3Opus[Claude 3 Opus<br/>Â¥0.015/1K]
        Anthropic --> Claude3Sonnet[Claude 3.5 Sonnet<br/>Â¥0.003/1K]
    end

    AI --> Provider

    style AI fill:#51cf66
    style Provider fill:#ffd43b
    style GPT4 fill:#74c0fc
    style GPT35 fill:#74c0fc
    style Claude3Opus fill:#74c0fc
    style Claude3Sonnet fill:#74c0fc
```

### æ­£ç¡®çš„æ•°æ®ç»“æ„

| æ¦‚å¿µ | æ­£ç¡®ç†è§£ | å­˜å‚¨ä½ç½® |
|------|---------|---------|
| **AI èŠ‚ç‚¹** | 1 ä¸ªèŠ‚ç‚¹ï¼Œç”¨æˆ·å¯æ‹–æ‹½ | n8n å†…ç½®èŠ‚ç‚¹ |
| **AI æœåŠ¡æä¾›å•†** | OpenAI, Anthropic, Google | `platform_ai_provider` è¡¨ |
| **å¤§æ¨¡å‹** | GPT-4, Claude 3ï¼ˆæä¾›å•†ä¸‹çš„æ¨¡å‹ï¼‰ | `platform_ai_provider.models_config` (JSONB) |
| **å¹³å°æ’ä»¶** | å¹³å°å®˜æ–¹èŠ‚ç‚¹ï¼ˆå¤©æ°”ã€OCRç­‰ï¼‰ | `platform_node` è¡¨ |
| **ç¬¬ä¸‰æ–¹æ’ä»¶** | å¼€å‘è€…è´¡çŒ®èŠ‚ç‚¹ | `platform_node` è¡¨ |
| **è‡ªå®šä¹‰æ’ä»¶** | ç”¨æˆ·ä¸Šä¼ èŠ‚ç‚¹ | `custom_node` è¡¨ |
| **èŠ‚ç‚¹æˆæƒé…ç½®** | ç”¨æˆ·ä¸ºèŠ‚ç‚¹é…ç½®çš„ API Key | `user_node_config` è¡¨ |

### æ­£ç¡®çš„å‡­è¯/æˆæƒæ¶æ„

```mermaid
graph TB
    subgraph "ç”¨æˆ·ä½“éªŒ"
        U[ç”¨æˆ·] --> WF[å·¥ä½œæµç¼–è¾‘å™¨]
        U --> NM[èŠ‚ç‚¹ç®¡ç†é¡µé¢]
    end

    subgraph "èŠ‚ç‚¹æˆæƒé…ç½®ï¼ˆæŒ‰èŠ‚ç‚¹ç±»å‹ï¼‰"
        WF --> |ç›´æ¥é…ç½®| NC[èŠ‚ç‚¹å‚æ•°é¢æ¿]
        NM --> |ç»Ÿä¸€ç®¡ç†| NC
        NC --> DB[(user_node_configè¡¨)]
    end

    subgraph "å¹³å°æ‰˜ç®¡èŠ‚ç‚¹"
        AI[AIèŠ‚ç‚¹] --> |è‡ªåŠ¨æ³¨å…¥å¹³å°Key| PA[(platform_ai_provider)]
        PA --> |æŒ‰é‡è®¡è´¹| Billing[è®¡è´¹ç³»ç»Ÿ]
    end

    subgraph "ç¬¬ä¸‰æ–¹èŠ‚ç‚¹"
        GitHub[GitHubèŠ‚ç‚¹] --> |ç”¨æˆ·é…ç½®| DB
        Notion[NotionèŠ‚ç‚¹] --> |ç”¨æˆ·é…ç½®| DB
    end

    subgraph "è‡ªå®šä¹‰èŠ‚ç‚¹"
        Custom[è‡ªå®šä¹‰èŠ‚ç‚¹] --> |æ··åˆæ¨¡å¼| ConfigMode{é…ç½®æ¨¡å¼?}
        ConfigMode --> |ä¸ªäººé…ç½®| DB
        ConfigMode --> |å›¢é˜Ÿå…±äº«| SharedDB[(custom_node.shared_config)]
    end

    style AI fill:#51cf66
    style PA fill:#51cf66
    style DB fill:#ffd43b
    style SharedDB fill:#ffd43b
```

### å…³é”®è®¾è®¡åŸåˆ™

1. **âŒ åˆ é™¤å‡­è¯ç®¡ç†é¡µé¢** - ç”¨æˆ·ä¸éœ€è¦ç†è§£"å‡­è¯"çš„æ¦‚å¿µ
2. **âœ… èŠ‚ç‚¹ç®¡ç†é¡µé¢** - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰èŠ‚ç‚¹çš„æˆæƒä¿¡æ¯
3. **âœ… å·¥ä½œæµä¸­ç›´æ¥é…ç½®** - åœ¨èŠ‚ç‚¹å‚æ•°é¢æ¿ä¸­ç›´æ¥å¡«å†™ API Key
4. **âœ… ç”¨æˆ·çº§åˆ«éš”ç¦»** - æ¯ä¸ªç”¨æˆ·çš„æˆæƒä¿¡æ¯åªæœ‰è‡ªå·±èƒ½çœ‹åˆ°
5. **âœ… åŒç±»å‹è‡ªåŠ¨å¤ç”¨** - é…ç½®ä¸€æ¬¡ï¼Œæ‰€æœ‰åŒç±»å‹èŠ‚ç‚¹è‡ªåŠ¨ä½¿ç”¨
6. **âœ… å¹³å°æ‰˜ç®¡è‡ªåŠ¨è®¡è´¹** - AI èŠ‚ç‚¹æ— éœ€é…ç½®ï¼Œè‡ªåŠ¨ä½¿ç”¨å¹³å° API Key

---

## ğŸ› ï¸ éœ€è¦ä¿®æ­£çš„åœ°æ–¹

### 1. æ•°æ®åº“å±‚

#### é—®é¢˜æ–‡ä»¶
- `1762511302220-CreatePlatformServiceTables.ts` âŒ
- `1762511302660-ExtendPlatformServiceForPlugins.ts` âŒ
- `1762511302880-CreateWorkspacePluginCredentialsTable.ts` âŒ
- `packages/@n8n/db/src/entities/credentials-entity.ts` âŒï¼ˆå®Œå…¨åˆ é™¤ï¼‰
- `packages/@n8n/db/src/entities/workspace-plugin-credentials.entity.ts` âŒï¼ˆå®Œå…¨åˆ é™¤ï¼‰

#### ä¿®æ­£æ–¹æ¡ˆ
- åˆ›å»ºæ–°è¿ç§»ï¼š`1762511303000-RedesignPlatformServices.ts`
- åˆ›å»ºæ–°è¡¨ï¼š
  - `platform_ai_provider` - AI æœåŠ¡æä¾›å•†ï¼ˆOpenAI, Anthropicï¼‰
  - `platform_node` - å¹³å°å®˜æ–¹èŠ‚ç‚¹
  - `custom_node` - è‡ªå®šä¹‰èŠ‚ç‚¹ï¼ˆæ”¯æŒæ··åˆé…ç½®æ¨¡å¼ï¼‰
  - `user_node_config` - ç”¨æˆ·èŠ‚ç‚¹é…ç½®ï¼ˆæ›¿ä»£ credentialsï¼‰
- åˆ é™¤æ—§è¡¨ï¼š
  - `credentials_entity` - n8n åŸæœ‰çš„å‡­è¯ç³»ç»Ÿ
  - `shared_credentials` - å·²åœ¨ä¹‹å‰é˜¶æ®µåˆ é™¤
  - `workspace_plugin_credentials` - é”™è¯¯è®¾è®¡çš„è¡¨

### 2. Entity/Repository å±‚

#### é—®é¢˜æ–‡ä»¶
- `packages/@n8n/db/src/entities/platform-service.entity.ts` âŒ
- `packages/@n8n/db/src/repositories/platform-service.repository.ts` âŒ

#### ä¿®æ­£æ–¹æ¡ˆ
- æ‹†åˆ†ä¸ºï¼š
  - `platform-ai-provider.entity.ts`
  - `platform-node.entity.ts`
  - `custom-node.entity.ts`

### 3. Service å±‚

#### é—®é¢˜æ–‡ä»¶
- `packages/cli/src/services/platform-service.service.ts` âŒ
- `packages/cli/src/services/platform-rag.service.ts` âœ…ï¼ˆè¿™ä¸ªä¿ç•™ï¼‰
- `packages/cli/src/services/plugin-*.service.ts` âŒ

#### ä¿®æ­£æ–¹æ¡ˆ
- åˆ›å»ºï¼š
  - `platform-ai-provider.service.ts`ï¼ˆç®¡ç† AI æœåŠ¡æä¾›å•†ï¼‰
  - `platform-node.service.ts`ï¼ˆç®¡ç†å¹³å°èŠ‚ç‚¹ï¼‰
  - `custom-node.service.ts`ï¼ˆç®¡ç†è‡ªå®šä¹‰èŠ‚ç‚¹ï¼‰

### 4. Controller å±‚

#### é—®é¢˜æ–‡ä»¶
- `packages/cli/src/controllers/platform-services.controller.ts` âŒ
- `packages/cli/src/controllers/admin/admin-plugins.controller.ts` âŒ
- `packages/cli/src/controllers/plugins.controller.ts` âŒ

#### ä¿®æ­£æ–¹æ¡ˆ
- é‡å‘½åå’Œé‡æ„ï¼š
  - `platform-ai-providers.controller.ts`
  - `admin/admin-nodes.controller.ts`
  - `custom-nodes.controller.ts`

### 5. å‰ç«¯å±‚

#### é—®é¢˜æ–‡ä»¶
- `packages/editor-ui/src/api/platform-services.ts` âŒ
- `packages/editor-ui/src/api/plugins.ts` âŒ
- `packages/editor-ui/src/stores/platform-services.store.ts` âŒ
- `packages/editor-ui/src/stores/plugins.store.ts` âŒ
- `packages/editor-ui/src/views/PluginMarket.vue` âŒ
- `packages/editor-ui/src/views/NodeMarket.vue` âŒï¼ˆå¦‚æœå­˜åœ¨ï¼‰

#### ä¿®æ­£æ–¹æ¡ˆ
- åˆ›å»ºï¼š
  - `packages/editor-ui/src/api/ai-providers.ts`
  - `packages/editor-ui/src/api/custom-nodes.ts`
  - `packages/editor-ui/src/stores/ai-providers.store.ts`
  - `packages/editor-ui/src/views/NodesMarket.vue`ï¼ˆç»Ÿä¸€çš„èŠ‚ç‚¹å¸‚åœºï¼‰

---

## ğŸ“… ä¿®æ­£å®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šæ•°æ®åº“ä¿®æ­£ï¼ˆ0.5 å¤©ï¼‰

**ä»»åŠ¡ï¼š**
1. åˆ›å»ºæ–°è¿ç§»è„šæœ¬ï¼ˆå‘åå…¼å®¹ï¼Œä¸åˆ é™¤æ—§è¡¨ï¼‰
2. åˆ›å»ºæ–°è¡¨ï¼š
   - `platform_ai_provider`
   - `platform_node`
   - `custom_node`
3. è¿ç§»ç°æœ‰æ•°æ®ï¼š
   - å°† `platform_service` ä¸­ `service_type='ai_model'` çš„è®°å½•è½¬æ¢
   - å°†æ’ä»¶ç›¸å…³æ•°æ®åˆ†ç¦»åˆ° `platform_node` å’Œ `custom_node`

**æ£€æŸ¥æ¸…å•ï¼š**
- [ ] æ–°è¿ç§»è„šæœ¬åˆ›å»º
- [ ] æ•°æ®è¿ç§»éªŒè¯
- [ ] æ—§è¡¨æ ‡è®°ä¸ºå¼ƒç”¨ï¼ˆæš‚ä¸åˆ é™¤ï¼‰

### é˜¶æ®µ 2ï¼šEntity/Repository ä¿®æ­£ï¼ˆ0.5 å¤©ï¼‰

**ä»»åŠ¡ï¼š**
1. åˆ›å»ºæ–° Entity
2. åˆ›å»ºæ–° Repository
3. æ›´æ–°ç±»å‹å®šä¹‰

**æ£€æŸ¥æ¸…å•ï¼š**
- [ ] PlatformAIProvider Entity
- [ ] PlatformNode Entity
- [ ] CustomNode Entity
- [ ] TypeScript ç¼–è¯‘é€šè¿‡

### é˜¶æ®µ 3ï¼šService å±‚ä¿®æ­£ï¼ˆ1 å¤©ï¼‰

**ä»»åŠ¡ï¼š**
1. é‡æ„ PlatformServiceService
2. åˆ›å»º PlatformAIProviderService
3. åˆ›å»º PlatformNodeService
4. åˆ›å»º CustomNodeService

**æ£€æŸ¥æ¸…å•ï¼š**
- [ ] Service å±‚æ¥å£è®¾è®¡
- [ ] å•å…ƒæµ‹è¯•ç¼–å†™
- [ ] æ–‡æ¡£æ›´æ–°

### é˜¶æ®µ 4ï¼šController å±‚ä¿®æ­£ï¼ˆ1 å¤©ï¼‰

**ä»»åŠ¡ï¼š**
1. é‡æ„ API ç«¯ç‚¹
2. æ›´æ–°è·¯ç”±
3. æ›´æ–°æƒé™æ£€æŸ¥

**æ£€æŸ¥æ¸…å•ï¼š**
- [ ] API ç«¯ç‚¹é‡å‘½å
- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] Postman æµ‹è¯•é€šè¿‡

### é˜¶æ®µ 5ï¼šå‰ç«¯ä¿®æ­£ï¼ˆ1.5 å¤©ï¼‰

**ä»»åŠ¡ï¼š**
1. é‡æ„ API å±‚
2. é‡æ„ Store
3. é‡æ„ UI ç»„ä»¶

**æ£€æŸ¥æ¸…å•ï¼š**
- [ ] API å±‚æ›´æ–°
- [ ] Store æ›´æ–°
- [ ] ç»„ä»¶æ›´æ–°
- [ ] å›½é™…åŒ–æ›´æ–°
- [ ] UI æµ‹è¯•é€šè¿‡

### é˜¶æ®µ 6ï¼šé›†æˆæµ‹è¯•å’ŒéªŒè¯ï¼ˆ0.5 å¤©ï¼‰

**ä»»åŠ¡ï¼š**
1. ç«¯åˆ°ç«¯æµ‹è¯•
2. å›å½’æµ‹è¯•
3. æ€§èƒ½æµ‹è¯•

**æ£€æŸ¥æ¸…å•ï¼š**
- [ ] æ•°æ®éš”ç¦»éªŒè¯
- [ ] AI è°ƒç”¨è®¡è´¹éªŒè¯
- [ ] èŠ‚ç‚¹å¸‚åœºåŠŸèƒ½éªŒè¯
- [ ] è‡ªå®šä¹‰èŠ‚ç‚¹ä¸Šä¼ éªŒè¯

---

## ğŸ—„ï¸ ä¿®æ­£åçš„æ•°æ®åº“è®¾è®¡

### è¡¨ 1ï¼šplatform_ai_providerï¼ˆå¹³å° AI æœåŠ¡æä¾›å•†ï¼‰

```sql
CREATE TABLE platform_ai_provider (
  provider_key VARCHAR(100) PRIMARY KEY,        -- 'openai', 'anthropic', 'google'
  provider_name VARCHAR(200) NOT NULL,          -- 'OpenAI', 'Anthropic', 'Google'

  -- å¹³å°ç»Ÿä¸€é…ç½®çš„ API Key
  api_key_encrypted TEXT NOT NULL,              -- åŠ å¯†å­˜å‚¨
  api_endpoint VARCHAR(500) NOT NULL,           -- 'https://api.openai.com'

  -- æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ï¼ˆJSONBï¼‰
  models_config JSONB NOT NULL,                 -- è§ä¸‹æ–¹ç¤ºä¾‹

  -- é…é¢é…ç½®
  quota_config JSONB,                           -- { monthlyTokens: 10000000 }

  -- çŠ¶æ€
  is_active BOOLEAN NOT NULL DEFAULT true,
  enabled BOOLEAN NOT NULL DEFAULT true,

  -- å®¡è®¡
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- models_config ç¤ºä¾‹
{
  "models": [
    {
      "id": "gpt-4-turbo",
      "name": "GPT-4 Turbo",
      "description": "Most capable GPT-4 model",
      "pricePerToken": 0.00001,
      "currency": "CNY",
      "contextWindow": 128000,
      "maxOutputTokens": 4096,
      "supportsFunctions": true,
      "supportsVision": false
    },
    {
      "id": "gpt-4o",
      "name": "GPT-4o",
      "description": "Multimodal flagship model",
      "pricePerToken": 0.000005,
      "currency": "CNY",
      "contextWindow": 128000,
      "maxOutputTokens": 16384,
      "supportsFunctions": true,
      "supportsVision": true
    },
    {
      "id": "gpt-3.5-turbo",
      "name": "GPT-3.5 Turbo",
      "description": "Fast and efficient",
      "pricePerToken": 0.000001,
      "currency": "CNY",
      "contextWindow": 16000,
      "maxOutputTokens": 4096,
      "supportsFunctions": true,
      "supportsVision": false
    }
  ]
}
```

### è¡¨ 2ï¼šplatform_nodeï¼ˆå¹³å°èŠ‚ç‚¹/æ’ä»¶ï¼‰

```sql
CREATE TABLE platform_node (
  node_key VARCHAR(100) PRIMARY KEY,            -- 'weather-query', 'ocr-service'
  node_name VARCHAR(200) NOT NULL,              -- 'å¤©æ°”æŸ¥è¯¢', 'OCR è¯†åˆ«'

  -- èŠ‚ç‚¹ç±»å‹
  node_type VARCHAR(50) NOT NULL,               -- 'platform_official' | 'third_party_approved'

  -- èŠ‚ç‚¹å®šä¹‰ï¼ˆå®Œæ•´çš„ INodeTypeDescriptionï¼‰
  node_definition JSONB NOT NULL,               -- è§ä¸‹æ–¹ç¤ºä¾‹

  -- èŠ‚ç‚¹æ‰§è¡Œä»£ç ï¼ˆå¯é€‰ï¼Œå¯¹äºç®€å•èŠ‚ç‚¹å¯å†…åµŒåœ¨ definition ä¸­ï¼‰
  node_code TEXT,                                -- TypeScript ä»£ç 

  -- åˆ†ç±»å’Œå…ƒä¿¡æ¯
  category VARCHAR(100),                         -- 'messaging', 'cloud', 'ai', etc.
  description TEXT,
  icon_url VARCHAR(500),
  version VARCHAR(50) NOT NULL DEFAULT '1.0.0',

  -- è®¡è´¹ï¼ˆå¦‚æœæ˜¯å¹³å°æ‰˜ç®¡æœåŠ¡ï¼‰
  is_billable BOOLEAN NOT NULL DEFAULT false,
  price_per_request DECIMAL(10, 4),             -- æŒ‰æ¬¡è®¡è´¹

  -- å®¡æ ¸ï¼ˆä»…ç¬¬ä¸‰æ–¹èŠ‚ç‚¹ï¼‰
  submission_status VARCHAR(50),                 -- 'approved' | 'rejected'
  submitted_by UUID,                             -- æäº¤è€…ç”¨æˆ· ID
  submitted_at TIMESTAMP,
  reviewed_by UUID,
  reviewed_at TIMESTAMP,
  review_notes TEXT,

  -- çŠ¶æ€
  is_active BOOLEAN NOT NULL DEFAULT true,
  enabled BOOLEAN NOT NULL DEFAULT true,

  -- å®¡è®¡
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- å¤–é”®
  FOREIGN KEY (submitted_by) REFERENCES user(id),
  FOREIGN KEY (reviewed_by) REFERENCES user(id)
);

-- node_definition ç¤ºä¾‹ï¼ˆå¤©æ°”æŸ¥è¯¢èŠ‚ç‚¹ï¼‰
{
  "displayName": "å¤©æ°”æŸ¥è¯¢",
  "name": "weatherQuery",
  "icon": "fa:cloud-sun",
  "group": ["transform"],
  "version": [1],
  "description": "æŸ¥è¯¢å®æ—¶å¤©æ°”ä¿¡æ¯",
  "defaults": {
    "name": "å¤©æ°”æŸ¥è¯¢"
  },
  "inputs": ["main"],
  "outputs": ["main"],
  "properties": [
    {
      "displayName": "åŸå¸‚",
      "name": "city",
      "type": "string",
      "default": "",
      "required": true,
      "description": "è¦æŸ¥è¯¢çš„åŸå¸‚åç§°"
    }
  ]
}
```

### è¡¨ 3ï¼šcustom_nodeï¼ˆç”¨æˆ·è‡ªå®šä¹‰èŠ‚ç‚¹ï¼‰

```sql
CREATE TABLE custom_node (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  node_key VARCHAR(100) NOT NULL,               -- å·¥ä½œç©ºé—´å†…å”¯ä¸€
  node_name VARCHAR(200) NOT NULL,

  -- æ‰€å±å·¥ä½œç©ºé—´
  workspace_id UUID NOT NULL,

  -- èŠ‚ç‚¹å®šä¹‰å’Œä»£ç 
  node_definition JSONB NOT NULL,
  node_code TEXT NOT NULL,                       -- å¿…é¡»æä¾›ä»£ç 

  -- âœ… æ–°å¢ï¼šé…ç½®æ¨¡å¼ï¼ˆä¸ªäººé…ç½® vs å›¢é˜Ÿå…±äº«ï¼‰
  config_mode VARCHAR(20) NOT NULL DEFAULT 'personal',  -- 'personal' | 'shared'

  -- âœ… æ–°å¢ï¼šå¦‚æœæ˜¯å›¢é˜Ÿå…±äº«æ¨¡å¼ï¼Œå­˜å‚¨å›¢é˜Ÿå…±äº«çš„é…ç½®
  shared_config_data TEXT,                       -- åŠ å¯†çš„é…ç½®æ•°æ®ï¼ˆä»… shared æ¨¡å¼ï¼‰
  shared_config_by UUID,                         -- é…ç½®è€…ï¼ˆä»… shared æ¨¡å¼ï¼‰

  -- âœ… æ–°å¢ï¼šé…ç½®å­—æ®µå®šä¹‰ï¼ˆä¾›ç”¨æˆ·å¡«å†™ï¼‰
  config_schema JSONB,                           -- å®šä¹‰éœ€è¦ç”¨æˆ·é…ç½®çš„å­—æ®µ

  -- åˆ†ç±»å’Œå…ƒä¿¡æ¯
  category VARCHAR(100),
  description TEXT,
  icon_url VARCHAR(500),
  version VARCHAR(50) NOT NULL DEFAULT '1.0.0',

  -- å¯è§æ€§ï¼ˆå·¥ä½œç©ºé—´ç§æœ‰ï¼‰
  visibility VARCHAR(50) NOT NULL DEFAULT 'workspace',  -- å§‹ç»ˆä¸º 'workspace'

  -- æäº¤å®¡æ ¸ï¼ˆå¯é€‰ï¼‰
  submission_status VARCHAR(50),                 -- 'draft' | 'pending' | 'approved' | 'rejected'
  submitted_at TIMESTAMP,
  reviewed_by UUID,
  reviewed_at TIMESTAMP,
  review_notes TEXT,

  -- çŠ¶æ€
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- å®¡è®¡
  created_by UUID NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- å¤–é”®
  FOREIGN KEY (workspace_id) REFERENCES project(id) ON DELETE CASCADE,
  FOREIGN KEY (created_by) REFERENCES user(id),
  FOREIGN KEY (reviewed_by) REFERENCES user(id),
  FOREIGN KEY (shared_config_by) REFERENCES user(id),

  -- å”¯ä¸€çº¦æŸ
  UNIQUE(workspace_id, node_key)
);

-- ç´¢å¼•
CREATE INDEX idx_custom_node_workspace ON custom_node(workspace_id);
CREATE INDEX idx_custom_node_status ON custom_node(submission_status);
CREATE INDEX idx_custom_node_config_mode ON custom_node(config_mode);

-- config_schema ç¤ºä¾‹ï¼ˆå®šä¹‰éœ€è¦ç”¨æˆ·é…ç½®çš„å­—æ®µï¼‰
{
  "fields": [
    {
      "name": "apiKey",
      "displayName": "API Key",
      "type": "string",
      "typeOptions": { "password": true },
      "required": true,
      "description": "ä»å…¬å¸å†…éƒ¨ç³»ç»Ÿè·å–çš„ API Key"
    },
    {
      "name": "baseUrl",
      "displayName": "Base URL",
      "type": "string",
      "default": "https://api.company.com",
      "required": false
    }
  ]
}
```

### è¡¨ 4ï¼šuser_node_configï¼ˆç”¨æˆ·èŠ‚ç‚¹é…ç½®ï¼‰

**âœ… æ ¸å¿ƒè¡¨ï¼šæ›¿ä»£ credentials_entity å’Œ workspace_plugin_credentials**

```sql
CREATE TABLE user_node_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ç”¨æˆ· IDï¼ˆå“ªä¸ªç”¨æˆ·çš„é…ç½®ï¼‰
  user_id UUID NOT NULL,

  -- èŠ‚ç‚¹ç±»å‹ï¼ˆæŒ‰èŠ‚ç‚¹ç±»å‹å­˜å‚¨ï¼Œå®ç°è‡ªåŠ¨å¤ç”¨ï¼‰
  node_type VARCHAR(100) NOT NULL,              -- ä¾‹å¦‚: 'n8n-nodes-base.github', 'custom.company-api'

  -- åŠ å¯†çš„é…ç½®æ•°æ®ï¼ˆJSON æ ¼å¼ï¼‰
  config_data TEXT NOT NULL,                     -- åŠ å¯†å­˜å‚¨ï¼š{"apiKey": "ghp_xxx", "baseUrl": "..."}

  -- é…ç½®çŠ¶æ€
  is_configured BOOLEAN NOT NULL DEFAULT true,

  -- æœ€åä½¿ç”¨æ—¶é—´ï¼ˆç”¨äºæ¸…ç†è¿‡æœŸé…ç½®ï¼‰
  last_used_at TIMESTAMP,

  -- å®¡è®¡
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- å¤–é”®
  FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE,

  -- å”¯ä¸€çº¦æŸï¼šä¸€ä¸ªç”¨æˆ·å¯¹ä¸€ä¸ªèŠ‚ç‚¹ç±»å‹åªèƒ½æœ‰ä¸€ä»½é…ç½®
  UNIQUE (user_id, node_type)
);

-- ç´¢å¼•
CREATE INDEX idx_user_node_config_lookup ON user_node_config(user_id, node_type);
CREATE INDEX idx_user_node_config_last_used ON user_node_config(last_used_at);
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```sql
-- ç”¨æˆ·1ä¸º GitHub èŠ‚ç‚¹é…ç½®æˆæƒ
INSERT INTO user_node_config (user_id, node_type, config_data)
VALUES (
  'user-1-uuid',
  'n8n-nodes-base.github',
  'encrypted:{"accessToken": "ghp_user1_token"}'
);

-- ç”¨æˆ·2ä¸ºç›¸åŒçš„ GitHub èŠ‚ç‚¹é…ç½®è‡ªå·±çš„æˆæƒ
INSERT INTO user_node_config (user_id, node_type, config_data)
VALUES (
  'user-2-uuid',
  'n8n-nodes-base.github',
  'encrypted:{"accessToken": "ghp_user2_token"}'
);

-- ç”¨æˆ·1æ‰“å¼€ GitHub èŠ‚ç‚¹ â†’ è‡ªåŠ¨åŠ è½½ user-1 çš„é…ç½®
-- ç”¨æˆ·2æ‰“å¼€ GitHub èŠ‚ç‚¹ â†’ è‡ªåŠ¨åŠ è½½ user-2 çš„é…ç½®
-- âœ… å®ç°ç”¨æˆ·çº§åˆ«éš”ç¦» + åŒç±»å‹èŠ‚ç‚¹è‡ªåŠ¨å¤ç”¨
```

### è¡¨ 5ï¼šplatform_rag_serviceï¼ˆä¿ç•™ï¼Œä¸å˜ï¼‰

```sql
-- è¿™ä¸ªè¡¨è®¾è®¡æ˜¯æ­£ç¡®çš„ï¼Œä¿æŒä¸å˜
CREATE TABLE platform_rag_service (
  service_key VARCHAR(100) PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  domain VARCHAR(50) NOT NULL,
  price_per_query_cny DOUBLE NOT NULL,
  metadata JSONB,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## ğŸ“± å‰ç«¯ä½“éªŒè®¾è®¡

### èŠ‚ç‚¹ç®¡ç†é¡µé¢ï¼ˆæ›¿ä»£å‡­è¯ç®¡ç†ï¼‰

```
èŠ‚ç‚¹ç®¡ç† (UserNodeManagement.vue)
â”œâ”€ å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼ˆè‡ªåŠ¨å¯ç”¨ï¼ŒæŒ‰é‡è®¡è´¹ï¼‰
â”‚   â”œâ”€ OpenAI                   [å·²å¯ç”¨ âœ“] [æŸ¥çœ‹å®šä»·]
â”‚   â”œâ”€ Anthropic                [å·²å¯ç”¨ âœ“] [æŸ¥çœ‹å®šä»·]
â”‚   â””â”€ æ³•å¾‹çŸ¥è¯†åº“ RAG           [å·²å¯ç”¨ âœ“] [æŸ¥çœ‹å®šä»·]
â”‚
â”œâ”€ ç¬¬ä¸‰æ–¹èŠ‚ç‚¹ï¼ˆéœ€è¦æˆæƒï¼‰
â”‚   â”œâ”€ GitHub                   [å·²é…ç½® âœ“]
â”‚   â”‚   â””â”€ Personal Access Token: ghp_***xxx
â”‚   â”‚       [ç¼–è¾‘] [åˆ é™¤] [æµ‹è¯•è¿æ¥]
â”‚   â”‚
â”‚   â”œâ”€ Notion                   [æœªé…ç½® âš ï¸]
â”‚   â”‚   â””â”€ [é…ç½®æˆæƒ] æŒ‰é’®
â”‚   â”‚
â”‚   â””â”€ Slack                    [å·²é…ç½® âœ“]
â”‚       â””â”€ OAuth Token: xoxb-***xxx
â”‚           [é‡æ–°æˆæƒ] [åˆ é™¤]
â”‚
â””â”€ è‡ªå®šä¹‰èŠ‚ç‚¹ï¼ˆå›¢é˜Ÿä¸Šä¼ ï¼‰
    â”œâ”€ å…¬å¸å†…éƒ¨ API v1.0        [å›¢é˜Ÿå…±äº« âœ“]
    â”‚   â””â”€ ä¸Šä¼ è€…: å¼ ä¸‰
    â”‚   â””â”€ é…ç½®è€…: æå››ï¼ˆç®¡ç†å‘˜ï¼‰
    â”‚   â””â”€ å…¨å‘˜å¯ç”¨ï¼Œæ— éœ€é…ç½®
    â”‚
    â”œâ”€ æ•°æ®æ¸…æ´—æ’ä»¶ v2.0        [éœ€è¦ä¸ªäººé…ç½® âš ï¸]
    â”‚   â””â”€ ä¸Šä¼ è€…: ç‹äº”
    â”‚   â””â”€ çŠ¶æ€: æœªé…ç½®
    â”‚   â””â”€ [é…ç½®æˆæƒ] æŒ‰é’®
    â”‚
    â””â”€ [+ ä¸Šä¼ æ–°èŠ‚ç‚¹] æŒ‰é’®
```

### å·¥ä½œæµä¸­çš„èŠ‚ç‚¹é…ç½®ä½“éªŒ

**åœºæ™¯ 1ï¼šç”¨æˆ·Bé¦–æ¬¡ä½¿ç”¨ GitHub èŠ‚ç‚¹ï¼ˆæœªé…ç½®ï¼‰**

```
ç”¨æˆ·Bæ‰“å¼€å·¥ä½œæµ â†’ ç‚¹å‡» GitHub èŠ‚ç‚¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitHub èŠ‚ç‚¹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ æœªé…ç½®æˆæƒ                       â”‚
â”‚                                     â”‚
â”‚ Personal Access Token               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ [è¾“å…¥ä½ çš„ GitHub Token]     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ ğŸ’¡ é…ç½®åå°†è‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰ GitHub  â”‚
â”‚    èŠ‚ç‚¹ï¼Œæ— éœ€é‡å¤å¡«å†™              â”‚
â”‚                                     â”‚
â”‚ [ğŸ’¾ ä¿å­˜é…ç½®]  [å»èŠ‚ç‚¹ç®¡ç† â†’]      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Resource                            â”‚
â”‚ â—‹ Issue  â— Repository               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœºæ™¯ 2ï¼šç”¨æˆ·Bå·²é…ç½®ï¼ˆå·²é…ç½®ï¼‰**

```
ç”¨æˆ·Bæ‰“å¼€å·¥ä½œæµ â†’ ç‚¹å‡» GitHub èŠ‚ç‚¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitHub èŠ‚ç‚¹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… å·²é…ç½®æˆæƒ  [ä¿®æ”¹]               â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Resource                            â”‚
â”‚ â—‹ Issue  â— Repository               â”‚
â”‚                                     â”‚
â”‚ Operation                           â”‚
â”‚ â—‹ Create  â— Get  â—‹ Update           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœºæ™¯ 3ï¼šAI èŠ‚ç‚¹ï¼ˆå¹³å°æ‰˜ç®¡ï¼Œæ— éœ€é…ç½®ï¼‰**

```
ç”¨æˆ·æ‰“å¼€å·¥ä½œæµ â†’ æ‹–æ‹½ OpenAI èŠ‚ç‚¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI èŠ‚ç‚¹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŒŸ å¹³å°æ‰˜ç®¡ - æŒ‰é‡è®¡è´¹               â”‚
â”‚                                     â”‚
â”‚ Model                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ â— GPT-4 Turbo  Â¥0.01/1K     â”‚   â”‚
â”‚ â”‚ â—‹ GPT-4o       Â¥0.005/1K    â”‚   â”‚
â”‚ â”‚ â—‹ GPT-3.5      Â¥0.001/1K    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚ Prompt                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹...        â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚ ğŸ’° æœ¬æœˆå·²ä½¿ç”¨: 12,500 / 1,000,000  â”‚
â”‚ [â”â”â”â”â”â”â”â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 1.25%       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» ä¿®æ­£åçš„ä»£ç ç¤ºä¾‹

### 1. UserNodeConfigServiceï¼ˆæ ¸å¿ƒæœåŠ¡ï¼‰

```typescript
// packages/cli/src/services/user-node-config.service.ts
import { Service } from '@n8n/di';
import { UserNodeConfigRepository } from '@/repositories/user-node-config.repository';
import { CustomNodeRepository } from '@/repositories/custom-node.repository';
import { Cipher } from '@/services/cipher.service';

@Service()
export class UserNodeConfigService {
  constructor(
    private readonly userNodeConfigRepository: UserNodeConfigRepository,
    private readonly customNodeRepository: CustomNodeRepository,
    private readonly cipher: Cipher,
  ) {}

  /**
   * è·å–ç”¨æˆ·çš„èŠ‚ç‚¹é…ç½®ï¼ˆç”¨äºèŠ‚ç‚¹æ‰§è¡Œæ—¶æ³¨å…¥ï¼‰
   */
  async getUserNodeConfig(userId: string, nodeType: string) {
    const config = await this.userNodeConfigRepository.findOne({
      where: { userId, nodeType },
    });

    if (!config) return null;

    // è§£å¯†é…ç½®æ•°æ®
    const decrypted = this.cipher.decrypt(config.configData);
    return JSON.parse(decrypted);
  }

  /**
   * ä¿å­˜ç”¨æˆ·çš„èŠ‚ç‚¹é…ç½®ï¼ˆä»å·¥ä½œæµæˆ–èŠ‚ç‚¹ç®¡ç†é¡µé¢ï¼‰
   */
  async saveUserNodeConfig(
    userId: string,
    nodeType: string,
    configData: Record<string, any>,
  ) {
    // åŠ å¯†é…ç½®æ•°æ®
    const encrypted = this.cipher.encrypt(JSON.stringify(configData));

    // Upsertï¼ˆå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
    await this.userNodeConfigRepository.upsert(
      {
        userId,
        nodeType,
        configData: encrypted,
        isConfigured: true,
        lastUsedAt: new Date(),
      },
      ['userId', 'nodeType'],
    );
  }

  /**
   * è·å–èŠ‚ç‚¹é…ç½®ï¼ˆå¤„ç†å›¢é˜Ÿå…±äº«æ¨¡å¼ï¼‰
   */
  async getNodeConfig(userId: string, nodeType: string, workspaceId: string) {
    // 1. æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰èŠ‚ç‚¹
    if (nodeType.startsWith('custom.')) {
      const customNode = await this.customNodeRepository.findOne({
        where: { nodeKey: nodeType, workspaceId },
      });

      if (customNode) {
        // 2a. å›¢é˜Ÿå…±äº«æ¨¡å¼ï¼šç›´æ¥è¿”å›å…±äº«é…ç½®
        if (customNode.configMode === 'shared') {
          const decrypted = this.cipher.decrypt(customNode.sharedConfigData);
          return JSON.parse(decrypted);
        }

        // 2b. ä¸ªäººé…ç½®æ¨¡å¼ï¼šè·å–ç”¨æˆ·è‡ªå·±çš„é…ç½®
        const userConfig = await this.getUserNodeConfig(userId, nodeType);
        if (!userConfig) {
          throw new Error(
            `è¯·å…ˆé…ç½® ${customNode.nodeName} çš„æˆæƒä¿¡æ¯`
          );
        }
        return userConfig;
      }
    }

    // 3. ç¬¬ä¸‰æ–¹èŠ‚ç‚¹ï¼šæ€»æ˜¯ä½¿ç”¨ä¸ªäººé…ç½®
    const userConfig = await this.getUserNodeConfig(userId, nodeType);
    if (!userConfig) {
      throw new Error(`è¯·å…ˆé…ç½®è¯¥èŠ‚ç‚¹çš„æˆæƒä¿¡æ¯`);
    }

    return userConfig;
  }

  /**
   * æµ‹è¯•èŠ‚ç‚¹è¿æ¥
   */
  async testNodeConnection(userId: string, nodeType: string) {
    const config = await this.getUserNodeConfig(userId, nodeType);
    if (!config) {
      throw new Error('æœªæ‰¾åˆ°èŠ‚ç‚¹é…ç½®');
    }

    // æ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒç”¨ç›¸åº”çš„æµ‹è¯•æ–¹æ³•
    // è¿™é‡Œéœ€è¦èŠ‚ç‚¹å®šä¹‰ä¸­çš„ test æ–¹æ³•
    // ...
    return { success: true };
  }

  /**
   * è·å–ç”¨æˆ·çš„æ‰€æœ‰èŠ‚ç‚¹é…ç½®ï¼ˆç”¨äºèŠ‚ç‚¹ç®¡ç†é¡µé¢ï¼‰
   */
  async getAllUserNodeConfigs(userId: string) {
    const configs = await this.userNodeConfigRepository.find({
      where: { userId },
    });

    return configs.map(config => ({
      nodeType: config.nodeType,
      isConfigured: config.isConfigured,
      lastUsedAt: config.lastUsedAt,
      updatedAt: config.updatedAt,
    }));
  }
}
```

### 2. å·¥ä½œæµèŠ‚ç‚¹å‚æ•°é¢æ¿ï¼ˆæ”¯æŒç›´æ¥é…ç½®ï¼‰

```vue
<!-- packages/frontend/editor-ui/src/app/components/NodeSettings/NodeAuthConfig.vue -->
<template>
  <div class="node-auth-config">
    <!-- æœªé…ç½®çŠ¶æ€ -->
    <div v-if="!isConfigured" class="auth-not-configured">
      <Alert type="warning">
        <template #icon>âš ï¸</template>
        æ­¤èŠ‚ç‚¹éœ€è¦æˆæƒæ‰èƒ½ä½¿ç”¨
      </Alert>

      <!-- é…ç½®è¡¨å• -->
      <div class="config-form">
        <FormField
          v-for="field in configFields"
          :key="field.name"
          :label="field.displayName"
          :required="field.required"
        >
          <Input
            v-model="formData[field.name]"
            :type="field.typeOptions?.password ? 'password' : 'text'"
            :placeholder="field.placeholder"
          />
          <p v-if="field.description" class="field-hint">
            {{ field.description }}
          </p>
        </FormField>
      </div>

      <!-- æç¤º -->
      <div class="auto-reuse-hint">
        <Icon name="info-circle" />
        <span>é…ç½®åå°†è‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰ {{ nodeDisplayName }} èŠ‚ç‚¹</span>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="actions">
        <Button @click="saveConfig" type="primary" :loading="saving">
          ğŸ’¾ ä¿å­˜é…ç½®
        </Button>
        <Button @click="goToNodeManagement" type="text">
          åœ¨èŠ‚ç‚¹ç®¡ç†ä¸­é…ç½® â†’
        </Button>
      </div>
    </div>

    <!-- å·²é…ç½®çŠ¶æ€ -->
    <div v-else class="auth-configured">
      <Badge status="success">âœ… å·²é…ç½®æˆæƒ</Badge>
      <Button @click="editConfig" type="text" size="small">
        ä¿®æ”¹
      </Button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useUserNodeConfigStore } from '@/stores/userNodeConfig.store';
import { useNodeTypesStore } from '@/stores/nodeTypes.store';

const props = defineProps<{
  nodeType: string;
}>();

const userNodeConfigStore = useUserNodeConfigStore();
const nodeTypesStore = useNodeTypesStore();

const isConfigured = ref(false);
const formData = ref<Record<string, any>>({});
const saving = ref(false);

// è·å–èŠ‚ç‚¹å®šä¹‰
const nodeTypeInfo = computed(() => {
  return nodeTypesStore.getNodeType(props.nodeType);
});

const nodeDisplayName = computed(() => nodeTypeInfo.value?.displayName || '');

// è·å–é…ç½®å­—æ®µå®šä¹‰
const configFields = computed(() => {
  return nodeTypeInfo.value?.userConfigFields || [];
});

// æ£€æŸ¥æ˜¯å¦å·²é…ç½®
onMounted(async () => {
  const config = await userNodeConfigStore.getUserConfig(props.nodeType);
  isConfigured.value = !!config;

  if (config) {
    formData.value = config;
  }
});

// ä¿å­˜é…ç½®
async function saveConfig() {
  saving.value = true;
  try {
    await userNodeConfigStore.saveConfig(props.nodeType, formData.value);
    isConfigured.value = true;
    showToast('é…ç½®ä¿å­˜æˆåŠŸï¼ŒåŒç±»å‹èŠ‚ç‚¹å°†è‡ªåŠ¨ä½¿ç”¨æ­¤é…ç½®', 'success');
  } catch (error) {
    showToast(`é…ç½®ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
  } finally {
    saving.value = false;
  }
}

// ç¼–è¾‘é…ç½®
function editConfig() {
  isConfigured.value = false;
}

// è·³è½¬åˆ°èŠ‚ç‚¹ç®¡ç†
function goToNodeManagement() {
  router.push('/node-management');
}
</script>
```

### 3. èŠ‚ç‚¹ç®¡ç†é¡µé¢

```vue
<!-- packages/frontend/editor-ui/src/app/views/UserNodeManagement.vue -->
<template>
  <div class="user-node-management">
    <PageHeader title="èŠ‚ç‚¹ç®¡ç†">
      <template #description>
        ç®¡ç†æ‰€æœ‰èŠ‚ç‚¹çš„æˆæƒä¿¡æ¯ã€‚é…ç½®ä¸€æ¬¡ï¼Œæ‰€æœ‰å·¥ä½œæµè‡ªåŠ¨ä½¿ç”¨ã€‚
      </template>
    </PageHeader>

    <!-- å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ -->
    <Section title="å¹³å°æ‰˜ç®¡èŠ‚ç‚¹ï¼ˆæŒ‰é‡è®¡è´¹ï¼‰">
      <p class="section-desc">
        è¿™äº›èŠ‚ç‚¹ç”±å¹³å°æä¾›ï¼Œæ— éœ€é…ç½®ï¼Œä½¿ç”¨æ—¶è‡ªåŠ¨ä»å·¥ä½œç©ºé—´ä½™é¢æ‰£è´¹ã€‚
      </p>
      <div class="node-grid">
        <NodeCard
          v-for="node in platformManagedNodes"
          :key="node.type"
          :node="node"
          :is-platform-managed="true"
          disabled
        >
          <template #badge>
            <Badge type="success">å¹³å°æ‰˜ç®¡</Badge>
          </template>
          <template #footer>
            <Button type="text" size="small" @click="viewPricing(node)">
              æŸ¥çœ‹å®šä»·
            </Button>
          </template>
        </NodeCard>
      </div>
    </Section>

    <!-- ç¬¬ä¸‰æ–¹èŠ‚ç‚¹ -->
    <Section title="ç¬¬ä¸‰æ–¹èŠ‚ç‚¹ï¼ˆéœ€è¦æˆæƒï¼‰">
      <p class="section-desc">
        é…ç½®ä½ çš„ä¸ªäººè´¦å·æˆæƒä¿¡æ¯ï¼Œä»…ä½ è‡ªå·±å¯è§ã€‚
      </p>
      <div class="node-list">
        <NodeItem
          v-for="node in thirdPartyNodes"
          :key="node.type"
          :node="node"
          :user-config="userConfigs[node.type]"
          @configure="openConfigDialog(node)"
          @edit="openEditDialog(node)"
          @delete="deleteConfig(node)"
          @test="testConnection(node)"
        />
      </div>
    </Section>

    <!-- è‡ªå®šä¹‰èŠ‚ç‚¹ -->
    <Section title="è‡ªå®šä¹‰èŠ‚ç‚¹ï¼ˆå›¢é˜Ÿä¸Šä¼ ï¼‰">
      <div class="node-list">
        <CustomNodeItem
          v-for="node in customNodes"
          :key="node.id"
          :node="node"
          :user-config="userConfigs[node.nodeKey]"
          @configure="openCustomNodeConfigDialog(node)"
          @edit="editCustomNode(node)"
          @delete="deleteCustomNode(node)"
        />
      </div>
      <Button @click="showUploadDialog = true" type="dashed" block>
        + ä¸Šä¼ æ–°èŠ‚ç‚¹
      </Button>
    </Section>

    <!-- é…ç½®å¯¹è¯æ¡† -->
    <NodeConfigDialog
      v-if="showConfigDialog"
      :node="selectedNode"
      @save="saveNodeConfig"
      @close="showConfigDialog = false"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useUserNodeConfigStore } from '@/stores/userNodeConfig.store';
import { useCustomNodesStore } from '@/stores/customNodes.store';

const userNodeConfigStore = useUserNodeConfigStore();
const customNodesStore = useCustomNodesStore();

const platformManagedNodes = ref([]);
const thirdPartyNodes = ref([]);
const customNodes = ref([]);
const userConfigs = ref({});

onMounted(async () => {
  // åŠ è½½æ‰€æœ‰èŠ‚ç‚¹ç±»å‹å’Œç”¨æˆ·é…ç½®
  await Promise.all([
    loadAllNodeTypes(),
    userNodeConfigStore.fetchUserConfigs(),
    customNodesStore.fetchWorkspaceCustomNodes(),
  ]);

  platformManagedNodes.value = filterPlatformManagedNodes();
  thirdPartyNodes.value = filterThirdPartyNodes();
  customNodes.value = customNodesStore.customNodes;
  userConfigs.value = userNodeConfigStore.userConfigs;
});

async function saveNodeConfig(nodeType: string, configData: any) {
  await userNodeConfigStore.saveConfig(nodeType, configData);
  showToast('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
}

async function testConnection(node: any) {
  const result = await userNodeConfigStore.testConnection(node.type);
  if (result.success) {
    showToast('è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
  } else {
    showToast(`è¿æ¥æµ‹è¯•å¤±è´¥: ${result.message}`, 'error');
  }
}
</script>
```

### 4. å‰ç«¯ï¼šAI èŠ‚ç‚¹å‚æ•°é…ç½®

```vue
<!-- packages/editor-ui/src/features/ai/AINodeConfig.vue -->
<template>
  <div class="ai-node-config">
    <!-- é€‰æ‹© AI æœåŠ¡æä¾›å•† -->
    <n8n-form-item label="AI æœåŠ¡æä¾›å•†">
      <n8n-select v-model="selectedProvider" @change="handleProviderChange">
        <n8n-option
          v-for="provider in availableProviders"
          :key="provider.providerKey"
          :value="provider.providerKey"
        >
          <div class="provider-option">
            <span>{{ provider.providerName }}</span>
            <n8n-tag type="success">å¹³å°æ‰˜ç®¡</n8n-tag>
          </div>
        </n8n-option>
        <n8n-option value="custom">
          <span>è‡ªå®šä¹‰</span>
          <n8n-tag type="warning">éœ€é…ç½® API Key</n8n-tag>
        </n8n-option>
      </n8n-select>
    </n8n-form-item>

    <!-- é€‰æ‹©æ¨¡å‹ï¼ˆåŠ¨æ€åŠ è½½ï¼‰ -->
    <n8n-form-item label="æ¨¡å‹" v-if="selectedProvider !== 'custom'">
      <n8n-select v-model="selectedModel">
        <n8n-option
          v-for="model in availableModels"
          :key="model.id"
          :value="model.id"
        >
          <div class="model-option">
            <div>
              <strong>{{ model.name }}</strong>
              <p class="model-desc">{{ model.description }}</p>
            </div>
            <div class="model-info">
              <span class="price">Â¥{{ model.pricePerToken }}/1K tokens</span>
              <span class="context">{{ model.contextWindow.toLocaleString() }} tokens</span>
            </div>
          </div>
        </n8n-option>
      </n8n-select>
    </n8n-form-item>

    <!-- é…é¢æ˜¾ç¤º -->
    <n8n-alert type="info" v-if="quotaInfo">
      æœ¬æœˆå·²ä½¿ç”¨: {{ quotaInfo.used.toLocaleString() }} / {{ quotaInfo.total.toLocaleString() }} tokens
      <n8n-progress :percentage="quotaPercentage" />
    </n8n-alert>

    <!-- Prompt è¾“å…¥ -->
    <n8n-form-item label="Prompt">
      <n8n-input type="textarea" v-model="prompt" rows="6" />
    </n8n-form-item>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { useAIProvidersStore } from '@/stores/ai-providers.store';

const aiProvidersStore = useAIProvidersStore();

const selectedProvider = ref('openai');
const selectedModel = ref('');
const prompt = ref('');

// è·å–å¯ç”¨æä¾›å•†
const availableProviders = computed(() => aiProvidersStore.providers);

// è·å–å½“å‰æä¾›å•†çš„æ¨¡å‹åˆ—è¡¨
const availableModels = computed(() => {
  const provider = availableProviders.value.find(p => p.providerKey === selectedProvider.value);
  return provider?.modelsConfig?.models || [];
});

// è·å–é…é¢ä¿¡æ¯
const quotaInfo = computed(() => {
  const provider = availableProviders.value.find(p => p.providerKey === selectedProvider.value);
  return provider?.quotaUsage;
});

const quotaPercentage = computed(() => {
  if (!quotaInfo.value) return 0;
  return (quotaInfo.value.used / quotaInfo.value.total) * 100;
});

// æä¾›å•†åˆ‡æ¢æ—¶ï¼Œé€‰æ‹©é»˜è®¤æ¨¡å‹
watch(selectedProvider, () => {
  if (availableModels.value.length > 0) {
    selectedModel.value = availableModels.value[0].id;
  }
});

// åˆå§‹åŒ–
aiProvidersStore.fetchProviders();
</script>
```

### 2. åç«¯ï¼šPlatformAIProviderService

```typescript
// packages/cli/src/services/platform-ai-provider.service.ts
import { Service } from '@n8n/di';
import { PlatformAIProviderRepository } from '@/repositories/platform-ai-provider.repository';
import { EncryptionService } from './encryption.service';
import { BillingService } from './billing.service';
import type { ChatCompletionRequest, ChatCompletionResponse } from '@/types';

@Service()
export class PlatformAIProviderService {
  constructor(
    private readonly providerRepository: PlatformAIProviderRepository,
    private readonly encryptionService: EncryptionService,
    private readonly billingService: BillingService,
  ) {}

  /**
   * è·å–æ‰€æœ‰æ´»è·ƒçš„ AI æœåŠ¡æä¾›å•†
   */
  async getActiveProviders() {
    return await this.providerRepository.find({
      where: { isActive: true, enabled: true },
    });
  }

  /**
   * è·å–æŸä¸ªæä¾›å•†çš„æ¨¡å‹åˆ—è¡¨
   */
  async getProviderModels(providerKey: string) {
    const provider = await this.providerRepository.findOne({
      where: { providerKey },
    });

    if (!provider) {
      throw new ProviderNotFoundError(providerKey);
    }

    return provider.modelsConfig.models;
  }

  /**
   * è°ƒç”¨ AI æœåŠ¡ï¼ˆç»Ÿä¸€æ¥å£ï¼‰
   */
  async chatCompletion(
    providerKey: string,
    modelId: string,
    request: ChatCompletionRequest,
    workspaceId: string,
    userId: string,
  ): Promise<ChatCompletionResponse> {
    // 1. è·å–æä¾›å•†é…ç½®
    const provider = await this.providerRepository.findOne({
      where: { providerKey, isActive: true },
    });

    if (!provider) {
      throw new ProviderNotFoundError(providerKey);
    }

    // 2. è§£å¯† API Key
    const apiKey = await this.encryptionService.decrypt(provider.apiKeyEncrypted);

    // 3. æŸ¥æ‰¾æ¨¡å‹é…ç½®
    const model = provider.modelsConfig.models.find(m => m.id === modelId);
    if (!model) {
      throw new ModelNotFoundError(modelId);
    }

    // 4. æ£€æŸ¥ä½™é¢ï¼ˆé¢„ä¼°è´¹ç”¨ï¼‰
    const estimatedTokens = this.estimateTokens(request.messages);
    const estimatedCost = estimatedTokens * model.pricePerToken / 1000;
    await this.billingService.checkBalance(workspaceId, estimatedCost);

    // 5. è°ƒç”¨ AI API
    const response = await this.callProviderAPI(
      provider.apiEndpoint,
      apiKey,
      modelId,
      request,
    );

    // 6. è®°å½•ä½¿ç”¨é‡å¹¶æ‰£è´¹
    const actualTokens = response.usage.totalTokens;
    const actualCost = actualTokens * model.pricePerToken / 1000;

    await this.billingService.recordUsageAndCharge({
      workspaceId,
      userId,
      serviceKey: `${providerKey}:${modelId}`,
      tokensUsed: actualTokens,
      costCny: actualCost,
      metadata: {
        model: modelId,
        provider: providerKey,
        promptTokens: response.usage.promptTokens,
        completionTokens: response.usage.completionTokens,
      },
    });

    return response;
  }

  /**
   * è°ƒç”¨æä¾›å•† APIï¼ˆæŠ½è±¡å±‚ï¼‰
   */
  private async callProviderAPI(
    endpoint: string,
    apiKey: string,
    modelId: string,
    request: ChatCompletionRequest,
  ): Promise<ChatCompletionResponse> {
    const response = await fetch(`${endpoint}/v1/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: modelId,
        messages: request.messages,
        temperature: request.temperature,
        max_tokens: request.maxTokens,
      }),
    });

    if (!response.ok) {
      throw new AIProviderError(`Provider API error: ${response.statusText}`);
    }

    return await response.json();
  }

  /**
   * é¢„ä¼° token æ•°é‡ï¼ˆç®€å•å®ç°ï¼‰
   */
  private estimateTokens(messages: any[]): number {
    // ç²—ç•¥ä¼°ç®—ï¼šå¹³å‡ 1 ä¸ª token â‰ˆ 0.75 ä¸ªå•è¯ â‰ˆ 4 ä¸ªå­—ç¬¦
    const totalChars = messages.reduce((sum, msg) => sum + msg.content.length, 0);
    return Math.ceil(totalChars / 4);
  }
}
```

### 3. Controllerï¼šPlatformAIProvidersController

```typescript
// packages/cli/src/controllers/platform-ai-providers.controller.ts
import { RestController, Get, Post, Param, Body } from '@/decorators';
import { WorkspaceContext } from '@/decorators/workspace-context';
import { PlatformAIProviderService } from '@/services/platform-ai-provider.service';

@RestController('/platform-ai-providers')
export class PlatformAIProvidersController {
  constructor(private readonly providerService: PlatformAIProviderService) {}

  /**
   * è·å–æ‰€æœ‰å¯ç”¨çš„ AI æœåŠ¡æä¾›å•†
   */
  @Get('/')
  async getProviders() {
    return await this.providerService.getActiveProviders();
  }

  /**
   * è·å–æŸä¸ªæä¾›å•†çš„æ¨¡å‹åˆ—è¡¨
   */
  @Get('/:providerKey/models')
  async getProviderModels(@Param('providerKey') providerKey: string) {
    return await this.providerService.getProviderModels(providerKey);
  }

  /**
   * è°ƒç”¨ AI èŠå¤©æ¥å£ï¼ˆè‡ªåŠ¨è®¡è´¹ï¼‰
   */
  @Post('/:providerKey/chat/completions')
  async chatCompletion(
    @Param('providerKey') providerKey: string,
    @Body() body: { model: string; messages: any[]; temperature?: number },
    @WorkspaceContext() context: { workspaceId: string; userId: string },
  ) {
    return await this.providerService.chatCompletion(
      providerKey,
      body.model,
      {
        messages: body.messages,
        temperature: body.temperature,
      },
      context.workspaceId,
      context.userId,
    );
  }
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

ä¿®æ­£å®Œæˆåï¼Œéœ€æ»¡è¶³ä»¥ä¸‹æ ‡å‡†ï¼š

### æ•°æ®åº“å±‚
- [ ] `platform_ai_provider` è¡¨åˆ›å»ºæˆåŠŸ
- [ ] `platform_node` è¡¨åˆ›å»ºæˆåŠŸ
- [ ] `custom_node` è¡¨åˆ›å»ºæˆåŠŸ
- [ ] æ•°æ®è¿ç§»å®Œæˆï¼Œæ— ä¸¢å¤±
- [ ] æ—§è¡¨æ•°æ®æ­£ç¡®å½’æ¡£

### åç«¯å±‚
- [ ] PlatformAIProviderService æµ‹è¯•é€šè¿‡
- [ ] PlatformNodeService æµ‹è¯•é€šè¿‡
- [ ] CustomNodeService æµ‹è¯•é€šè¿‡
- [ ] API ç«¯ç‚¹å…¨éƒ¨æµ‹è¯•é€šè¿‡ï¼ˆPostmanï¼‰
- [ ] TypeScript ç¼–è¯‘ 0 errors

### å‰ç«¯å±‚
- [ ] AI èŠ‚ç‚¹å‚æ•°é…ç½®æ­£å¸¸å·¥ä½œ
- [ ] æ¨¡å‹åˆ—è¡¨åŠ¨æ€åŠ è½½
- [ ] ç»Ÿä¸€èŠ‚ç‚¹å¸‚åœºï¼ˆä¸å†æœ‰"æ’ä»¶å¸‚åœº"ï¼‰
- [ ] è‡ªå®šä¹‰èŠ‚ç‚¹ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] UI/UX æµ‹è¯•é€šè¿‡

### é›†æˆæµ‹è¯•
- [ ] ç”¨æˆ·å¯ä»¥ä½¿ç”¨ AI èŠ‚ç‚¹è°ƒç”¨ GPT-4
- [ ] è‡ªåŠ¨è®¡è´¹æ­£ç¡®ï¼ˆæŒ‰ token è®¡è´¹ï¼‰
- [ ] è‡ªå®šä¹‰èŠ‚ç‚¹ä¸Šä¼ å’Œæ‰§è¡Œæ­£å¸¸
- [ ] æ•°æ®éš”ç¦»éªŒè¯é€šè¿‡

---

## ğŸ“Š ä¿®æ­£ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | åŸå›  | æ—¶é—´ |
|-------|------|------|------|
| **P0** | æ•°æ®åº“ä¿®æ­£ | æ ¸å¿ƒæ¶æ„ï¼Œå½±å“æ‰€æœ‰åç»­å¼€å‘ | 0.5 å¤© |
| **P0** | Entity/Repository | ä¾èµ–æ•°æ®åº“ä¿®æ­£ | 0.5 å¤© |
| **P0** | Service å±‚ä¿®æ­£ | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ | 1 å¤© |
| **P1** | Controller ä¿®æ­£ | API æ¥å£ | 1 å¤© |
| **P1** | å‰ç«¯ä¿®æ­£ | ç”¨æˆ·ç•Œé¢ | 1.5 å¤© |
| **P2** | é›†æˆæµ‹è¯• | éªŒè¯ä¿®æ­£ | 0.5 å¤© |

**æ€»è®¡ï¼š5 å¤©**

---

## ğŸ“ æ€»ç»“

### å…³é”®è¦ç‚¹

1. **å¤§æ¨¡å‹ä¸æ˜¯èŠ‚ç‚¹** - å®ƒä»¬æ˜¯ AI èŠ‚ç‚¹çš„å‚æ•°é€‰é¡¹
2. **æ’ä»¶ = èŠ‚ç‚¹** - æ²¡æœ‰ç‹¬ç«‹çš„"æ’ä»¶"æ¦‚å¿µ
3. **å¹³å°ç®¡ç†æä¾›å•†ï¼Œä¸æ˜¯æ¨¡å‹** - OpenAI æ˜¯æä¾›å•†ï¼ŒGPT-4 æ˜¯æ¨¡å‹
4. **ç»Ÿä¸€çš„èŠ‚ç‚¹å¸‚åœº** - æ‰€æœ‰èŠ‚ç‚¹ï¼ˆå¹³å°ã€ç¬¬ä¸‰æ–¹ã€è‡ªå®šä¹‰ï¼‰åœ¨ä¸€ä¸ªåœ°æ–¹å±•ç¤º
5. **âŒ åˆ é™¤å‡­è¯ç®¡ç†** - ç”¨æˆ·ä¸éœ€è¦ç†è§£"å‡­è¯"æ¦‚å¿µ
6. **âœ… èŠ‚ç‚¹ç®¡ç†é¡µé¢** - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰èŠ‚ç‚¹æˆæƒï¼Œç”¨æˆ·çº§åˆ«éš”ç¦»
7. **âœ… å·¥ä½œæµä¸­ç›´æ¥é…ç½®** - åœ¨èŠ‚ç‚¹å‚æ•°é¢æ¿ç›´æ¥å¡«å†™ API Key
8. **âœ… åŒç±»å‹è‡ªåŠ¨å¤ç”¨** - é…ç½®ä¸€æ¬¡ï¼Œæ‰€æœ‰åŒç±»å‹èŠ‚ç‚¹è‡ªåŠ¨ä½¿ç”¨

### ä¿®æ­£èŒƒå›´å¯¹æ¯”

| ç±»åˆ« | åŸè®¡åˆ’ | è¡¥å……å‡­è¯ä¿®æ­£ | åˆè®¡ |
|------|--------|-------------|------|
| **æ•°æ®åº“è¡¨** | é‡æ„ 3 ä¸ª | + åˆ é™¤ 2 ä¸ªï¼Œ+ æ–°å¢ 1 ä¸ª | 6 ä¸ªè¡¨ |
| **Entity** | 3 ä¸ª | + åˆ é™¤ 2 ä¸ªï¼Œ+ æ–°å¢ 1 ä¸ª | 6 ä¸ªæ–‡ä»¶ |
| **Service** | 3 ä¸ª | + åˆ é™¤ 1 ä¸ªï¼Œ+ æ–°å¢ 1 ä¸ª | 5 ä¸ªæ–‡ä»¶ |
| **Controller** | 2 ä¸ª | + åˆ é™¤ 1 ä¸ªï¼Œ+ æ–°å¢ 1 ä¸ª | 4 ä¸ªæ–‡ä»¶ |
| **å‰ç«¯ API** | 2 ä¸ª | + åˆ é™¤ 1 ä¸ªï¼Œ+ æ–°å¢ 1 ä¸ª | 4 ä¸ªæ–‡ä»¶ |
| **å‰ç«¯ Store** | 2 ä¸ª | + åˆ é™¤ 1 ä¸ªï¼Œ+ æ–°å¢ 1 ä¸ª | 4 ä¸ªæ–‡ä»¶ |
| **å‰ç«¯ç»„ä»¶** | 3 ä¸ª | + åˆ é™¤ 1 ä¸ªï¼Œ+ æ–°å¢ 2 ä¸ª | 6 ä¸ªæ–‡ä»¶ |
| **æ€»è®¡** | 16 ä¸ªæ–‡ä»¶ | + 19 ä¸ªæ–‡ä»¶ | **35 ä¸ªæ–‡ä»¶** |
| **é¢„è®¡å·¥æ—¶** | 5 å¤© | + 2 å¤© | **7 å¤©** |

### éœ€è¦åˆ é™¤çš„æ–‡ä»¶ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰

#### å‡­è¯ç³»ç»Ÿç›¸å…³ï¼ˆ9 ä¸ªæ–‡ä»¶ï¼‰
```bash
# Entity å’Œ Repository
packages/@n8n/db/src/entities/credentials-entity.ts
packages/@n8n/db/src/entities/workspace-plugin-credentials.entity.ts
packages/@n8n/db/src/repositories/credentials.repository.ts
packages/@n8n/db/src/repositories/workspace-plugin-credentials.repository.ts

# Service å’Œ Controller
packages/cli/src/credentials/credentials.service.ts
packages/cli/src/credentials/credentials.service.ee.ts
packages/cli/src/controllers/credentials.controller.ts

# å‰ç«¯
packages/frontend/editor-ui/src/stores/credentials.store.ts
packages/frontend/editor-ui/src/api/credentials.ts
```

#### è¿ç§»æ–‡ä»¶ï¼ˆ3 ä¸ªï¼‰
```bash
packages/@n8n/db/src/migrations/common/1762511302220-CreatePlatformServiceTables.ts
packages/@n8n/db/src/migrations/common/1762511302660-ExtendPlatformServiceForPlugins.ts
packages/@n8n/db/src/migrations/common/1762511302880-CreateWorkspacePluginCredentialsTable.ts
```

### éœ€è¦åˆ›å»ºçš„æ–‡ä»¶ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰

#### æ•°æ®åº“å±‚
```bash
packages/@n8n/db/src/migrations/common/1762511303000-RedesignPlatformArchitecture.ts
packages/@n8n/db/src/entities/platform-ai-provider.entity.ts
packages/@n8n/db/src/entities/user-node-config.entity.ts
packages/@n8n/db/src/repositories/platform-ai-provider.repository.ts
packages/@n8n/db/src/repositories/user-node-config.repository.ts
```

#### åç«¯å±‚
```bash
packages/cli/src/services/platform-ai-provider.service.ts
packages/cli/src/services/user-node-config.service.ts
packages/cli/src/controllers/platform-ai-providers.controller.ts
packages/cli/src/controllers/user-node-config.controller.ts
```

#### å‰ç«¯å±‚
```bash
packages/frontend/editor-ui/src/api/ai-providers.ts
packages/frontend/editor-ui/src/api/user-node-config.ts
packages/frontend/editor-ui/src/stores/ai-providers.store.ts
packages/frontend/editor-ui/src/stores/userNodeConfig.store.ts
packages/frontend/editor-ui/src/views/UserNodeManagement.vue
packages/frontend/editor-ui/src/components/NodeSettings/NodeAuthConfig.vue
```

### ä¸‹ä¸€æ­¥

1. âœ… **åˆ›å»ºæ­¤æ–‡æ¡£**ï¼ˆå·²å®Œæˆï¼‰
2. âœ… **è¡¥å……å‡­è¯ç³»ç»Ÿä¿®æ­£æ–¹æ¡ˆ**ï¼ˆå·²å®Œæˆï¼‰
3. ğŸ”¨ **å¼€å§‹æ•°æ®åº“ä¿®æ­£**ï¼ˆåˆ›å»ºæ–°è¿ç§»è„šæœ¬ï¼‰
4. ğŸ”¨ **ä¿®æ­£ Entity/Repository**
5. ğŸ”¨ **ä¿®æ­£ Service å±‚**
6. ğŸ”¨ **ä¿®æ­£ Controller å±‚**
7. ğŸ”¨ **ä¿®æ­£å‰ç«¯**
8. âœ… **å®ŒæˆéªŒæ”¶æµ‹è¯•**

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.0ï¼ˆè¡¥å……å‡­è¯ç³»ç»Ÿä¿®æ­£ï¼‰
**åˆ›å»ºæ—¥æœŸï¼š** 2025-11-08
**æœ€åæ›´æ–°ï¼š** 2025-11-08
**çŠ¶æ€ï¼š** å¾…å®æ–½
**é¢„è®¡å®Œæˆï¼š** 7 å¤©å
