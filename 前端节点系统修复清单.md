# å‰ç«¯èŠ‚ç‚¹ç³»ç»Ÿ - å¿«é€Ÿä¿®å¤æ¸…å•

> **ä¼˜å…ˆçº§æ’åºï¼š** P0 (1-2å¤©) â†’ P1 (2-4å‘¨) â†’ P2 (ä¸‹æœˆ) â†’ P3 (æœªæ¥)

---

## ğŸ”´ P0 ä¼˜å…ˆçº§ - ç«‹å³ä¿®å¤ (é˜»å¡åŠŸèƒ½) 

### P0-1: ä¿®å¤NodeItem.vueä¸­çš„Badgeæ˜¾ç¤º

**é—®é¢˜ï¼š** èŠ‚ç‚¹æ¥æº(builtin/platform/custom)æœªæ˜¾ç¤º

**æ–‡ä»¶ï¼š** `/packages/frontend/editor-ui/src/features/shared/nodeCreator/components/ItemTypes/NodeItem.vue`

**ä¿®å¤æ­¥éª¤ï¼š**

```diff
+++ a/packages/frontend/editor-ui/src/features/shared/nodeCreator/components/ItemTypes/NodeItem.vue

 <script setup lang="ts">
 import type { SimplifiedNodeType } from '@/Interface';
+import { N8nBadge } from '@n8n/design-system';

 export interface Props {
 	nodeType: SimplifiedNodeType;
 	subcategory?: string;
 	active?: boolean;
 }

+const nodeBadge = computed(() => {
+	const source = (props.nodeType as any).source || 'unknown';
+	const badgeConfig = {
+		'builtin': { text: 'å†…ç½®', color: 'info' },
+		'platform': { text: 'å¹³å°', color: 'success' },
+		'thirdParty': { text: 'ç¬¬ä¸‰æ–¹', color: 'warning' },
+		'custom': { text: 'æˆ‘çš„', color: 'primary' },
+	};
+	return badgeConfig[source as keyof typeof badgeConfig];
+});

 const description = computed<string>(() => {
     // ... ç°æœ‰ä»£ç  ...
 });

</script>

 <template>
-	<div :class="['node-item-container', { 'node-item-container--active': active }]">
+	<div :class="['node-item-container', { 'node-item-container--active': active }]">
+		<div class="node-item-header">
+			<!-- ç°æœ‰iconå’Œname -->
+			<span v-if="nodeBadge" class="node-item-badge" :style="{ background: getBadgeColor(nodeBadge.color) }">
+				{{ nodeBadge.text }}
+			</span>
+		</div>
```

**é¢„æœŸç»“æœï¼š**
```
[GitHubå›¾æ ‡] GitHub [å¹³å°]  â† æ·»åŠ [å¹³å°]Badge
[Setå›¾æ ‡] Set [å†…ç½®]         â† æ·»åŠ [å†…ç½®]Badge  
[Customå›¾æ ‡] MyNode [æˆ‘çš„]  â† æ·»åŠ [æˆ‘çš„]Badge
```

**éªŒè¯æ–¹æ³•ï¼š**
- [ ] åœ¨èŠ‚ç‚¹é€‰æ‹©å™¨ä¸­çœ‹åˆ°èŠ‚ç‚¹æ—è¾¹çš„Badge
- [ ] Badgeé¢œè‰²æ­£ç¡®ï¼ˆå†…ç½®=è“ã€å¹³å°=ç»¿ã€ç¬¬ä¸‰æ–¹=é»„ã€æˆ‘çš„=çº¢ï¼‰
- [ ] è·¨æµè§ˆå™¨æµ‹è¯•

---

### P0-2: ä¿®å¤nodeTypes.store.tsä¸­çš„Sourceä¿ç•™

**é—®é¢˜ï¼š** convertAvailableNodeToDescriptionä¸­æ·»åŠ çš„sourceå­—æ®µåœ¨setNodeTypesåä¸¢å¤±

**æ–‡ä»¶ï¼š** `/packages/frontend/editor-ui/src/app/stores/nodeTypes.store.ts`

**ä¿®å¤æ­¥éª¤ï¼š**

```diff
-const setNodeTypes = (newNodeTypes: INodeTypeDescription[] = []) => {
+const setNodeTypes = (newNodeTypes: INodeTypeDescription[] = []) => {
     const groupedNodeTypes = groupNodeTypesByNameAndType(newNodeTypes);
     nodeTypes.value = {
         ...nodeTypes.value,
         ...groupedNodeTypes,
     };
+	
+	// ç¡®ä¿è‡ªå®šä¹‰å­—æ®µè¢«ä¿ç•™
+	for (const nodeName in groupedNodeTypes) {
+		for (const version in groupedNodeTypes[nodeName]) {
+			const originalNode = newNodeTypes.find(n => n.name === nodeName);
+			if (originalNode && (originalNode as any).source) {
+				(nodeTypes.value[nodeName][Number(version)] as any).source = (originalNode as any).source;
+				(nodeTypes.value[nodeName][Number(version)] as any).pricingModel = (originalNode as any).pricingModel;
+				(nodeTypes.value[nodeName][Number(version)] as any).pricePerCall = (originalNode as any).pricePerCall;
+			}
+		}
+	}
 };
```

**æˆ–è€…æ›´å¥½çš„æ–¹å¼ - ä¿®æ”¹convertAvailableNodeToDescription:**

```typescript
const convertAvailableNodeToDescription = (
	availableNode: AvailableNode,
): INodeTypeDescription | null => {
	try {
		if (availableNode.source === 'builtin') {
			return null; // Builtin nodes already loaded
		}

		// åˆ›å»ºå®Œæ•´çš„èŠ‚ç‚¹å®šä¹‰
		const nodeDescription: any = {
			name: availableNode.nodeName,
			displayName: availableNode.nodeName,
			description: availableNode.description || '',
			version: availableNode.version ? parseFloat(availableNode.version) : 1,
			defaults: {
				name: availableNode.nodeName,
			},
			inputs: [NodeConnectionTypes.Main],
			outputs: [NodeConnectionTypes.Main],
			properties: [],
			group: ['transform'],
			codex: {
				categories: [availableNode.category || 'Uncategorized'],
				subcategories: {
					[availableNode.category || 'Uncategorized']: [availableNode.source],
				},
			},
			// âœ… æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
			__source: availableNode.source,  // âœ… ä½¿ç”¨å‰ç¼€é¿å…å†²çª
			__pricingModel: availableNode.pricingModel,
			__pricePerCall: availableNode.pricePerCall,
		};

		if (availableNode.iconUrl) {
			Object.assign(nodeDescription, { iconUrl: availableNode.iconUrl });
		}

		return nodeDescription as INodeTypeDescription;
	} catch (error) {
		console.error(`Failed to convert available node ${availableNode.nodeName}:`, error);
		return null;
	}
};
```

**éªŒè¯æ–¹æ³•ï¼š**
- [ ] åœ¨å¼€å‘è€…å·¥å…·ä¸­æ£€æŸ¥nodeTypes.value
- [ ] ç¡®è®¤sourceå­—æ®µå­˜åœ¨ï¼š`nodeTypesStore.nodeTypes['github'].1.__source === 'platform'`
- [ ] visibleNodeTypesä¸­çš„èŠ‚ç‚¹éƒ½æœ‰sourceä¿¡æ¯

---

### P0-3: æ·»åŠ å·¥ä½œç©ºé—´åˆ‡æ¢æ—¶çš„èŠ‚ç‚¹åˆ·æ–°

**é—®é¢˜ï¼š** åˆ‡æ¢å·¥ä½œç©ºé—´åï¼Œè‡ªå®šä¹‰èŠ‚ç‚¹åˆ—è¡¨æœªæ›´æ–°

**æ–‡ä»¶ï¼š** `/packages/frontend/editor-ui/src/app/stores/nodeTypes.store.ts`

**ä¿®å¤æ­¥éª¤ï¼š**

```typescript
// åœ¨returnä¹‹å‰æ·»åŠ Watch

import { watch } from 'vue';
import { useProjectsStore } from '@/features/collaboration/projects/projects.store';

// è·å–ProjectsStoreå®ä¾‹
const projectsStore = useProjectsStore();

// âœ… ç›‘å¬å·¥ä½œç©ºé—´å˜åŒ–
watch(
	() => projectsStore.currentWorkspaceId,
	async (newWorkspaceId, oldWorkspaceId) => {
		if (newWorkspaceId && newWorkspaceId !== oldWorkspaceId) {
			console.log(`[nodeTypes.store] Workspace changed: ${oldWorkspaceId} â†’ ${newWorkspaceId}`);
			
			// é‡æ–°åŠ è½½èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬è¯¥å·¥ä½œç©ºé—´çš„è‡ªå®šä¹‰èŠ‚ç‚¹ï¼‰
			try {
				await getNodeTypes();
				console.log('[nodeTypes.store] Nodes reloaded successfully');
			} catch (error) {
				console.error('[nodeTypes.store] Failed to reload nodes:', error);
			}
		}
	}
);
```

**éªŒè¯æ–¹æ³•ï¼š**
- [ ] æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
- [ ] çœ‹åˆ°æ—¥å¿—ï¼š"Workspace changed: xxx â†’ yyy"
- [ ] è‡ªå®šä¹‰èŠ‚ç‚¹åˆ—è¡¨åœ¨åˆ‡æ¢å·¥ä½œç©ºé—´åç«‹å³æ›´æ–°

---

### P0-4: ç¡®ä¿è‡ªå®šä¹‰èŠ‚ç‚¹è¿”å›å®Œæ•´nodeDefinition

**é—®é¢˜ï¼š** å¹³å°å’Œè‡ªå®šä¹‰èŠ‚ç‚¹ç¼ºå°‘å®Œæ•´çš„nodeDefinitionå’Œproperties

**æ–‡ä»¶ï¼š** `/packages/cli/src/controllers/available-nodes.controller.ts`

**ä¿®å¤æ­¥éª¤ï¼š**

æ£€æŸ¥ç¬¬84-127è¡Œçš„èŠ‚ç‚¹æ˜ å°„ï¼Œç¡®ä¿åŒ…å«å®Œæ•´ä¿¡æ¯ï¼š

```diff
 ...customNodes.map((node) => ({
     nodeKey: node.nodeKey,
     nodeName: node.nodeName,
     nodeType: 'custom' as const,
     category: node.category,
     description: node.description,
     iconUrl: node.iconUrl,
     version: node.version,
     source: 'custom' as const,
     needsConfig: true,
+    nodeDefinition: node.nodeDefinition,  // âœ… æ·»åŠ å®Œæ•´å®šä¹‰
 })),
```

**éªŒè¯æ–¹æ³•ï¼š**
- [ ] æŸ¥è¯¢API: GET `/rest/available-nodes?workspaceId=xxx`
- [ ] ç¡®è®¤responseä¸­æ¯ä¸ªcustomèŠ‚ç‚¹éƒ½æœ‰nodeDefinition
- [ ] NodeItemèƒ½å¤Ÿæ¸²æŸ“å®Œæ•´çš„properties

---

## ğŸŸ  P1 ä¼˜å…ˆçº§ - ä¸»è¦åŠŸèƒ½ (2-4å‘¨)

### P1-1: æ·»åŠ èŠ‚ç‚¹ä»·æ ¼å­—æ®µåˆ°API

**æ–‡ä»¶ï¼š** å¤šä¸ªæ–‡ä»¶

**ä¿®å¤æ­¥éª¤ï¼š**

1. **æ›´æ–°AvailableNodeæ¥å£**
```typescript
// packages/frontend/editor-ui/src/app/api/available-nodes.api.ts
export interface AvailableNode {
	nodeKey: string;
	nodeName: string;
	nodeType: string;
	category: string | null;
	description: string | null;
	iconUrl: string | null;
	version: string | null;
	source: NodeSource;
	needsConfig: boolean;
	isConfigured: boolean;
	// âœ… æ·»åŠ ä»·æ ¼ä¿¡æ¯
	pricingModel?: 'free' | 'per-call' | 'per-usage';
	pricePerCall?: number;
	priceCurrency?: string;
}
```

2. **æ›´æ–°åç«¯Controller**
```typescript
// packages/cli/src/controllers/available-nodes.controller.ts
...platformNodes.map((node) => ({
	// ... ç°æœ‰å­—æ®µ ...
	pricingModel: node.pricingConfig?.model,
	pricePerCall: node.pricingConfig?.pricePerCall,
	priceCurrency: node.pricingConfig?.currency || 'CNY',
}))...
```

3. **æ›´æ–°Storeå¤„ç†**
```typescript
// åœ¨convertAvailableNodeToDescriptionä¸­ä¿ç•™ä»·æ ¼ä¿¡æ¯
__pricingModel: availableNode.pricingModel,
__pricePerCall: availableNode.pricePerCall,
__priceCurrency: availableNode.priceCurrency,
```

---

### P1-2: NodeItemä¸­æ˜¾ç¤ºä»·æ ¼

**æ–‡ä»¶ï¼š** `/packages/frontend/editor-ui/src/features/shared/nodeCreator/components/ItemTypes/NodeItem.vue`

**ä¿®å¤æ­¥éª¤ï¼š**

```vue
<template>
	<div class="node-item">
		<NodeIcon :node="nodeType" />
		<div class="node-item-content">
			<div class="node-item-header">
				<span class="node-item-name">{{ nodeType.displayName }}</span>
				<span v-if="nodeBadge" :class="['badge', `badge--${nodeBadge.color}`]">
					{{ nodeBadge.text }}
				</span>
			</div>
			<p v-if="description" class="node-item-description">{{ description }}</p>
			<!-- âœ… æ·»åŠ ä»·æ ¼æ˜¾ç¤º -->
			<div v-if="nodePrice" class="node-item-footer">
				<span class="node-item-price">
					Â¥{{ nodePrice }}
					<span class="price-unit">/ æ¬¡</span>
				</span>
			</div>
		</div>
	</div>
</template>

<script setup lang="ts">
const nodePrice = computed(() => {
	const price = (props.nodeType as any).__pricePerCall;
	if (!price) return null;
	return price.toFixed(4);
});
</script>

<style scoped>
.node-item-price {
	font-size: var(--font-size--2xs);
	color: var(--color--text--tint-1);
	font-weight: var(--font-weight--bold);
}

.price-unit {
	font-size: var(--font-size--3xs);
	color: var(--color--text--tint-2);
}
</style>
```

---

### P1-3: å·¥ä½œæµæˆæœ¬ä¼°ç®—

**æ–°æ–‡ä»¶ï¼š** `/packages/frontend/editor-ui/src/features/workflows/workflow-cost-estimator.ts`

```typescript
import { useNodeTypesStore } from '@/app/stores/nodeTypes.store';

export interface WorkflowCost {
	totalEstimatedCost: number;
	nodesCosts: Map<string, number>;
	currency: string;
	executionsPerMonth?: number;
	monthlyEstimatedCost?: number;
}

export function estimateWorkflowCost(
	workflow: Workflow,
	executionsPerMonth?: number
): WorkflowCost {
	const nodeTypesStore = useNodeTypesStore();
	const nodesCosts = new Map<string, number>();
	let totalCost = 0;

	for (const node of workflow.nodes) {
		const nodeType = nodeTypesStore.getNodeType.value(node.type);
		if (!nodeType) continue;

		const price = (nodeType as any).__pricePerCall || 0;
		nodesCosts.set(node.name, price);
		totalCost += price;
	}

	return {
		totalEstimatedCost: totalCost,
		nodesCosts,
		currency: 'CNY',
		executionsPerMonth,
		monthlyEstimatedCost: executionsPerMonth ? totalCost * executionsPerMonth : undefined,
	};
}
```

---

## ğŸŸ¡ P2 ä¼˜å…ˆçº§ - å¢å¼ºåŠŸèƒ½ (ä¸‹æœˆ)

### P2-1: é‡æ„NodeCreatorä¸ºä¸‰å±‚Tab

**æ–‡ä»¶ï¼š** `/packages/frontend/editor-ui/src/features/shared/nodeCreator/components/NodeCreator.vue`

ä½¿ç”¨computedç­›é€‰å†…ç½®ã€å¹³å°ã€è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Œå¹¶åˆ†åˆ«æ˜¾ç¤ºåœ¨ä¸‰ä¸ªTabä¸­ã€‚

### P2-2: è‡ªå®šä¹‰èŠ‚ç‚¹ä¸Šä¼ ç•Œé¢

**æ–°æ–‡ä»¶ï¼š** `/packages/frontend/editor-ui/src/features/shared/nodeCreator/components/CustomNodeUploadDialog.vue`

æä¾›èŠ‚ç‚¹ä¸Šä¼ ã€ç¼–è¾‘ã€åˆ é™¤åŠŸèƒ½ã€‚

---

## ğŸŸ¢ P3 ä¼˜å…ˆçº§ - æœªæ¥æ”¹è¿› (é•¿æœŸ)

### P3-1: èŠ‚ç‚¹æ€§èƒ½ç›‘æ§

åœ¨ExecutionPanelä¸­æ˜¾ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œæ—¶é—´å’Œèµ„æºæ¶ˆè€—ã€‚

### P3-2: èŠ‚ç‚¹é¢„æµ‹æˆæœ¬

åŸºäºå†å²æ‰§è¡Œæ•°æ®é¢„æµ‹å®é™…æˆæœ¬ã€‚

---

## âœ… éªŒè¯æ¸…å•

### å¼€å‘æ—¶éªŒè¯

- [ ] `pnpm lint` é€šè¿‡
- [ ] `pnpm typecheck` é€šè¿‡
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ— æŠ¥é”™
- [ ] èŠ‚ç‚¹åˆ—è¡¨åŠ è½½ < 500ms

### åŠŸèƒ½éªŒè¯

- [ ] èŠ‚ç‚¹æ˜¾ç¤ºBadgeï¼ˆå†…ç½®/å¹³å°/æˆ‘çš„ï¼‰
- [ ] Badgeé¢œè‰²æ­£ç¡®
- [ ] å·¥ä½œç©ºé—´åˆ‡æ¢åè‡ªå®šä¹‰èŠ‚ç‚¹åˆ·æ–°
- [ ] æœç´¢ç»“æœåŒ…å«Badge
- [ ] æ‹–æ‹½æ·»åŠ èŠ‚ç‚¹ä»å¯ç”¨

### æµè§ˆå™¨éªŒè¯

- [ ] Chrome æœ€æ–°ç‰ˆ
- [ ] Firefox æœ€æ–°ç‰ˆ
- [ ] Safari æœ€æ–°ç‰ˆ

### æ€§èƒ½éªŒè¯

- [ ] èŠ‚ç‚¹é€‰æ‹©å™¨æ‰“å¼€ < 1s
- [ ] å·¥ä½œç©ºé—´åˆ‡æ¢ < 1s
- [ ] æœç´¢å“åº” < 200ms
- [ ] å†…å­˜å ç”¨ç¨³å®š

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

**åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œï¼š**

```javascript
// æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹åŠå…¶source
const store = useNodeTypesStore();
const nodes = Object.values(store.nodeTypes)
  .flatMap(v => Object.values(v));
nodes.forEach(n => {
  const source = (n).__source || (n as any).source;
  console.log(`${n.name}: ${source}`);
});

// æŸ¥çœ‹æŒ‰sourceåˆ†ç±»çš„èŠ‚ç‚¹æ•°
const grouped = {};
nodes.forEach(n => {
  const source = (n).__source || 'unknown';
  grouped[source] = (grouped[source] || 0) + 1;
});
console.table(grouped);

// æŸ¥çœ‹ä»·æ ¼ä¿¡æ¯
nodes
  .filter(n => (n as any).__pricePerCall)
  .forEach(n => {
    console.log(`${n.name}: Â¥${(n as any).__pricePerCall}`);
  });
```

---

## ğŸ“‹ æ¯æ—¥è¿›åº¦è·Ÿè¸ª

**Day 1:**
- [ ] å®ŒæˆP0-1: Badgeæ˜¾ç¤º
- [ ] å®ŒæˆP0-2: Sourceä¿ç•™
- [ ] éªŒè¯P0-1å’ŒP0-2

**Day 2:**
- [ ] å®ŒæˆP0-3: å·¥ä½œç©ºé—´åˆ·æ–°
- [ ] å®ŒæˆP0-4: å®Œæ•´nodeDefinition
- [ ] å®Œæ•´å›å½’æµ‹è¯•P0æ‰€æœ‰åŠŸèƒ½

**Week 2:**
- [ ] å®ŒæˆP1-1: ä»·æ ¼å­—æ®µ
- [ ] å®ŒæˆP1-2: ä»·æ ¼æ˜¾ç¤º
- [ ] å¼€å§‹P1-3: æˆæœ¬ä¼°ç®—

**Week 3-4:**
- [ ] å®ŒæˆP1-3: æˆæœ¬ä¼°ç®—
- [ ] å¼€å§‹P2åŠŸèƒ½
- [ ] å®Œæ•´åŠŸèƒ½æµ‹è¯•

---

## ğŸ’¬ æäº¤ä¿¡æ¯æ¨¡æ¿

```
feat: æ·»åŠ èŠ‚ç‚¹æ¥æºBadgeæ˜¾ç¤º

- åœ¨NodeItemä¸­æ˜¾ç¤º[å†…ç½®]/[å¹³å°]/[æˆ‘çš„]Badge
- ç¡®ä¿sourceå­—æ®µæ­£ç¡®æµå‘UI
- æ·»åŠ å·¥ä½œç©ºé—´åˆ‡æ¢æ—¶çš„èŠ‚ç‚¹åˆ·æ–°
- å®Œå–„è‡ªå®šä¹‰èŠ‚ç‚¹çš„nodeDefinitionè¿”å›

Relates to: #XXXX
```

---

**æœ€åæ›´æ–°ï¼š** 2025-11-11
