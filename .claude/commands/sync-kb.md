---
name: sync-kb
description: 知识库同步工作流 - 智能对比差异清理冗余同步更新
model: inherit
tools: [Read, Grep, Glob, Bash, Write, Edit]
mcp-servers: ["context7","smithery-ai-server-sequential-thinking"]
priority: HIGH
---

# 🔄 /sync-kb - 知识库同步工作流

**调用方式** : /sync-kb [可选:指定文档名,默认全部]

**语言**: 中文 | **反馈**: 实时卡片 | **执行**: 禁止跳过任何步骤

---

## 📚 知识库结构

```yaml
.claude/guide/
  ├── index.md                    # 文件索引+功能注释(仅结构,禁止代码)
  ├── 项目架构.md                  # 技术栈+系统架构图(版本精确)
  ├── 用户规则.md                  # 自定义规则(用户维护)
  ├── 自定义库.md                  # 封装库清单(路径+功能+禁用原生库)
  ├── API.md                      # 全部API+复用函数(签名+参数,禁止实现代码)
  ├── 网络文档.md                  # 参考文档记录(标题+链接+采用状态)
  ├── 核心流程/[功能名].md         # Top10流程图(Mermaid+涉及API)
  └── 知识沉淀/
      ├── 错误修复/[日期]_[描述].md   # 错误现象+根因+解决方案
      └── 踩坑记录/[问题描述].md      # 重复问题汇总
```

---

## 🚫 执行规则

```yaml
禁止: 猜测数据 | 记录代码实现 | 跳过验证 | 占位符 | 格式不规范
强制: 只记录核心(功能/签名/依赖) | 清理冗余 | 覆盖率≥95% | 版本精确
违规: 同步失败,必须重新执行
```

---

## 步骤1: 差异扫描  (项目 vs 知识库)

```md

**1.1: 扫描项目当前状态** :
    文件清单 → Glob "**/*.{py,js,ts,jsx,tsx,vue,go,rs,java}" 排除(node_modules/,dist/,.git/) |
    技术栈 → package.json/requirements.txt/go.mod/pom.xml |
    自定义库 → Glob "**/*{Manager,Client,Service}*.{py,js,ts}" + "src/{lib,core,server}/**" |
    API/函数 → Grep "@app.route|@Get|@Post|axios|fetch" + import统计≥2 |
    配置依赖 → 读取配置文件版本号

**1.2: 读取现有知识库** :
    逐个读取 .claude/guide/ 全部文档 → 提取(文件列表/库列表/API列表/函数列表/依赖版本/流程列表)

**1.3: 智能对比差异** :
    ⚠️ 缺失: 项目有但知识库无 → 标记[新增]
    ⚠️ 过时: 知识库有但项目无/已改名/已移动 → 标记[删除/更新]
    ⚠️ 版本: 依赖版本不一致 → 标记[版本更新]
    ⚠️ 臃肿: 知识库含代码实现/重复描述/过长注释 → 标记[清理优化]

**1.4: 生成差异报告** : 卡片展示[缺失项/过时项/版本差异/臃肿内容]统计

**差异报告格式:**
==============================================================
📊 知识库差异分析
==============================================================

⚠️ 缺失项: [N]个
  - 文件未记录: [X]个
  - 自定义库未记录: [Y]个
  - API/函数未记录: [Z]个

⚠️ 过时项: [M]个
  - 已删除文件: [A]个
  - 已弃用库/API: [B]个
  - 路径变更: [C]个

⚠️ 版本差异: [K]个
  - [依赖1]: 知识库[v1.0] → 实际[v2.0]
  - [依赖2]: 知识库[v3.1] → 实际[v3.5]

⚠️ 臃肿内容: [L]处
  - 代码实现片段: [D]处
  - 重复描述: [E]处
  - 过长注释: [F]处

==============================================================

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 自检: ✓扫描项目 ✓读取知识库 ✓智能对比 ✓生成报告 → 全"是"进入步骤2
==============================================================

```

---

## 步骤2: 问题识别  (确定更新策略)

```md

**2.1: 分类问题** :
    缺失 → [新增]策略 | 过时 → [删除]策略 | 版本差异 → [更新]策略 | 臃肿 → [优化]策略

**2.2: 制定更新计划** :
    按优先级排序: P1-索引(影响全局) → P2-核心文档(架构/库/API) → P3-流程(功能) → P4-参考(文档) → P5-沉淀(历史) |
    按文档归类: 每个文档的[新增/删除/更新/优化]操作清单

**2.3: 优化规则定义** :
    ❌ 删除: 代码实现(if/for/while等) | 完整函数体 | import语句 | 注释块(≥5行) |
    ✅ 保留: 功能描述(一句话) | 函数签名(名称+参数+返回) | 依赖关系(A调用B) | 关键配置(版本/路径) |
    🔧 精简: 长描述→核心要点 | 多段落→单行 | 示例代码→签名

**2.4: 展示更新计划** : 卡片展示[按文档分组的操作清单]

**更新计划格式:**
==============================================================
📋 知识库更新计划
==============================================================

📄 index.md (P1)
  - 新增文件: [X]个 → 提取功能注释
  - 删除文件: [Y]个 → 移除记录
  - 优化描述: [Z]处 → 精简为一行

📐 项目架构.md (P2)
  - 更新依赖: [依赖1] v1.0→v2.0, [依赖2] v3.1→v3.5
  - 优化架构图: 简化节点描述

🔧 自定义库.md (P2)
  - 新增库: [库名1], [库名2]
  - 删除库: [已弃用库名]
  - 优化描述: [X]处 → 删除实现代码,保留功能签名

🌐 API.md (P2)
  - 新增API: [X]个 → 提取签名+参数
  - 新增函数: [Y]个 → 提取签名+返回
  - 优化描述: [Z]处 → 删除示例代码,保留接口定义

🔄 核心流程/[功能].md (P3)
  - 更新流程: [流程名] → 同步涉及API变化
  - 优化描述: 精简流程节点说明

📖 网络文档.md (P4)
  - 无变化 / 清理失效链接

💡 知识沉淀 (P5)
  - 归档旧记录 → 保留最近7天

==============================================================

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 自检: ✓分类问题 ✓制定计划 ✓定义规则 ✓展示计划 → 全"是"询问用户确认
==============================================================

```

**2.5: 询问用户** : "📋 是否开始同步知识库? ( 是 / 取消 )" → [是:步骤3 / 取消:退出]

---

## 步骤3: 清理优化  (瘦身去冗余)

```md

**3.1: 按文档逐个优化** : 从P1→P5依次处理,每处理完一个文档立即反馈进度

**3.2: 优化操作** :
    删除代码: Grep查找代码模式(if/for/def/function/const.*=.*\{) → 删除整块 |
    删除注释: 查找注释块(≥5行 #... 或 //... 或 /*...*/) → 删除 |
    精简描述: 长段落(≥3行) → 提取核心一句话 | 多个例子 → 保留1个或删除 |
    统一格式: 对齐分隔符 | 检查Mermaid语法 | 验证链接有效性

**3.3: 验证瘦身效果** : 对比优化前后(文件大小/行数/关键信息完整性) → 确保核心信息未丢失

**进度反馈格式:**
==============================================================
🔧 正在优化: [文档名]
==============================================================
✅ 已处理: [X]/[N]文档
🗑️ 删除代码: [A]处 | 删除注释: [B]处 | 精简描述: [C]处
📉 瘦身: [原行数]行 → [新行数]行 (-[Y]%)
==============================================================

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 自检: ✓逐个优化 ✓删除冗余 ✓验证完整 → 全"是"进入步骤4
==============================================================

```

---

## 步骤4: 同步更新  (按计划执行)

```md

**4.1: 按优先级执行** : P1索引 → P2核心 → P3流程 → P4参考 → P5沉淀

**4.2: 更新操作** :
    新增内容 → Edit在对应位置插入(格式严格遵守文档规范) |
    删除内容 → Edit移除过时记录 |
    更新内容 → Edit替换旧版本/旧路径/旧描述 |
    优化内容 → 已在步骤3完成

**4.3: 实时验证** : 每更新一个文档 → 立即Read检查 → 确保格式正确/内容准确/无遗漏

**4.4: 处理特殊文档** :
    用户规则.md → 跳过(用户维护) |
    核心流程/*.md → 检测流程是否仍有效,无效则删除 |
    知识沉淀/* → 归档≥3个月旧记录

**进度反馈格式:**
==============================================================
📊 同步进度
==============================================================
✅ 已完成: [X]/[N]文档
🔄 进行中: [文档名]
⏳ 待执行: [Y]个
==============================================================

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 自检: ✓按优先级执行 ✓实时验证 ✓处理特殊文档 → 全"是"进入步骤5
==============================================================

```

---

## 步骤5: 完整性验证  (质量检查)

```md

**5.1: 覆盖率检查** :
    index.md: Glob扫描文件数 vs index记录数 → 覆盖率≥95% |
    自定义库.md: Glob扫描库文件 vs 库记录 → 全覆盖 |
    API.md: Grep扫描API/函数 vs API记录 → 主要接口全覆盖

**5.2: 准确性检查** :
    版本号 = 配置文件 | 路径真实存在 | Mermaid语法可渲染 | 链接有效(状态码200)

**5.3: 格式检查** :
    分隔符统一(---) | 标题层级正确 | yaml格式正确 | 无残留代码片段(随机抽查3处)

**5.4: 生成验证报告** : 卡片展示[覆盖率/准确性/格式检查]结果

**验证报告格式:**
==============================================================
✅ 知识库验证报告
==============================================================

📊 覆盖率:
  - index.md: [X]/[Y]文件 ([Z]%)
  - 自定义库: [A]/[A]库 (100%)
  - API/函数: [B]/[C]接口 ([D]%)

✅ 准确性:
  - 版本号: ✓一致
  - 路径存在: ✓全部有效
  - Mermaid: ✓可渲染
  - 链接: ✓有效

✅ 格式:
  - 分隔符: ✓统一
  - 标题层级: ✓正确
  - 无代码残留: ✓已清理

==============================================================

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 自检: ✓覆盖率检查 ✓准确性检查 ✓格式检查 ✓生成报告 → 全"是"完成同步
==============================================================

```

---

## 步骤6: 同步总结  (最终报告)

```md

**6.1: 生成完成报告** : 卡片展示本次同步的完整数据

**同步完成格式:**
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  🎉 知识库同步完成            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

📚 同步统计: [N]个文档已更新 | ⏱️ 耗时[X]分[Y]秒

✅ 新增: 文件[A]个 | 库[B]个 | API/函数[C]个
🗑️ 删除: 过时记录[D]个 | 代码片段[E]处 | 冗余描述[F]处
🔄 更新: 版本号[G]个 | 路径变更[H]个 | 流程[I]个
📉 瘦身: 总行数 [原]行 → [新]行 (-[Z]%)

📊 质量: 覆盖率[X]% | 准确性✓ | 格式✓

💡 建议: [后续优化建议,如:定期同步频率/需补充的流程图等]

==============================================================

```

---

## 🎯 最佳实践

```yaml
频率建议: 每10次任务执行 → 同步1次知识库 | 大重构后 → 立即同步
检查重点: 版本号精确 | 路径真实 | 无代码实现 | 描述精简
持续优化: 定期清理≥3个月旧沉淀 | 合并重复流程 | 删除无效参考文档
```

---

> **核心原则**: 只记录"是什么"(接口/功能/依赖),不记录"怎么做"(实现代码) | 一句话说清楚 | 保持精简高效
